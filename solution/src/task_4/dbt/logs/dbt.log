[0m02:27:34.265749 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019C49E24DF0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019C4C953AC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019C4C9531F0>]}


============================== 02:27:34.269756 | 176c0f37-d49c-4ca7-b30e-49d5165f2691 ==============================
[0m02:27:34.269756 [info ] [MainThread]: Running with dbt=1.8.8
[0m02:27:34.269756 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\nicol\\.dbt', 'debug': 'False', 'version_check': 'True', 'log_path': 'src\\task_4\\dbt\\logs', 'fail_fast': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'None', 'quiet': 'False', 'no_print': 'None', 'log_format': 'default', 'invocation_command': 'dbt debug --project-dir src/task_4/dbt', 'introspect': 'True', 'static_parser': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m02:27:34.287384 [info ] [MainThread]: dbt version: 1.8.8
[0m02:27:34.288384 [info ] [MainThread]: python version: 3.10.2
[0m02:27:34.288384 [info ] [MainThread]: python path: C:\Users\nicol\AppData\Local\pypoetry\Cache\virtualenvs\ifco-assessment-vsLPAIdc-py3.10\Scripts\python.exe
[0m02:27:34.289387 [info ] [MainThread]: os info: Windows-10-10.0.22631-SP0
[0m02:27:34.290385 [info ] [MainThread]: Using profiles dir at C:\Users\nicol\.dbt
[0m02:27:34.290385 [info ] [MainThread]: Using profiles.yml file at C:\Users\nicol\.dbt\profiles.yml
[0m02:27:34.291384 [info ] [MainThread]: Using dbt_project.yml file at src\task_4\dbt\dbt_project.yml
[0m02:27:34.295895 [warn ] [MainThread]: [[33mWARNING[0m]: Deprecated functionality
The `source-paths` config has been renamed to `model-paths`. Please update your
`dbt_project.yml` configuration to reflect this change.
[0m02:27:34.296894 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'deprecation', 'label': '176c0f37-d49c-4ca7-b30e-49d5165f2691', 'property_': 'warn', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019C4C9DBF40>]}
[0m02:27:34.375329 [info ] [MainThread]: Configuration:
[0m02:27:34.376335 [info ] [MainThread]:   profiles.yml file [[31mERROR not found[0m]
[0m02:27:34.376335 [info ] [MainThread]:   dbt_project.yml file [[32mOK found and valid[0m]
[0m02:27:34.377334 [info ] [MainThread]: Required dependencies:
[0m02:27:34.378335 [debug] [MainThread]: Executing "git --help"
[0m02:27:34.408981 [debug] [MainThread]: STDOUT: "b"usage: git [--version] [--help] [-C <path>] [-c <name>=<value>]\n           [--exec-path[=<path>]] [--html-path] [--man-path] [--info-path]\n           [-p | --paginate | -P | --no-pager] [--no-replace-objects] [--bare]\n           [--git-dir=<path>] [--work-tree=<path>] [--namespace=<name>]\n           [--super-prefix=<path>] [--config-env=<name>=<envvar>]\n           <command> [<args>]\n\nThese are common Git commands used in various situations:\n\nstart a working area (see also: git help tutorial)\n   clone     Clone a repository into a new directory\n   init      Create an empty Git repository or reinitialize an existing one\n\nwork on the current change (see also: git help everyday)\n   add       Add file contents to the index\n   mv        Move or rename a file, a directory, or a symlink\n   restore   Restore working tree files\n   rm        Remove files from the working tree and from the index\n\nexamine the history and state (see also: git help revisions)\n   bisect    Use binary search to find the commit that introduced a bug\n   diff      Show changes between commits, commit and working tree, etc\n   grep      Print lines matching a pattern\n   log       Show commit logs\n   show      Show various types of objects\n   status    Show the working tree status\n\ngrow, mark and tweak your common history\n   branch    List, create, or delete branches\n   commit    Record changes to the repository\n   merge     Join two or more development histories together\n   rebase    Reapply commits on top of another base tip\n   reset     Reset current HEAD to the specified state\n   switch    Switch branches\n   tag       Create, list, delete or verify a tag object signed with GPG\n\ncollaborate (see also: git help workflows)\n   fetch     Download objects and refs from another repository\n   pull      Fetch from and integrate with another repository or a local branch\n   push      Update remote refs along with associated objects\n\n'git help -a' and 'git help -g' list available subcommands and some\nconcept guides. See 'git help <command>' or 'git help <concept>'\nto read about a specific subcommand or concept.\nSee 'git help git' for an overview of the system.\n""
[0m02:27:34.409982 [debug] [MainThread]: STDERR: "b''"
[0m02:27:34.410982 [info ] [MainThread]:  - git [[32mOK found[0m]

[0m02:27:34.412982 [info ] [MainThread]: Connection test skipped since no profile was found
[0m02:27:34.413979 [info ] [MainThread]: [31m1 check failed:[0m
[0m02:27:34.413979 [info ] [MainThread]: dbt looked for a profiles.yml file in C:\Users\nicol\.dbt\profiles.yml, but did
not find one. For more information on configuring your profile, consult the
documentation:

https://docs.getdbt.com/docs/configure-your-profile


[0m02:27:34.416948 [debug] [MainThread]: Command `dbt debug` failed at 02:27:34.416948 after 0.23 seconds
[0m02:27:34.417948 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019C49E24DF0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019C4A663610>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019C4A0CE260>]}
[0m02:27:34.417948 [debug] [MainThread]: Flushing usage events
[0m02:30:56.256924 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB605A0EB0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB630C35B0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB630C3520>]}


============================== 02:30:56.260924 | ec4c0247-209f-4d01-abd8-650831022880 ==============================
[0m02:30:56.260924 [info ] [MainThread]: Running with dbt=1.8.8
[0m02:30:56.261925 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'profiles_dir': 'src/task_4/dbt', 'log_path': 'src\\task_4\\dbt\\logs', 'fail_fast': 'False', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'None', 'log_format': 'default', 'invocation_command': 'dbt debug --project-dir src/task_4/dbt --profiles-dir src/task_4/dbt', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m02:30:56.279112 [info ] [MainThread]: dbt version: 1.8.8
[0m02:30:56.280113 [info ] [MainThread]: python version: 3.10.2
[0m02:30:56.280113 [info ] [MainThread]: python path: C:\Users\nicol\AppData\Local\pypoetry\Cache\virtualenvs\ifco-assessment-vsLPAIdc-py3.10\Scripts\python.exe
[0m02:30:56.281113 [info ] [MainThread]: os info: Windows-10-10.0.22631-SP0
[0m02:30:56.496363 [info ] [MainThread]: Using profiles dir at src/task_4/dbt
[0m02:30:56.497371 [info ] [MainThread]: Using profiles.yml file at src/task_4/dbt\profiles.yml
[0m02:30:56.497698 [info ] [MainThread]: Using dbt_project.yml file at src\task_4\dbt\dbt_project.yml
[0m02:30:56.507187 [info ] [MainThread]: adapter type: postgres
[0m02:30:56.508186 [info ] [MainThread]: adapter version: 1.8.2
[0m02:30:56.511334 [warn ] [MainThread]: [[33mWARNING[0m]: Deprecated functionality
The `source-paths` config has been renamed to `model-paths`. Please update your
`dbt_project.yml` configuration to reflect this change.
[0m02:30:56.512338 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'deprecation', 'label': 'ec4c0247-209f-4d01-abd8-650831022880', 'property_': 'warn', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB6320DAE0>]}
[0m02:30:56.594286 [info ] [MainThread]: Configuration:
[0m02:30:56.595286 [info ] [MainThread]:   profiles.yml file [[32mOK found and valid[0m]
[0m02:30:56.595286 [info ] [MainThread]:   dbt_project.yml file [[32mOK found and valid[0m]
[0m02:30:56.596497 [info ] [MainThread]: Required dependencies:
[0m02:30:56.597293 [debug] [MainThread]: Executing "git --help"
[0m02:30:56.621598 [debug] [MainThread]: STDOUT: "b"usage: git [--version] [--help] [-C <path>] [-c <name>=<value>]\n           [--exec-path[=<path>]] [--html-path] [--man-path] [--info-path]\n           [-p | --paginate | -P | --no-pager] [--no-replace-objects] [--bare]\n           [--git-dir=<path>] [--work-tree=<path>] [--namespace=<name>]\n           [--super-prefix=<path>] [--config-env=<name>=<envvar>]\n           <command> [<args>]\n\nThese are common Git commands used in various situations:\n\nstart a working area (see also: git help tutorial)\n   clone     Clone a repository into a new directory\n   init      Create an empty Git repository or reinitialize an existing one\n\nwork on the current change (see also: git help everyday)\n   add       Add file contents to the index\n   mv        Move or rename a file, a directory, or a symlink\n   restore   Restore working tree files\n   rm        Remove files from the working tree and from the index\n\nexamine the history and state (see also: git help revisions)\n   bisect    Use binary search to find the commit that introduced a bug\n   diff      Show changes between commits, commit and working tree, etc\n   grep      Print lines matching a pattern\n   log       Show commit logs\n   show      Show various types of objects\n   status    Show the working tree status\n\ngrow, mark and tweak your common history\n   branch    List, create, or delete branches\n   commit    Record changes to the repository\n   merge     Join two or more development histories together\n   rebase    Reapply commits on top of another base tip\n   reset     Reset current HEAD to the specified state\n   switch    Switch branches\n   tag       Create, list, delete or verify a tag object signed with GPG\n\ncollaborate (see also: git help workflows)\n   fetch     Download objects and refs from another repository\n   pull      Fetch from and integrate with another repository or a local branch\n   push      Update remote refs along with associated objects\n\n'git help -a' and 'git help -g' list available subcommands and some\nconcept guides. See 'git help <command>' or 'git help <concept>'\nto read about a specific subcommand or concept.\nSee 'git help git' for an overview of the system.\n""
[0m02:30:56.622598 [debug] [MainThread]: STDERR: "b''"
[0m02:30:56.622598 [info ] [MainThread]:  - git [[32mOK found[0m]

[0m02:30:56.624104 [info ] [MainThread]: Connection:
[0m02:30:56.625112 [info ] [MainThread]:   host: db
[0m02:30:56.625112 [info ] [MainThread]:   port: 5432
[0m02:30:56.626234 [info ] [MainThread]:   user: user
[0m02:30:56.626234 [info ] [MainThread]:   database: data_engineering_test
[0m02:30:56.627235 [info ] [MainThread]:   schema: public
[0m02:30:56.627781 [info ] [MainThread]:   connect_timeout: 10
[0m02:30:56.628789 [info ] [MainThread]:   role: None
[0m02:30:56.628789 [info ] [MainThread]:   search_path: None
[0m02:30:56.629787 [info ] [MainThread]:   keepalives_idle: 0
[0m02:30:56.629787 [info ] [MainThread]:   sslmode: None
[0m02:30:56.630790 [info ] [MainThread]:   sslcert: None
[0m02:30:56.630790 [info ] [MainThread]:   sslkey: None
[0m02:30:56.631792 [info ] [MainThread]:   sslrootcert: None
[0m02:30:56.632790 [info ] [MainThread]:   application_name: dbt
[0m02:30:56.632790 [info ] [MainThread]:   retries: 1
[0m02:30:56.632790 [info ] [MainThread]: Registered adapter: postgres=1.8.2
[0m02:30:56.634296 [debug] [MainThread]: Acquiring new postgres connection 'debug'
[0m02:30:58.722983 [debug] [MainThread]: Using postgres connection "debug"
[0m02:30:58.723982 [debug] [MainThread]: On debug: select 1 as id
[0m02:30:58.724489 [debug] [MainThread]: Opening a new connection, currently in state init
[0m02:31:01.463912 [debug] [MainThread]: Postgres adapter: Got a retryable error when attempting to open a postgres connection.
1 attempts remaining. Retrying in 0 seconds.
Error:
could not translate host name "db" to address: Host desconocido. 

[0m02:31:04.165702 [debug] [MainThread]: Postgres adapter: Error running SQL: select 1 as id
[0m02:31:04.166709 [debug] [MainThread]: Postgres adapter: Rolling back transaction.
[0m02:31:04.166709 [debug] [MainThread]: On debug: No close available on handle
[0m02:31:04.167708 [info ] [MainThread]:   Connection test: [[31mERROR[0m]

[0m02:31:04.167708 [info ] [MainThread]: [31m1 check failed:[0m
[0m02:31:04.168707 [info ] [MainThread]: dbt was unable to connect to the specified database.
The database returned the following error:

  >Database Error
  could not translate host name "db" to address: Host desconocido. 
  

Check your database credentials and try again. For more information, visit:
https://docs.getdbt.com/docs/configure-your-profile


[0m02:31:04.170708 [debug] [MainThread]: Command `dbt debug` failed at 02:31:04.170708 after 7.98 seconds
[0m02:31:04.170708 [debug] [MainThread]: Connection 'debug' was properly closed.
[0m02:31:04.171708 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB605A0EB0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB6314B8E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB60DA8FD0>]}
[0m02:31:04.171708 [debug] [MainThread]: Flushing usage events
[0m02:31:24.582117 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000182B3280E50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000182B5DA2F20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000182B5DA3BE0>]}


============================== 02:31:24.586051 | 5bc1fa53-54eb-43d2-b712-d82a5d284147 ==============================
[0m02:31:24.586051 [info ] [MainThread]: Running with dbt=1.8.8
[0m02:31:24.586051 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'src/task_4/dbt', 'version_check': 'True', 'debug': 'False', 'log_path': 'src\\task_4\\dbt\\logs', 'fail_fast': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'None', 'log_format': 'default', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'target_path': 'None', 'invocation_command': 'dbt debug --project-dir src/task_4/dbt --profiles-dir src/task_4/dbt', 'send_anonymous_usage_stats': 'True'}
[0m02:31:24.603170 [info ] [MainThread]: dbt version: 1.8.8
[0m02:31:24.604170 [info ] [MainThread]: python version: 3.10.2
[0m02:31:24.605003 [info ] [MainThread]: python path: C:\Users\nicol\AppData\Local\pypoetry\Cache\virtualenvs\ifco-assessment-vsLPAIdc-py3.10\Scripts\python.exe
[0m02:31:24.606097 [info ] [MainThread]: os info: Windows-10-10.0.22631-SP0
[0m02:31:24.661075 [info ] [MainThread]: Using profiles dir at src/task_4/dbt
[0m02:31:24.662007 [info ] [MainThread]: Using profiles.yml file at src/task_4/dbt\profiles.yml
[0m02:31:24.663026 [info ] [MainThread]: Using dbt_project.yml file at src\task_4\dbt\dbt_project.yml
[0m02:31:24.664025 [info ] [MainThread]: adapter type: postgres
[0m02:31:24.664530 [info ] [MainThread]: adapter version: 1.8.2
[0m02:31:24.667170 [warn ] [MainThread]: [[33mWARNING[0m]: Deprecated functionality
The `source-paths` config has been renamed to `model-paths`. Please update your
`dbt_project.yml` configuration to reflect this change.
[0m02:31:24.668173 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'deprecation', 'label': '5bc1fa53-54eb-43d2-b712-d82a5d284147', 'property_': 'warn', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000182B5DDD270>]}
[0m02:31:24.745033 [info ] [MainThread]: Configuration:
[0m02:31:24.745540 [info ] [MainThread]:   profiles.yml file [[32mOK found and valid[0m]
[0m02:31:24.746548 [info ] [MainThread]:   dbt_project.yml file [[32mOK found and valid[0m]
[0m02:31:24.747545 [info ] [MainThread]: Required dependencies:
[0m02:31:24.747545 [debug] [MainThread]: Executing "git --help"
[0m02:31:24.769907 [debug] [MainThread]: STDOUT: "b"usage: git [--version] [--help] [-C <path>] [-c <name>=<value>]\n           [--exec-path[=<path>]] [--html-path] [--man-path] [--info-path]\n           [-p | --paginate | -P | --no-pager] [--no-replace-objects] [--bare]\n           [--git-dir=<path>] [--work-tree=<path>] [--namespace=<name>]\n           [--super-prefix=<path>] [--config-env=<name>=<envvar>]\n           <command> [<args>]\n\nThese are common Git commands used in various situations:\n\nstart a working area (see also: git help tutorial)\n   clone     Clone a repository into a new directory\n   init      Create an empty Git repository or reinitialize an existing one\n\nwork on the current change (see also: git help everyday)\n   add       Add file contents to the index\n   mv        Move or rename a file, a directory, or a symlink\n   restore   Restore working tree files\n   rm        Remove files from the working tree and from the index\n\nexamine the history and state (see also: git help revisions)\n   bisect    Use binary search to find the commit that introduced a bug\n   diff      Show changes between commits, commit and working tree, etc\n   grep      Print lines matching a pattern\n   log       Show commit logs\n   show      Show various types of objects\n   status    Show the working tree status\n\ngrow, mark and tweak your common history\n   branch    List, create, or delete branches\n   commit    Record changes to the repository\n   merge     Join two or more development histories together\n   rebase    Reapply commits on top of another base tip\n   reset     Reset current HEAD to the specified state\n   switch    Switch branches\n   tag       Create, list, delete or verify a tag object signed with GPG\n\ncollaborate (see also: git help workflows)\n   fetch     Download objects and refs from another repository\n   pull      Fetch from and integrate with another repository or a local branch\n   push      Update remote refs along with associated objects\n\n'git help -a' and 'git help -g' list available subcommands and some\nconcept guides. See 'git help <command>' or 'git help <concept>'\nto read about a specific subcommand or concept.\nSee 'git help git' for an overview of the system.\n""
[0m02:31:24.770904 [debug] [MainThread]: STDERR: "b''"
[0m02:31:24.770904 [info ] [MainThread]:  - git [[32mOK found[0m]

[0m02:31:24.771903 [info ] [MainThread]: Connection:
[0m02:31:24.772904 [info ] [MainThread]:   host: localhost
[0m02:31:24.772904 [info ] [MainThread]:   port: 5432
[0m02:31:24.774410 [info ] [MainThread]:   user: user
[0m02:31:24.774925 [info ] [MainThread]:   database: data_engineering_test
[0m02:31:24.774925 [info ] [MainThread]:   schema: public
[0m02:31:24.775933 [info ] [MainThread]:   connect_timeout: 10
[0m02:31:24.775933 [info ] [MainThread]:   role: None
[0m02:31:24.776932 [info ] [MainThread]:   search_path: None
[0m02:31:24.776932 [info ] [MainThread]:   keepalives_idle: 0
[0m02:31:24.777933 [info ] [MainThread]:   sslmode: None
[0m02:31:24.778932 [info ] [MainThread]:   sslcert: None
[0m02:31:24.778932 [info ] [MainThread]:   sslkey: None
[0m02:31:24.779934 [info ] [MainThread]:   sslrootcert: None
[0m02:31:24.779934 [info ] [MainThread]:   application_name: dbt
[0m02:31:24.780933 [info ] [MainThread]:   retries: 1
[0m02:31:24.780933 [info ] [MainThread]: Registered adapter: postgres=1.8.2
[0m02:31:24.781933 [debug] [MainThread]: Acquiring new postgres connection 'debug'
[0m02:31:24.859973 [debug] [MainThread]: Using postgres connection "debug"
[0m02:31:24.860505 [debug] [MainThread]: On debug: select 1 as id
[0m02:31:24.861037 [debug] [MainThread]: Opening a new connection, currently in state init
[0m02:31:24.894903 [debug] [MainThread]: SQL status: SELECT 1 in 0.034 seconds
[0m02:31:24.896128 [debug] [MainThread]: On debug: Close
[0m02:31:24.896912 [info ] [MainThread]:   Connection test: [[32mOK connection ok[0m]

[0m02:31:24.897912 [info ] [MainThread]: [32mAll checks passed![0m
[0m02:31:24.899429 [debug] [MainThread]: Command `dbt debug` succeeded at 02:31:24.899429 after 0.39 seconds
[0m02:31:24.899429 [debug] [MainThread]: Connection 'debug' was properly closed.
[0m02:31:24.900429 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000182B3280E50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000182B351E2C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000182B3A75180>]}
[0m02:31:24.900429 [debug] [MainThread]: Flushing usage events
[0m02:35:35.974024 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000186B40A0E20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000186B6BC30A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000186B6BC3F40>]}


============================== 02:35:35.978358 | 4da4e4e2-7680-44c8-8976-068cb2b95b51 ==============================
[0m02:35:35.978358 [info ] [MainThread]: Running with dbt=1.8.8
[0m02:35:35.979361 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'src/task_4/dbt', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'src\\task_4\\dbt\\logs', 'version_check': 'True', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'log_format': 'default', 'introspect': 'True', 'static_parser': 'True', 'invocation_command': 'dbt run --models calculate_commissions --project-dir src/task_4/dbt --profiles-dir src/task_4/dbt', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m02:35:36.033285 [warn ] [MainThread]: [[33mWARNING[0m]: Deprecated functionality
The `source-paths` config has been renamed to `model-paths`. Please update your
`dbt_project.yml` configuration to reflect this change.
[0m02:35:36.034286 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'deprecation', 'label': '4da4e4e2-7680-44c8-8976-068cb2b95b51', 'property_': 'warn', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000186B6D1D060>]}
[0m02:35:36.191547 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '4da4e4e2-7680-44c8-8976-068cb2b95b51', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000186B6D1FCD0>]}
[0m02:35:36.240211 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '4da4e4e2-7680-44c8-8976-068cb2b95b51', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000186B3BE2A70>]}
[0m02:35:36.242212 [info ] [MainThread]: Registered adapter: postgres=1.8.2
[0m02:35:36.265928 [debug] [MainThread]: checksum: ec53e341a936509427e16df1c646386a84befec52c1957e3f4359fbc36fc93f5, vars: {}, profile: , target: , version: 1.8.8
[0m02:35:36.266936 [info ] [MainThread]: Unable to do partial parsing because saved manifest not found. Starting full parse.
[0m02:35:36.267936 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '4da4e4e2-7680-44c8-8976-068cb2b95b51', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000186B6E0AAD0>]}
[0m02:35:37.857061 [error] [MainThread]: Encountered an error:
Compilation Error
  Model 'model.task_4.calculate_comissions' (models\calculate_comissions.sql) depends on a node named 'orders' which was not found
[0m02:35:37.859060 [debug] [MainThread]: Command `dbt run` failed at 02:35:37.859060 after 1.95 seconds
[0m02:35:37.860059 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000186B40A0E20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000186B6D83790>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000186B70A1BD0>]}
[0m02:35:37.860059 [debug] [MainThread]: Flushing usage events
[0m02:40:17.808239 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001461FA60DF0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014622583DF0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014622583460>]}


============================== 02:40:17.812238 | ae9aefe8-c093-43ec-8447-a199b308d7c9 ==============================
[0m02:40:17.812238 [info ] [MainThread]: Running with dbt=1.8.8
[0m02:40:17.813239 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'src/task_4/dbt', 'version_check': 'True', 'warn_error': 'None', 'log_path': 'src\\task_4\\dbt\\logs', 'debug': 'False', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'log_format': 'default', 'invocation_command': 'dbt run --models calculate_commissions --project-dir src/task_4/dbt --profiles-dir src/task_4/dbt', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m02:40:18.006476 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'ae9aefe8-c093-43ec-8447-a199b308d7c9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001461FCFE260>]}
[0m02:40:18.057015 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'ae9aefe8-c093-43ec-8447-a199b308d7c9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001461F5A2A40>]}
[0m02:40:18.059016 [info ] [MainThread]: Registered adapter: postgres=1.8.2
[0m02:40:18.069062 [debug] [MainThread]: checksum: ec53e341a936509427e16df1c646386a84befec52c1957e3f4359fbc36fc93f5, vars: {}, profile: , target: , version: 1.8.8
[0m02:40:18.070063 [info ] [MainThread]: Unable to do partial parsing because saved manifest not found. Starting full parse.
[0m02:40:18.071063 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': 'ae9aefe8-c093-43ec-8447-a199b308d7c9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014622582D40>]}
[0m02:40:19.050349 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'ae9aefe8-c093-43ec-8447-a199b308d7c9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000146229FC6D0>]}
[0m02:40:19.197059 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'ae9aefe8-c093-43ec-8447-a199b308d7c9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014623AD6860>]}
[0m02:40:19.198059 [info ] [MainThread]: Found 1 model, 423 macros
[0m02:40:19.199060 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ae9aefe8-c093-43ec-8447-a199b308d7c9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014623AD6800>]}
[0m02:40:19.200057 [warn ] [MainThread]: The selection criterion 'calculate_commissions' does not match any enabled nodes
[0m02:40:19.201061 [info ] [MainThread]: 
[0m02:40:19.202059 [warn ] [MainThread]: Nothing to do. Try checking your model configs and model specification args
[0m02:40:19.203060 [debug] [MainThread]: Command end result
[0m02:40:19.227085 [debug] [MainThread]: Command `dbt run` succeeded at 02:40:19.227085 after 1.50 seconds
[0m02:40:19.227085 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001461FA60DF0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000146219BD660>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001461F8D9600>]}
[0m02:40:19.228084 [debug] [MainThread]: Flushing usage events
[0m02:41:31.409495 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023AAD6E4E50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023AB0222230>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023AB0222200>]}


============================== 02:41:31.412496 | c09f705b-250d-4f00-9319-75b4c4275cfd ==============================
[0m02:41:31.412496 [info ] [MainThread]: Running with dbt=1.8.8
[0m02:41:31.414003 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'version_check': 'True', 'log_path': 'src\\task_4\\dbt\\logs', 'profiles_dir': 'src/task_4/dbt', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'invocation_command': 'dbt run --models calculate_commissions --project-dir src/task_4/dbt --profiles-dir src/task_4/dbt', 'introspect': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m02:41:31.600731 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'c09f705b-250d-4f00-9319-75b4c4275cfd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023AB0377250>]}
[0m02:41:31.650170 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'c09f705b-250d-4f00-9319-75b4c4275cfd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023AAD236A70>]}
[0m02:41:31.652173 [info ] [MainThread]: Registered adapter: postgres=1.8.2
[0m02:41:31.660401 [debug] [MainThread]: checksum: ec53e341a936509427e16df1c646386a84befec52c1957e3f4359fbc36fc93f5, vars: {}, profile: , target: , version: 1.8.8
[0m02:41:31.814212 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m02:41:31.814718 [debug] [MainThread]: Partial parsing: updated file: task_4://models\calculate_comissions.sql
[0m02:41:32.007127 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'c09f705b-250d-4f00-9319-75b4c4275cfd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023AB07DD2A0>]}
[0m02:41:32.090376 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'c09f705b-250d-4f00-9319-75b4c4275cfd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023AB06500A0>]}
[0m02:41:32.091376 [info ] [MainThread]: Found 1 model, 423 macros
[0m02:41:32.092375 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'c09f705b-250d-4f00-9319-75b4c4275cfd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023AB0652560>]}
[0m02:41:32.093377 [warn ] [MainThread]: The selection criterion 'calculate_commissions' does not match any enabled nodes
[0m02:41:32.095119 [info ] [MainThread]: 
[0m02:41:32.096250 [warn ] [MainThread]: Nothing to do. Try checking your model configs and model specification args
[0m02:41:32.096250 [debug] [MainThread]: Command end result
[0m02:41:32.121175 [debug] [MainThread]: Command `dbt run` succeeded at 02:41:32.120174 after 0.79 seconds
[0m02:41:32.121175 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023AAD6E4E50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023AAF66C520>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023AAF650550>]}
[0m02:41:32.122175 [debug] [MainThread]: Flushing usage events
[0m02:43:48.992343 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021B120D0E20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021B14BF2EF0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021B14BF3400>]}


============================== 02:43:48.996203 | 6d13edf8-a885-441f-aefa-74709c9c1231 ==============================
[0m02:43:48.996203 [info ] [MainThread]: Running with dbt=1.8.8
[0m02:43:48.996203 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'src\\task_4\\dbt\\logs', 'version_check': 'True', 'profiles_dir': 'src/task_4/dbt', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'invocation_command': 'dbt run --models src/task_4/dbt/calculate_commissions --project-dir src/task_4/dbt --profiles-dir src/task_4/dbt', 'log_format': 'default', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m02:43:49.181047 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '6d13edf8-a885-441f-aefa-74709c9c1231', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021B14D7E080>]}
[0m02:43:49.230604 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '6d13edf8-a885-441f-aefa-74709c9c1231', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021B1466A170>]}
[0m02:43:49.232608 [info ] [MainThread]: Registered adapter: postgres=1.8.2
[0m02:43:49.240636 [debug] [MainThread]: checksum: ec53e341a936509427e16df1c646386a84befec52c1957e3f4359fbc36fc93f5, vars: {}, profile: , target: , version: 1.8.8
[0m02:43:49.385250 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m02:43:49.385250 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m02:43:49.412578 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '6d13edf8-a885-441f-aefa-74709c9c1231', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021B15068130>]}
[0m02:43:49.507238 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '6d13edf8-a885-441f-aefa-74709c9c1231', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021B1507E2F0>]}
[0m02:43:49.508238 [info ] [MainThread]: Found 1 model, 423 macros
[0m02:43:49.509237 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '6d13edf8-a885-441f-aefa-74709c9c1231', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021B1507E8C0>]}
[0m02:43:49.510238 [warn ] [MainThread]: The selection criterion 'src/task_4/dbt/calculate_commissions' does not match any enabled nodes
[0m02:43:49.511239 [info ] [MainThread]: 
[0m02:43:49.511239 [warn ] [MainThread]: Nothing to do. Try checking your model configs and model specification args
[0m02:43:49.513239 [debug] [MainThread]: Command end result
[0m02:43:49.537024 [debug] [MainThread]: Command `dbt run` succeeded at 02:43:49.537024 after 0.61 seconds
[0m02:43:49.538024 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021B120D0E20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021B14C7F130>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021B14EAD840>]}
[0m02:43:49.538024 [debug] [MainThread]: Flushing usage events
[0m02:43:59.138758 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BC346C0E20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BC371E2EF0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BC371E3400>]}


============================== 02:43:59.142393 | 49361f96-1ca7-4d5c-813c-32b18ad38d49 ==============================
[0m02:43:59.142393 [info ] [MainThread]: Running with dbt=1.8.8
[0m02:43:59.143392 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'version_check': 'True', 'log_path': 'src\\task_4\\dbt\\logs', 'profiles_dir': 'src/task_4/dbt', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'log_format': 'default', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'target_path': 'None', 'invocation_command': 'dbt run --models src/task_4/dbt/calculate_commissions.sql --project-dir src/task_4/dbt --profiles-dir src/task_4/dbt', 'send_anonymous_usage_stats': 'True'}
[0m02:43:59.332092 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '49361f96-1ca7-4d5c-813c-32b18ad38d49', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BC3736E080>]}
[0m02:43:59.381778 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '49361f96-1ca7-4d5c-813c-32b18ad38d49', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BC36C5A170>]}
[0m02:43:59.384285 [info ] [MainThread]: Registered adapter: postgres=1.8.2
[0m02:43:59.392813 [debug] [MainThread]: checksum: ec53e341a936509427e16df1c646386a84befec52c1957e3f4359fbc36fc93f5, vars: {}, profile: , target: , version: 1.8.8
[0m02:43:59.527781 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m02:43:59.527781 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m02:43:59.556855 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '49361f96-1ca7-4d5c-813c-32b18ad38d49', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BC37658130>]}
[0m02:43:59.644444 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '49361f96-1ca7-4d5c-813c-32b18ad38d49', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BC3766E2F0>]}
[0m02:43:59.644950 [info ] [MainThread]: Found 1 model, 423 macros
[0m02:43:59.645957 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '49361f96-1ca7-4d5c-813c-32b18ad38d49', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BC3766E8C0>]}
[0m02:43:59.646958 [warn ] [MainThread]: The selection criterion 'src/task_4/dbt/calculate_commissions.sql' does not match any enabled nodes
[0m02:43:59.647958 [info ] [MainThread]: 
[0m02:43:59.647958 [warn ] [MainThread]: Nothing to do. Try checking your model configs and model specification args
[0m02:43:59.649957 [debug] [MainThread]: Command end result
[0m02:43:59.675794 [debug] [MainThread]: Command `dbt run` succeeded at 02:43:59.675286 after 0.60 seconds
[0m02:43:59.675794 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BC346C0E20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BC3726F130>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BC3749D840>]}
[0m02:43:59.676804 [debug] [MainThread]: Flushing usage events
[0m02:44:13.957627 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022A50BD4E50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022A53711D50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022A53713DC0>]}


============================== 02:44:13.961628 | b4dfee34-38dd-44c7-8235-4b33ba622bf8 ==============================
[0m02:44:13.961628 [info ] [MainThread]: Running with dbt=1.8.8
[0m02:44:13.962632 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'src/task_4/dbt', 'version_check': 'True', 'warn_error': 'None', 'log_path': 'src\\task_4\\dbt\\logs', 'fail_fast': 'False', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'log_format': 'default', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --project-dir src/task_4/dbt --profiles-dir src/task_4/dbt', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m02:44:14.154234 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'b4dfee34-38dd-44c7-8235-4b33ba622bf8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022A538D2590>]}
[0m02:44:14.202801 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'b4dfee34-38dd-44c7-8235-4b33ba622bf8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022A50722A70>]}
[0m02:44:14.205310 [info ] [MainThread]: Registered adapter: postgres=1.8.2
[0m02:44:14.213376 [debug] [MainThread]: checksum: ec53e341a936509427e16df1c646386a84befec52c1957e3f4359fbc36fc93f5, vars: {}, profile: , target: , version: 1.8.8
[0m02:44:14.345209 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m02:44:14.346215 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m02:44:14.372427 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'b4dfee34-38dd-44c7-8235-4b33ba622bf8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022A53B88130>]}
[0m02:44:14.458113 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'b4dfee34-38dd-44c7-8235-4b33ba622bf8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022A53B9A440>]}
[0m02:44:14.459115 [info ] [MainThread]: Found 1 model, 423 macros
[0m02:44:14.460115 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'b4dfee34-38dd-44c7-8235-4b33ba622bf8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022A53B9A860>]}
[0m02:44:14.461123 [info ] [MainThread]: 
[0m02:44:14.462114 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m02:44:14.464118 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_engineering_test'
[0m02:44:14.548324 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test"
[0m02:44:14.549324 [debug] [ThreadPool]: On list_data_engineering_test: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "list_data_engineering_test"} */

    select distinct nspname from pg_namespace
  
[0m02:44:14.549324 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m02:44:14.602012 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.052 seconds
[0m02:44:14.604009 [debug] [ThreadPool]: On list_data_engineering_test: Close
[0m02:44:14.605024 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_engineering_test_public'
[0m02:44:14.611033 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test_public"
[0m02:44:14.612035 [debug] [ThreadPool]: On list_data_engineering_test_public: BEGIN
[0m02:44:14.612035 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m02:44:14.631589 [debug] [ThreadPool]: SQL status: BEGIN in 0.019 seconds
[0m02:44:14.631589 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test_public"
[0m02:44:14.632590 [debug] [ThreadPool]: On list_data_engineering_test_public: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "list_data_engineering_test_public"} */
select
      'data_engineering_test' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_engineering_test' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_engineering_test' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m02:44:14.660703 [debug] [ThreadPool]: SQL status: SELECT 2 in 0.028 seconds
[0m02:44:14.662691 [debug] [ThreadPool]: On list_data_engineering_test_public: ROLLBACK
[0m02:44:14.664295 [debug] [ThreadPool]: On list_data_engineering_test_public: Close
[0m02:44:14.669371 [debug] [MainThread]: Using postgres connection "master"
[0m02:44:14.669371 [debug] [MainThread]: On master: BEGIN
[0m02:44:14.670372 [debug] [MainThread]: Opening a new connection, currently in state init
[0m02:44:14.707688 [debug] [MainThread]: SQL status: BEGIN in 0.037 seconds
[0m02:44:14.707688 [debug] [MainThread]: Using postgres connection "master"
[0m02:44:14.708688 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m02:44:14.730406 [debug] [MainThread]: SQL status: SELECT 0 in 0.022 seconds
[0m02:44:14.732407 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'b4dfee34-38dd-44c7-8235-4b33ba622bf8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022A53B9D1E0>]}
[0m02:44:14.732407 [debug] [MainThread]: On master: ROLLBACK
[0m02:44:14.734407 [debug] [MainThread]: Using postgres connection "master"
[0m02:44:14.734915 [debug] [MainThread]: On master: BEGIN
[0m02:44:14.737103 [debug] [MainThread]: SQL status: BEGIN in 0.002 seconds
[0m02:44:14.737103 [debug] [MainThread]: On master: COMMIT
[0m02:44:14.738102 [debug] [MainThread]: Using postgres connection "master"
[0m02:44:14.738102 [debug] [MainThread]: On master: COMMIT
[0m02:44:14.739103 [debug] [MainThread]: SQL status: COMMIT in 0.001 seconds
[0m02:44:14.739103 [debug] [MainThread]: On master: Close
[0m02:44:14.740100 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m02:44:14.741103 [info ] [MainThread]: 
[0m02:44:14.744934 [debug] [Thread-1 (]: Began running node model.task_4.calculate_comissions
[0m02:44:14.745940 [info ] [Thread-1 (]: 1 of 1 START sql view model public.calculate_comissions ........................ [RUN]
[0m02:44:14.745940 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.task_4.calculate_comissions'
[0m02:44:14.746941 [debug] [Thread-1 (]: Began compiling node model.task_4.calculate_comissions
[0m02:44:14.752940 [debug] [Thread-1 (]: Writing injected SQL for node "model.task_4.calculate_comissions"
[0m02:44:14.754966 [debug] [Thread-1 (]: Began executing node model.task_4.calculate_comissions
[0m02:44:14.791293 [debug] [Thread-1 (]: Writing runtime sql for node "model.task_4.calculate_comissions"
[0m02:44:14.793292 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m02:44:14.793292 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: BEGIN
[0m02:44:14.794291 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m02:44:14.815933 [debug] [Thread-1 (]: SQL status: BEGIN in 0.021 seconds
[0m02:44:14.815933 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m02:44:14.816932 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */

  create view "data_engineering_test"."public"."calculate_comissions__dbt_tmp"
    
    
  as (
    WITH salesowners AS (
    SELECT
        o.order_id,
        unnest(string_to_array(o.salesowners, ', ')) AS salesowner,
        -- We convert the Gross value to Euros
        i.grossValue / 100.0 AS gross_value_in_euros,  
        
        -- Now we take the vat from the gross value in eruos to get the net value in euros.
        (gross_value_in_euros * i.vat)/100 AS net_value_in_euros
    FROM
        public.orders o
    JOIN
        public.invoicing_data i ON o.order_id = i.orderId
),
commission_calc AS (
    SELECT
        order_id,
        salesowner,
        CASE 
            WHEN row_number() OVER (PARTITION BY order_id ORDER BY salesowner) = 1 THEN net_value_in_euros * 0.06  -- Main Owner - 6%
            WHEN row_number() OVER (PARTITION BY order_id ORDER BY salesowner) = 2 THEN net_value_in_euros * 0.025  -- Co-owner 1 - 2.5%
            WHEN row_number() OVER (PARTITION BY order_id ORDER BY salesowner) = 3 THEN net_value_in_euros * 0.0095  -- Co-owner 2 - 0.95%
            ELSE 0  -- No commission for others
        END AS commission
    FROM salesowners
)
SELECT
    salesowner,
    SUM(commission) AS total_commission
FROM commission_calc
GROUP BY salesowner
ORDER BY total_commission DESC;
  );
[0m02:44:14.819955 [debug] [Thread-1 (]: Postgres adapter: Postgres error: syntax error at or near ";"
LINE 38: ORDER BY total_commission DESC;
                                       ^

[0m02:44:14.819955 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: ROLLBACK
[0m02:44:14.821957 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: Close
[0m02:44:14.849510 [debug] [Thread-1 (]: Database Error in model calculate_comissions (models\calculate_comissions.sql)
  syntax error at or near ";"
  LINE 38: ORDER BY total_commission DESC;
                                         ^
  compiled code at target\run\task_4\models\calculate_comissions.sql
[0m02:44:14.851514 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b4dfee34-38dd-44c7-8235-4b33ba622bf8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022A50707D60>]}
[0m02:44:14.851514 [error] [Thread-1 (]: 1 of 1 ERROR creating sql view model public.calculate_comissions ............... [[31mERROR[0m in 0.10s]
[0m02:44:14.853090 [debug] [Thread-1 (]: Finished running node model.task_4.calculate_comissions
[0m02:44:14.855199 [debug] [MainThread]: Using postgres connection "master"
[0m02:44:14.855730 [debug] [MainThread]: On master: BEGIN
[0m02:44:14.856258 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m02:44:14.873460 [debug] [MainThread]: SQL status: BEGIN in 0.017 seconds
[0m02:44:14.874460 [debug] [MainThread]: On master: COMMIT
[0m02:44:14.874967 [debug] [MainThread]: Using postgres connection "master"
[0m02:44:14.874967 [debug] [MainThread]: On master: COMMIT
[0m02:44:14.876121 [debug] [MainThread]: SQL status: COMMIT in 0.001 seconds
[0m02:44:14.877131 [debug] [MainThread]: On master: Close
[0m02:44:14.878129 [debug] [MainThread]: Connection 'master' was properly closed.
[0m02:44:14.878129 [debug] [MainThread]: Connection 'list_data_engineering_test' was properly closed.
[0m02:44:14.878129 [debug] [MainThread]: Connection 'list_data_engineering_test_public' was properly closed.
[0m02:44:14.879132 [debug] [MainThread]: Connection 'model.task_4.calculate_comissions' was properly closed.
[0m02:44:14.879132 [info ] [MainThread]: 
[0m02:44:14.880128 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 0.42 seconds (0.42s).
[0m02:44:14.881634 [debug] [MainThread]: Command end result
[0m02:44:14.909745 [info ] [MainThread]: 
[0m02:44:14.910752 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m02:44:14.910752 [info ] [MainThread]: 
[0m02:44:14.911748 [error] [MainThread]:   Database Error in model calculate_comissions (models\calculate_comissions.sql)
  syntax error at or near ";"
  LINE 38: ORDER BY total_commission DESC;
                                         ^
  compiled code at target\run\task_4\models\calculate_comissions.sql
[0m02:44:14.912751 [info ] [MainThread]: 
[0m02:44:14.912751 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m02:44:14.915266 [debug] [MainThread]: Command `dbt run` failed at 02:44:14.914258 after 1.02 seconds
[0m02:44:14.915266 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022A50BD4E50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022A50707D60>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022A53B9A4A0>]}
[0m02:44:14.915266 [debug] [MainThread]: Flushing usage events
[0m02:57:53.771179 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012D7BF40D90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012D7EA62680>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012D7EA63E20>]}


============================== 02:57:53.775185 | 4bcc8ac6-7c51-42b8-a952-50c634abeb96 ==============================
[0m02:57:53.775185 [info ] [MainThread]: Running with dbt=1.8.8
[0m02:57:53.776185 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4\\dbt', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4\\dbt\\logs', 'warn_error': 'None', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'log_format': 'default', 'invocation_command': 'dbt run --models src/task_4/dbt/models/calculate_commissions.sql', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m02:57:53.974287 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '4bcc8ac6-7c51-42b8-a952-50c634abeb96', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012D7EBEDED0>]}
[0m02:57:54.023860 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '4bcc8ac6-7c51-42b8-a952-50c634abeb96', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012D7BA76A40>]}
[0m02:57:54.025862 [info ] [MainThread]: Registered adapter: postgres=1.8.2
[0m02:57:54.033946 [debug] [MainThread]: checksum: ec53e341a936509427e16df1c646386a84befec52c1957e3f4359fbc36fc93f5, vars: {}, profile: , target: , version: 1.8.8
[0m02:57:54.172408 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m02:57:54.172408 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m02:57:54.199072 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '4bcc8ac6-7c51-42b8-a952-50c634abeb96', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012D7EED8130>]}
[0m02:57:54.285975 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '4bcc8ac6-7c51-42b8-a952-50c634abeb96', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012D7EEEE410>]}
[0m02:57:54.286977 [info ] [MainThread]: Found 1 model, 423 macros
[0m02:57:54.287977 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '4bcc8ac6-7c51-42b8-a952-50c634abeb96', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012D7EEEEA40>]}
[0m02:57:54.287977 [warn ] [MainThread]: The selection criterion 'src/task_4/dbt/models/calculate_commissions.sql' does not match any enabled nodes
[0m02:57:54.289999 [info ] [MainThread]: 
[0m02:57:54.289999 [warn ] [MainThread]: Nothing to do. Try checking your model configs and model specification args
[0m02:57:54.292005 [debug] [MainThread]: Command end result
[0m02:57:54.315232 [debug] [MainThread]: Command `dbt run` succeeded at 02:57:54.315232 after 0.62 seconds
[0m02:57:54.316231 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012D7BF40D90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012D7DEC0520>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012D7EAEF1F0>]}
[0m02:57:54.317230 [debug] [MainThread]: Flushing usage events
[0m02:58:33.246078 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000216E5564DF0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000216E8093610>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000216E80938B0>]}


============================== 02:58:33.249583 | 3605eebe-a74e-4a71-aacc-249b60259501 ==============================
[0m02:58:33.249583 [info ] [MainThread]: Running with dbt=1.8.8
[0m02:58:33.250090 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'src\\task_4\\dbt\\logs', 'debug': 'False', 'profiles_dir': 'src/task_4/dbt', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --profiles-dir src/task_4/dbt --project-dir src/task_4/dbt', 'log_format': 'default', 'static_parser': 'True', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m02:58:33.435083 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '3605eebe-a74e-4a71-aacc-249b60259501', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000216E82523B0>]}
[0m02:58:33.483030 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '3605eebe-a74e-4a71-aacc-249b60259501', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000216E50B6A40>]}
[0m02:58:33.485031 [info ] [MainThread]: Registered adapter: postgres=1.8.2
[0m02:58:33.493055 [debug] [MainThread]: checksum: ec53e341a936509427e16df1c646386a84befec52c1957e3f4359fbc36fc93f5, vars: {}, profile: , target: , version: 1.8.8
[0m02:58:33.627091 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m02:58:33.628091 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m02:58:33.655679 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '3605eebe-a74e-4a71-aacc-249b60259501', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000216E8508130>]}
[0m02:58:33.742741 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '3605eebe-a74e-4a71-aacc-249b60259501', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000216E851A4A0>]}
[0m02:58:33.743741 [info ] [MainThread]: Found 1 model, 423 macros
[0m02:58:33.743741 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '3605eebe-a74e-4a71-aacc-249b60259501', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000216E596FDF0>]}
[0m02:58:33.745741 [info ] [MainThread]: 
[0m02:58:33.746741 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m02:58:33.747740 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_engineering_test'
[0m02:58:33.853825 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test"
[0m02:58:33.853825 [debug] [ThreadPool]: On list_data_engineering_test: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "list_data_engineering_test"} */

    select distinct nspname from pg_namespace
  
[0m02:58:33.854826 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m02:58:33.877003 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.022 seconds
[0m02:58:33.878003 [debug] [ThreadPool]: On list_data_engineering_test: Close
[0m02:58:33.880028 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_engineering_test_public'
[0m02:58:33.886038 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test_public"
[0m02:58:33.887033 [debug] [ThreadPool]: On list_data_engineering_test_public: BEGIN
[0m02:58:33.887033 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m02:58:33.903348 [debug] [ThreadPool]: SQL status: BEGIN in 0.016 seconds
[0m02:58:33.903348 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test_public"
[0m02:58:33.904344 [debug] [ThreadPool]: On list_data_engineering_test_public: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "list_data_engineering_test_public"} */
select
      'data_engineering_test' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_engineering_test' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_engineering_test' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m02:58:33.908346 [debug] [ThreadPool]: SQL status: SELECT 2 in 0.004 seconds
[0m02:58:33.909852 [debug] [ThreadPool]: On list_data_engineering_test_public: ROLLBACK
[0m02:58:33.911509 [debug] [ThreadPool]: On list_data_engineering_test_public: Close
[0m02:58:33.915517 [debug] [MainThread]: Using postgres connection "master"
[0m02:58:33.916515 [debug] [MainThread]: On master: BEGIN
[0m02:58:33.916515 [debug] [MainThread]: Opening a new connection, currently in state init
[0m02:58:33.931245 [debug] [MainThread]: SQL status: BEGIN in 0.014 seconds
[0m02:58:33.931245 [debug] [MainThread]: Using postgres connection "master"
[0m02:58:33.932254 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m02:58:33.937251 [debug] [MainThread]: SQL status: SELECT 0 in 0.004 seconds
[0m02:58:33.938252 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '3605eebe-a74e-4a71-aacc-249b60259501', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000216E8511CC0>]}
[0m02:58:33.939250 [debug] [MainThread]: On master: ROLLBACK
[0m02:58:33.940101 [debug] [MainThread]: Using postgres connection "master"
[0m02:58:33.940101 [debug] [MainThread]: On master: BEGIN
[0m02:58:33.942108 [debug] [MainThread]: SQL status: BEGIN in 0.001 seconds
[0m02:58:33.942108 [debug] [MainThread]: On master: COMMIT
[0m02:58:33.943108 [debug] [MainThread]: Using postgres connection "master"
[0m02:58:33.943108 [debug] [MainThread]: On master: COMMIT
[0m02:58:33.944108 [debug] [MainThread]: SQL status: COMMIT in 0.001 seconds
[0m02:58:33.945107 [debug] [MainThread]: On master: Close
[0m02:58:33.945107 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m02:58:33.946111 [info ] [MainThread]: 
[0m02:58:33.949106 [debug] [Thread-1 (]: Began running node model.task_4.calculate_comissions
[0m02:58:33.950182 [info ] [Thread-1 (]: 1 of 1 START sql view model public.calculate_comissions ........................ [RUN]
[0m02:58:33.951192 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.task_4.calculate_comissions'
[0m02:58:33.951192 [debug] [Thread-1 (]: Began compiling node model.task_4.calculate_comissions
[0m02:58:33.957697 [debug] [Thread-1 (]: Writing injected SQL for node "model.task_4.calculate_comissions"
[0m02:58:33.957697 [debug] [Thread-1 (]: Began executing node model.task_4.calculate_comissions
[0m02:58:33.994990 [debug] [Thread-1 (]: Writing runtime sql for node "model.task_4.calculate_comissions"
[0m02:58:33.995990 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m02:58:33.996994 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: BEGIN
[0m02:58:33.996994 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m02:58:34.057823 [debug] [Thread-1 (]: SQL status: BEGIN in 0.060 seconds
[0m02:58:34.057823 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m02:58:34.057823 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */

  create view "data_engineering_test"."public"."calculate_comissions__dbt_tmp"
    
    
  as (
    WITH salesowners AS (
    SELECT
        o.order_id,
        unnest(string_to_array(o.salesowners, ', ')) AS salesowner,
        -- We convert the Gross value to Euros
        i.grossValue / 100.0 AS gross_value_in_euros,  
        
        -- Now we take the vat from the gross value in eruos to get the net value in euros.
        (gross_value_in_euros * i.vat)/100 AS net_value_in_euros
    FROM
        public.orders o
    JOIN
        public.invoicing_data i ON o.order_id = i.orderId
),
commission_calc AS (
    SELECT
        order_id,
        salesowner,
        CASE 
            WHEN row_number() OVER (PARTITION BY order_id ORDER BY salesowner) = 1 THEN net_value_in_euros * 0.06  -- Main Owner - 6%
            WHEN row_number() OVER (PARTITION BY order_id ORDER BY salesowner) = 2 THEN net_value_in_euros * 0.025  -- Co-owner 1 - 2.5%
            WHEN row_number() OVER (PARTITION BY order_id ORDER BY salesowner) = 3 THEN net_value_in_euros * 0.0095  -- Co-owner 2 - 0.95%
            ELSE 0  -- No commission for others
        END AS commission
    FROM salesowners
)
SELECT
    salesowner,
    SUM(commission) AS total_commission
FROM commission_calc
GROUP BY salesowner
ORDER BY total_commission DESC;
  );
[0m02:58:34.060338 [debug] [Thread-1 (]: Postgres adapter: Postgres error: syntax error at or near ";"
LINE 38: ORDER BY total_commission DESC;
                                       ^

[0m02:58:34.060845 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: ROLLBACK
[0m02:58:34.061854 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: Close
[0m02:58:34.065850 [debug] [Thread-1 (]: Database Error in model calculate_comissions (models\calculate_comissions.sql)
  syntax error at or near ";"
  LINE 38: ORDER BY total_commission DESC;
                                         ^
  compiled code at target\run\task_4\models\calculate_comissions.sql
[0m02:58:34.066850 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3605eebe-a74e-4a71-aacc-249b60259501', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000216E50979A0>]}
[0m02:58:34.067850 [error] [Thread-1 (]: 1 of 1 ERROR creating sql view model public.calculate_comissions ............... [[31mERROR[0m in 0.12s]
[0m02:58:34.067850 [debug] [Thread-1 (]: Finished running node model.task_4.calculate_comissions
[0m02:58:34.070361 [debug] [MainThread]: Using postgres connection "master"
[0m02:58:34.070361 [debug] [MainThread]: On master: BEGIN
[0m02:58:34.071582 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m02:58:34.097820 [debug] [MainThread]: SQL status: BEGIN in 0.026 seconds
[0m02:58:34.097820 [debug] [MainThread]: On master: COMMIT
[0m02:58:34.097820 [debug] [MainThread]: Using postgres connection "master"
[0m02:58:34.099325 [debug] [MainThread]: On master: COMMIT
[0m02:58:34.100336 [debug] [MainThread]: SQL status: COMMIT in 0.001 seconds
[0m02:58:34.100336 [debug] [MainThread]: On master: Close
[0m02:58:34.101506 [debug] [MainThread]: Connection 'master' was properly closed.
[0m02:58:34.102506 [debug] [MainThread]: Connection 'list_data_engineering_test' was properly closed.
[0m02:58:34.102506 [debug] [MainThread]: Connection 'list_data_engineering_test_public' was properly closed.
[0m02:58:34.102506 [debug] [MainThread]: Connection 'model.task_4.calculate_comissions' was properly closed.
[0m02:58:34.103502 [info ] [MainThread]: 
[0m02:58:34.104507 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 0.36 seconds (0.36s).
[0m02:58:34.104507 [debug] [MainThread]: Command end result
[0m02:58:34.131185 [info ] [MainThread]: 
[0m02:58:34.132183 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m02:58:34.132183 [info ] [MainThread]: 
[0m02:58:34.133183 [error] [MainThread]:   Database Error in model calculate_comissions (models\calculate_comissions.sql)
  syntax error at or near ";"
  LINE 38: ORDER BY total_commission DESC;
                                         ^
  compiled code at target\run\task_4\models\calculate_comissions.sql
[0m02:58:34.134182 [info ] [MainThread]: 
[0m02:58:34.134182 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m02:58:34.136182 [debug] [MainThread]: Command `dbt run` failed at 02:58:34.136182 after 0.96 seconds
[0m02:58:34.136182 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000216E5564DF0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000216E596FE50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000216E50979A0>]}
[0m02:58:34.137183 [debug] [MainThread]: Flushing usage events
[0m02:59:48.315138 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025843A58E80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000258465725F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000258465720E0>]}


============================== 02:59:48.319136 | 11c5590e-b415-4722-acb5-6d5177b0acec ==============================
[0m02:59:48.319136 [info ] [MainThread]: Running with dbt=1.8.8
[0m02:59:48.320098 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'profiles_dir': 'src/task_4/dbt', 'log_path': 'src\\task_4\\dbt\\logs', 'version_check': 'True', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'log_format': 'default', 'introspect': 'True', 'static_parser': 'True', 'invocation_command': 'dbt run --profiles-dir src/task_4/dbt --project-dir src/task_4/dbt', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m02:59:48.507295 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '11c5590e-b415-4722-acb5-6d5177b0acec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025846732740>]}
[0m02:59:48.556036 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '11c5590e-b415-4722-acb5-6d5177b0acec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025843586AA0>]}
[0m02:59:48.557036 [info ] [MainThread]: Registered adapter: postgres=1.8.2
[0m02:59:48.565762 [debug] [MainThread]: checksum: ec53e341a936509427e16df1c646386a84befec52c1957e3f4359fbc36fc93f5, vars: {}, profile: , target: , version: 1.8.8
[0m02:59:48.706219 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m02:59:48.707219 [debug] [MainThread]: Partial parsing: updated file: task_4://models\calculate_comissions.sql
[0m02:59:48.897291 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '11c5590e-b415-4722-acb5-6d5177b0acec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025846B2D270>]}
[0m02:59:48.977954 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '11c5590e-b415-4722-acb5-6d5177b0acec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002584699E980>]}
[0m02:59:48.979985 [info ] [MainThread]: Found 1 model, 423 macros
[0m02:59:48.979985 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '11c5590e-b415-4722-acb5-6d5177b0acec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002584699E9B0>]}
[0m02:59:48.981994 [info ] [MainThread]: 
[0m02:59:48.982993 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m02:59:48.983991 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_engineering_test'
[0m02:59:49.067796 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test"
[0m02:59:49.067796 [debug] [ThreadPool]: On list_data_engineering_test: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "list_data_engineering_test"} */

    select distinct nspname from pg_namespace
  
[0m02:59:49.069302 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m02:59:49.088035 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.019 seconds
[0m02:59:49.089542 [debug] [ThreadPool]: On list_data_engineering_test: Close
[0m02:59:49.091063 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_engineering_test_public'
[0m02:59:49.097062 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test_public"
[0m02:59:49.097062 [debug] [ThreadPool]: On list_data_engineering_test_public: BEGIN
[0m02:59:49.098063 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m02:59:49.113048 [debug] [ThreadPool]: SQL status: BEGIN in 0.016 seconds
[0m02:59:49.114048 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test_public"
[0m02:59:49.115048 [debug] [ThreadPool]: On list_data_engineering_test_public: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "list_data_engineering_test_public"} */
select
      'data_engineering_test' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_engineering_test' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_engineering_test' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m02:59:49.118047 [debug] [ThreadPool]: SQL status: SELECT 2 in 0.003 seconds
[0m02:59:49.120383 [debug] [ThreadPool]: On list_data_engineering_test_public: ROLLBACK
[0m02:59:49.121517 [debug] [ThreadPool]: On list_data_engineering_test_public: Close
[0m02:59:49.125522 [debug] [MainThread]: Using postgres connection "master"
[0m02:59:49.126522 [debug] [MainThread]: On master: BEGIN
[0m02:59:49.126522 [debug] [MainThread]: Opening a new connection, currently in state init
[0m02:59:49.156215 [debug] [MainThread]: SQL status: BEGIN in 0.030 seconds
[0m02:59:49.157217 [debug] [MainThread]: Using postgres connection "master"
[0m02:59:49.157217 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m02:59:49.164732 [debug] [MainThread]: SQL status: SELECT 0 in 0.007 seconds
[0m02:59:49.165744 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '11c5590e-b415-4722-acb5-6d5177b0acec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000258469871C0>]}
[0m02:59:49.166744 [debug] [MainThread]: On master: ROLLBACK
[0m02:59:49.167742 [debug] [MainThread]: Using postgres connection "master"
[0m02:59:49.167742 [debug] [MainThread]: On master: BEGIN
[0m02:59:49.170258 [debug] [MainThread]: SQL status: BEGIN in 0.001 seconds
[0m02:59:49.170258 [debug] [MainThread]: On master: COMMIT
[0m02:59:49.171364 [debug] [MainThread]: Using postgres connection "master"
[0m02:59:49.171879 [debug] [MainThread]: On master: COMMIT
[0m02:59:49.172889 [debug] [MainThread]: SQL status: COMMIT in 0.001 seconds
[0m02:59:49.172889 [debug] [MainThread]: On master: Close
[0m02:59:49.173893 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m02:59:49.173893 [info ] [MainThread]: 
[0m02:59:49.176889 [debug] [Thread-1 (]: Began running node model.task_4.calculate_comissions
[0m02:59:49.177888 [info ] [Thread-1 (]: 1 of 1 START sql view model public.calculate_comissions ........................ [RUN]
[0m02:59:49.177888 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.task_4.calculate_comissions'
[0m02:59:49.179398 [debug] [Thread-1 (]: Began compiling node model.task_4.calculate_comissions
[0m02:59:49.185929 [debug] [Thread-1 (]: Writing injected SQL for node "model.task_4.calculate_comissions"
[0m02:59:49.186929 [debug] [Thread-1 (]: Began executing node model.task_4.calculate_comissions
[0m02:59:49.271373 [debug] [Thread-1 (]: Writing runtime sql for node "model.task_4.calculate_comissions"
[0m02:59:49.272374 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m02:59:49.273370 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: BEGIN
[0m02:59:49.273370 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m02:59:49.288542 [debug] [Thread-1 (]: SQL status: BEGIN in 0.014 seconds
[0m02:59:49.288542 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m02:59:49.289541 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */

  create view "data_engineering_test"."public"."calculate_comissions__dbt_tmp"
    
    
  as (
    WITH salesowners AS (
    SELECT
        o.order_id,
        unnest(string_to_array(o.salesowners, ', ')) AS salesowner,
        -- We convert the Gross value to Euros
        i.grossValue / 100.0 AS gross_value_in_euros,  
        
        -- Now we take the vat from the gross value in eruos to get the net value in euros.
        (gross_value_in_euros * i.vat)/100 AS net_value_in_euros
    FROM
        public.orders o
    JOIN
        public.invoicing_data i ON o.order_id = i.orderId
),
commission_calc AS (
    SELECT
        order_id,
        salesowner,
        CASE 
            WHEN row_number() OVER (PARTITION BY order_id ORDER BY salesowner) = 1 THEN net_value_in_euros * 0.06  -- Main Owner - 6%
            WHEN row_number() OVER (PARTITION BY order_id ORDER BY salesowner) = 2 THEN net_value_in_euros * 0.025  -- Co-owner 1 - 2.5%
            WHEN row_number() OVER (PARTITION BY order_id ORDER BY salesowner) = 3 THEN net_value_in_euros * 0.0095  -- Co-owner 2 - 0.95%
            ELSE 0  -- No commission for others
        END AS commission
    FROM salesowners
)
SELECT
    salesowner,
    SUM(commission) AS total_commission
FROM commission_calc
GROUP BY salesowner;
  );
[0m02:59:49.291063 [debug] [Thread-1 (]: Postgres adapter: Postgres error: syntax error at or near ";"
LINE 37: GROUP BY salesowner;
                            ^

[0m02:59:49.292061 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: ROLLBACK
[0m02:59:49.293061 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: Close
[0m02:59:49.297060 [debug] [Thread-1 (]: Database Error in model calculate_comissions (models\calculate_comissions.sql)
  syntax error at or near ";"
  LINE 37: GROUP BY salesowner;
                              ^
  compiled code at target\run\task_4\models\calculate_comissions.sql
[0m02:59:49.299057 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '11c5590e-b415-4722-acb5-6d5177b0acec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025846A36CE0>]}
[0m02:59:49.299565 [error] [Thread-1 (]: 1 of 1 ERROR creating sql view model public.calculate_comissions ............... [[31mERROR[0m in 0.12s]
[0m02:59:49.300068 [debug] [Thread-1 (]: Finished running node model.task_4.calculate_comissions
[0m02:59:49.302265 [debug] [MainThread]: Using postgres connection "master"
[0m02:59:49.302265 [debug] [MainThread]: On master: BEGIN
[0m02:59:49.303268 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m02:59:49.317098 [debug] [MainThread]: SQL status: BEGIN in 0.014 seconds
[0m02:59:49.318094 [debug] [MainThread]: On master: COMMIT
[0m02:59:49.318094 [debug] [MainThread]: Using postgres connection "master"
[0m02:59:49.319100 [debug] [MainThread]: On master: COMMIT
[0m02:59:49.320149 [debug] [MainThread]: SQL status: COMMIT in 0.001 seconds
[0m02:59:49.321159 [debug] [MainThread]: On master: Close
[0m02:59:49.322161 [debug] [MainThread]: Connection 'master' was properly closed.
[0m02:59:49.322161 [debug] [MainThread]: Connection 'list_data_engineering_test' was properly closed.
[0m02:59:49.323159 [debug] [MainThread]: Connection 'list_data_engineering_test_public' was properly closed.
[0m02:59:49.323159 [debug] [MainThread]: Connection 'model.task_4.calculate_comissions' was properly closed.
[0m02:59:49.323159 [info ] [MainThread]: 
[0m02:59:49.324157 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 0.34 seconds (0.34s).
[0m02:59:49.325157 [debug] [MainThread]: Command end result
[0m02:59:49.351333 [info ] [MainThread]: 
[0m02:59:49.352342 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m02:59:49.353347 [info ] [MainThread]: 
[0m02:59:49.354343 [error] [MainThread]:   Database Error in model calculate_comissions (models\calculate_comissions.sql)
  syntax error at or near ";"
  LINE 37: GROUP BY salesowner;
                              ^
  compiled code at target\run\task_4\models\calculate_comissions.sql
[0m02:59:49.355339 [info ] [MainThread]: 
[0m02:59:49.355339 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m02:59:49.357342 [debug] [MainThread]: Command `dbt run` failed at 02:59:49.357342 after 1.11 seconds
[0m02:59:49.357342 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025843A58E80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000258469E80A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000258469E8070>]}
[0m02:59:49.358342 [debug] [MainThread]: Flushing usage events
[0m03:01:02.262963 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000233F1804EB0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000233F4333280>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000233F4331C60>]}


============================== 03:01:02.266476 | d4e38b0e-7d0f-48a6-aef6-4bb6e1e3e67d ==============================
[0m03:01:02.266476 [info ] [MainThread]: Running with dbt=1.8.8
[0m03:01:02.267481 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'src\\task_4\\dbt\\logs', 'version_check': 'True', 'profiles_dir': 'src/task_4/dbt', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --profiles-dir src/task_4/dbt --project-dir src/task_4/dbt', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m03:01:02.456904 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'd4e38b0e-7d0f-48a6-aef6-4bb6e1e3e67d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000233F44F2770>]}
[0m03:01:02.506388 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'd4e38b0e-7d0f-48a6-aef6-4bb6e1e3e67d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000233F1346AA0>]}
[0m03:01:02.507393 [info ] [MainThread]: Registered adapter: postgres=1.8.2
[0m03:01:02.516421 [debug] [MainThread]: checksum: ec53e341a936509427e16df1c646386a84befec52c1957e3f4359fbc36fc93f5, vars: {}, profile: , target: , version: 1.8.8
[0m03:01:02.675121 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m03:01:02.676130 [debug] [MainThread]: Partial parsing: updated file: task_4://models\calculate_comissions.sql
[0m03:01:02.867877 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'd4e38b0e-7d0f-48a6-aef6-4bb6e1e3e67d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000233F48ED2A0>]}
[0m03:01:02.952323 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'd4e38b0e-7d0f-48a6-aef6-4bb6e1e3e67d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000233F4762A10>]}
[0m03:01:02.952323 [info ] [MainThread]: Found 1 model, 423 macros
[0m03:01:02.953828 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd4e38b0e-7d0f-48a6-aef6-4bb6e1e3e67d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000233F47631F0>]}
[0m03:01:02.954834 [info ] [MainThread]: 
[0m03:01:02.955880 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m03:01:02.957879 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_engineering_test'
[0m03:01:03.041774 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test"
[0m03:01:03.041774 [debug] [ThreadPool]: On list_data_engineering_test: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "list_data_engineering_test"} */

    select distinct nspname from pg_namespace
  
[0m03:01:03.042774 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m03:01:03.063817 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.021 seconds
[0m03:01:03.065849 [debug] [ThreadPool]: On list_data_engineering_test: Close
[0m03:01:03.066998 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_engineering_test_public'
[0m03:01:03.072999 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test_public"
[0m03:01:03.072999 [debug] [ThreadPool]: On list_data_engineering_test_public: BEGIN
[0m03:01:03.074000 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m03:01:03.087912 [debug] [ThreadPool]: SQL status: BEGIN in 0.014 seconds
[0m03:01:03.088908 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test_public"
[0m03:01:03.088908 [debug] [ThreadPool]: On list_data_engineering_test_public: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "list_data_engineering_test_public"} */
select
      'data_engineering_test' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_engineering_test' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_engineering_test' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m03:01:03.092909 [debug] [ThreadPool]: SQL status: SELECT 2 in 0.003 seconds
[0m03:01:03.094651 [debug] [ThreadPool]: On list_data_engineering_test_public: ROLLBACK
[0m03:01:03.095658 [debug] [ThreadPool]: On list_data_engineering_test_public: Close
[0m03:01:03.100658 [debug] [MainThread]: Using postgres connection "master"
[0m03:01:03.100658 [debug] [MainThread]: On master: BEGIN
[0m03:01:03.101658 [debug] [MainThread]: Opening a new connection, currently in state init
[0m03:01:03.118549 [debug] [MainThread]: SQL status: BEGIN in 0.017 seconds
[0m03:01:03.118549 [debug] [MainThread]: Using postgres connection "master"
[0m03:01:03.119547 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m03:01:03.129578 [debug] [MainThread]: SQL status: SELECT 0 in 0.010 seconds
[0m03:01:03.130577 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd4e38b0e-7d0f-48a6-aef6-4bb6e1e3e67d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000233F48E2260>]}
[0m03:01:03.131578 [debug] [MainThread]: On master: ROLLBACK
[0m03:01:03.132576 [debug] [MainThread]: Using postgres connection "master"
[0m03:01:03.133578 [debug] [MainThread]: On master: BEGIN
[0m03:01:03.135631 [debug] [MainThread]: SQL status: BEGIN in 0.001 seconds
[0m03:01:03.135770 [debug] [MainThread]: On master: COMMIT
[0m03:01:03.135770 [debug] [MainThread]: Using postgres connection "master"
[0m03:01:03.136627 [debug] [MainThread]: On master: COMMIT
[0m03:01:03.137629 [debug] [MainThread]: SQL status: COMMIT in 0.001 seconds
[0m03:01:03.138628 [debug] [MainThread]: On master: Close
[0m03:01:03.138628 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m03:01:03.139631 [info ] [MainThread]: 
[0m03:01:03.142628 [debug] [Thread-1 (]: Began running node model.task_4.calculate_comissions
[0m03:01:03.143633 [info ] [Thread-1 (]: 1 of 1 START sql view model public.calculate_comissions ........................ [RUN]
[0m03:01:03.144146 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.task_4.calculate_comissions'
[0m03:01:03.144653 [debug] [Thread-1 (]: Began compiling node model.task_4.calculate_comissions
[0m03:01:03.150662 [debug] [Thread-1 (]: Writing injected SQL for node "model.task_4.calculate_comissions"
[0m03:01:03.151664 [debug] [Thread-1 (]: Began executing node model.task_4.calculate_comissions
[0m03:01:03.239311 [debug] [Thread-1 (]: Writing runtime sql for node "model.task_4.calculate_comissions"
[0m03:01:03.241312 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m03:01:03.241312 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: BEGIN
[0m03:01:03.242312 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m03:01:03.277629 [debug] [Thread-1 (]: SQL status: BEGIN in 0.036 seconds
[0m03:01:03.278629 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m03:01:03.279631 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */

  create view "data_engineering_test"."public"."calculate_comissions__dbt_tmp"
    
    
  as (
    WITH salesowners AS (
    SELECT
        o.order_id,
        unnest(string_to_array(o.salesowners, ', ')) AS salesowner,
        -- We convert the Gross value to Euros
        i.grossValue / 100.0 AS gross_value_in_euros,  
        
        -- Now we take the vat from the gross value in eruos to get the net value in euros.
        (gross_value_in_euros * i.vat)/100 AS net_value_in_euros
    FROM
        public.orders o
    JOIN
        public.invoicing_data i ON o.order_id = i.orderId
),
commission_calc AS (
    SELECT
        order_id,
        salesowner,
        CASE 
            WHEN row_number() OVER (PARTITION BY order_id ORDER BY salesowner) = 1 THEN net_value_in_euros * 0.06  -- Main Owner - 6%
            WHEN row_number() OVER (PARTITION BY order_id ORDER BY salesowner) = 2 THEN net_value_in_euros * 0.025  -- Co-owner 1 - 2.5%
            WHEN row_number() OVER (PARTITION BY order_id ORDER BY salesowner) = 3 THEN net_value_in_euros * 0.0095  -- Co-owner 2 - 0.95%
            ELSE 0  -- No commission for others
        END AS commission
    FROM salesowners
)
SELECT
    salesowner,
    SUM(commission) AS total_commission
FROM commission_calc
GROUP BY salesowner
ORDER BY total_commission DESC
  );
[0m03:01:03.285727 [debug] [Thread-1 (]: Postgres adapter: Postgres error: column i.orderid does not exist
LINE 19:         public.invoicing_data i ON o.order_id = i.orderId
                                                         ^
HINT:  Perhaps you meant to reference the column "i.order_id".

[0m03:01:03.286723 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: ROLLBACK
[0m03:01:03.287720 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: Close
[0m03:01:03.291718 [debug] [Thread-1 (]: Database Error in model calculate_comissions (models\calculate_comissions.sql)
  column i.orderid does not exist
  LINE 19:         public.invoicing_data i ON o.order_id = i.orderId
                                                           ^
  HINT:  Perhaps you meant to reference the column "i.order_id".
  compiled code at target\run\task_4\models\calculate_comissions.sql
[0m03:01:03.292723 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd4e38b0e-7d0f-48a6-aef6-4bb6e1e3e67d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000233F48C21A0>]}
[0m03:01:03.293723 [error] [Thread-1 (]: 1 of 1 ERROR creating sql view model public.calculate_comissions ............... [[31mERROR[0m in 0.15s]
[0m03:01:03.294659 [debug] [Thread-1 (]: Finished running node model.task_4.calculate_comissions
[0m03:01:03.295895 [debug] [MainThread]: Using postgres connection "master"
[0m03:01:03.296902 [debug] [MainThread]: On master: BEGIN
[0m03:01:03.296902 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m03:01:03.310957 [debug] [MainThread]: SQL status: BEGIN in 0.013 seconds
[0m03:01:03.311958 [debug] [MainThread]: On master: COMMIT
[0m03:01:03.311958 [debug] [MainThread]: Using postgres connection "master"
[0m03:01:03.311958 [debug] [MainThread]: On master: COMMIT
[0m03:01:03.313974 [debug] [MainThread]: SQL status: COMMIT in 0.001 seconds
[0m03:01:03.314505 [debug] [MainThread]: On master: Close
[0m03:01:03.315513 [debug] [MainThread]: Connection 'master' was properly closed.
[0m03:01:03.315890 [debug] [MainThread]: Connection 'list_data_engineering_test' was properly closed.
[0m03:01:03.316514 [debug] [MainThread]: Connection 'list_data_engineering_test_public' was properly closed.
[0m03:01:03.316514 [debug] [MainThread]: Connection 'model.task_4.calculate_comissions' was properly closed.
[0m03:01:03.317513 [info ] [MainThread]: 
[0m03:01:03.318512 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 0.36 seconds (0.36s).
[0m03:01:03.319513 [debug] [MainThread]: Command end result
[0m03:01:03.349605 [info ] [MainThread]: 
[0m03:01:03.350605 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m03:01:03.351603 [info ] [MainThread]: 
[0m03:01:03.352602 [error] [MainThread]:   Database Error in model calculate_comissions (models\calculate_comissions.sql)
  column i.orderid does not exist
  LINE 19:         public.invoicing_data i ON o.order_id = i.orderId
                                                           ^
  HINT:  Perhaps you meant to reference the column "i.order_id".
  compiled code at target\run\task_4\models\calculate_comissions.sql
[0m03:01:03.353603 [info ] [MainThread]: 
[0m03:01:03.353603 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m03:01:03.354825 [debug] [MainThread]: Command `dbt run` failed at 03:01:03.354825 after 1.16 seconds
[0m03:01:03.355832 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000233F1804EB0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000233F45D9060>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000233F47A80D0>]}
[0m03:01:03.355832 [debug] [MainThread]: Flushing usage events
[0m03:01:17.531515 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000134E4490E50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000134E6FB1D50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000134E6FB3DC0>]}


============================== 03:01:17.534537 | 096b42c7-eb09-4f34-bbf1-a9a457e4ca9e ==============================
[0m03:01:17.534537 [info ] [MainThread]: Running with dbt=1.8.8
[0m03:01:17.535543 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'debug': 'False', 'log_path': 'src\\task_4\\dbt\\logs', 'fail_fast': 'False', 'profiles_dir': 'src/task_4/dbt', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'log_format': 'default', 'introspect': 'True', 'invocation_command': 'dbt run --profiles-dir src/task_4/dbt --project-dir src/task_4/dbt', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m03:01:17.721626 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '096b42c7-eb09-4f34-bbf1-a9a457e4ca9e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000134E7172590>]}
[0m03:01:17.770716 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '096b42c7-eb09-4f34-bbf1-a9a457e4ca9e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000134E3FC6A70>]}
[0m03:01:17.772718 [info ] [MainThread]: Registered adapter: postgres=1.8.2
[0m03:01:17.781731 [debug] [MainThread]: checksum: ec53e341a936509427e16df1c646386a84befec52c1957e3f4359fbc36fc93f5, vars: {}, profile: , target: , version: 1.8.8
[0m03:01:17.929723 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m03:01:17.930722 [debug] [MainThread]: Partial parsing: updated file: task_4://models\calculate_comissions.sql
[0m03:01:18.122677 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '096b42c7-eb09-4f34-bbf1-a9a457e4ca9e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000134E7571240>]}
[0m03:01:18.204772 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '096b42c7-eb09-4f34-bbf1-a9a457e4ca9e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000134E73DE980>]}
[0m03:01:18.206018 [info ] [MainThread]: Found 1 model, 423 macros
[0m03:01:18.206916 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '096b42c7-eb09-4f34-bbf1-a9a457e4ca9e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000134E73DE920>]}
[0m03:01:18.207916 [info ] [MainThread]: 
[0m03:01:18.208918 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m03:01:18.209917 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_engineering_test'
[0m03:01:18.292925 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test"
[0m03:01:18.293925 [debug] [ThreadPool]: On list_data_engineering_test: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "list_data_engineering_test"} */

    select distinct nspname from pg_namespace
  
[0m03:01:18.294430 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m03:01:18.311654 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.018 seconds
[0m03:01:18.313654 [debug] [ThreadPool]: On list_data_engineering_test: Close
[0m03:01:18.314669 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_engineering_test_public'
[0m03:01:18.320769 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test_public"
[0m03:01:18.321770 [debug] [ThreadPool]: On list_data_engineering_test_public: BEGIN
[0m03:01:18.321770 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m03:01:18.336943 [debug] [ThreadPool]: SQL status: BEGIN in 0.015 seconds
[0m03:01:18.336943 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test_public"
[0m03:01:18.337944 [debug] [ThreadPool]: On list_data_engineering_test_public: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "list_data_engineering_test_public"} */
select
      'data_engineering_test' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_engineering_test' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_engineering_test' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m03:01:18.340941 [debug] [ThreadPool]: SQL status: SELECT 2 in 0.003 seconds
[0m03:01:18.342940 [debug] [ThreadPool]: On list_data_engineering_test_public: ROLLBACK
[0m03:01:18.343945 [debug] [ThreadPool]: On list_data_engineering_test_public: Close
[0m03:01:18.348646 [debug] [MainThread]: Using postgres connection "master"
[0m03:01:18.348646 [debug] [MainThread]: On master: BEGIN
[0m03:01:18.349646 [debug] [MainThread]: Opening a new connection, currently in state init
[0m03:01:18.363740 [debug] [MainThread]: SQL status: BEGIN in 0.014 seconds
[0m03:01:18.363740 [debug] [MainThread]: Using postgres connection "master"
[0m03:01:18.364807 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m03:01:18.380223 [debug] [MainThread]: SQL status: SELECT 0 in 0.014 seconds
[0m03:01:18.381221 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '096b42c7-eb09-4f34-bbf1-a9a457e4ca9e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000134E73C71F0>]}
[0m03:01:18.382222 [debug] [MainThread]: On master: ROLLBACK
[0m03:01:18.382222 [debug] [MainThread]: Using postgres connection "master"
[0m03:01:18.383728 [debug] [MainThread]: On master: BEGIN
[0m03:01:18.385781 [debug] [MainThread]: SQL status: BEGIN in 0.001 seconds
[0m03:01:18.386315 [debug] [MainThread]: On master: COMMIT
[0m03:01:18.386315 [debug] [MainThread]: Using postgres connection "master"
[0m03:01:18.386315 [debug] [MainThread]: On master: COMMIT
[0m03:01:18.388322 [debug] [MainThread]: SQL status: COMMIT in 0.001 seconds
[0m03:01:18.388322 [debug] [MainThread]: On master: Close
[0m03:01:18.389323 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m03:01:18.389323 [info ] [MainThread]: 
[0m03:01:18.392321 [debug] [Thread-1 (]: Began running node model.task_4.calculate_comissions
[0m03:01:18.393826 [info ] [Thread-1 (]: 1 of 1 START sql view model public.calculate_comissions ........................ [RUN]
[0m03:01:18.393826 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.task_4.calculate_comissions'
[0m03:01:18.394833 [debug] [Thread-1 (]: Began compiling node model.task_4.calculate_comissions
[0m03:01:18.401350 [debug] [Thread-1 (]: Writing injected SQL for node "model.task_4.calculate_comissions"
[0m03:01:18.402349 [debug] [Thread-1 (]: Began executing node model.task_4.calculate_comissions
[0m03:01:18.488496 [debug] [Thread-1 (]: Writing runtime sql for node "model.task_4.calculate_comissions"
[0m03:01:18.489498 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m03:01:18.490498 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: BEGIN
[0m03:01:18.491497 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m03:01:18.505683 [debug] [Thread-1 (]: SQL status: BEGIN in 0.015 seconds
[0m03:01:18.506609 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m03:01:18.506609 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */

  create view "data_engineering_test"."public"."calculate_comissions__dbt_tmp"
    
    
  as (
    WITH salesowners AS (
    SELECT
        o.order_id,
        unnest(string_to_array(o.salesowners, ', ')) AS salesowner,
        -- We convert the Gross value to Euros
        i.grossValue / 100.0 AS gross_value_in_euros,  
        
        -- Now we take the vat from the gross value in eruos to get the net value in euros.
        (gross_value_in_euros * i.vat)/100 AS net_value_in_euros
    FROM
        public.orders o
    JOIN
        public.invoicing_data i ON o.order_id = i.order_id
),
commission_calc AS (
    SELECT
        order_id,
        salesowner,
        CASE 
            WHEN row_number() OVER (PARTITION BY order_id ORDER BY salesowner) = 1 THEN net_value_in_euros * 0.06  -- Main Owner - 6%
            WHEN row_number() OVER (PARTITION BY order_id ORDER BY salesowner) = 2 THEN net_value_in_euros * 0.025  -- Co-owner 1 - 2.5%
            WHEN row_number() OVER (PARTITION BY order_id ORDER BY salesowner) = 3 THEN net_value_in_euros * 0.0095  -- Co-owner 2 - 0.95%
            ELSE 0  -- No commission for others
        END AS commission
    FROM salesowners
)
SELECT
    salesowner,
    SUM(commission) AS total_commission
FROM commission_calc
GROUP BY salesowner
ORDER BY total_commission DESC
  );
[0m03:01:18.514777 [debug] [Thread-1 (]: Postgres adapter: Postgres error: column i.grossvalue does not exist
LINE 12:         i.grossValue / 100.0 AS gross_value_in_euros,  
                 ^
HINT:  Perhaps you meant to reference the column "i.gross_value".

[0m03:01:18.515786 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: ROLLBACK
[0m03:01:18.516786 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: Close
[0m03:01:18.520784 [debug] [Thread-1 (]: Database Error in model calculate_comissions (models\calculate_comissions.sql)
  column i.grossvalue does not exist
  LINE 12:         i.grossValue / 100.0 AS gross_value_in_euros,  
                   ^
  HINT:  Perhaps you meant to reference the column "i.gross_value".
  compiled code at target\run\task_4\models\calculate_comissions.sql
[0m03:01:18.521784 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '096b42c7-eb09-4f34-bbf1-a9a457e4ca9e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000134E75600A0>]}
[0m03:01:18.522784 [error] [Thread-1 (]: 1 of 1 ERROR creating sql view model public.calculate_comissions ............... [[31mERROR[0m in 0.13s]
[0m03:01:18.523783 [debug] [Thread-1 (]: Finished running node model.task_4.calculate_comissions
[0m03:01:18.526039 [debug] [MainThread]: Using postgres connection "master"
[0m03:01:18.526039 [debug] [MainThread]: On master: BEGIN
[0m03:01:18.526039 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m03:01:18.541561 [debug] [MainThread]: SQL status: BEGIN in 0.015 seconds
[0m03:01:18.542560 [debug] [MainThread]: On master: COMMIT
[0m03:01:18.542560 [debug] [MainThread]: Using postgres connection "master"
[0m03:01:18.542560 [debug] [MainThread]: On master: COMMIT
[0m03:01:18.544586 [debug] [MainThread]: SQL status: COMMIT in 0.001 seconds
[0m03:01:18.544586 [debug] [MainThread]: On master: Close
[0m03:01:18.545679 [debug] [MainThread]: Connection 'master' was properly closed.
[0m03:01:18.545679 [debug] [MainThread]: Connection 'list_data_engineering_test' was properly closed.
[0m03:01:18.546592 [debug] [MainThread]: Connection 'list_data_engineering_test_public' was properly closed.
[0m03:01:18.546592 [debug] [MainThread]: Connection 'model.task_4.calculate_comissions' was properly closed.
[0m03:01:18.546592 [info ] [MainThread]: 
[0m03:01:18.547592 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 0.34 seconds (0.34s).
[0m03:01:18.548594 [debug] [MainThread]: Command end result
[0m03:01:18.574645 [info ] [MainThread]: 
[0m03:01:18.575654 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m03:01:18.575813 [info ] [MainThread]: 
[0m03:01:18.576655 [error] [MainThread]:   Database Error in model calculate_comissions (models\calculate_comissions.sql)
  column i.grossvalue does not exist
  LINE 12:         i.grossValue / 100.0 AS gross_value_in_euros,  
                   ^
  HINT:  Perhaps you meant to reference the column "i.gross_value".
  compiled code at target\run\task_4\models\calculate_comissions.sql
[0m03:01:18.577653 [info ] [MainThread]: 
[0m03:01:18.577653 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m03:01:18.579652 [debug] [MainThread]: Command `dbt run` failed at 03:01:18.579652 after 1.11 seconds
[0m03:01:18.579652 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000134E4490E50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000134E725D030>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000134E7428070>]}
[0m03:01:18.580653 [debug] [MainThread]: Flushing usage events
[0m03:01:44.291745 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000226C61F0E80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000226C8D125F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000226C8D120E0>]}


============================== 03:01:44.295625 | e5135cf6-dc70-47a4-bc1b-ea8e4c8d3d59 ==============================
[0m03:01:44.295625 [info ] [MainThread]: Running with dbt=1.8.8
[0m03:01:44.296624 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'src/task_4/dbt', 'fail_fast': 'False', 'warn_error': 'None', 'log_path': 'src\\task_4\\dbt\\logs', 'version_check': 'True', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'log_format': 'default', 'static_parser': 'True', 'invocation_command': 'dbt run --profiles-dir src/task_4/dbt --project-dir src/task_4/dbt', 'introspect': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m03:01:44.484309 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'e5135cf6-dc70-47a4-bc1b-ea8e4c8d3d59', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000226C8ED2740>]}
[0m03:01:44.533688 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'e5135cf6-dc70-47a4-bc1b-ea8e4c8d3d59', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000226C5D32AA0>]}
[0m03:01:44.534699 [info ] [MainThread]: Registered adapter: postgres=1.8.2
[0m03:01:44.543838 [debug] [MainThread]: checksum: ec53e341a936509427e16df1c646386a84befec52c1957e3f4359fbc36fc93f5, vars: {}, profile: , target: , version: 1.8.8
[0m03:01:44.691638 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m03:01:44.692638 [debug] [MainThread]: Partial parsing: updated file: task_4://models\calculate_comissions.sql
[0m03:01:44.888690 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'e5135cf6-dc70-47a4-bc1b-ea8e4c8d3d59', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000226C92D1270>]}
[0m03:01:44.975700 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'e5135cf6-dc70-47a4-bc1b-ea8e4c8d3d59', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000226C913E980>]}
[0m03:01:44.976706 [info ] [MainThread]: Found 1 model, 423 macros
[0m03:01:44.977708 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e5135cf6-dc70-47a4-bc1b-ea8e4c8d3d59', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000226C913E9B0>]}
[0m03:01:44.978706 [info ] [MainThread]: 
[0m03:01:44.979706 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m03:01:44.981707 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_engineering_test'
[0m03:01:45.067324 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test"
[0m03:01:45.067324 [debug] [ThreadPool]: On list_data_engineering_test: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "list_data_engineering_test"} */

    select distinct nspname from pg_namespace
  
[0m03:01:45.068328 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m03:01:45.087545 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.019 seconds
[0m03:01:45.089541 [debug] [ThreadPool]: On list_data_engineering_test: Close
[0m03:01:45.090545 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_engineering_test_public'
[0m03:01:45.096573 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test_public"
[0m03:01:45.096573 [debug] [ThreadPool]: On list_data_engineering_test_public: BEGIN
[0m03:01:45.096573 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m03:01:45.111929 [debug] [ThreadPool]: SQL status: BEGIN in 0.014 seconds
[0m03:01:45.111929 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test_public"
[0m03:01:45.112926 [debug] [ThreadPool]: On list_data_engineering_test_public: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "list_data_engineering_test_public"} */
select
      'data_engineering_test' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_engineering_test' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_engineering_test' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m03:01:45.115665 [debug] [ThreadPool]: SQL status: SELECT 2 in 0.003 seconds
[0m03:01:45.117280 [debug] [ThreadPool]: On list_data_engineering_test_public: ROLLBACK
[0m03:01:45.118288 [debug] [ThreadPool]: On list_data_engineering_test_public: Close
[0m03:01:45.122288 [debug] [MainThread]: Using postgres connection "master"
[0m03:01:45.123793 [debug] [MainThread]: On master: BEGIN
[0m03:01:45.123793 [debug] [MainThread]: Opening a new connection, currently in state init
[0m03:01:45.151074 [debug] [MainThread]: SQL status: BEGIN in 0.027 seconds
[0m03:01:45.152072 [debug] [MainThread]: Using postgres connection "master"
[0m03:01:45.152072 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m03:01:45.164114 [debug] [MainThread]: SQL status: SELECT 0 in 0.011 seconds
[0m03:01:45.165630 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e5135cf6-dc70-47a4-bc1b-ea8e4c8d3d59', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000226C91271C0>]}
[0m03:01:45.165630 [debug] [MainThread]: On master: ROLLBACK
[0m03:01:45.167628 [debug] [MainThread]: Using postgres connection "master"
[0m03:01:45.167628 [debug] [MainThread]: On master: BEGIN
[0m03:01:45.169632 [debug] [MainThread]: SQL status: BEGIN in 0.002 seconds
[0m03:01:45.170630 [debug] [MainThread]: On master: COMMIT
[0m03:01:45.170630 [debug] [MainThread]: Using postgres connection "master"
[0m03:01:45.170630 [debug] [MainThread]: On master: COMMIT
[0m03:01:45.171631 [debug] [MainThread]: SQL status: COMMIT in 0.001 seconds
[0m03:01:45.172629 [debug] [MainThread]: On master: Close
[0m03:01:45.173629 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m03:01:45.173629 [info ] [MainThread]: 
[0m03:01:45.176697 [debug] [Thread-1 (]: Began running node model.task_4.calculate_comissions
[0m03:01:45.177701 [info ] [Thread-1 (]: 1 of 1 START sql view model public.calculate_comissions ........................ [RUN]
[0m03:01:45.178700 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.task_4.calculate_comissions'
[0m03:01:45.178700 [debug] [Thread-1 (]: Began compiling node model.task_4.calculate_comissions
[0m03:01:45.186046 [debug] [Thread-1 (]: Writing injected SQL for node "model.task_4.calculate_comissions"
[0m03:01:45.187725 [debug] [Thread-1 (]: Began executing node model.task_4.calculate_comissions
[0m03:01:45.272808 [debug] [Thread-1 (]: Writing runtime sql for node "model.task_4.calculate_comissions"
[0m03:01:45.274758 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m03:01:45.274758 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: BEGIN
[0m03:01:45.275918 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m03:01:45.301048 [debug] [Thread-1 (]: SQL status: BEGIN in 0.025 seconds
[0m03:01:45.301048 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m03:01:45.302048 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */

  create view "data_engineering_test"."public"."calculate_comissions__dbt_tmp"
    
    
  as (
    WITH salesowners AS (
    SELECT
        o.order_id,
        unnest(string_to_array(o.salesowners, ', ')) AS salesowner,
        -- We convert the Gross value to Euros
        i.gross_value / 100.0 AS gross_value_in_euros,  
        
        -- Now we take the vat from the gross value in eruos to get the net value in euros.
        (gross_value_in_euros * i.vat)/100 AS net_value_in_euros
    FROM
        public.orders o
    JOIN
        public.invoicing_data i ON o.order_id = i.order_id
),
commission_calc AS (
    SELECT
        order_id,
        salesowner,
        CASE 
            WHEN row_number() OVER (PARTITION BY order_id ORDER BY salesowner) = 1 THEN net_value_in_euros * 0.06  -- Main Owner - 6%
            WHEN row_number() OVER (PARTITION BY order_id ORDER BY salesowner) = 2 THEN net_value_in_euros * 0.025  -- Co-owner 1 - 2.5%
            WHEN row_number() OVER (PARTITION BY order_id ORDER BY salesowner) = 3 THEN net_value_in_euros * 0.0095  -- Co-owner 2 - 0.95%
            ELSE 0  -- No commission for others
        END AS commission
    FROM salesowners
)
SELECT
    salesowner,
    SUM(commission) AS total_commission
FROM commission_calc
GROUP BY salesowner
ORDER BY total_commission DESC
  );
[0m03:01:45.309050 [debug] [Thread-1 (]: Postgres adapter: Postgres error: column "gross_value_in_euros" does not exist
LINE 15:         (gross_value_in_euros * i.vat)/100 AS net_value_in_e...
                  ^

[0m03:01:45.309050 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: ROLLBACK
[0m03:01:45.310051 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: Close
[0m03:01:45.314560 [debug] [Thread-1 (]: Database Error in model calculate_comissions (models\calculate_comissions.sql)
  column "gross_value_in_euros" does not exist
  LINE 15:         (gross_value_in_euros * i.vat)/100 AS net_value_in_e...
                    ^
  compiled code at target\run\task_4\models\calculate_comissions.sql
[0m03:01:45.316024 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e5135cf6-dc70-47a4-bc1b-ea8e4c8d3d59', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000226C91D61D0>]}
[0m03:01:45.317024 [error] [Thread-1 (]: 1 of 1 ERROR creating sql view model public.calculate_comissions ............... [[31mERROR[0m in 0.14s]
[0m03:01:45.318026 [debug] [Thread-1 (]: Finished running node model.task_4.calculate_comissions
[0m03:01:45.319023 [debug] [MainThread]: Using postgres connection "master"
[0m03:01:45.320026 [debug] [MainThread]: On master: BEGIN
[0m03:01:45.320026 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m03:01:45.334788 [debug] [MainThread]: SQL status: BEGIN in 0.014 seconds
[0m03:01:45.334788 [debug] [MainThread]: On master: COMMIT
[0m03:01:45.335816 [debug] [MainThread]: Using postgres connection "master"
[0m03:01:45.335816 [debug] [MainThread]: On master: COMMIT
[0m03:01:45.337816 [debug] [MainThread]: SQL status: COMMIT in 0.001 seconds
[0m03:01:45.338815 [debug] [MainThread]: On master: Close
[0m03:01:45.339819 [debug] [MainThread]: Connection 'master' was properly closed.
[0m03:01:45.339819 [debug] [MainThread]: Connection 'list_data_engineering_test' was properly closed.
[0m03:01:45.340821 [debug] [MainThread]: Connection 'list_data_engineering_test_public' was properly closed.
[0m03:01:45.340821 [debug] [MainThread]: Connection 'model.task_4.calculate_comissions' was properly closed.
[0m03:01:45.341821 [info ] [MainThread]: 
[0m03:01:45.342817 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 0.36 seconds (0.36s).
[0m03:01:45.343817 [debug] [MainThread]: Command end result
[0m03:01:45.369705 [info ] [MainThread]: 
[0m03:01:45.370706 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m03:01:45.370706 [info ] [MainThread]: 
[0m03:01:45.371709 [error] [MainThread]:   Database Error in model calculate_comissions (models\calculate_comissions.sql)
  column "gross_value_in_euros" does not exist
  LINE 15:         (gross_value_in_euros * i.vat)/100 AS net_value_in_e...
                    ^
  compiled code at target\run\task_4\models\calculate_comissions.sql
[0m03:01:45.372708 [info ] [MainThread]: 
[0m03:01:45.373707 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m03:01:45.374598 [debug] [MainThread]: Command `dbt run` failed at 03:01:45.374598 after 1.15 seconds
[0m03:01:45.375604 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000226C61F0E80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000226C91880A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000226C9188070>]}
[0m03:01:45.375604 [debug] [MainThread]: Flushing usage events
[0m03:02:59.156957 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002130BA20E80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002130E5525F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002130E5520E0>]}


============================== 03:02:59.159958 | 5d387178-9726-4ad5-a597-3e1c325cbd4b ==============================
[0m03:02:59.159958 [info ] [MainThread]: Running with dbt=1.8.8
[0m03:02:59.160956 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'src/task_4/dbt', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'src\\task_4\\dbt\\logs', 'debug': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'log_format': 'default', 'invocation_command': 'dbt run --profiles-dir src/task_4/dbt --project-dir src/task_4/dbt', 'static_parser': 'True', 'introspect': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m03:02:59.347009 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '5d387178-9726-4ad5-a597-3e1c325cbd4b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002130E712740>]}
[0m03:02:59.395735 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '5d387178-9726-4ad5-a597-3e1c325cbd4b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002130B566AA0>]}
[0m03:02:59.396743 [info ] [MainThread]: Registered adapter: postgres=1.8.2
[0m03:02:59.405777 [debug] [MainThread]: checksum: ec53e341a936509427e16df1c646386a84befec52c1957e3f4359fbc36fc93f5, vars: {}, profile: , target: , version: 1.8.8
[0m03:02:59.560541 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m03:02:59.561541 [debug] [MainThread]: Partial parsing: updated file: task_4://models\calculate_comissions.sql
[0m03:02:59.752058 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '5d387178-9726-4ad5-a597-3e1c325cbd4b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002130EB0D270>]}
[0m03:02:59.832316 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '5d387178-9726-4ad5-a597-3e1c325cbd4b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002130E982980>]}
[0m03:02:59.833829 [info ] [MainThread]: Found 1 model, 423 macros
[0m03:02:59.834835 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '5d387178-9726-4ad5-a597-3e1c325cbd4b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002130E9829B0>]}
[0m03:02:59.836349 [info ] [MainThread]: 
[0m03:02:59.837350 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m03:02:59.838351 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_engineering_test'
[0m03:02:59.924575 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test"
[0m03:02:59.925633 [debug] [ThreadPool]: On list_data_engineering_test: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "list_data_engineering_test"} */

    select distinct nspname from pg_namespace
  
[0m03:02:59.925633 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m03:02:59.945420 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.019 seconds
[0m03:02:59.946460 [debug] [ThreadPool]: On list_data_engineering_test: Close
[0m03:02:59.948031 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_engineering_test_public'
[0m03:02:59.953798 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test_public"
[0m03:02:59.954803 [debug] [ThreadPool]: On list_data_engineering_test_public: BEGIN
[0m03:02:59.955313 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m03:02:59.970369 [debug] [ThreadPool]: SQL status: BEGIN in 0.015 seconds
[0m03:02:59.971370 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test_public"
[0m03:02:59.971370 [debug] [ThreadPool]: On list_data_engineering_test_public: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "list_data_engineering_test_public"} */
select
      'data_engineering_test' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_engineering_test' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_engineering_test' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m03:02:59.974883 [debug] [ThreadPool]: SQL status: SELECT 2 in 0.003 seconds
[0m03:02:59.977014 [debug] [ThreadPool]: On list_data_engineering_test_public: ROLLBACK
[0m03:02:59.978015 [debug] [ThreadPool]: On list_data_engineering_test_public: Close
[0m03:02:59.982530 [debug] [MainThread]: Using postgres connection "master"
[0m03:02:59.982530 [debug] [MainThread]: On master: BEGIN
[0m03:02:59.984039 [debug] [MainThread]: Opening a new connection, currently in state init
[0m03:03:00.012872 [debug] [MainThread]: SQL status: BEGIN in 0.029 seconds
[0m03:03:00.013873 [debug] [MainThread]: Using postgres connection "master"
[0m03:03:00.013873 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m03:03:00.018910 [debug] [MainThread]: SQL status: SELECT 0 in 0.004 seconds
[0m03:03:00.019909 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '5d387178-9726-4ad5-a597-3e1c325cbd4b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002130E9671C0>]}
[0m03:03:00.020908 [debug] [MainThread]: On master: ROLLBACK
[0m03:03:00.021908 [debug] [MainThread]: Using postgres connection "master"
[0m03:03:00.022908 [debug] [MainThread]: On master: BEGIN
[0m03:03:00.024916 [debug] [MainThread]: SQL status: BEGIN in 0.001 seconds
[0m03:03:00.024916 [debug] [MainThread]: On master: COMMIT
[0m03:03:00.025921 [debug] [MainThread]: Using postgres connection "master"
[0m03:03:00.026095 [debug] [MainThread]: On master: COMMIT
[0m03:03:00.026925 [debug] [MainThread]: SQL status: COMMIT in 0.001 seconds
[0m03:03:00.027925 [debug] [MainThread]: On master: Close
[0m03:03:00.027925 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m03:03:00.028928 [info ] [MainThread]: 
[0m03:03:00.031929 [debug] [Thread-1 (]: Began running node model.task_4.calculate_comissions
[0m03:03:00.032932 [info ] [Thread-1 (]: 1 of 1 START sql view model public.calculate_comissions ........................ [RUN]
[0m03:03:00.033932 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.task_4.calculate_comissions'
[0m03:03:00.034450 [debug] [Thread-1 (]: Began compiling node model.task_4.calculate_comissions
[0m03:03:00.041458 [debug] [Thread-1 (]: Writing injected SQL for node "model.task_4.calculate_comissions"
[0m03:03:00.042461 [debug] [Thread-1 (]: Began executing node model.task_4.calculate_comissions
[0m03:03:00.128373 [debug] [Thread-1 (]: Writing runtime sql for node "model.task_4.calculate_comissions"
[0m03:03:00.129375 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m03:03:00.130374 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: BEGIN
[0m03:03:00.130374 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m03:03:00.152648 [debug] [Thread-1 (]: SQL status: BEGIN in 0.022 seconds
[0m03:03:00.153646 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m03:03:00.154155 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */

  create view "data_engineering_test"."public"."calculate_comissions__dbt_tmp"
    
    
  as (
    WITH salesowners AS (
    SELECT
        o.order_id,
        unnest(string_to_array(o.salesowners, ', ')) AS salesowner,

        -- Converting the gross value to euros then substracting the vat to get the net value in euros
        (i.gross_value / 100.0 * i.vat)/100 AS net_value_in_euros

    FROM
        public.orders o
    JOIN
        public.invoicing_data i ON o.order_id = i.order_id
),
commission_calc AS (
    SELECT
        order_id,
        salesowner,
        CASE 
            WHEN row_number() OVER (PARTITION BY order_id ORDER BY salesowner) = 1 THEN net_value_in_euros * 0.06  -- Main Owner - 6%
            WHEN row_number() OVER (PARTITION BY order_id ORDER BY salesowner) = 2 THEN net_value_in_euros * 0.025  -- Co-owner 1 - 2.5%
            WHEN row_number() OVER (PARTITION BY order_id ORDER BY salesowner) = 3 THEN net_value_in_euros * 0.0095  -- Co-owner 2 - 0.95%
            ELSE 0  -- No commission for others
        END AS commission
    FROM salesowners
)
SELECT
    salesowner,
    SUM(commission) AS total_commission
FROM commission_calc
GROUP BY salesowner
ORDER BY total_commission DESC
  );
[0m03:03:00.187285 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.032 seconds
[0m03:03:00.193787 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m03:03:00.193787 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */
alter table "data_engineering_test"."public"."calculate_comissions__dbt_tmp" rename to "calculate_comissions"
[0m03:03:00.197742 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.003 seconds
[0m03:03:00.210982 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: COMMIT
[0m03:03:00.210982 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m03:03:00.211992 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: COMMIT
[0m03:03:00.215987 [debug] [Thread-1 (]: SQL status: COMMIT in 0.004 seconds
[0m03:03:00.221996 [debug] [Thread-1 (]: Applying DROP to: "data_engineering_test"."public"."calculate_comissions__dbt_backup"
[0m03:03:00.226671 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m03:03:00.226671 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */
drop view if exists "data_engineering_test"."public"."calculate_comissions__dbt_backup" cascade
[0m03:03:00.229672 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.002 seconds
[0m03:03:00.232671 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: Close
[0m03:03:00.234185 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5d387178-9726-4ad5-a597-3e1c325cbd4b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002130A739FC0>]}
[0m03:03:00.234690 [info ] [Thread-1 (]: 1 of 1 OK created sql view model public.calculate_comissions ................... [[32mCREATE VIEW[0m in 0.20s]
[0m03:03:00.235700 [debug] [Thread-1 (]: Finished running node model.task_4.calculate_comissions
[0m03:03:00.236706 [debug] [MainThread]: Using postgres connection "master"
[0m03:03:00.237706 [debug] [MainThread]: On master: BEGIN
[0m03:03:00.237706 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m03:03:00.261001 [debug] [MainThread]: SQL status: BEGIN in 0.023 seconds
[0m03:03:00.262002 [debug] [MainThread]: On master: COMMIT
[0m03:03:00.262002 [debug] [MainThread]: Using postgres connection "master"
[0m03:03:00.263002 [debug] [MainThread]: On master: COMMIT
[0m03:03:00.264003 [debug] [MainThread]: SQL status: COMMIT in 0.001 seconds
[0m03:03:00.264514 [debug] [MainThread]: On master: Close
[0m03:03:00.265524 [debug] [MainThread]: Connection 'master' was properly closed.
[0m03:03:00.265524 [debug] [MainThread]: Connection 'list_data_engineering_test' was properly closed.
[0m03:03:00.266523 [debug] [MainThread]: Connection 'list_data_engineering_test_public' was properly closed.
[0m03:03:00.266523 [debug] [MainThread]: Connection 'model.task_4.calculate_comissions' was properly closed.
[0m03:03:00.267523 [info ] [MainThread]: 
[0m03:03:00.267523 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 0.43 seconds (0.43s).
[0m03:03:00.268524 [debug] [MainThread]: Command end result
[0m03:03:00.297087 [info ] [MainThread]: 
[0m03:03:00.298087 [info ] [MainThread]: [32mCompleted successfully[0m
[0m03:03:00.298087 [info ] [MainThread]: 
[0m03:03:00.299086 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m03:03:00.301107 [debug] [MainThread]: Command `dbt run` succeeded at 03:03:00.301107 after 1.21 seconds
[0m03:03:00.301107 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002130BA20E80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021307FBB220>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002130B546AA0>]}
[0m03:03:00.302090 [debug] [MainThread]: Flushing usage events
[0m03:05:47.035695 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A0D5D94EB0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A0D88C3280>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A0D88C1C60>]}


============================== 03:05:47.038693 | e6238ea9-1949-493f-b19b-49e83a0b37c9 ==============================
[0m03:05:47.038693 [info ] [MainThread]: Running with dbt=1.8.8
[0m03:05:47.039694 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'src/task_4/dbt', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'src\\task_4\\dbt\\logs', 'version_check': 'True', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'log_format': 'default', 'introspect': 'True', 'target_path': 'None', 'invocation_command': 'dbt run --profiles-dir src/task_4/dbt --project-dir src/task_4/dbt', 'send_anonymous_usage_stats': 'True'}
[0m03:05:47.227684 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'e6238ea9-1949-493f-b19b-49e83a0b37c9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A0D8A82770>]}
[0m03:05:47.275901 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'e6238ea9-1949-493f-b19b-49e83a0b37c9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A0D58E2AA0>]}
[0m03:05:47.277726 [info ] [MainThread]: Registered adapter: postgres=1.8.2
[0m03:05:47.285748 [debug] [MainThread]: checksum: ec53e341a936509427e16df1c646386a84befec52c1957e3f4359fbc36fc93f5, vars: {}, profile: , target: , version: 1.8.8
[0m03:05:47.438570 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m03:05:47.439571 [debug] [MainThread]: Partial parsing: updated file: task_4://models\calculate_comissions.sql
[0m03:05:47.629868 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'e6238ea9-1949-493f-b19b-49e83a0b37c9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A0D8E7D2A0>]}
[0m03:05:47.711471 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'e6238ea9-1949-493f-b19b-49e83a0b37c9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A0D8CEEA10>]}
[0m03:05:47.712468 [info ] [MainThread]: Found 1 model, 423 macros
[0m03:05:47.712468 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e6238ea9-1949-493f-b19b-49e83a0b37c9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A0D8CEF1F0>]}
[0m03:05:47.714489 [info ] [MainThread]: 
[0m03:05:47.715586 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m03:05:47.716495 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_engineering_test'
[0m03:05:47.799658 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test"
[0m03:05:47.800657 [debug] [ThreadPool]: On list_data_engineering_test: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "list_data_engineering_test"} */

    select distinct nspname from pg_namespace
  
[0m03:05:47.800657 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m03:05:47.818694 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.018 seconds
[0m03:05:47.820694 [debug] [ThreadPool]: On list_data_engineering_test: Close
[0m03:05:47.821699 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_engineering_test_public'
[0m03:05:47.827848 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test_public"
[0m03:05:47.827848 [debug] [ThreadPool]: On list_data_engineering_test_public: BEGIN
[0m03:05:47.828846 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m03:05:47.843943 [debug] [ThreadPool]: SQL status: BEGIN in 0.015 seconds
[0m03:05:47.844458 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test_public"
[0m03:05:47.844458 [debug] [ThreadPool]: On list_data_engineering_test_public: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "list_data_engineering_test_public"} */
select
      'data_engineering_test' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_engineering_test' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_engineering_test' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m03:05:47.848464 [debug] [ThreadPool]: SQL status: SELECT 2 in 0.003 seconds
[0m03:05:47.849466 [debug] [ThreadPool]: On list_data_engineering_test_public: ROLLBACK
[0m03:05:47.851467 [debug] [ThreadPool]: On list_data_engineering_test_public: Close
[0m03:05:47.855803 [debug] [MainThread]: Using postgres connection "master"
[0m03:05:47.856808 [debug] [MainThread]: On master: BEGIN
[0m03:05:47.856808 [debug] [MainThread]: Opening a new connection, currently in state init
[0m03:05:47.871188 [debug] [MainThread]: SQL status: BEGIN in 0.014 seconds
[0m03:05:47.872191 [debug] [MainThread]: Using postgres connection "master"
[0m03:05:47.872191 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m03:05:47.876367 [debug] [MainThread]: SQL status: SELECT 0 in 0.003 seconds
[0m03:05:47.877379 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e6238ea9-1949-493f-b19b-49e83a0b37c9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A0D8E72260>]}
[0m03:05:47.878377 [debug] [MainThread]: On master: ROLLBACK
[0m03:05:47.879378 [debug] [MainThread]: Using postgres connection "master"
[0m03:05:47.879378 [debug] [MainThread]: On master: BEGIN
[0m03:05:47.881377 [debug] [MainThread]: SQL status: BEGIN in 0.001 seconds
[0m03:05:47.882381 [debug] [MainThread]: On master: COMMIT
[0m03:05:47.882381 [debug] [MainThread]: Using postgres connection "master"
[0m03:05:47.882381 [debug] [MainThread]: On master: COMMIT
[0m03:05:47.883889 [debug] [MainThread]: SQL status: COMMIT in 0.001 seconds
[0m03:05:47.884898 [debug] [MainThread]: On master: Close
[0m03:05:47.885409 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m03:05:47.885409 [info ] [MainThread]: 
[0m03:05:47.888416 [debug] [Thread-1 (]: Began running node model.task_4.calculate_comissions
[0m03:05:47.889417 [info ] [Thread-1 (]: 1 of 1 START sql view model public.calculate_comissions ........................ [RUN]
[0m03:05:47.890417 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.task_4.calculate_comissions'
[0m03:05:47.890417 [debug] [Thread-1 (]: Began compiling node model.task_4.calculate_comissions
[0m03:05:47.897459 [debug] [Thread-1 (]: Writing injected SQL for node "model.task_4.calculate_comissions"
[0m03:05:47.899464 [debug] [Thread-1 (]: Began executing node model.task_4.calculate_comissions
[0m03:05:47.988624 [debug] [Thread-1 (]: Writing runtime sql for node "model.task_4.calculate_comissions"
[0m03:05:47.989629 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m03:05:47.989629 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: BEGIN
[0m03:05:47.990629 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m03:05:48.019926 [debug] [Thread-1 (]: SQL status: BEGIN in 0.029 seconds
[0m03:05:48.019926 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m03:05:48.020923 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */

  create view "data_engineering_test"."public"."calculate_comissions__dbt_tmp"
    
    
  as (
    WITH salesowners AS (
    SELECT
        o.order_id,
        unnest(string_to_array(o.salesowners, ', ')) AS salesowner,

        -- Converting the gross value to euros then substracting the vat to get the net value in euros
        (i.gross_value / 100.0 * (1-i.vat))/100 AS net_value_in_euros

    FROM
        public.orders o
    JOIN
        public.invoicing_data i ON o.order_id = i.order_id
),
commission_calc AS (
    SELECT
        order_id,
        salesowner,
        CASE 
            WHEN row_number() OVER (PARTITION BY order_id ORDER BY salesowner) = 1 THEN net_value_in_euros * 0.06  -- Main Owner - 6%
            WHEN row_number() OVER (PARTITION BY order_id ORDER BY salesowner) = 2 THEN net_value_in_euros * 0.025  -- Co-owner 1 - 2.5%
            WHEN row_number() OVER (PARTITION BY order_id ORDER BY salesowner) = 3 THEN net_value_in_euros * 0.0095  -- Co-owner 2 - 0.95%
            ELSE 0  -- No commission for others
        END AS commission
    FROM salesowners
)
SELECT
    salesowner,
    SUM(commission) AS total_commission
FROM commission_calc
GROUP BY salesowner
ORDER BY total_commission DESC
  );
[0m03:05:48.025605 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.004 seconds
[0m03:05:48.031606 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m03:05:48.032607 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */
alter table "data_engineering_test"."public"."calculate_comissions__dbt_tmp" rename to "calculate_comissions"
[0m03:05:48.033608 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m03:05:48.046878 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: COMMIT
[0m03:05:48.047877 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m03:05:48.047877 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: COMMIT
[0m03:05:48.050879 [debug] [Thread-1 (]: SQL status: COMMIT in 0.002 seconds
[0m03:05:48.057894 [debug] [Thread-1 (]: Applying DROP to: "data_engineering_test"."public"."calculate_comissions__dbt_backup"
[0m03:05:48.061406 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m03:05:48.062406 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */
drop view if exists "data_engineering_test"."public"."calculate_comissions__dbt_backup" cascade
[0m03:05:48.063913 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.001 seconds
[0m03:05:48.067112 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: Close
[0m03:05:48.068116 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e6238ea9-1949-493f-b19b-49e83a0b37c9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A0D4AB9FF0>]}
[0m03:05:48.069115 [info ] [Thread-1 (]: 1 of 1 OK created sql view model public.calculate_comissions ................... [[32mCREATE VIEW[0m in 0.18s]
[0m03:05:48.070113 [debug] [Thread-1 (]: Finished running node model.task_4.calculate_comissions
[0m03:05:48.071115 [debug] [MainThread]: Using postgres connection "master"
[0m03:05:48.072113 [debug] [MainThread]: On master: BEGIN
[0m03:05:48.072113 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m03:05:48.085868 [debug] [MainThread]: SQL status: BEGIN in 0.013 seconds
[0m03:05:48.086706 [debug] [MainThread]: On master: COMMIT
[0m03:05:48.086706 [debug] [MainThread]: Using postgres connection "master"
[0m03:05:48.087708 [debug] [MainThread]: On master: COMMIT
[0m03:05:48.088708 [debug] [MainThread]: SQL status: COMMIT in 0.001 seconds
[0m03:05:48.088708 [debug] [MainThread]: On master: Close
[0m03:05:48.089707 [debug] [MainThread]: Connection 'master' was properly closed.
[0m03:05:48.090708 [debug] [MainThread]: Connection 'list_data_engineering_test' was properly closed.
[0m03:05:48.090708 [debug] [MainThread]: Connection 'list_data_engineering_test_public' was properly closed.
[0m03:05:48.090708 [debug] [MainThread]: Connection 'model.task_4.calculate_comissions' was properly closed.
[0m03:05:48.091708 [info ] [MainThread]: 
[0m03:05:48.092707 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 0.38 seconds (0.38s).
[0m03:05:48.093706 [debug] [MainThread]: Command end result
[0m03:05:48.120660 [info ] [MainThread]: 
[0m03:05:48.121660 [info ] [MainThread]: [32mCompleted successfully[0m
[0m03:05:48.121660 [info ] [MainThread]: 
[0m03:05:48.122658 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m03:05:48.124775 [debug] [MainThread]: Command `dbt run` succeeded at 03:05:48.123658 after 1.16 seconds
[0m03:05:48.124775 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A0D5D94EB0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A0D232B220>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A0D5848AC0>]}
[0m03:05:48.125782 [debug] [MainThread]: Flushing usage events
[0m03:07:01.202178 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB6E2E8DF0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB70E03610>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB70E038B0>]}


============================== 03:07:01.206234 | 8f8e2a46-ab60-4ad6-9e15-d96caa05e3aa ==============================
[0m03:07:01.206234 [info ] [MainThread]: Running with dbt=1.8.8
[0m03:07:01.206234 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'src\\task_4\\dbt\\logs', 'debug': 'False', 'profiles_dir': 'src/task_4/dbt', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --profiles-dir src/task_4/dbt --project-dir src/task_4/dbt', 'introspect': 'True', 'static_parser': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m03:07:01.394025 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '8f8e2a46-ab60-4ad6-9e15-d96caa05e3aa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB70FBA3B0>]}
[0m03:07:01.443981 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '8f8e2a46-ab60-4ad6-9e15-d96caa05e3aa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB6DE16A40>]}
[0m03:07:01.446491 [info ] [MainThread]: Registered adapter: postgres=1.8.2
[0m03:07:01.455644 [debug] [MainThread]: checksum: ec53e341a936509427e16df1c646386a84befec52c1957e3f4359fbc36fc93f5, vars: {}, profile: , target: , version: 1.8.8
[0m03:07:01.620275 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m03:07:01.621275 [debug] [MainThread]: Partial parsing: updated file: task_4://models\calculate_comissions.sql
[0m03:07:01.813646 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '8f8e2a46-ab60-4ad6-9e15-d96caa05e3aa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB713BD1E0>]}
[0m03:07:01.894857 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '8f8e2a46-ab60-4ad6-9e15-d96caa05e3aa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB712329E0>]}
[0m03:07:01.895865 [info ] [MainThread]: Found 1 model, 423 macros
[0m03:07:01.895865 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '8f8e2a46-ab60-4ad6-9e15-d96caa05e3aa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB712328F0>]}
[0m03:07:01.897863 [info ] [MainThread]: 
[0m03:07:01.898864 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m03:07:01.899863 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_engineering_test'
[0m03:07:01.982883 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test"
[0m03:07:01.982883 [debug] [ThreadPool]: On list_data_engineering_test: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "list_data_engineering_test"} */

    select distinct nspname from pg_namespace
  
[0m03:07:01.983882 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m03:07:02.001109 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.017 seconds
[0m03:07:02.002114 [debug] [ThreadPool]: On list_data_engineering_test: Close
[0m03:07:02.003620 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_engineering_test_public'
[0m03:07:02.009653 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test_public"
[0m03:07:02.010652 [debug] [ThreadPool]: On list_data_engineering_test_public: BEGIN
[0m03:07:02.010652 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m03:07:02.024870 [debug] [ThreadPool]: SQL status: BEGIN in 0.014 seconds
[0m03:07:02.025879 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test_public"
[0m03:07:02.025879 [debug] [ThreadPool]: On list_data_engineering_test_public: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "list_data_engineering_test_public"} */
select
      'data_engineering_test' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_engineering_test' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_engineering_test' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m03:07:02.029876 [debug] [ThreadPool]: SQL status: SELECT 3 in 0.003 seconds
[0m03:07:02.030880 [debug] [ThreadPool]: On list_data_engineering_test_public: ROLLBACK
[0m03:07:02.031880 [debug] [ThreadPool]: On list_data_engineering_test_public: Close
[0m03:07:02.036926 [debug] [MainThread]: Using postgres connection "master"
[0m03:07:02.036926 [debug] [MainThread]: On master: BEGIN
[0m03:07:02.037927 [debug] [MainThread]: Opening a new connection, currently in state init
[0m03:07:02.052093 [debug] [MainThread]: SQL status: BEGIN in 0.014 seconds
[0m03:07:02.052093 [debug] [MainThread]: Using postgres connection "master"
[0m03:07:02.053602 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m03:07:02.057664 [debug] [MainThread]: SQL status: SELECT 2 in 0.004 seconds
[0m03:07:02.059664 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '8f8e2a46-ab60-4ad6-9e15-d96caa05e3aa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB71231BD0>]}
[0m03:07:02.059664 [debug] [MainThread]: On master: ROLLBACK
[0m03:07:02.061663 [debug] [MainThread]: Using postgres connection "master"
[0m03:07:02.061663 [debug] [MainThread]: On master: BEGIN
[0m03:07:02.063664 [debug] [MainThread]: SQL status: BEGIN in 0.001 seconds
[0m03:07:02.063664 [debug] [MainThread]: On master: COMMIT
[0m03:07:02.064724 [debug] [MainThread]: Using postgres connection "master"
[0m03:07:02.064724 [debug] [MainThread]: On master: COMMIT
[0m03:07:02.065935 [debug] [MainThread]: SQL status: COMMIT in 0.001 seconds
[0m03:07:02.066943 [debug] [MainThread]: On master: Close
[0m03:07:02.066943 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m03:07:02.067941 [info ] [MainThread]: 
[0m03:07:02.070940 [debug] [Thread-1 (]: Began running node model.task_4.calculate_comissions
[0m03:07:02.070940 [info ] [Thread-1 (]: 1 of 1 START sql view model public.calculate_comissions ........................ [RUN]
[0m03:07:02.071945 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.task_4.calculate_comissions'
[0m03:07:02.072942 [debug] [Thread-1 (]: Began compiling node model.task_4.calculate_comissions
[0m03:07:02.079456 [debug] [Thread-1 (]: Writing injected SQL for node "model.task_4.calculate_comissions"
[0m03:07:02.080455 [debug] [Thread-1 (]: Began executing node model.task_4.calculate_comissions
[0m03:07:02.167833 [debug] [Thread-1 (]: Writing runtime sql for node "model.task_4.calculate_comissions"
[0m03:07:02.168825 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m03:07:02.169823 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: BEGIN
[0m03:07:02.170823 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m03:07:02.184881 [debug] [Thread-1 (]: SQL status: BEGIN in 0.014 seconds
[0m03:07:02.184881 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m03:07:02.186019 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */

  create view "data_engineering_test"."public"."calculate_comissions__dbt_tmp"
    
    
  as (
    WITH salesowners AS (
    SELECT
        o.order_id,
        unnest(string_to_array(o.salesowners, ', ')) AS salesowner,

        -- Converting the gross value to euros then substracting the vat to get the net value in euros
        (i.gross_value / 100.0 * (1-i.vat)/100 AS net_value_in_euros

    FROM
        public.orders o
    JOIN
        public.invoicing_data i ON o.order_id = i.order_id
),
commission_calc AS (
    SELECT
        order_id,
        salesowner,
        CASE 
            WHEN row_number() OVER (PARTITION BY order_id ORDER BY salesowner) = 1 THEN net_value_in_euros * 0.06  -- Main Owner - 6%
            WHEN row_number() OVER (PARTITION BY order_id ORDER BY salesowner) = 2 THEN net_value_in_euros * 0.025  -- Co-owner 1 - 2.5%
            WHEN row_number() OVER (PARTITION BY order_id ORDER BY salesowner) = 3 THEN net_value_in_euros * 0.0095  -- Co-owner 2 - 0.95%
            ELSE 0  -- No commission for others
        END AS commission
    FROM salesowners
)
SELECT
    salesowner,
    SUM(commission) AS total_commission
FROM commission_calc
GROUP BY salesowner
ORDER BY total_commission DESC
  );
[0m03:07:02.187029 [debug] [Thread-1 (]: Postgres adapter: Postgres error: syntax error at or near "AS"
LINE 13:         (i.gross_value / 100.0 * (1-i.vat)/100 AS net_value_...
                                                        ^

[0m03:07:02.188029 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: ROLLBACK
[0m03:07:02.189028 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: Close
[0m03:07:02.193026 [debug] [Thread-1 (]: Database Error in model calculate_comissions (models\calculate_comissions.sql)
  syntax error at or near "AS"
  LINE 13:         (i.gross_value / 100.0 * (1-i.vat)/100 AS net_value_...
                                                          ^
  compiled code at target\run\task_4\models\calculate_comissions.sql
[0m03:07:02.194529 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8f8e2a46-ab60-4ad6-9e15-d96caa05e3aa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB70770B80>]}
[0m03:07:02.195534 [error] [Thread-1 (]: 1 of 1 ERROR creating sql view model public.calculate_comissions ............... [[31mERROR[0m in 0.12s]
[0m03:07:02.196535 [debug] [Thread-1 (]: Finished running node model.task_4.calculate_comissions
[0m03:07:02.198536 [debug] [MainThread]: Using postgres connection "master"
[0m03:07:02.198536 [debug] [MainThread]: On master: BEGIN
[0m03:07:02.199533 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m03:07:02.213883 [debug] [MainThread]: SQL status: BEGIN in 0.014 seconds
[0m03:07:02.214389 [debug] [MainThread]: On master: COMMIT
[0m03:07:02.214896 [debug] [MainThread]: Using postgres connection "master"
[0m03:07:02.214896 [debug] [MainThread]: On master: COMMIT
[0m03:07:02.215905 [debug] [MainThread]: SQL status: COMMIT in 0.001 seconds
[0m03:07:02.216906 [debug] [MainThread]: On master: Close
[0m03:07:02.216906 [debug] [MainThread]: Connection 'master' was properly closed.
[0m03:07:02.217906 [debug] [MainThread]: Connection 'list_data_engineering_test' was properly closed.
[0m03:07:02.217906 [debug] [MainThread]: Connection 'list_data_engineering_test_public' was properly closed.
[0m03:07:02.217906 [debug] [MainThread]: Connection 'model.task_4.calculate_comissions' was properly closed.
[0m03:07:02.218902 [info ] [MainThread]: 
[0m03:07:02.218902 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 0.32 seconds (0.32s).
[0m03:07:02.219904 [debug] [MainThread]: Command end result
[0m03:07:02.245767 [info ] [MainThread]: 
[0m03:07:02.246774 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m03:07:02.246774 [info ] [MainThread]: 
[0m03:07:02.247773 [error] [MainThread]:   Database Error in model calculate_comissions (models\calculate_comissions.sql)
  syntax error at or near "AS"
  LINE 13:         (i.gross_value / 100.0 * (1-i.vat)/100 AS net_value_...
                                                          ^
  compiled code at target\run\task_4\models\calculate_comissions.sql
[0m03:07:02.247773 [info ] [MainThread]: 
[0m03:07:02.248773 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m03:07:02.249775 [debug] [MainThread]: Command `dbt run` failed at 03:07:02.249775 after 1.11 seconds
[0m03:07:02.250775 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB6E2E8DF0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB710A8D00>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB71278070>]}
[0m03:07:02.251775 [debug] [MainThread]: Flushing usage events
[0m03:07:13.846768 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001426A114DF0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001426CC43610>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001426CC438B0>]}


============================== 03:07:13.850764 | 92474d60-b62f-4173-a355-0903aad4715a ==============================
[0m03:07:13.850764 [info ] [MainThread]: Running with dbt=1.8.8
[0m03:07:13.850764 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'src/task_4/dbt', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'src\\task_4\\dbt\\logs', 'version_check': 'True', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'log_format': 'default', 'introspect': 'True', 'static_parser': 'True', 'invocation_command': 'dbt run --profiles-dir src/task_4/dbt --project-dir src/task_4/dbt', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m03:07:14.040477 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '92474d60-b62f-4173-a355-0903aad4715a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001426CE023B0>]}
[0m03:07:14.090627 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '92474d60-b62f-4173-a355-0903aad4715a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014269C56A40>]}
[0m03:07:14.092631 [info ] [MainThread]: Registered adapter: postgres=1.8.2
[0m03:07:14.100826 [debug] [MainThread]: checksum: ec53e341a936509427e16df1c646386a84befec52c1957e3f4359fbc36fc93f5, vars: {}, profile: , target: , version: 1.8.8
[0m03:07:14.243681 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m03:07:14.244687 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m03:07:14.271527 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '92474d60-b62f-4173-a355-0903aad4715a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001426D0B8130>]}
[0m03:07:14.356528 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '92474d60-b62f-4173-a355-0903aad4715a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001426D0CA4A0>]}
[0m03:07:14.357527 [info ] [MainThread]: Found 1 model, 423 macros
[0m03:07:14.358527 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '92474d60-b62f-4173-a355-0903aad4715a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001426A51FDF0>]}
[0m03:07:14.359526 [info ] [MainThread]: 
[0m03:07:14.360527 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m03:07:14.361527 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_engineering_test'
[0m03:07:14.448652 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test"
[0m03:07:14.449652 [debug] [ThreadPool]: On list_data_engineering_test: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "list_data_engineering_test"} */

    select distinct nspname from pg_namespace
  
[0m03:07:14.450652 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m03:07:14.467903 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.018 seconds
[0m03:07:14.469901 [debug] [ThreadPool]: On list_data_engineering_test: Close
[0m03:07:14.470900 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_engineering_test_public'
[0m03:07:14.476914 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test_public"
[0m03:07:14.477913 [debug] [ThreadPool]: On list_data_engineering_test_public: BEGIN
[0m03:07:14.477913 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m03:07:14.491138 [debug] [ThreadPool]: SQL status: BEGIN in 0.014 seconds
[0m03:07:14.492136 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test_public"
[0m03:07:14.492136 [debug] [ThreadPool]: On list_data_engineering_test_public: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "list_data_engineering_test_public"} */
select
      'data_engineering_test' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_engineering_test' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_engineering_test' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m03:07:14.495703 [debug] [ThreadPool]: SQL status: SELECT 2 in 0.003 seconds
[0m03:07:14.497698 [debug] [ThreadPool]: On list_data_engineering_test_public: ROLLBACK
[0m03:07:14.498700 [debug] [ThreadPool]: On list_data_engineering_test_public: Close
[0m03:07:14.502700 [debug] [MainThread]: Using postgres connection "master"
[0m03:07:14.503701 [debug] [MainThread]: On master: BEGIN
[0m03:07:14.504207 [debug] [MainThread]: Opening a new connection, currently in state init
[0m03:07:14.519247 [debug] [MainThread]: SQL status: BEGIN in 0.015 seconds
[0m03:07:14.520245 [debug] [MainThread]: Using postgres connection "master"
[0m03:07:14.521245 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m03:07:14.524765 [debug] [MainThread]: SQL status: SELECT 0 in 0.003 seconds
[0m03:07:14.525820 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '92474d60-b62f-4173-a355-0903aad4715a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001426D0CDCC0>]}
[0m03:07:14.526818 [debug] [MainThread]: On master: ROLLBACK
[0m03:07:14.527819 [debug] [MainThread]: Using postgres connection "master"
[0m03:07:14.528817 [debug] [MainThread]: On master: BEGIN
[0m03:07:14.529820 [debug] [MainThread]: SQL status: BEGIN in 0.001 seconds
[0m03:07:14.530818 [debug] [MainThread]: On master: COMMIT
[0m03:07:14.530818 [debug] [MainThread]: Using postgres connection "master"
[0m03:07:14.531818 [debug] [MainThread]: On master: COMMIT
[0m03:07:14.532819 [debug] [MainThread]: SQL status: COMMIT in 0.001 seconds
[0m03:07:14.532819 [debug] [MainThread]: On master: Close
[0m03:07:14.533818 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m03:07:14.534833 [info ] [MainThread]: 
[0m03:07:14.536999 [debug] [Thread-1 (]: Began running node model.task_4.calculate_comissions
[0m03:07:14.537998 [info ] [Thread-1 (]: 1 of 1 START sql view model public.calculate_comissions ........................ [RUN]
[0m03:07:14.538998 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.task_4.calculate_comissions'
[0m03:07:14.539999 [debug] [Thread-1 (]: Began compiling node model.task_4.calculate_comissions
[0m03:07:14.545511 [debug] [Thread-1 (]: Writing injected SQL for node "model.task_4.calculate_comissions"
[0m03:07:14.546507 [debug] [Thread-1 (]: Began executing node model.task_4.calculate_comissions
[0m03:07:14.584899 [debug] [Thread-1 (]: Writing runtime sql for node "model.task_4.calculate_comissions"
[0m03:07:14.586092 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m03:07:14.587100 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: BEGIN
[0m03:07:14.587100 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m03:07:14.600646 [debug] [Thread-1 (]: SQL status: BEGIN in 0.013 seconds
[0m03:07:14.601644 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m03:07:14.602645 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */

  create view "data_engineering_test"."public"."calculate_comissions__dbt_tmp"
    
    
  as (
    WITH salesowners AS (
    SELECT
        o.order_id,
        unnest(string_to_array(o.salesowners, ', ')) AS salesowner,

        -- Converting the gross value to euros then substracting the vat to get the net value in euros
        (i.gross_value / 100.0 * (1-i.vat)/100 AS net_value_in_euros

    FROM
        public.orders o
    JOIN
        public.invoicing_data i ON o.order_id = i.order_id
),
commission_calc AS (
    SELECT
        order_id,
        salesowner,
        CASE 
            WHEN row_number() OVER (PARTITION BY order_id ORDER BY salesowner) = 1 THEN net_value_in_euros * 0.06  -- Main Owner - 6%
            WHEN row_number() OVER (PARTITION BY order_id ORDER BY salesowner) = 2 THEN net_value_in_euros * 0.025  -- Co-owner 1 - 2.5%
            WHEN row_number() OVER (PARTITION BY order_id ORDER BY salesowner) = 3 THEN net_value_in_euros * 0.0095  -- Co-owner 2 - 0.95%
            ELSE 0  -- No commission for others
        END AS commission
    FROM salesowners
)
SELECT
    salesowner,
    SUM(commission) AS total_commission
FROM commission_calc
GROUP BY salesowner
ORDER BY total_commission DESC
  );
[0m03:07:14.603645 [debug] [Thread-1 (]: Postgres adapter: Postgres error: syntax error at or near "AS"
LINE 13:         (i.gross_value / 100.0 * (1-i.vat)/100 AS net_value_...
                                                        ^

[0m03:07:14.603645 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: ROLLBACK
[0m03:07:14.605801 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: Close
[0m03:07:14.608807 [debug] [Thread-1 (]: Database Error in model calculate_comissions (models\calculate_comissions.sql)
  syntax error at or near "AS"
  LINE 13:         (i.gross_value / 100.0 * (1-i.vat)/100 AS net_value_...
                                                          ^
  compiled code at target\run\task_4\models\calculate_comissions.sql
[0m03:07:14.610810 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '92474d60-b62f-4173-a355-0903aad4715a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014269C479A0>]}
[0m03:07:14.611806 [error] [Thread-1 (]: 1 of 1 ERROR creating sql view model public.calculate_comissions ............... [[31mERROR[0m in 0.07s]
[0m03:07:14.612808 [debug] [Thread-1 (]: Finished running node model.task_4.calculate_comissions
[0m03:07:14.614462 [debug] [MainThread]: Using postgres connection "master"
[0m03:07:14.614462 [debug] [MainThread]: On master: BEGIN
[0m03:07:14.615469 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m03:07:14.628499 [debug] [MainThread]: SQL status: BEGIN in 0.013 seconds
[0m03:07:14.629498 [debug] [MainThread]: On master: COMMIT
[0m03:07:14.629498 [debug] [MainThread]: Using postgres connection "master"
[0m03:07:14.630496 [debug] [MainThread]: On master: COMMIT
[0m03:07:14.631496 [debug] [MainThread]: SQL status: COMMIT in 0.001 seconds
[0m03:07:14.631496 [debug] [MainThread]: On master: Close
[0m03:07:14.632497 [debug] [MainThread]: Connection 'master' was properly closed.
[0m03:07:14.632497 [debug] [MainThread]: Connection 'list_data_engineering_test' was properly closed.
[0m03:07:14.634005 [debug] [MainThread]: Connection 'list_data_engineering_test_public' was properly closed.
[0m03:07:14.634528 [debug] [MainThread]: Connection 'model.task_4.calculate_comissions' was properly closed.
[0m03:07:14.634528 [info ] [MainThread]: 
[0m03:07:14.635537 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 0.27 seconds (0.27s).
[0m03:07:14.636536 [debug] [MainThread]: Command end result
[0m03:07:14.662988 [info ] [MainThread]: 
[0m03:07:14.663988 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m03:07:14.664496 [info ] [MainThread]: 
[0m03:07:14.664496 [error] [MainThread]:   Database Error in model calculate_comissions (models\calculate_comissions.sql)
  syntax error at or near "AS"
  LINE 13:         (i.gross_value / 100.0 * (1-i.vat)/100 AS net_value_...
                                                          ^
  compiled code at target\run\task_4\models\calculate_comissions.sql
[0m03:07:14.665503 [info ] [MainThread]: 
[0m03:07:14.666502 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m03:07:14.667504 [debug] [MainThread]: Command `dbt run` failed at 03:07:14.667504 after 0.89 seconds
[0m03:07:14.668504 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001426A114DF0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001426A51FE50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014269C479A0>]}
[0m03:07:14.668504 [debug] [MainThread]: Flushing usage events
[0m03:07:36.771666 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000184AD5A4E80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000184B00D25F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000184B00D20E0>]}


============================== 03:07:36.775819 | 16c0d226-a12c-48f5-b0e9-a6d6d1ad3525 ==============================
[0m03:07:36.775819 [info ] [MainThread]: Running with dbt=1.8.8
[0m03:07:36.776668 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'profiles_dir': 'src/task_4/dbt', 'log_path': 'src\\task_4\\dbt\\logs', 'version_check': 'True', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'log_format': 'default', 'static_parser': 'True', 'invocation_command': 'dbt run --profiles-dir src/task_4/dbt --project-dir src/task_4/dbt', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m03:07:36.974432 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '16c0d226-a12c-48f5-b0e9-a6d6d1ad3525', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000184B0292740>]}
[0m03:07:37.024630 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '16c0d226-a12c-48f5-b0e9-a6d6d1ad3525', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000184AD0F2AA0>]}
[0m03:07:37.026644 [info ] [MainThread]: Registered adapter: postgres=1.8.2
[0m03:07:37.034653 [debug] [MainThread]: checksum: ec53e341a936509427e16df1c646386a84befec52c1957e3f4359fbc36fc93f5, vars: {}, profile: , target: , version: 1.8.8
[0m03:07:37.171691 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m03:07:37.172692 [debug] [MainThread]: Partial parsing: updated file: task_4://models\calculate_comissions.sql
[0m03:07:37.368741 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '16c0d226-a12c-48f5-b0e9-a6d6d1ad3525', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000184B0691270>]}
[0m03:07:37.452730 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '16c0d226-a12c-48f5-b0e9-a6d6d1ad3525', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000184B0502980>]}
[0m03:07:37.453729 [info ] [MainThread]: Found 1 model, 423 macros
[0m03:07:37.454239 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '16c0d226-a12c-48f5-b0e9-a6d6d1ad3525', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000184B05029B0>]}
[0m03:07:37.455979 [info ] [MainThread]: 
[0m03:07:37.456985 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m03:07:37.457985 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_engineering_test'
[0m03:07:37.564590 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test"
[0m03:07:37.564590 [debug] [ThreadPool]: On list_data_engineering_test: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "list_data_engineering_test"} */

    select distinct nspname from pg_namespace
  
[0m03:07:37.565849 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m03:07:37.582465 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.017 seconds
[0m03:07:37.584494 [debug] [ThreadPool]: On list_data_engineering_test: Close
[0m03:07:37.585502 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_engineering_test_public'
[0m03:07:37.591511 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test_public"
[0m03:07:37.592507 [debug] [ThreadPool]: On list_data_engineering_test_public: BEGIN
[0m03:07:37.592507 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m03:07:37.606566 [debug] [ThreadPool]: SQL status: BEGIN in 0.014 seconds
[0m03:07:37.607561 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test_public"
[0m03:07:37.608560 [debug] [ThreadPool]: On list_data_engineering_test_public: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "list_data_engineering_test_public"} */
select
      'data_engineering_test' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_engineering_test' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_engineering_test' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m03:07:37.611565 [debug] [ThreadPool]: SQL status: SELECT 2 in 0.003 seconds
[0m03:07:37.613560 [debug] [ThreadPool]: On list_data_engineering_test_public: ROLLBACK
[0m03:07:37.614572 [debug] [ThreadPool]: On list_data_engineering_test_public: Close
[0m03:07:37.618787 [debug] [MainThread]: Using postgres connection "master"
[0m03:07:37.619792 [debug] [MainThread]: On master: BEGIN
[0m03:07:37.619792 [debug] [MainThread]: Opening a new connection, currently in state init
[0m03:07:37.632820 [debug] [MainThread]: SQL status: BEGIN in 0.013 seconds
[0m03:07:37.633815 [debug] [MainThread]: Using postgres connection "master"
[0m03:07:37.634320 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m03:07:37.637996 [debug] [MainThread]: SQL status: SELECT 0 in 0.003 seconds
[0m03:07:37.638996 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '16c0d226-a12c-48f5-b0e9-a6d6d1ad3525', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000184B04E71C0>]}
[0m03:07:37.639996 [debug] [MainThread]: On master: ROLLBACK
[0m03:07:37.640997 [debug] [MainThread]: Using postgres connection "master"
[0m03:07:37.642001 [debug] [MainThread]: On master: BEGIN
[0m03:07:37.642997 [debug] [MainThread]: SQL status: BEGIN in 0.001 seconds
[0m03:07:37.643998 [debug] [MainThread]: On master: COMMIT
[0m03:07:37.644502 [debug] [MainThread]: Using postgres connection "master"
[0m03:07:37.644502 [debug] [MainThread]: On master: COMMIT
[0m03:07:37.645508 [debug] [MainThread]: SQL status: COMMIT in 0.001 seconds
[0m03:07:37.646508 [debug] [MainThread]: On master: Close
[0m03:07:37.646508 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m03:07:37.647513 [info ] [MainThread]: 
[0m03:07:37.650507 [debug] [Thread-1 (]: Began running node model.task_4.calculate_comissions
[0m03:07:37.651511 [info ] [Thread-1 (]: 1 of 1 START sql view model public.calculate_comissions ........................ [RUN]
[0m03:07:37.652508 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.task_4.calculate_comissions'
[0m03:07:37.652508 [debug] [Thread-1 (]: Began compiling node model.task_4.calculate_comissions
[0m03:07:37.659539 [debug] [Thread-1 (]: Writing injected SQL for node "model.task_4.calculate_comissions"
[0m03:07:37.660536 [debug] [Thread-1 (]: Began executing node model.task_4.calculate_comissions
[0m03:07:37.746837 [debug] [Thread-1 (]: Writing runtime sql for node "model.task_4.calculate_comissions"
[0m03:07:37.747837 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m03:07:37.748837 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: BEGIN
[0m03:07:37.749841 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m03:07:37.776218 [debug] [Thread-1 (]: SQL status: BEGIN in 0.027 seconds
[0m03:07:37.776218 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m03:07:37.777225 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */

  create view "data_engineering_test"."public"."calculate_comissions__dbt_tmp"
    
    
  as (
    WITH salesowners AS (
    SELECT
        o.order_id,
        unnest(string_to_array(o.salesowners, ', ')) AS salesowner,

        -- Converting the gross value to euros then substracting the vat to get the net value in euros
        (i.gross_value / 100.0 * (1-i.vat))/100 AS net_value_in_euros

    FROM
        public.orders o
    JOIN
        public.invoicing_data i ON o.order_id = i.order_id
),
commission_calc AS (
    SELECT
        order_id,
        salesowner,
        CASE 
            WHEN row_number() OVER (PARTITION BY order_id ORDER BY salesowner) = 1 THEN net_value_in_euros * 0.06  -- Main Owner - 6%
            WHEN row_number() OVER (PARTITION BY order_id ORDER BY salesowner) = 2 THEN net_value_in_euros * 0.025  -- Co-owner 1 - 2.5%
            WHEN row_number() OVER (PARTITION BY order_id ORDER BY salesowner) = 3 THEN net_value_in_euros * 0.0095  -- Co-owner 2 - 0.95%
            ELSE 0  -- No commission for others
        END AS commission
    FROM salesowners
)
SELECT
    salesowner,
    SUM(commission) AS total_commission
FROM commission_calc
GROUP BY salesowner
ORDER BY total_commission DESC
  );
[0m03:07:37.786941 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.009 seconds
[0m03:07:37.792938 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m03:07:37.793942 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */
alter table "data_engineering_test"."public"."calculate_comissions__dbt_tmp" rename to "calculate_comissions"
[0m03:07:37.795459 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.002 seconds
[0m03:07:37.808706 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: COMMIT
[0m03:07:37.809707 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m03:07:37.809707 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: COMMIT
[0m03:07:37.812709 [debug] [Thread-1 (]: SQL status: COMMIT in 0.002 seconds
[0m03:07:37.819624 [debug] [Thread-1 (]: Applying DROP to: "data_engineering_test"."public"."calculate_comissions__dbt_backup"
[0m03:07:37.824125 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m03:07:37.824630 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */
drop view if exists "data_engineering_test"."public"."calculate_comissions__dbt_backup" cascade
[0m03:07:37.825813 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.001 seconds
[0m03:07:37.828820 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: Close
[0m03:07:37.830823 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '16c0d226-a12c-48f5-b0e9-a6d6d1ad3525', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000184AC2C9FC0>]}
[0m03:07:37.830823 [info ] [Thread-1 (]: 1 of 1 OK created sql view model public.calculate_comissions ................... [[32mCREATE VIEW[0m in 0.18s]
[0m03:07:37.831823 [debug] [Thread-1 (]: Finished running node model.task_4.calculate_comissions
[0m03:07:37.832823 [debug] [MainThread]: Using postgres connection "master"
[0m03:07:37.833822 [debug] [MainThread]: On master: BEGIN
[0m03:07:37.834327 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m03:07:37.867726 [debug] [MainThread]: SQL status: BEGIN in 0.033 seconds
[0m03:07:37.867726 [debug] [MainThread]: On master: COMMIT
[0m03:07:37.868724 [debug] [MainThread]: Using postgres connection "master"
[0m03:07:37.868724 [debug] [MainThread]: On master: COMMIT
[0m03:07:37.869724 [debug] [MainThread]: SQL status: COMMIT in 0.001 seconds
[0m03:07:37.870728 [debug] [MainThread]: On master: Close
[0m03:07:37.870728 [debug] [MainThread]: Connection 'master' was properly closed.
[0m03:07:37.871726 [debug] [MainThread]: Connection 'list_data_engineering_test' was properly closed.
[0m03:07:37.871726 [debug] [MainThread]: Connection 'list_data_engineering_test_public' was properly closed.
[0m03:07:37.872724 [debug] [MainThread]: Connection 'model.task_4.calculate_comissions' was properly closed.
[0m03:07:37.872724 [info ] [MainThread]: 
[0m03:07:37.873724 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 0.42 seconds (0.42s).
[0m03:07:37.873724 [debug] [MainThread]: Command end result
[0m03:07:37.899887 [info ] [MainThread]: 
[0m03:07:37.900887 [info ] [MainThread]: [32mCompleted successfully[0m
[0m03:07:37.901901 [info ] [MainThread]: 
[0m03:07:37.902888 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m03:07:37.904394 [debug] [MainThread]: Command `dbt run` succeeded at 03:07:37.904394 after 1.20 seconds
[0m03:07:37.904898 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000184AD5A4E80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000184A9B3B220>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000184AD0D6AA0>]}
[0m03:07:37.904898 [debug] [MainThread]: Flushing usage events
[0m03:08:03.287499 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022DC84B0E20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022DCAFD1D20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022DCAFD3D60>]}


============================== 03:08:03.291494 | 51620db9-3b83-4e20-8efe-ca9b499ebb2f ==============================
[0m03:08:03.291494 [info ] [MainThread]: Running with dbt=1.8.8
[0m03:08:03.292496 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'src\\task_4\\dbt\\logs', 'version_check': 'True', 'profiles_dir': 'src/task_4/dbt', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'log_format': 'default', 'introspect': 'True', 'static_parser': 'True', 'invocation_command': 'dbt run --profiles-dir src/task_4/dbt --project-dir src/task_4/dbt', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m03:08:03.481910 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '51620db9-3b83-4e20-8efe-ca9b499ebb2f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022DCB191C90>]}
[0m03:08:03.530779 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '51620db9-3b83-4e20-8efe-ca9b499ebb2f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022DC7FF6A70>]}
[0m03:08:03.532779 [info ] [MainThread]: Registered adapter: postgres=1.8.2
[0m03:08:03.540799 [debug] [MainThread]: checksum: ec53e341a936509427e16df1c646386a84befec52c1957e3f4359fbc36fc93f5, vars: {}, profile: , target: , version: 1.8.8
[0m03:08:03.686899 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m03:08:03.686899 [debug] [MainThread]: Partial parsing: updated file: task_4://models\calculate_comissions.sql
[0m03:08:03.878728 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '51620db9-3b83-4e20-8efe-ca9b499ebb2f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022DCB58D210>]}
[0m03:08:03.960184 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '51620db9-3b83-4e20-8efe-ca9b499ebb2f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022DCB402500>]}
[0m03:08:03.961183 [info ] [MainThread]: Found 1 model, 423 macros
[0m03:08:03.961183 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '51620db9-3b83-4e20-8efe-ca9b499ebb2f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022DCB4024D0>]}
[0m03:08:03.962182 [info ] [MainThread]: 
[0m03:08:03.963687 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m03:08:03.965842 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_engineering_test'
[0m03:08:04.050223 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test"
[0m03:08:04.051219 [debug] [ThreadPool]: On list_data_engineering_test: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "list_data_engineering_test"} */

    select distinct nspname from pg_namespace
  
[0m03:08:04.051219 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m03:08:04.070167 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.019 seconds
[0m03:08:04.072168 [debug] [ThreadPool]: On list_data_engineering_test: Close
[0m03:08:04.073674 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_engineering_test_public'
[0m03:08:04.080192 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test_public"
[0m03:08:04.081196 [debug] [ThreadPool]: On list_data_engineering_test_public: BEGIN
[0m03:08:04.081196 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m03:08:04.096555 [debug] [ThreadPool]: SQL status: BEGIN in 0.015 seconds
[0m03:08:04.096555 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test_public"
[0m03:08:04.097556 [debug] [ThreadPool]: On list_data_engineering_test_public: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "list_data_engineering_test_public"} */
select
      'data_engineering_test' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_engineering_test' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_engineering_test' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m03:08:04.101558 [debug] [ThreadPool]: SQL status: SELECT 2 in 0.004 seconds
[0m03:08:04.103556 [debug] [ThreadPool]: On list_data_engineering_test_public: ROLLBACK
[0m03:08:04.104570 [debug] [ThreadPool]: On list_data_engineering_test_public: Close
[0m03:08:04.108577 [debug] [MainThread]: Using postgres connection "master"
[0m03:08:04.109575 [debug] [MainThread]: On master: BEGIN
[0m03:08:04.110578 [debug] [MainThread]: Opening a new connection, currently in state init
[0m03:08:04.124691 [debug] [MainThread]: SQL status: BEGIN in 0.015 seconds
[0m03:08:04.125701 [debug] [MainThread]: Using postgres connection "master"
[0m03:08:04.126703 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m03:08:04.138019 [debug] [MainThread]: SQL status: SELECT 0 in 0.011 seconds
[0m03:08:04.139020 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '51620db9-3b83-4e20-8efe-ca9b499ebb2f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022DCB402EF0>]}
[0m03:08:04.139020 [debug] [MainThread]: On master: ROLLBACK
[0m03:08:04.141536 [debug] [MainThread]: Using postgres connection "master"
[0m03:08:04.141536 [debug] [MainThread]: On master: BEGIN
[0m03:08:04.142536 [debug] [MainThread]: SQL status: BEGIN in 0.001 seconds
[0m03:08:04.144045 [debug] [MainThread]: On master: COMMIT
[0m03:08:04.144568 [debug] [MainThread]: Using postgres connection "master"
[0m03:08:04.144568 [debug] [MainThread]: On master: COMMIT
[0m03:08:04.145575 [debug] [MainThread]: SQL status: COMMIT in 0.001 seconds
[0m03:08:04.146575 [debug] [MainThread]: On master: Close
[0m03:08:04.146575 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m03:08:04.147576 [info ] [MainThread]: 
[0m03:08:04.150575 [debug] [Thread-1 (]: Began running node model.task_4.calculate_comissions
[0m03:08:04.151574 [info ] [Thread-1 (]: 1 of 1 START sql view model public.calculate_comissions ........................ [RUN]
[0m03:08:04.152575 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.task_4.calculate_comissions'
[0m03:08:04.152575 [debug] [Thread-1 (]: Began compiling node model.task_4.calculate_comissions
[0m03:08:04.159761 [debug] [Thread-1 (]: Writing injected SQL for node "model.task_4.calculate_comissions"
[0m03:08:04.160761 [debug] [Thread-1 (]: Began executing node model.task_4.calculate_comissions
[0m03:08:04.247888 [debug] [Thread-1 (]: Writing runtime sql for node "model.task_4.calculate_comissions"
[0m03:08:04.248883 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m03:08:04.249885 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: BEGIN
[0m03:08:04.249885 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m03:08:04.264748 [debug] [Thread-1 (]: SQL status: BEGIN in 0.014 seconds
[0m03:08:04.264748 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m03:08:04.265757 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */

  create view "data_engineering_test"."public"."calculate_comissions__dbt_tmp"
    
    
  as (
    WITH salesowners AS (
    SELECT
        o.order_id,
        unnest(string_to_array(o.salesowners, ', ')) AS salesowner,

        -- Converting the gross value to euros then substracting the vat to get the net value in euros
        ((i.gross_value / 100.0) * (1-i.vat))/100 AS net_value_in_euros

    FROM
        public.orders o
    JOIN
        public.invoicing_data i ON o.order_id = i.order_id
),
commission_calc AS (
    SELECT
        order_id,
        salesowner,
        CASE 
            WHEN row_number() OVER (PARTITION BY order_id ORDER BY salesowner) = 1 THEN net_value_in_euros * 0.06  -- Main Owner - 6%
            WHEN row_number() OVER (PARTITION BY order_id ORDER BY salesowner) = 2 THEN net_value_in_euros * 0.025  -- Co-owner 1 - 2.5%
            WHEN row_number() OVER (PARTITION BY order_id ORDER BY salesowner) = 3 THEN net_value_in_euros * 0.0095  -- Co-owner 2 - 0.95%
            ELSE 0  -- No commission for others
        END AS commission
    FROM salesowners
)
SELECT
    salesowner,
    SUM(commission) AS total_commission
FROM commission_calc
GROUP BY salesowner
ORDER BY total_commission DESC
  );
[0m03:08:04.271755 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.005 seconds
[0m03:08:04.278023 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m03:08:04.279021 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */
alter table "data_engineering_test"."public"."calculate_comissions__dbt_tmp" rename to "calculate_comissions"
[0m03:08:04.280022 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m03:08:04.294046 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: COMMIT
[0m03:08:04.294565 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m03:08:04.295573 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: COMMIT
[0m03:08:04.297712 [debug] [Thread-1 (]: SQL status: COMMIT in 0.002 seconds
[0m03:08:04.304224 [debug] [Thread-1 (]: Applying DROP to: "data_engineering_test"."public"."calculate_comissions__dbt_backup"
[0m03:08:04.307738 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m03:08:04.308734 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */
drop view if exists "data_engineering_test"."public"."calculate_comissions__dbt_backup" cascade
[0m03:08:04.309739 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.001 seconds
[0m03:08:04.312735 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: Close
[0m03:08:04.314261 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '51620db9-3b83-4e20-8efe-ca9b499ebb2f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022DC71C9F60>]}
[0m03:08:04.314765 [info ] [Thread-1 (]: 1 of 1 OK created sql view model public.calculate_comissions ................... [[32mCREATE VIEW[0m in 0.16s]
[0m03:08:04.315895 [debug] [Thread-1 (]: Finished running node model.task_4.calculate_comissions
[0m03:08:04.316774 [debug] [MainThread]: Using postgres connection "master"
[0m03:08:04.317774 [debug] [MainThread]: On master: BEGIN
[0m03:08:04.317774 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m03:08:04.332898 [debug] [MainThread]: SQL status: BEGIN in 0.014 seconds
[0m03:08:04.333897 [debug] [MainThread]: On master: COMMIT
[0m03:08:04.333897 [debug] [MainThread]: Using postgres connection "master"
[0m03:08:04.334660 [debug] [MainThread]: On master: COMMIT
[0m03:08:04.335667 [debug] [MainThread]: SQL status: COMMIT in 0.001 seconds
[0m03:08:04.336669 [debug] [MainThread]: On master: Close
[0m03:08:04.336669 [debug] [MainThread]: Connection 'master' was properly closed.
[0m03:08:04.337667 [debug] [MainThread]: Connection 'list_data_engineering_test' was properly closed.
[0m03:08:04.337667 [debug] [MainThread]: Connection 'list_data_engineering_test_public' was properly closed.
[0m03:08:04.337667 [debug] [MainThread]: Connection 'model.task_4.calculate_comissions' was properly closed.
[0m03:08:04.338667 [info ] [MainThread]: 
[0m03:08:04.339669 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 0.37 seconds (0.37s).
[0m03:08:04.339669 [debug] [MainThread]: Command end result
[0m03:08:04.366049 [info ] [MainThread]: 
[0m03:08:04.367057 [info ] [MainThread]: [32mCompleted successfully[0m
[0m03:08:04.368056 [info ] [MainThread]: 
[0m03:08:04.369057 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m03:08:04.370056 [debug] [MainThread]: Command `dbt run` succeeded at 03:08:04.370056 after 1.15 seconds
[0m03:08:04.371059 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022DC84B0E20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022DCACA3430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022DC7F5ED70>]}
[0m03:08:04.372057 [debug] [MainThread]: Flushing usage events
[0m03:09:03.720652 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017E6E880E20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017E713A1D20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017E713A3D60>]}


============================== 03:09:03.724660 | 1d4f8442-8725-46fd-bde0-e97ab2356bda ==============================
[0m03:09:03.724660 [info ] [MainThread]: Running with dbt=1.8.8
[0m03:09:03.725667 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'src/task_4/dbt', 'debug': 'False', 'warn_error': 'None', 'log_path': 'src\\task_4\\dbt\\logs', 'version_check': 'True', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'introspect': 'True', 'log_format': 'default', 'target_path': 'None', 'invocation_command': 'dbt run --profiles-dir src/task_4/dbt --project-dir src/task_4/dbt', 'send_anonymous_usage_stats': 'True'}
[0m03:09:03.913734 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '1d4f8442-8725-46fd-bde0-e97ab2356bda', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017E71561C90>]}
[0m03:09:03.962773 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '1d4f8442-8725-46fd-bde0-e97ab2356bda', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017E6E3C6A70>]}
[0m03:09:03.964888 [info ] [MainThread]: Registered adapter: postgres=1.8.2
[0m03:09:03.973894 [debug] [MainThread]: checksum: ec53e341a936509427e16df1c646386a84befec52c1957e3f4359fbc36fc93f5, vars: {}, profile: , target: , version: 1.8.8
[0m03:09:04.155624 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m03:09:04.155820 [debug] [MainThread]: Partial parsing: updated file: task_4://models\calculate_comissions.sql
[0m03:09:04.348704 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '1d4f8442-8725-46fd-bde0-e97ab2356bda', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017E7195D210>]}
[0m03:09:04.429934 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '1d4f8442-8725-46fd-bde0-e97ab2356bda', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017E717CE500>]}
[0m03:09:04.430936 [info ] [MainThread]: Found 1 model, 423 macros
[0m03:09:04.431935 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '1d4f8442-8725-46fd-bde0-e97ab2356bda', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017E717CE4D0>]}
[0m03:09:04.432937 [info ] [MainThread]: 
[0m03:09:04.434649 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m03:09:04.435853 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_engineering_test'
[0m03:09:04.519508 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test"
[0m03:09:04.520506 [debug] [ThreadPool]: On list_data_engineering_test: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "list_data_engineering_test"} */

    select distinct nspname from pg_namespace
  
[0m03:09:04.520506 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m03:09:04.538868 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.018 seconds
[0m03:09:04.539869 [debug] [ThreadPool]: On list_data_engineering_test: Close
[0m03:09:04.541870 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_engineering_test_public'
[0m03:09:04.546882 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test_public"
[0m03:09:04.547882 [debug] [ThreadPool]: On list_data_engineering_test_public: BEGIN
[0m03:09:04.547882 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m03:09:04.562164 [debug] [ThreadPool]: SQL status: BEGIN in 0.014 seconds
[0m03:09:04.562164 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test_public"
[0m03:09:04.562164 [debug] [ThreadPool]: On list_data_engineering_test_public: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "list_data_engineering_test_public"} */
select
      'data_engineering_test' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_engineering_test' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_engineering_test' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m03:09:04.566749 [debug] [ThreadPool]: SQL status: SELECT 2 in 0.003 seconds
[0m03:09:04.567749 [debug] [ThreadPool]: On list_data_engineering_test_public: ROLLBACK
[0m03:09:04.568749 [debug] [ThreadPool]: On list_data_engineering_test_public: Close
[0m03:09:04.573747 [debug] [MainThread]: Using postgres connection "master"
[0m03:09:04.574259 [debug] [MainThread]: On master: BEGIN
[0m03:09:04.574259 [debug] [MainThread]: Opening a new connection, currently in state init
[0m03:09:04.587548 [debug] [MainThread]: SQL status: BEGIN in 0.013 seconds
[0m03:09:04.588547 [debug] [MainThread]: Using postgres connection "master"
[0m03:09:04.588547 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m03:09:04.594622 [debug] [MainThread]: SQL status: SELECT 0 in 0.005 seconds
[0m03:09:04.595768 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '1d4f8442-8725-46fd-bde0-e97ab2356bda', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017E717CEEF0>]}
[0m03:09:04.596776 [debug] [MainThread]: On master: ROLLBACK
[0m03:09:04.597776 [debug] [MainThread]: Using postgres connection "master"
[0m03:09:04.598776 [debug] [MainThread]: On master: BEGIN
[0m03:09:04.599776 [debug] [MainThread]: SQL status: BEGIN in 0.001 seconds
[0m03:09:04.600777 [debug] [MainThread]: On master: COMMIT
[0m03:09:04.600777 [debug] [MainThread]: Using postgres connection "master"
[0m03:09:04.601776 [debug] [MainThread]: On master: COMMIT
[0m03:09:04.602773 [debug] [MainThread]: SQL status: COMMIT in 0.001 seconds
[0m03:09:04.602773 [debug] [MainThread]: On master: Close
[0m03:09:04.603773 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m03:09:04.604886 [info ] [MainThread]: 
[0m03:09:04.607892 [debug] [Thread-1 (]: Began running node model.task_4.calculate_comissions
[0m03:09:04.607892 [info ] [Thread-1 (]: 1 of 1 START sql view model public.calculate_comissions ........................ [RUN]
[0m03:09:04.608891 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.task_4.calculate_comissions'
[0m03:09:04.609892 [debug] [Thread-1 (]: Began compiling node model.task_4.calculate_comissions
[0m03:09:04.615906 [debug] [Thread-1 (]: Writing injected SQL for node "model.task_4.calculate_comissions"
[0m03:09:04.617909 [debug] [Thread-1 (]: Began executing node model.task_4.calculate_comissions
[0m03:09:04.701362 [debug] [Thread-1 (]: Writing runtime sql for node "model.task_4.calculate_comissions"
[0m03:09:04.702358 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m03:09:04.702358 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: BEGIN
[0m03:09:04.703866 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m03:09:04.731934 [debug] [Thread-1 (]: SQL status: BEGIN in 0.029 seconds
[0m03:09:04.732936 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m03:09:04.733936 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */

  create view "data_engineering_test"."public"."calculate_comissions__dbt_tmp"
    
    
  as (
    WITH salesowners AS (
    SELECT
        o.order_id,
        unnest(string_to_array(o.salesowners, ', ')) AS salesowner,

        -- Converting the gross value to euros then substracting the vat to get the net value in euros
        ((i.gross_value / 100.0) * (100-i.vat))/100 AS net_value_in_euros

    FROM
        public.orders o
    JOIN
        public.invoicing_data i ON o.order_id = i.order_id
),
commission_calc AS (
    SELECT
        order_id,
        salesowner,
        CASE 
            WHEN row_number() OVER (PARTITION BY order_id ORDER BY salesowner) = 1 THEN net_value_in_euros * 0.06  -- Main Owner - 6%
            WHEN row_number() OVER (PARTITION BY order_id ORDER BY salesowner) = 2 THEN net_value_in_euros * 0.025  -- Co-owner 1 - 2.5%
            WHEN row_number() OVER (PARTITION BY order_id ORDER BY salesowner) = 3 THEN net_value_in_euros * 0.0095  -- Co-owner 2 - 0.95%
            ELSE 0  -- No commission for others
        END AS commission
    FROM salesowners
)
SELECT
    salesowner,
    SUM(commission) AS total_commission
FROM commission_calc
GROUP BY salesowner
ORDER BY total_commission DESC
  );
[0m03:09:04.737455 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.004 seconds
[0m03:09:04.744535 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m03:09:04.744535 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */
alter table "data_engineering_test"."public"."calculate_comissions__dbt_tmp" rename to "calculate_comissions"
[0m03:09:04.746544 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m03:09:04.759583 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: COMMIT
[0m03:09:04.760585 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m03:09:04.760585 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: COMMIT
[0m03:09:04.763584 [debug] [Thread-1 (]: SQL status: COMMIT in 0.002 seconds
[0m03:09:04.769620 [debug] [Thread-1 (]: Applying DROP to: "data_engineering_test"."public"."calculate_comissions__dbt_backup"
[0m03:09:04.774132 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m03:09:04.774642 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */
drop view if exists "data_engineering_test"."public"."calculate_comissions__dbt_backup" cascade
[0m03:09:04.775651 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.001 seconds
[0m03:09:04.778654 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: Close
[0m03:09:04.779651 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1d4f8442-8725-46fd-bde0-e97ab2356bda', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017E6D599F60>]}
[0m03:09:04.781162 [info ] [Thread-1 (]: 1 of 1 OK created sql view model public.calculate_comissions ................... [[32mCREATE VIEW[0m in 0.17s]
[0m03:09:04.782175 [debug] [Thread-1 (]: Finished running node model.task_4.calculate_comissions
[0m03:09:04.782175 [debug] [MainThread]: Using postgres connection "master"
[0m03:09:04.783736 [debug] [MainThread]: On master: BEGIN
[0m03:09:04.783736 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m03:09:04.809956 [debug] [MainThread]: SQL status: BEGIN in 0.026 seconds
[0m03:09:04.810958 [debug] [MainThread]: On master: COMMIT
[0m03:09:04.810958 [debug] [MainThread]: Using postgres connection "master"
[0m03:09:04.811955 [debug] [MainThread]: On master: COMMIT
[0m03:09:04.812955 [debug] [MainThread]: SQL status: COMMIT in 0.001 seconds
[0m03:09:04.812955 [debug] [MainThread]: On master: Close
[0m03:09:04.813956 [debug] [MainThread]: Connection 'master' was properly closed.
[0m03:09:04.815473 [debug] [MainThread]: Connection 'list_data_engineering_test' was properly closed.
[0m03:09:04.815473 [debug] [MainThread]: Connection 'list_data_engineering_test_public' was properly closed.
[0m03:09:04.816472 [debug] [MainThread]: Connection 'model.task_4.calculate_comissions' was properly closed.
[0m03:09:04.816472 [info ] [MainThread]: 
[0m03:09:04.817478 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 0.38 seconds (0.38s).
[0m03:09:04.818474 [debug] [MainThread]: Command end result
[0m03:09:04.845506 [info ] [MainThread]: 
[0m03:09:04.846036 [info ] [MainThread]: [32mCompleted successfully[0m
[0m03:09:04.847045 [info ] [MainThread]: 
[0m03:09:04.848043 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m03:09:04.849755 [debug] [MainThread]: Command `dbt run` succeeded at 03:09:04.849043 after 1.19 seconds
[0m03:09:04.850261 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017E6E880E20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017E71073430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017E6E32ED70>]}
[0m03:09:04.850261 [debug] [MainThread]: Flushing usage events
[0m03:17:05.209509 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018D86294DF0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018D88DC3610>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018D88DC38B0>]}


============================== 03:17:05.214016 | 28e045f3-32af-41ab-95df-3cfdd7b80581 ==============================
[0m03:17:05.214016 [info ] [MainThread]: Running with dbt=1.8.8
[0m03:17:05.214535 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'src/task_4/dbt', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'src\\task_4\\dbt\\logs', 'version_check': 'True', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --profiles-dir src/task_4/dbt --project-dir src/task_4/dbt', 'log_format': 'default', 'introspect': 'True', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m03:17:05.408954 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '28e045f3-32af-41ab-95df-3cfdd7b80581', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018D88F823B0>]}
[0m03:17:05.458601 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '28e045f3-32af-41ab-95df-3cfdd7b80581', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018D85DE6A40>]}
[0m03:17:05.460601 [info ] [MainThread]: Registered adapter: postgres=1.8.2
[0m03:17:05.468617 [debug] [MainThread]: checksum: ec53e341a936509427e16df1c646386a84befec52c1957e3f4359fbc36fc93f5, vars: {}, profile: , target: , version: 1.8.8
[0m03:17:05.618722 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m03:17:05.619721 [debug] [MainThread]: Partial parsing: updated file: task_4://models\calculate_comissions.sql
[0m03:17:05.810926 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '28e045f3-32af-41ab-95df-3cfdd7b80581', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018D893811E0>]}
[0m03:17:05.897406 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '28e045f3-32af-41ab-95df-3cfdd7b80581', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018D891F29E0>]}
[0m03:17:05.898407 [info ] [MainThread]: Found 1 model, 423 macros
[0m03:17:05.898407 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '28e045f3-32af-41ab-95df-3cfdd7b80581', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018D891F28F0>]}
[0m03:17:05.900406 [info ] [MainThread]: 
[0m03:17:05.901411 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m03:17:05.902407 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_engineering_test'
[0m03:17:06.002404 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test"
[0m03:17:06.002925 [debug] [ThreadPool]: On list_data_engineering_test: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "list_data_engineering_test"} */

    select distinct nspname from pg_namespace
  
[0m03:17:06.003448 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m03:17:06.023161 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.020 seconds
[0m03:17:06.024797 [debug] [ThreadPool]: On list_data_engineering_test: Close
[0m03:17:06.026938 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_engineering_test_public'
[0m03:17:06.033754 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test_public"
[0m03:17:06.034494 [debug] [ThreadPool]: On list_data_engineering_test_public: BEGIN
[0m03:17:06.034494 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m03:17:06.049753 [debug] [ThreadPool]: SQL status: BEGIN in 0.015 seconds
[0m03:17:06.050753 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test_public"
[0m03:17:06.050753 [debug] [ThreadPool]: On list_data_engineering_test_public: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "list_data_engineering_test_public"} */
select
      'data_engineering_test' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_engineering_test' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_engineering_test' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m03:17:06.054767 [debug] [ThreadPool]: SQL status: SELECT 2 in 0.003 seconds
[0m03:17:06.055777 [debug] [ThreadPool]: On list_data_engineering_test_public: ROLLBACK
[0m03:17:06.057150 [debug] [ThreadPool]: On list_data_engineering_test_public: Close
[0m03:17:06.062834 [debug] [MainThread]: Using postgres connection "master"
[0m03:17:06.063360 [debug] [MainThread]: On master: BEGIN
[0m03:17:06.063876 [debug] [MainThread]: Opening a new connection, currently in state init
[0m03:17:06.098092 [debug] [MainThread]: SQL status: BEGIN in 0.034 seconds
[0m03:17:06.099093 [debug] [MainThread]: Using postgres connection "master"
[0m03:17:06.099093 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m03:17:06.103597 [debug] [MainThread]: SQL status: SELECT 0 in 0.004 seconds
[0m03:17:06.104607 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '28e045f3-32af-41ab-95df-3cfdd7b80581', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018D891F1BD0>]}
[0m03:17:06.105766 [debug] [MainThread]: On master: ROLLBACK
[0m03:17:06.106271 [debug] [MainThread]: Using postgres connection "master"
[0m03:17:06.107281 [debug] [MainThread]: On master: BEGIN
[0m03:17:06.109281 [debug] [MainThread]: SQL status: BEGIN in 0.001 seconds
[0m03:17:06.109281 [debug] [MainThread]: On master: COMMIT
[0m03:17:06.109281 [debug] [MainThread]: Using postgres connection "master"
[0m03:17:06.110279 [debug] [MainThread]: On master: COMMIT
[0m03:17:06.111283 [debug] [MainThread]: SQL status: COMMIT in 0.001 seconds
[0m03:17:06.112280 [debug] [MainThread]: On master: Close
[0m03:17:06.112280 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m03:17:06.112280 [info ] [MainThread]: 
[0m03:17:06.116311 [debug] [Thread-1 (]: Began running node model.task_4.calculate_comissions
[0m03:17:06.116311 [info ] [Thread-1 (]: 1 of 1 START sql view model public.calculate_comissions ........................ [RUN]
[0m03:17:06.117311 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.task_4.calculate_comissions'
[0m03:17:06.118313 [debug] [Thread-1 (]: Began compiling node model.task_4.calculate_comissions
[0m03:17:06.123816 [debug] [Thread-1 (]: Writing injected SQL for node "model.task_4.calculate_comissions"
[0m03:17:06.125329 [debug] [Thread-1 (]: Began executing node model.task_4.calculate_comissions
[0m03:17:06.210527 [debug] [Thread-1 (]: Writing runtime sql for node "model.task_4.calculate_comissions"
[0m03:17:06.211528 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m03:17:06.212528 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: BEGIN
[0m03:17:06.212528 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m03:17:06.226805 [debug] [Thread-1 (]: SQL status: BEGIN in 0.014 seconds
[0m03:17:06.226805 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m03:17:06.227805 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */

  create view "data_engineering_test"."public"."calculate_comissions__dbt_tmp"
    
    
  as (
    WITH salesowners AS (
    SELECT
        o.order_id,
        unnest(string_to_array(o.salesowners, ', ')) AS salesowner,

        -- Converting the gross value to euros then substracting the vat to get the net value in euros
        ((i.gross_value / 100.0) * (100+i.vat))/100 AS net_value_in_euros

    FROM
        public.orders o
    JOIN
        public.invoicing_data i ON o.order_id = i.order_id
),
commission_calc AS (
    SELECT
        order_id,
        salesowner,
        CASE 
            WHEN row_number() OVER (PARTITION BY order_id ORDER BY salesowner) = 1 THEN net_value_in_euros * 0.06  -- Main Owner - 6%
            WHEN row_number() OVER (PARTITION BY order_id ORDER BY salesowner) = 2 THEN net_value_in_euros * 0.025  -- Co-owner 1 - 2.5%
            WHEN row_number() OVER (PARTITION BY order_id ORDER BY salesowner) = 3 THEN net_value_in_euros * 0.0095  -- Co-owner 2 - 0.95%
            ELSE 0  -- No commission for others
        END AS commission
    FROM salesowners
)
SELECT
    salesowner,
    SUM(commission) AS total_commission
FROM commission_calc
GROUP BY salesowner
ORDER BY total_commission DESC
  );
[0m03:17:06.236041 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.007 seconds
[0m03:17:06.242042 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m03:17:06.243042 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */
alter table "data_engineering_test"."public"."calculate_comissions__dbt_tmp" rename to "calculate_comissions"
[0m03:17:06.245558 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m03:17:06.259259 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: COMMIT
[0m03:17:06.260262 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m03:17:06.260262 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: COMMIT
[0m03:17:06.265338 [debug] [Thread-1 (]: SQL status: COMMIT in 0.004 seconds
[0m03:17:06.271352 [debug] [Thread-1 (]: Applying DROP to: "data_engineering_test"."public"."calculate_comissions__dbt_backup"
[0m03:17:06.276075 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m03:17:06.276934 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */
drop view if exists "data_engineering_test"."public"."calculate_comissions__dbt_backup" cascade
[0m03:17:06.278934 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.001 seconds
[0m03:17:06.280930 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: Close
[0m03:17:06.282931 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '28e045f3-32af-41ab-95df-3cfdd7b80581', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018D84FB9F30>]}
[0m03:17:06.283931 [info ] [Thread-1 (]: 1 of 1 OK created sql view model public.calculate_comissions ................... [[32mCREATE VIEW[0m in 0.16s]
[0m03:17:06.284490 [debug] [Thread-1 (]: Finished running node model.task_4.calculate_comissions
[0m03:17:06.286499 [debug] [MainThread]: Using postgres connection "master"
[0m03:17:06.286499 [debug] [MainThread]: On master: BEGIN
[0m03:17:06.287498 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m03:17:06.300729 [debug] [MainThread]: SQL status: BEGIN in 0.013 seconds
[0m03:17:06.300729 [debug] [MainThread]: On master: COMMIT
[0m03:17:06.301728 [debug] [MainThread]: Using postgres connection "master"
[0m03:17:06.301728 [debug] [MainThread]: On master: COMMIT
[0m03:17:06.302730 [debug] [MainThread]: SQL status: COMMIT in 0.001 seconds
[0m03:17:06.303728 [debug] [MainThread]: On master: Close
[0m03:17:06.304819 [debug] [MainThread]: Connection 'master' was properly closed.
[0m03:17:06.304819 [debug] [MainThread]: Connection 'list_data_engineering_test' was properly closed.
[0m03:17:06.305751 [debug] [MainThread]: Connection 'list_data_engineering_test_public' was properly closed.
[0m03:17:06.305751 [debug] [MainThread]: Connection 'model.task_4.calculate_comissions' was properly closed.
[0m03:17:06.306759 [info ] [MainThread]: 
[0m03:17:06.306759 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 0.41 seconds (0.41s).
[0m03:17:06.307763 [debug] [MainThread]: Command end result
[0m03:17:06.334302 [info ] [MainThread]: 
[0m03:17:06.334808 [info ] [MainThread]: [32mCompleted successfully[0m
[0m03:17:06.335816 [info ] [MainThread]: 
[0m03:17:06.335816 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m03:17:06.337819 [debug] [MainThread]: Command `dbt run` succeeded at 03:17:06.337819 after 1.20 seconds
[0m03:17:06.338819 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018D86294DF0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018D85DE6230>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018D88A93370>]}
[0m03:17:06.339817 [debug] [MainThread]: Flushing usage events
[0m03:17:53.235565 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023078600E80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002307B1225F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002307B1220E0>]}


============================== 03:17:53.239574 | e791bd98-1c6c-457a-86aa-84d1880b52d4 ==============================
[0m03:17:53.239574 [info ] [MainThread]: Running with dbt=1.8.8
[0m03:17:53.240574 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'src\\task_4\\dbt\\logs', 'debug': 'False', 'profiles_dir': 'src/task_4/dbt', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'introspect': 'True', 'invocation_command': 'dbt run --profiles-dir src/task_4/dbt --project-dir src/task_4/dbt', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m03:17:53.428571 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'e791bd98-1c6c-457a-86aa-84d1880b52d4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002307B2E2740>]}
[0m03:17:53.477838 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'e791bd98-1c6c-457a-86aa-84d1880b52d4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023078136AA0>]}
[0m03:17:53.479841 [info ] [MainThread]: Registered adapter: postgres=1.8.2
[0m03:17:53.488398 [debug] [MainThread]: checksum: ec53e341a936509427e16df1c646386a84befec52c1957e3f4359fbc36fc93f5, vars: {}, profile: , target: , version: 1.8.8
[0m03:17:53.640366 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m03:17:53.641367 [debug] [MainThread]: Partial parsing: updated file: task_4://models\calculate_comissions.sql
[0m03:17:53.841511 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'e791bd98-1c6c-457a-86aa-84d1880b52d4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002307B6DD270>]}
[0m03:17:53.933801 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'e791bd98-1c6c-457a-86aa-84d1880b52d4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002307B54E980>]}
[0m03:17:53.934807 [info ] [MainThread]: Found 1 model, 423 macros
[0m03:17:53.934807 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e791bd98-1c6c-457a-86aa-84d1880b52d4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002307B54E9B0>]}
[0m03:17:53.936816 [info ] [MainThread]: 
[0m03:17:53.937815 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m03:17:53.938815 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_engineering_test'
[0m03:17:54.022772 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test"
[0m03:17:54.023772 [debug] [ThreadPool]: On list_data_engineering_test: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "list_data_engineering_test"} */

    select distinct nspname from pg_namespace
  
[0m03:17:54.024281 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m03:17:54.042127 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.018 seconds
[0m03:17:54.043634 [debug] [ThreadPool]: On list_data_engineering_test: Close
[0m03:17:54.044642 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_engineering_test_public'
[0m03:17:54.050790 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test_public"
[0m03:17:54.051795 [debug] [ThreadPool]: On list_data_engineering_test_public: BEGIN
[0m03:17:54.051795 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m03:17:54.065747 [debug] [ThreadPool]: SQL status: BEGIN in 0.013 seconds
[0m03:17:54.065747 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test_public"
[0m03:17:54.066744 [debug] [ThreadPool]: On list_data_engineering_test_public: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "list_data_engineering_test_public"} */
select
      'data_engineering_test' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_engineering_test' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_engineering_test' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m03:17:54.069744 [debug] [ThreadPool]: SQL status: SELECT 2 in 0.003 seconds
[0m03:17:54.071748 [debug] [ThreadPool]: On list_data_engineering_test_public: ROLLBACK
[0m03:17:54.072744 [debug] [ThreadPool]: On list_data_engineering_test_public: Close
[0m03:17:54.076608 [debug] [MainThread]: Using postgres connection "master"
[0m03:17:54.077609 [debug] [MainThread]: On master: BEGIN
[0m03:17:54.077609 [debug] [MainThread]: Opening a new connection, currently in state init
[0m03:17:54.105990 [debug] [MainThread]: SQL status: BEGIN in 0.028 seconds
[0m03:17:54.106998 [debug] [MainThread]: Using postgres connection "master"
[0m03:17:54.107999 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m03:17:54.112002 [debug] [MainThread]: SQL status: SELECT 0 in 0.004 seconds
[0m03:17:54.112998 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e791bd98-1c6c-457a-86aa-84d1880b52d4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002307B5371C0>]}
[0m03:17:54.114000 [debug] [MainThread]: On master: ROLLBACK
[0m03:17:54.114507 [debug] [MainThread]: Using postgres connection "master"
[0m03:17:54.115517 [debug] [MainThread]: On master: BEGIN
[0m03:17:54.116517 [debug] [MainThread]: SQL status: BEGIN in 0.001 seconds
[0m03:17:54.117518 [debug] [MainThread]: On master: COMMIT
[0m03:17:54.117518 [debug] [MainThread]: Using postgres connection "master"
[0m03:17:54.118517 [debug] [MainThread]: On master: COMMIT
[0m03:17:54.119517 [debug] [MainThread]: SQL status: COMMIT in 0.001 seconds
[0m03:17:54.119517 [debug] [MainThread]: On master: Close
[0m03:17:54.120516 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m03:17:54.120516 [info ] [MainThread]: 
[0m03:17:54.122517 [debug] [Thread-1 (]: Began running node model.task_4.calculate_comissions
[0m03:17:54.124540 [info ] [Thread-1 (]: 1 of 1 START sql view model public.calculate_comissions ........................ [RUN]
[0m03:17:54.124540 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.task_4.calculate_comissions'
[0m03:17:54.125731 [debug] [Thread-1 (]: Began compiling node model.task_4.calculate_comissions
[0m03:17:54.131289 [debug] [Thread-1 (]: Writing injected SQL for node "model.task_4.calculate_comissions"
[0m03:17:54.132285 [debug] [Thread-1 (]: Began executing node model.task_4.calculate_comissions
[0m03:17:54.216674 [debug] [Thread-1 (]: Writing runtime sql for node "model.task_4.calculate_comissions"
[0m03:17:54.217677 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m03:17:54.218672 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: BEGIN
[0m03:17:54.218672 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m03:17:54.233703 [debug] [Thread-1 (]: SQL status: BEGIN in 0.014 seconds
[0m03:17:54.234209 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m03:17:54.234716 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */

  create view "data_engineering_test"."public"."calculate_comissions__dbt_tmp"
    
    
  as (
    WITH salesowners AS (
    SELECT
        o.order_id,
        unnest(string_to_array(o.salesowners, ', ')) AS salesowner,

        -- Converting the gross value to euros then substracting the vat to get the net value in euros
        (i.gross_value / 100.0) / (1 + i.vat / 100.0) AS net_value_in_euros

    FROM
        public.orders o
    JOIN
        public.invoicing_data i ON o.order_id = i.order_id
),
commission_calc AS (
    SELECT
        order_id,
        salesowner,
        CASE 
            WHEN row_number() OVER (PARTITION BY order_id ORDER BY salesowner) = 1 THEN net_value_in_euros * 0.06  -- Main Owner - 6%
            WHEN row_number() OVER (PARTITION BY order_id ORDER BY salesowner) = 2 THEN net_value_in_euros * 0.025  -- Co-owner 1 - 2.5%
            WHEN row_number() OVER (PARTITION BY order_id ORDER BY salesowner) = 3 THEN net_value_in_euros * 0.0095  -- Co-owner 2 - 0.95%
            ELSE 0  -- No commission for others
        END AS commission
    FROM salesowners
)
SELECT
    salesowner,
    SUM(commission) AS total_commission
FROM commission_calc
GROUP BY salesowner
ORDER BY total_commission DESC
  );
[0m03:17:54.242723 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.008 seconds
[0m03:17:54.249000 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m03:17:54.250005 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */
alter table "data_engineering_test"."public"."calculate_comissions__dbt_tmp" rename to "calculate_comissions"
[0m03:17:54.252001 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m03:17:54.264538 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: COMMIT
[0m03:17:54.265755 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m03:17:54.265755 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: COMMIT
[0m03:17:54.268764 [debug] [Thread-1 (]: SQL status: COMMIT in 0.002 seconds
[0m03:17:54.274773 [debug] [Thread-1 (]: Applying DROP to: "data_engineering_test"."public"."calculate_comissions__dbt_backup"
[0m03:17:54.278784 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m03:17:54.279780 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */
drop view if exists "data_engineering_test"."public"."calculate_comissions__dbt_backup" cascade
[0m03:17:54.280785 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.001 seconds
[0m03:17:54.283923 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: Close
[0m03:17:54.284935 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e791bd98-1c6c-457a-86aa-84d1880b52d4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023077319FC0>]}
[0m03:17:54.285946 [info ] [Thread-1 (]: 1 of 1 OK created sql view model public.calculate_comissions ................... [[32mCREATE VIEW[0m in 0.16s]
[0m03:17:54.286945 [debug] [Thread-1 (]: Finished running node model.task_4.calculate_comissions
[0m03:17:54.287944 [debug] [MainThread]: Using postgres connection "master"
[0m03:17:54.288944 [debug] [MainThread]: On master: BEGIN
[0m03:17:54.288944 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m03:17:54.324060 [debug] [MainThread]: SQL status: BEGIN in 0.035 seconds
[0m03:17:54.324565 [debug] [MainThread]: On master: COMMIT
[0m03:17:54.324565 [debug] [MainThread]: Using postgres connection "master"
[0m03:17:54.325574 [debug] [MainThread]: On master: COMMIT
[0m03:17:54.326573 [debug] [MainThread]: SQL status: COMMIT in 0.001 seconds
[0m03:17:54.326573 [debug] [MainThread]: On master: Close
[0m03:17:54.327572 [debug] [MainThread]: Connection 'master' was properly closed.
[0m03:17:54.327572 [debug] [MainThread]: Connection 'list_data_engineering_test' was properly closed.
[0m03:17:54.328574 [debug] [MainThread]: Connection 'list_data_engineering_test_public' was properly closed.
[0m03:17:54.328574 [debug] [MainThread]: Connection 'model.task_4.calculate_comissions' was properly closed.
[0m03:17:54.329572 [info ] [MainThread]: 
[0m03:17:54.329572 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 0.39 seconds (0.39s).
[0m03:17:54.330570 [debug] [MainThread]: Command end result
[0m03:17:54.356836 [info ] [MainThread]: 
[0m03:17:54.357833 [info ] [MainThread]: [32mCompleted successfully[0m
[0m03:17:54.357833 [info ] [MainThread]: 
[0m03:17:54.358835 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m03:17:54.359836 [debug] [MainThread]: Command `dbt run` succeeded at 03:17:54.359836 after 1.19 seconds
[0m03:17:54.360836 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023078600E80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023074BDB220>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023078126AA0>]}
[0m03:17:54.361836 [debug] [MainThread]: Flushing usage events
[0m03:36:08.374931 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FFE15E4E50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FFE4111D50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FFE4113DC0>]}


============================== 03:36:08.378938 | a80c2f90-1db4-4cc3-8959-62a4d6f8065f ==============================
[0m03:36:08.378938 [info ] [MainThread]: Running with dbt=1.8.8
[0m03:36:08.379938 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'src\\task_4\\dbt\\logs', 'version_check': 'True', 'profiles_dir': 'src/task_4/dbt', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'log_format': 'default', 'invocation_command': 'dbt run --profiles-dir src/task_4/dbt --project-dir src/task_4/dbt', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m03:36:08.596488 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'a80c2f90-1db4-4cc3-8959-62a4d6f8065f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FFE42D2590>]}
[0m03:36:08.645900 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'a80c2f90-1db4-4cc3-8959-62a4d6f8065f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FFE1132A70>]}
[0m03:36:08.647902 [info ] [MainThread]: Registered adapter: postgres=1.8.2
[0m03:36:08.657045 [debug] [MainThread]: checksum: ec53e341a936509427e16df1c646386a84befec52c1957e3f4359fbc36fc93f5, vars: {}, profile: , target: , version: 1.8.8
[0m03:36:08.826288 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m03:36:08.826288 [debug] [MainThread]: Partial parsing: updated file: task_4://models\calculate_comissions.sql
[0m03:36:09.029931 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'a80c2f90-1db4-4cc3-8959-62a4d6f8065f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FFE46CD240>]}
[0m03:36:09.121938 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'a80c2f90-1db4-4cc3-8959-62a4d6f8065f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FFE4542980>]}
[0m03:36:09.122939 [info ] [MainThread]: Found 1 model, 423 macros
[0m03:36:09.123953 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'a80c2f90-1db4-4cc3-8959-62a4d6f8065f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FFE4542920>]}
[0m03:36:09.124961 [info ] [MainThread]: 
[0m03:36:09.125958 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m03:36:09.127959 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_engineering_test'
[0m03:36:09.215217 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test"
[0m03:36:09.216223 [debug] [ThreadPool]: On list_data_engineering_test: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "list_data_engineering_test"} */

    select distinct nspname from pg_namespace
  
[0m03:36:09.216223 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m03:36:09.239643 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.023 seconds
[0m03:36:09.241642 [debug] [ThreadPool]: On list_data_engineering_test: Close
[0m03:36:09.243147 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_engineering_test_public'
[0m03:36:09.248671 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test_public"
[0m03:36:09.248671 [debug] [ThreadPool]: On list_data_engineering_test_public: BEGIN
[0m03:36:09.249673 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m03:36:09.263918 [debug] [ThreadPool]: SQL status: BEGIN in 0.014 seconds
[0m03:36:09.263918 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test_public"
[0m03:36:09.264925 [debug] [ThreadPool]: On list_data_engineering_test_public: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "list_data_engineering_test_public"} */
select
      'data_engineering_test' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_engineering_test' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_engineering_test' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m03:36:09.268923 [debug] [ThreadPool]: SQL status: SELECT 2 in 0.003 seconds
[0m03:36:09.269925 [debug] [ThreadPool]: On list_data_engineering_test_public: ROLLBACK
[0m03:36:09.270928 [debug] [ThreadPool]: On list_data_engineering_test_public: Close
[0m03:36:09.275942 [debug] [MainThread]: Using postgres connection "master"
[0m03:36:09.275942 [debug] [MainThread]: On master: BEGIN
[0m03:36:09.276946 [debug] [MainThread]: Opening a new connection, currently in state init
[0m03:36:09.301654 [debug] [MainThread]: SQL status: BEGIN in 0.025 seconds
[0m03:36:09.303158 [debug] [MainThread]: Using postgres connection "master"
[0m03:36:09.303670 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m03:36:09.307681 [debug] [MainThread]: SQL status: SELECT 0 in 0.004 seconds
[0m03:36:09.308678 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'a80c2f90-1db4-4cc3-8959-62a4d6f8065f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FFE45271F0>]}
[0m03:36:09.309675 [debug] [MainThread]: On master: ROLLBACK
[0m03:36:09.310678 [debug] [MainThread]: Using postgres connection "master"
[0m03:36:09.311678 [debug] [MainThread]: On master: BEGIN
[0m03:36:09.313189 [debug] [MainThread]: SQL status: BEGIN in 0.001 seconds
[0m03:36:09.313706 [debug] [MainThread]: On master: COMMIT
[0m03:36:09.313706 [debug] [MainThread]: Using postgres connection "master"
[0m03:36:09.313706 [debug] [MainThread]: On master: COMMIT
[0m03:36:09.315216 [debug] [MainThread]: SQL status: COMMIT in 0.001 seconds
[0m03:36:09.315216 [debug] [MainThread]: On master: Close
[0m03:36:09.316223 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m03:36:09.317224 [info ] [MainThread]: 
[0m03:36:09.320221 [debug] [Thread-1 (]: Began running node model.task_4.calculate_comissions
[0m03:36:09.321227 [info ] [Thread-1 (]: 1 of 1 START sql view model public.calculate_comissions ........................ [RUN]
[0m03:36:09.322227 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.task_4.calculate_comissions'
[0m03:36:09.322227 [debug] [Thread-1 (]: Began compiling node model.task_4.calculate_comissions
[0m03:36:09.328745 [debug] [Thread-1 (]: Writing injected SQL for node "model.task_4.calculate_comissions"
[0m03:36:09.330755 [debug] [Thread-1 (]: Began executing node model.task_4.calculate_comissions
[0m03:36:09.413945 [debug] [Thread-1 (]: Writing runtime sql for node "model.task_4.calculate_comissions"
[0m03:36:09.416482 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m03:36:09.417482 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: BEGIN
[0m03:36:09.417482 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m03:36:09.432981 [debug] [Thread-1 (]: SQL status: BEGIN in 0.015 seconds
[0m03:36:09.433915 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m03:36:09.433915 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */

  create view "data_engineering_test"."public"."calculate_comissions__dbt_tmp"
    
    
  as (
    WITH orders_with_salesowners AS (
    SELECT
        o.order_id,
        i.gross_value / 100.0 AS gross_value_in_euros,

        -- Converting the gross value into net value by taking the vat out in a non-lineal way.
        (i.gross_value / 100.0) / (1 + i.vat / 100.0) AS net_value_in_euros,
        string_to_array(o.salesowners, ', ') AS salesowners_array
    FROM
        public.orders o
    JOIN
        public.invoicing_data i ON o.order_id = i.order_id
),
salesowners AS (
    SELECT
        ows.order_id,
        ows.net_value_in_euros,
        so.salesowner,
        so.ordinality AS salesowner_position
    FROM
        orders_with_salesowners ows,
        unnest(ows.salesowners_array) WITH ORDINALITY AS so(salesowner, ordinality) -- unnests the array and assigns the order for each sales person in the order that it comes from the file
),
commission_calc AS (
    SELECT
        order_id,
        salesowner,
        CASE 
            WHEN salesowner_position = 1 THEN net_value_in_euros * 0.06    -- Main owner - 6%
            WHEN salesowner_position = 2 THEN net_value_in_euros * 0.025   -- Co-owner 1 - 2.5%
            WHEN salesowner_position = 3 THEN net_value_in_euros * 0.0095  -- Co-owner 2 - 0.95%
            ELSE 0  -- No comission
        END AS commission
    FROM salesowners
)
SELECT
    salesowner,
    SUM(commission) AS total_commission
FROM commission_calc
GROUP BY salesowner
ORDER BY total_commission DESC
  );
[0m03:36:09.444889 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.010 seconds
[0m03:36:09.451093 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m03:36:09.452089 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */
alter table "data_engineering_test"."public"."calculate_comissions__dbt_tmp" rename to "calculate_comissions"
[0m03:36:09.454001 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m03:36:09.467174 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: COMMIT
[0m03:36:09.467174 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m03:36:09.468174 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: COMMIT
[0m03:36:09.472178 [debug] [Thread-1 (]: SQL status: COMMIT in 0.004 seconds
[0m03:36:09.478684 [debug] [Thread-1 (]: Applying DROP to: "data_engineering_test"."public"."calculate_comissions__dbt_backup"
[0m03:36:09.481685 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m03:36:09.483701 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */
drop view if exists "data_engineering_test"."public"."calculate_comissions__dbt_backup" cascade
[0m03:36:09.484882 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.001 seconds
[0m03:36:09.486887 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: Close
[0m03:36:09.488893 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a80c2f90-1db4-4cc3-8959-62a4d6f8065f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FFE0309F90>]}
[0m03:36:09.489891 [info ] [Thread-1 (]: 1 of 1 OK created sql view model public.calculate_comissions ................... [[32mCREATE VIEW[0m in 0.17s]
[0m03:36:09.490891 [debug] [Thread-1 (]: Finished running node model.task_4.calculate_comissions
[0m03:36:09.491890 [debug] [MainThread]: Using postgres connection "master"
[0m03:36:09.491890 [debug] [MainThread]: On master: BEGIN
[0m03:36:09.492889 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m03:36:09.506920 [debug] [MainThread]: SQL status: BEGIN in 0.014 seconds
[0m03:36:09.506920 [debug] [MainThread]: On master: COMMIT
[0m03:36:09.507923 [debug] [MainThread]: Using postgres connection "master"
[0m03:36:09.507923 [debug] [MainThread]: On master: COMMIT
[0m03:36:09.508919 [debug] [MainThread]: SQL status: COMMIT in 0.001 seconds
[0m03:36:09.509923 [debug] [MainThread]: On master: Close
[0m03:36:09.509923 [debug] [MainThread]: Connection 'master' was properly closed.
[0m03:36:09.510920 [debug] [MainThread]: Connection 'list_data_engineering_test' was properly closed.
[0m03:36:09.510920 [debug] [MainThread]: Connection 'list_data_engineering_test_public' was properly closed.
[0m03:36:09.511928 [debug] [MainThread]: Connection 'model.task_4.calculate_comissions' was properly closed.
[0m03:36:09.511928 [info ] [MainThread]: 
[0m03:36:09.512920 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 0.39 seconds (0.39s).
[0m03:36:09.514021 [debug] [MainThread]: Command end result
[0m03:36:09.540718 [info ] [MainThread]: 
[0m03:36:09.540718 [info ] [MainThread]: [32mCompleted successfully[0m
[0m03:36:09.541720 [info ] [MainThread]: 
[0m03:36:09.541720 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m03:36:09.543746 [debug] [MainThread]: Command `dbt run` succeeded at 03:36:09.543746 after 1.24 seconds
[0m03:36:09.544753 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FFE15E4E50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FFDDBDB220>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FFE356B7F0>]}
[0m03:36:09.545750 [debug] [MainThread]: Flushing usage events
[0m03:38:04.257488 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F2B4C84DC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F2B77B3B80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F2B77B2530>]}


============================== 03:38:04.261500 | fc4332a6-9667-48f9-a180-de5072e58ac1 ==============================
[0m03:38:04.261500 [info ] [MainThread]: Running with dbt=1.8.8
[0m03:38:04.262508 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'src/task_4/dbt', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'src\\task_4\\dbt\\logs', 'debug': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'log_format': 'default', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --profiles-dir src/task_4/dbt --project-dir src/task_4/dbt', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m03:38:04.453061 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'fc4332a6-9667-48f9-a180-de5072e58ac1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F2B793EA70>]}
[0m03:38:04.503202 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'fc4332a6-9667-48f9-a180-de5072e58ac1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F2B47C6A40>]}
[0m03:38:04.504204 [info ] [MainThread]: Registered adapter: postgres=1.8.2
[0m03:38:04.512863 [debug] [MainThread]: checksum: ec53e341a936509427e16df1c646386a84befec52c1957e3f4359fbc36fc93f5, vars: {}, profile: , target: , version: 1.8.8
[0m03:38:04.665385 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m03:38:04.666386 [debug] [MainThread]: Partial parsing: updated file: task_4://models\calculate_comissions.sql
[0m03:38:04.858897 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'fc4332a6-9667-48f9-a180-de5072e58ac1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F2B7D6D1B0>]}
[0m03:38:04.946506 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'fc4332a6-9667-48f9-a180-de5072e58ac1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F2B7BE1840>]}
[0m03:38:04.947507 [info ] [MainThread]: Found 1 model, 423 macros
[0m03:38:04.948509 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'fc4332a6-9667-48f9-a180-de5072e58ac1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F2B7BE1A80>]}
[0m03:38:04.949507 [info ] [MainThread]: 
[0m03:38:04.950509 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m03:38:04.952646 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_engineering_test'
[0m03:38:05.040618 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test"
[0m03:38:05.040618 [debug] [ThreadPool]: On list_data_engineering_test: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "list_data_engineering_test"} */

    select distinct nspname from pg_namespace
  
[0m03:38:05.041790 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m03:38:05.058955 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.018 seconds
[0m03:38:05.061472 [debug] [ThreadPool]: On list_data_engineering_test: Close
[0m03:38:05.062985 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_engineering_test_public'
[0m03:38:05.067982 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test_public"
[0m03:38:05.068982 [debug] [ThreadPool]: On list_data_engineering_test_public: BEGIN
[0m03:38:05.068982 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m03:38:05.082966 [debug] [ThreadPool]: SQL status: BEGIN in 0.014 seconds
[0m03:38:05.083972 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test_public"
[0m03:38:05.084972 [debug] [ThreadPool]: On list_data_engineering_test_public: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "list_data_engineering_test_public"} */
select
      'data_engineering_test' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_engineering_test' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_engineering_test' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m03:38:05.088975 [debug] [ThreadPool]: SQL status: SELECT 2 in 0.004 seconds
[0m03:38:05.088975 [debug] [ThreadPool]: On list_data_engineering_test_public: ROLLBACK
[0m03:38:05.091490 [debug] [ThreadPool]: On list_data_engineering_test_public: Close
[0m03:38:05.095653 [debug] [MainThread]: Using postgres connection "master"
[0m03:38:05.095653 [debug] [MainThread]: On master: BEGIN
[0m03:38:05.096654 [debug] [MainThread]: Opening a new connection, currently in state init
[0m03:38:05.110443 [debug] [MainThread]: SQL status: BEGIN in 0.014 seconds
[0m03:38:05.111568 [debug] [MainThread]: Using postgres connection "master"
[0m03:38:05.112576 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m03:38:05.116581 [debug] [MainThread]: SQL status: SELECT 0 in 0.004 seconds
[0m03:38:05.117583 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'fc4332a6-9667-48f9-a180-de5072e58ac1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F2B7A0C580>]}
[0m03:38:05.117583 [debug] [MainThread]: On master: ROLLBACK
[0m03:38:05.119173 [debug] [MainThread]: Using postgres connection "master"
[0m03:38:05.120692 [debug] [MainThread]: On master: BEGIN
[0m03:38:05.122822 [debug] [MainThread]: SQL status: BEGIN in 0.001 seconds
[0m03:38:05.122822 [debug] [MainThread]: On master: COMMIT
[0m03:38:05.123348 [debug] [MainThread]: Using postgres connection "master"
[0m03:38:05.123348 [debug] [MainThread]: On master: COMMIT
[0m03:38:05.124356 [debug] [MainThread]: SQL status: COMMIT in 0.001 seconds
[0m03:38:05.125355 [debug] [MainThread]: On master: Close
[0m03:38:05.125355 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m03:38:05.126355 [info ] [MainThread]: 
[0m03:38:05.129357 [debug] [Thread-1 (]: Began running node model.task_4.calculate_comissions
[0m03:38:05.129357 [info ] [Thread-1 (]: 1 of 1 START sql view model public.calculate_comissions ........................ [RUN]
[0m03:38:05.131383 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.task_4.calculate_comissions'
[0m03:38:05.131383 [debug] [Thread-1 (]: Began compiling node model.task_4.calculate_comissions
[0m03:38:05.137954 [debug] [Thread-1 (]: Writing injected SQL for node "model.task_4.calculate_comissions"
[0m03:38:05.138958 [debug] [Thread-1 (]: Began executing node model.task_4.calculate_comissions
[0m03:38:05.224835 [debug] [Thread-1 (]: Writing runtime sql for node "model.task_4.calculate_comissions"
[0m03:38:05.226837 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m03:38:05.226837 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: BEGIN
[0m03:38:05.227835 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m03:38:05.253594 [debug] [Thread-1 (]: SQL status: BEGIN in 0.026 seconds
[0m03:38:05.254595 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m03:38:05.255594 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */

  create view "data_engineering_test"."public"."calculate_comissions__dbt_tmp"
    
    
  as (
    WITH orders_with_salesowners AS (
    SELECT
        o.order_id,
        ROUND(i.gross_value / 100.0, 2) AS gross_value_in_euros,

        -- Converting the gross value into net value by taking the vat out in a non-lineal way.
        ROUND((i.gross_value / 100.0) / (1 + i.vat / 100.0), 2) AS net_value_in_euros,
        string_to_array(o.salesowners, ', ') AS salesowners_array
    FROM
        public.orders o
    JOIN
        public.invoicing_data i ON o.order_id = i.order_id
),
salesowners AS (
    SELECT
        ows.order_id,
        ows.net_value_in_euros,
        so.salesowner,
        so.ordinality AS salesowner_position
    FROM
        orders_with_salesowners ows,
        unnest(ows.salesowners_array) WITH ORDINALITY AS so(salesowner, ordinality) -- unnests the array and assigns the order for each sales person in the order that it comes from the file
),
commission_calc AS (
    SELECT
        order_id,
        salesowner,
        CASE 
            WHEN salesowner_position = 1 THEN net_value_in_euros * 0.06    -- Main owner - 6%
            WHEN salesowner_position = 2 THEN net_value_in_euros * 0.025   -- Co-owner 1 - 2.5%
            WHEN salesowner_position = 3 THEN net_value_in_euros * 0.0095  -- Co-owner 2 - 0.95%
            ELSE 0  -- No comission
        END AS commission
    FROM salesowners
)
SELECT
    salesowner,
    SUM(commission) AS total_commission
FROM commission_calc
GROUP BY salesowner
ORDER BY total_commission DESC
  );
[0m03:38:05.266796 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.011 seconds
[0m03:38:05.272813 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m03:38:05.273812 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */
alter table "data_engineering_test"."public"."calculate_comissions__dbt_tmp" rename to "calculate_comissions"
[0m03:38:05.275813 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.002 seconds
[0m03:38:05.289322 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: COMMIT
[0m03:38:05.289322 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m03:38:05.290827 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: COMMIT
[0m03:38:05.294453 [debug] [Thread-1 (]: SQL status: COMMIT in 0.004 seconds
[0m03:38:05.301463 [debug] [Thread-1 (]: Applying DROP to: "data_engineering_test"."public"."calculate_comissions__dbt_backup"
[0m03:38:05.305471 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m03:38:05.306469 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */
drop view if exists "data_engineering_test"."public"."calculate_comissions__dbt_backup" cascade
[0m03:38:05.308473 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.001 seconds
[0m03:38:05.310469 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: Close
[0m03:38:05.311483 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fc4332a6-9667-48f9-a180-de5072e58ac1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F2B39A9F00>]}
[0m03:38:05.312745 [info ] [Thread-1 (]: 1 of 1 OK created sql view model public.calculate_comissions ................... [[32mCREATE VIEW[0m in 0.18s]
[0m03:38:05.313751 [debug] [Thread-1 (]: Finished running node model.task_4.calculate_comissions
[0m03:38:05.314750 [debug] [MainThread]: Using postgres connection "master"
[0m03:38:05.315753 [debug] [MainThread]: On master: BEGIN
[0m03:38:05.315753 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m03:38:05.330424 [debug] [MainThread]: SQL status: BEGIN in 0.014 seconds
[0m03:38:05.330424 [debug] [MainThread]: On master: COMMIT
[0m03:38:05.331514 [debug] [MainThread]: Using postgres connection "master"
[0m03:38:05.331514 [debug] [MainThread]: On master: COMMIT
[0m03:38:05.332661 [debug] [MainThread]: SQL status: COMMIT in 0.001 seconds
[0m03:38:05.333523 [debug] [MainThread]: On master: Close
[0m03:38:05.334520 [debug] [MainThread]: Connection 'master' was properly closed.
[0m03:38:05.334520 [debug] [MainThread]: Connection 'list_data_engineering_test' was properly closed.
[0m03:38:05.334520 [debug] [MainThread]: Connection 'list_data_engineering_test_public' was properly closed.
[0m03:38:05.335521 [debug] [MainThread]: Connection 'model.task_4.calculate_comissions' was properly closed.
[0m03:38:05.335521 [info ] [MainThread]: 
[0m03:38:05.336523 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 0.39 seconds (0.39s).
[0m03:38:05.337426 [debug] [MainThread]: Command end result
[0m03:38:05.363434 [info ] [MainThread]: 
[0m03:38:05.364436 [info ] [MainThread]: [32mCompleted successfully[0m
[0m03:38:05.364436 [info ] [MainThread]: 
[0m03:38:05.365435 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m03:38:05.367438 [debug] [MainThread]: Command `dbt run` succeeded at 03:38:05.366432 after 1.17 seconds
[0m03:38:05.367438 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F2B4C84DC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F2B126B220>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F2B6C0C070>]}
[0m03:38:05.368433 [debug] [MainThread]: Flushing usage events
[0m03:39:02.128648 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C8C36F0E80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C8C62125F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C8C62120E0>]}


============================== 03:39:02.133710 | 99fcc5cf-e784-4e78-974a-9c7c99ce1567 ==============================
[0m03:39:02.133710 [info ] [MainThread]: Running with dbt=1.8.8
[0m03:39:02.134709 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'src/task_4/dbt', 'version_check': 'True', 'debug': 'False', 'log_path': 'src\\task_4\\dbt\\logs', 'warn_error': 'None', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'log_format': 'default', 'introspect': 'True', 'static_parser': 'True', 'invocation_command': 'dbt run --profiles-dir src/task_4/dbt --project-dir src/task_4/dbt', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m03:39:02.339578 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '99fcc5cf-e784-4e78-974a-9c7c99ce1567', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C8C63D2740>]}
[0m03:39:02.391570 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '99fcc5cf-e784-4e78-974a-9c7c99ce1567', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C8C3232AA0>]}
[0m03:39:02.393604 [info ] [MainThread]: Registered adapter: postgres=1.8.2
[0m03:39:02.402724 [debug] [MainThread]: checksum: ec53e341a936509427e16df1c646386a84befec52c1957e3f4359fbc36fc93f5, vars: {}, profile: , target: , version: 1.8.8
[0m03:39:02.563603 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m03:39:02.564602 [debug] [MainThread]: Partial parsing: updated file: task_4://models\calculate_comissions.sql
[0m03:39:02.779603 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '99fcc5cf-e784-4e78-974a-9c7c99ce1567', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C8C67D1270>]}
[0m03:39:02.871867 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '99fcc5cf-e784-4e78-974a-9c7c99ce1567', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C8C663E980>]}
[0m03:39:02.872921 [info ] [MainThread]: Found 1 model, 423 macros
[0m03:39:02.873468 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '99fcc5cf-e784-4e78-974a-9c7c99ce1567', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C8C663E9B0>]}
[0m03:39:02.876474 [info ] [MainThread]: 
[0m03:39:02.876474 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m03:39:02.878477 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_engineering_test'
[0m03:39:02.971321 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test"
[0m03:39:02.972328 [debug] [ThreadPool]: On list_data_engineering_test: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "list_data_engineering_test"} */

    select distinct nspname from pg_namespace
  
[0m03:39:02.972328 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m03:39:02.991390 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.019 seconds
[0m03:39:02.992535 [debug] [ThreadPool]: On list_data_engineering_test: Close
[0m03:39:02.994545 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_engineering_test_public'
[0m03:39:03.001869 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test_public"
[0m03:39:03.002800 [debug] [ThreadPool]: On list_data_engineering_test_public: BEGIN
[0m03:39:03.002800 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m03:39:03.017888 [debug] [ThreadPool]: SQL status: BEGIN in 0.015 seconds
[0m03:39:03.018891 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test_public"
[0m03:39:03.019889 [debug] [ThreadPool]: On list_data_engineering_test_public: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "list_data_engineering_test_public"} */
select
      'data_engineering_test' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_engineering_test' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_engineering_test' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m03:39:03.023402 [debug] [ThreadPool]: SQL status: SELECT 2 in 0.003 seconds
[0m03:39:03.025404 [debug] [ThreadPool]: On list_data_engineering_test_public: ROLLBACK
[0m03:39:03.027401 [debug] [ThreadPool]: On list_data_engineering_test_public: Close
[0m03:39:03.032699 [debug] [MainThread]: Using postgres connection "master"
[0m03:39:03.032699 [debug] [MainThread]: On master: BEGIN
[0m03:39:03.033705 [debug] [MainThread]: Opening a new connection, currently in state init
[0m03:39:03.060544 [debug] [MainThread]: SQL status: BEGIN in 0.026 seconds
[0m03:39:03.060544 [debug] [MainThread]: Using postgres connection "master"
[0m03:39:03.061553 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m03:39:03.067724 [debug] [MainThread]: SQL status: SELECT 0 in 0.005 seconds
[0m03:39:03.068724 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '99fcc5cf-e784-4e78-974a-9c7c99ce1567', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C8C66271C0>]}
[0m03:39:03.069723 [debug] [MainThread]: On master: ROLLBACK
[0m03:39:03.071433 [debug] [MainThread]: Using postgres connection "master"
[0m03:39:03.071433 [debug] [MainThread]: On master: BEGIN
[0m03:39:03.073439 [debug] [MainThread]: SQL status: BEGIN in 0.002 seconds
[0m03:39:03.074440 [debug] [MainThread]: On master: COMMIT
[0m03:39:03.075442 [debug] [MainThread]: Using postgres connection "master"
[0m03:39:03.075442 [debug] [MainThread]: On master: COMMIT
[0m03:39:03.076441 [debug] [MainThread]: SQL status: COMMIT in 0.001 seconds
[0m03:39:03.077442 [debug] [MainThread]: On master: Close
[0m03:39:03.078442 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m03:39:03.079440 [info ] [MainThread]: 
[0m03:39:03.082717 [debug] [Thread-1 (]: Began running node model.task_4.calculate_comissions
[0m03:39:03.083470 [info ] [Thread-1 (]: 1 of 1 START sql view model public.calculate_comissions ........................ [RUN]
[0m03:39:03.084471 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.task_4.calculate_comissions'
[0m03:39:03.085473 [debug] [Thread-1 (]: Began compiling node model.task_4.calculate_comissions
[0m03:39:03.092738 [debug] [Thread-1 (]: Writing injected SQL for node "model.task_4.calculate_comissions"
[0m03:39:03.093739 [debug] [Thread-1 (]: Began executing node model.task_4.calculate_comissions
[0m03:39:03.192504 [debug] [Thread-1 (]: Writing runtime sql for node "model.task_4.calculate_comissions"
[0m03:39:03.193504 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m03:39:03.194507 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: BEGIN
[0m03:39:03.194507 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m03:39:03.230765 [debug] [Thread-1 (]: SQL status: BEGIN in 0.036 seconds
[0m03:39:03.231773 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m03:39:03.232278 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */

  create view "data_engineering_test"."public"."calculate_comissions__dbt_tmp"
    
    
  as (
    WITH orders_with_salesowners AS (
    SELECT
        o.order_id,
        i.gross_value / 100.0 AS gross_value_in_euros,

        -- Converting the gross value into net value by taking the vat out in a non-lineal way.
        (i.gross_value / 100.0) / (1 + i.vat / 100.0) AS net_value_in_euros,
        string_to_array(o.salesowners, ', ') AS salesowners_array
    FROM
        public.orders o
    JOIN
        public.invoicing_data i ON o.order_id = i.order_id
),
salesowners AS (
    SELECT
        ows.order_id,
        ows.net_value_in_euros,
        so.salesowner,
        so.ordinality AS salesowner_position
    FROM
        orders_with_salesowners ows,
        unnest(ows.salesowners_array) WITH ORDINALITY AS so(salesowner, ordinality) -- unnests the array and assigns the order for each sales person in the order that it comes from the file
),
commission_calc AS (
    SELECT
        order_id,
        salesowner,
        CASE 
            WHEN salesowner_position = 1 THEN net_value_in_euros * 0.06    -- Main owner - 6%
            WHEN salesowner_position = 2 THEN net_value_in_euros * 0.025   -- Co-owner 1 - 2.5%
            WHEN salesowner_position = 3 THEN net_value_in_euros * 0.0095  -- Co-owner 2 - 0.95%
            ELSE 0  -- No comission
        END AS commission
    FROM salesowners
)
SELECT
    salesowner,
    ROUND(SUM(commission), 2) AS total_commission
FROM commission_calc
GROUP BY salesowner
ORDER BY total_commission DESC
  );
[0m03:39:03.238285 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.005 seconds
[0m03:39:03.244223 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m03:39:03.245223 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */
alter table "data_engineering_test"."public"."calculate_comissions__dbt_tmp" rename to "calculate_comissions"
[0m03:39:03.247227 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m03:39:03.262379 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: COMMIT
[0m03:39:03.263386 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m03:39:03.263386 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: COMMIT
[0m03:39:03.266385 [debug] [Thread-1 (]: SQL status: COMMIT in 0.002 seconds
[0m03:39:03.273420 [debug] [Thread-1 (]: Applying DROP to: "data_engineering_test"."public"."calculate_comissions__dbt_backup"
[0m03:39:03.278421 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m03:39:03.279421 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */
drop view if exists "data_engineering_test"."public"."calculate_comissions__dbt_backup" cascade
[0m03:39:03.281581 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.001 seconds
[0m03:39:03.284526 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: Close
[0m03:39:03.286526 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '99fcc5cf-e784-4e78-974a-9c7c99ce1567', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C8C2409FC0>]}
[0m03:39:03.287526 [info ] [Thread-1 (]: 1 of 1 OK created sql view model public.calculate_comissions ................... [[32mCREATE VIEW[0m in 0.20s]
[0m03:39:03.288526 [debug] [Thread-1 (]: Finished running node model.task_4.calculate_comissions
[0m03:39:03.289527 [debug] [MainThread]: Using postgres connection "master"
[0m03:39:03.290528 [debug] [MainThread]: On master: BEGIN
[0m03:39:03.291036 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m03:39:03.304575 [debug] [MainThread]: SQL status: BEGIN in 0.014 seconds
[0m03:39:03.305572 [debug] [MainThread]: On master: COMMIT
[0m03:39:03.306572 [debug] [MainThread]: Using postgres connection "master"
[0m03:39:03.306572 [debug] [MainThread]: On master: COMMIT
[0m03:39:03.307576 [debug] [MainThread]: SQL status: COMMIT in 0.001 seconds
[0m03:39:03.308572 [debug] [MainThread]: On master: Close
[0m03:39:03.309571 [debug] [MainThread]: Connection 'master' was properly closed.
[0m03:39:03.309571 [debug] [MainThread]: Connection 'list_data_engineering_test' was properly closed.
[0m03:39:03.310574 [debug] [MainThread]: Connection 'list_data_engineering_test_public' was properly closed.
[0m03:39:03.310574 [debug] [MainThread]: Connection 'model.task_4.calculate_comissions' was properly closed.
[0m03:39:03.311643 [info ] [MainThread]: 
[0m03:39:03.312820 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 0.44 seconds (0.44s).
[0m03:39:03.313653 [debug] [MainThread]: Command end result
[0m03:39:03.341372 [info ] [MainThread]: 
[0m03:39:03.342384 [info ] [MainThread]: [32mCompleted successfully[0m
[0m03:39:03.342590 [info ] [MainThread]: 
[0m03:39:03.343381 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m03:39:03.345379 [debug] [MainThread]: Command `dbt run` succeeded at 03:39:03.345379 after 1.29 seconds
[0m03:39:03.345379 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C8C36F0E80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C8BFCAB220>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C8C3216AA0>]}
[0m03:39:03.346380 [debug] [MainThread]: Flushing usage events
[0m04:04:48.476721 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016F33EC4FD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016F369EF3A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016F369EF730>]}


============================== 04:04:48.480721 | 198a99ce-229e-40a0-8c7c-1afea3f304e2 ==============================
[0m04:04:48.480721 [info ] [MainThread]: Running with dbt=1.8.8
[0m04:04:48.481720 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4\\dbt\\logs', 'fail_fast': 'False', 'profiles_dir': 'C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4/dbt', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --profiles-dir C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4/dbt --project-dir C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4/dbt', 'introspect': 'True', 'static_parser': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m04:04:48.678169 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '198a99ce-229e-40a0-8c7c-1afea3f304e2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016F3416A440>]}
[0m04:04:48.727165 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '198a99ce-229e-40a0-8c7c-1afea3f304e2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016F33A06BC0>]}
[0m04:04:48.729168 [info ] [MainThread]: Registered adapter: postgres=1.8.2
[0m04:04:48.737166 [debug] [MainThread]: checksum: ec53e341a936509427e16df1c646386a84befec52c1957e3f4359fbc36fc93f5, vars: {}, profile: , target: , version: 1.8.8
[0m04:04:48.898139 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m04:04:48.899139 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m04:04:48.926139 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '198a99ce-229e-40a0-8c7c-1afea3f304e2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016F36E68130>]}
[0m04:04:49.019492 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '198a99ce-229e-40a0-8c7c-1afea3f304e2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016F36E50AC0>]}
[0m04:04:49.020493 [info ] [MainThread]: Found 1 model, 423 macros
[0m04:04:49.020493 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '198a99ce-229e-40a0-8c7c-1afea3f304e2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016F36E50A60>]}
[0m04:04:49.022493 [info ] [MainThread]: 
[0m04:04:49.023493 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m04:04:49.024493 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_engineering_test'
[0m04:04:49.116511 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test"
[0m04:04:49.117512 [debug] [ThreadPool]: On list_data_engineering_test: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "list_data_engineering_test"} */

    select distinct nspname from pg_namespace
  
[0m04:04:49.117512 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m04:04:49.136509 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.019 seconds
[0m04:04:49.138509 [debug] [ThreadPool]: On list_data_engineering_test: Close
[0m04:04:49.140512 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_engineering_test_public'
[0m04:04:49.146510 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test_public"
[0m04:04:49.146510 [debug] [ThreadPool]: On list_data_engineering_test_public: BEGIN
[0m04:04:49.147509 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m04:04:49.163510 [debug] [ThreadPool]: SQL status: BEGIN in 0.016 seconds
[0m04:04:49.163510 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test_public"
[0m04:04:49.164510 [debug] [ThreadPool]: On list_data_engineering_test_public: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "list_data_engineering_test_public"} */
select
      'data_engineering_test' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_engineering_test' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_engineering_test' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m04:04:49.171514 [debug] [ThreadPool]: SQL status: SELECT 2 in 0.007 seconds
[0m04:04:49.172512 [debug] [ThreadPool]: On list_data_engineering_test_public: ROLLBACK
[0m04:04:49.174513 [debug] [ThreadPool]: On list_data_engineering_test_public: Close
[0m04:04:49.178512 [debug] [MainThread]: Using postgres connection "master"
[0m04:04:49.179510 [debug] [MainThread]: On master: BEGIN
[0m04:04:49.179510 [debug] [MainThread]: Opening a new connection, currently in state init
[0m04:04:49.196512 [debug] [MainThread]: SQL status: BEGIN in 0.017 seconds
[0m04:04:49.197511 [debug] [MainThread]: Using postgres connection "master"
[0m04:04:49.198512 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m04:04:49.204515 [debug] [MainThread]: SQL status: SELECT 0 in 0.006 seconds
[0m04:04:49.205512 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '198a99ce-229e-40a0-8c7c-1afea3f304e2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016F36E68550>]}
[0m04:04:49.206509 [debug] [MainThread]: On master: ROLLBACK
[0m04:04:49.207510 [debug] [MainThread]: Using postgres connection "master"
[0m04:04:49.208511 [debug] [MainThread]: On master: BEGIN
[0m04:04:49.210512 [debug] [MainThread]: SQL status: BEGIN in 0.001 seconds
[0m04:04:49.210512 [debug] [MainThread]: On master: COMMIT
[0m04:04:49.211512 [debug] [MainThread]: Using postgres connection "master"
[0m04:04:49.211512 [debug] [MainThread]: On master: COMMIT
[0m04:04:49.212510 [debug] [MainThread]: SQL status: COMMIT in 0.001 seconds
[0m04:04:49.212510 [debug] [MainThread]: On master: Close
[0m04:04:49.213510 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m04:04:49.214512 [info ] [MainThread]: 
[0m04:04:49.217510 [debug] [Thread-1 (]: Began running node model.task_4.calculate_comissions
[0m04:04:49.218513 [info ] [Thread-1 (]: 1 of 1 START sql view model public.calculate_comissions ........................ [RUN]
[0m04:04:49.219510 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.task_4.calculate_comissions'
[0m04:04:49.219510 [debug] [Thread-1 (]: Began compiling node model.task_4.calculate_comissions
[0m04:04:49.226509 [debug] [Thread-1 (]: Writing injected SQL for node "model.task_4.calculate_comissions"
[0m04:04:49.227509 [debug] [Thread-1 (]: Began executing node model.task_4.calculate_comissions
[0m04:04:49.261514 [debug] [Thread-1 (]: Writing runtime sql for node "model.task_4.calculate_comissions"
[0m04:04:49.262509 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m04:04:49.263509 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: BEGIN
[0m04:04:49.263509 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m04:04:49.288391 [debug] [Thread-1 (]: SQL status: BEGIN in 0.024 seconds
[0m04:04:49.289391 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m04:04:49.289391 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */

  create view "data_engineering_test"."public"."calculate_comissions__dbt_tmp"
    
    
  as (
    WITH orders_with_salesowners AS (
    SELECT
        o.order_id,
        i.gross_value / 100.0 AS gross_value_in_euros,

        -- Converting the gross value into net value by taking the vat out in a non-lineal way.
        (i.gross_value / 100.0) / (1 + i.vat / 100.0) AS net_value_in_euros,
        string_to_array(o.salesowners, ', ') AS salesowners_array
    FROM
        public.orders o
    JOIN
        public.invoicing_data i ON o.order_id = i.order_id
),
salesowners AS (
    SELECT
        ows.order_id,
        ows.net_value_in_euros,
        so.salesowner,
        so.ordinality AS salesowner_position
    FROM
        orders_with_salesowners ows,
        unnest(ows.salesowners_array) WITH ORDINALITY AS so(salesowner, ordinality) -- unnests the array and assigns the order for each sales person in the order that it comes from the file
),
commission_calc AS (
    SELECT
        order_id,
        salesowner,
        CASE 
            WHEN salesowner_position = 1 THEN net_value_in_euros * 0.06    -- Main owner - 6%
            WHEN salesowner_position = 2 THEN net_value_in_euros * 0.025   -- Co-owner 1 - 2.5%
            WHEN salesowner_position = 3 THEN net_value_in_euros * 0.0095  -- Co-owner 2 - 0.95%
            ELSE 0  -- No comission
        END AS commission
    FROM salesowners
)
SELECT
    salesowner,
    ROUND(SUM(commission), 2) AS total_commission
FROM commission_calc
GROUP BY salesowner
ORDER BY total_commission DESC
  );
[0m04:04:49.302414 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.013 seconds
[0m04:04:49.308414 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m04:04:49.309413 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */
alter table "data_engineering_test"."public"."calculate_comissions__dbt_tmp" rename to "calculate_comissions"
[0m04:04:49.311415 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m04:04:49.324418 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: COMMIT
[0m04:04:49.325418 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m04:04:49.325418 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: COMMIT
[0m04:04:49.328414 [debug] [Thread-1 (]: SQL status: COMMIT in 0.003 seconds
[0m04:04:49.336415 [debug] [Thread-1 (]: Applying DROP to: "data_engineering_test"."public"."calculate_comissions__dbt_backup"
[0m04:04:49.340414 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m04:04:49.340414 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */
drop view if exists "data_engineering_test"."public"."calculate_comissions__dbt_backup" cascade
[0m04:04:49.342416 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.001 seconds
[0m04:04:49.345415 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: Close
[0m04:04:49.346415 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '198a99ce-229e-40a0-8c7c-1afea3f304e2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016F32BE9FF0>]}
[0m04:04:49.347414 [info ] [Thread-1 (]: 1 of 1 OK created sql view model public.calculate_comissions ................... [[32mCREATE VIEW[0m in 0.13s]
[0m04:04:49.348419 [debug] [Thread-1 (]: Finished running node model.task_4.calculate_comissions
[0m04:04:49.349416 [debug] [MainThread]: Using postgres connection "master"
[0m04:04:49.349416 [debug] [MainThread]: On master: BEGIN
[0m04:04:49.350417 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m04:04:49.364418 [debug] [MainThread]: SQL status: BEGIN in 0.014 seconds
[0m04:04:49.365416 [debug] [MainThread]: On master: COMMIT
[0m04:04:49.365416 [debug] [MainThread]: Using postgres connection "master"
[0m04:04:49.366416 [debug] [MainThread]: On master: COMMIT
[0m04:04:49.367416 [debug] [MainThread]: SQL status: COMMIT in 0.001 seconds
[0m04:04:49.367416 [debug] [MainThread]: On master: Close
[0m04:04:49.368415 [debug] [MainThread]: Connection 'master' was properly closed.
[0m04:04:49.368415 [debug] [MainThread]: Connection 'list_data_engineering_test' was properly closed.
[0m04:04:49.369416 [debug] [MainThread]: Connection 'list_data_engineering_test_public' was properly closed.
[0m04:04:49.369416 [debug] [MainThread]: Connection 'model.task_4.calculate_comissions' was properly closed.
[0m04:04:49.370416 [info ] [MainThread]: 
[0m04:04:49.370416 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 0.35 seconds (0.35s).
[0m04:04:49.371416 [debug] [MainThread]: Command end result
[0m04:04:49.395415 [info ] [MainThread]: 
[0m04:04:49.396416 [info ] [MainThread]: [32mCompleted successfully[0m
[0m04:04:49.396416 [info ] [MainThread]: 
[0m04:04:49.397417 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m04:04:49.398415 [debug] [MainThread]: Command `dbt run` succeeded at 04:04:49.398415 after 0.99 seconds
[0m04:04:49.399416 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016F33EC4FD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016F33A06BC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016F35E30F70>]}
[0m04:04:49.399416 [debug] [MainThread]: Flushing usage events
[0m04:07:55.411639 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001946CBA0F70>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001946F6C3160>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001946F6C3E50>]}


============================== 04:07:55.416139 | 0eaa9463-eff8-49b7-9fcc-ffe102d9649e ==============================
[0m04:07:55.416139 [info ] [MainThread]: Running with dbt=1.8.8
[0m04:07:55.417145 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4/dbt', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4\\dbt\\logs', 'version_check': 'True', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'log_format': 'default', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'target_path': 'None', 'invocation_command': 'dbt run --profiles-dir C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4/dbt --project-dir C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4/dbt', 'send_anonymous_usage_stats': 'True'}
[0m04:07:55.605100 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '0eaa9463-eff8-49b7-9fcc-ffe102d9649e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001946CE3E3E0>]}
[0m04:07:55.656891 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '0eaa9463-eff8-49b7-9fcc-ffe102d9649e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001946C6D6B30>]}
[0m04:07:55.658405 [info ] [MainThread]: Registered adapter: postgres=1.8.2
[0m04:07:55.667420 [debug] [MainThread]: checksum: ec53e341a936509427e16df1c646386a84befec52c1957e3f4359fbc36fc93f5, vars: {}, profile: , target: , version: 1.8.8
[0m04:07:55.809282 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m04:07:55.810282 [debug] [MainThread]: Partial parsing: updated file: task_4://models\calculate_comissions.sql
[0m04:07:56.004984 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '0eaa9463-eff8-49b7-9fcc-ffe102d9649e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001946FC81330>]}
[0m04:07:56.090783 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '0eaa9463-eff8-49b7-9fcc-ffe102d9649e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001946FAF32E0>]}
[0m04:07:56.091782 [info ] [MainThread]: Found 1 model, 423 macros
[0m04:07:56.091782 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0eaa9463-eff8-49b7-9fcc-ffe102d9649e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001946FAF3790>]}
[0m04:07:56.094298 [info ] [MainThread]: 
[0m04:07:56.095298 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m04:07:56.096297 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_engineering_test'
[0m04:07:56.179565 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test"
[0m04:07:56.180566 [debug] [ThreadPool]: On list_data_engineering_test: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "list_data_engineering_test"} */

    select distinct nspname from pg_namespace
  
[0m04:07:56.180566 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m04:07:56.199106 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.019 seconds
[0m04:07:56.201103 [debug] [ThreadPool]: On list_data_engineering_test: Close
[0m04:07:56.203108 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_engineering_test_public'
[0m04:07:56.208165 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test_public"
[0m04:07:56.209161 [debug] [ThreadPool]: On list_data_engineering_test_public: BEGIN
[0m04:07:56.209161 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m04:07:56.223275 [debug] [ThreadPool]: SQL status: BEGIN in 0.014 seconds
[0m04:07:56.224271 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test_public"
[0m04:07:56.224271 [debug] [ThreadPool]: On list_data_engineering_test_public: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "list_data_engineering_test_public"} */
select
      'data_engineering_test' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_engineering_test' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_engineering_test' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m04:07:56.228288 [debug] [ThreadPool]: SQL status: SELECT 3 in 0.003 seconds
[0m04:07:56.230287 [debug] [ThreadPool]: On list_data_engineering_test_public: ROLLBACK
[0m04:07:56.231290 [debug] [ThreadPool]: On list_data_engineering_test_public: Close
[0m04:07:56.236286 [debug] [MainThread]: Using postgres connection "master"
[0m04:07:56.236794 [debug] [MainThread]: On master: BEGIN
[0m04:07:56.237298 [debug] [MainThread]: Opening a new connection, currently in state init
[0m04:07:56.259118 [debug] [MainThread]: SQL status: BEGIN in 0.022 seconds
[0m04:07:56.260118 [debug] [MainThread]: Using postgres connection "master"
[0m04:07:56.260118 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m04:07:56.265118 [debug] [MainThread]: SQL status: SELECT 2 in 0.004 seconds
[0m04:07:56.266626 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0eaa9463-eff8-49b7-9fcc-ffe102d9649e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001946FAD6F50>]}
[0m04:07:56.267146 [debug] [MainThread]: On master: ROLLBACK
[0m04:07:56.268331 [debug] [MainThread]: Using postgres connection "master"
[0m04:07:56.268331 [debug] [MainThread]: On master: BEGIN
[0m04:07:56.270341 [debug] [MainThread]: SQL status: BEGIN in 0.001 seconds
[0m04:07:56.271340 [debug] [MainThread]: On master: COMMIT
[0m04:07:56.271340 [debug] [MainThread]: Using postgres connection "master"
[0m04:07:56.272340 [debug] [MainThread]: On master: COMMIT
[0m04:07:56.273340 [debug] [MainThread]: SQL status: COMMIT in 0.001 seconds
[0m04:07:56.273340 [debug] [MainThread]: On master: Close
[0m04:07:56.274342 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m04:07:56.274342 [info ] [MainThread]: 
[0m04:07:56.277357 [debug] [Thread-1 (]: Began running node model.task_4.calculate_comissions
[0m04:07:56.278368 [info ] [Thread-1 (]: 1 of 1 START sql view model public.calculate_comissions ........................ [RUN]
[0m04:07:56.278368 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.task_4.calculate_comissions'
[0m04:07:56.279365 [debug] [Thread-1 (]: Began compiling node model.task_4.calculate_comissions
[0m04:07:56.285366 [debug] [Thread-1 (]: Writing injected SQL for node "model.task_4.calculate_comissions"
[0m04:07:56.286877 [debug] [Thread-1 (]: Began executing node model.task_4.calculate_comissions
[0m04:07:56.371746 [debug] [Thread-1 (]: Writing runtime sql for node "model.task_4.calculate_comissions"
[0m04:07:56.372749 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m04:07:56.373747 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: BEGIN
[0m04:07:56.373747 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m04:07:56.389132 [debug] [Thread-1 (]: SQL status: BEGIN in 0.015 seconds
[0m04:07:56.389132 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m04:07:56.390142 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */

  create view "data_engineering_test"."public"."calculate_comissions__dbt_tmp"
    
    
  as (
    CREATE VIEW v_commissions AS
WITH orders_with_salesowners AS (
    SELECT
        o.order_id,
        i.gross_value / 100.0 AS gross_value_in_euros,

        -- Converting the gross value into net value by taking the vat out in a non-lineal way.
        (i.gross_value / 100.0) / (1 + i.vat / 100.0) AS net_value_in_euros,
        string_to_array(o.salesowners, ', ') AS salesowners_array
    FROM
        public.orders o
    JOIN
        public.invoicing_data i ON o.order_id = i.order_id
),
salesowners AS (
    SELECT
        ows.order_id,
        ows.net_value_in_euros,
        so.salesowner,
        so.ordinality AS salesowner_position
    FROM
        orders_with_salesowners ows,
        unnest(ows.salesowners_array) WITH ORDINALITY AS so(salesowner, ordinality) -- unnests the array and assigns the order for each sales person in the order that it comes from the file
),
commission_calc AS (
    SELECT
        order_id,
        salesowner,
        CASE 
            WHEN salesowner_position = 1 THEN net_value_in_euros * 0.06    -- Main owner - 6%
            WHEN salesowner_position = 2 THEN net_value_in_euros * 0.025   -- Co-owner 1 - 2.5%
            WHEN salesowner_position = 3 THEN net_value_in_euros * 0.0095  -- Co-owner 2 - 0.95%
            ELSE 0  -- No comission
        END AS commission
    FROM salesowners
)
SELECT
    salesowner,
    ROUND(SUM(commission), 2) AS total_commission
FROM commission_calc
GROUP BY salesowner
ORDER BY total_commission DESC
  );
[0m04:07:56.392141 [debug] [Thread-1 (]: Postgres adapter: Postgres error: syntax error at or near "CREATE"
LINE 7:     CREATE VIEW v_commissions AS
            ^

[0m04:07:56.392141 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: ROLLBACK
[0m04:07:56.393650 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: Close
[0m04:07:56.400145 [debug] [Thread-1 (]: Database Error in model calculate_comissions (models\calculate_comissions.sql)
  syntax error at or near "CREATE"
  LINE 7:     CREATE VIEW v_commissions AS
              ^
  compiled code at target\run\task_4\models\calculate_comissions.sql
[0m04:07:56.402146 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0eaa9463-eff8-49b7-9fcc-ffe102d9649e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001946CE99D50>]}
[0m04:07:56.403146 [error] [Thread-1 (]: 1 of 1 ERROR creating sql view model public.calculate_comissions ............... [[31mERROR[0m in 0.12s]
[0m04:07:56.404147 [debug] [Thread-1 (]: Finished running node model.task_4.calculate_comissions
[0m04:07:56.405147 [debug] [MainThread]: Using postgres connection "master"
[0m04:07:56.406145 [debug] [MainThread]: On master: BEGIN
[0m04:07:56.406145 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m04:07:56.444557 [debug] [MainThread]: SQL status: BEGIN in 0.038 seconds
[0m04:07:56.444557 [debug] [MainThread]: On master: COMMIT
[0m04:07:56.445555 [debug] [MainThread]: Using postgres connection "master"
[0m04:07:56.445555 [debug] [MainThread]: On master: COMMIT
[0m04:07:56.447063 [debug] [MainThread]: SQL status: COMMIT in 0.001 seconds
[0m04:07:56.447063 [debug] [MainThread]: On master: Close
[0m04:07:56.448069 [debug] [MainThread]: Connection 'master' was properly closed.
[0m04:07:56.448069 [debug] [MainThread]: Connection 'list_data_engineering_test' was properly closed.
[0m04:07:56.449070 [debug] [MainThread]: Connection 'list_data_engineering_test_public' was properly closed.
[0m04:07:56.449070 [debug] [MainThread]: Connection 'model.task_4.calculate_comissions' was properly closed.
[0m04:07:56.450070 [info ] [MainThread]: 
[0m04:07:56.450070 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 0.36 seconds (0.36s).
[0m04:07:56.451071 [debug] [MainThread]: Command end result
[0m04:07:56.475297 [info ] [MainThread]: 
[0m04:07:56.475297 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m04:07:56.476299 [info ] [MainThread]: 
[0m04:07:56.476806 [error] [MainThread]:   Database Error in model calculate_comissions (models\calculate_comissions.sql)
  syntax error at or near "CREATE"
  LINE 7:     CREATE VIEW v_commissions AS
              ^
  compiled code at target\run\task_4\models\calculate_comissions.sql
[0m04:07:56.477313 [info ] [MainThread]: 
[0m04:07:56.477313 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m04:07:56.478609 [debug] [MainThread]: Command `dbt run` failed at 04:07:56.478609 after 1.13 seconds
[0m04:07:56.479556 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001946CBA0F70>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001946F96D030>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001946F96C8B0>]}
[0m04:07:56.479556 [debug] [MainThread]: Flushing usage events
[0m04:10:38.376631 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022A07BA4EE0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022A0A6D3820>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022A0A6D2140>]}


============================== 04:10:38.381839 | 5bdd7902-4bcf-484f-a30c-ca0ea8d055b5 ==============================
[0m04:10:38.381839 [info ] [MainThread]: Running with dbt=1.8.8
[0m04:10:38.381839 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4/dbt', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4\\dbt\\logs', 'fail_fast': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'static_parser': 'True', 'invocation_command': 'dbt run --profiles-dir C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4/dbt --project-dir C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4/dbt', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m04:10:38.570236 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '5bdd7902-4bcf-484f-a30c-ca0ea8d055b5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022A07E3E350>]}
[0m04:10:38.618828 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '5bdd7902-4bcf-484f-a30c-ca0ea8d055b5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022A076C6AD0>]}
[0m04:10:38.619838 [info ] [MainThread]: Registered adapter: postgres=1.8.2
[0m04:10:38.628845 [debug] [MainThread]: checksum: ec53e341a936509427e16df1c646386a84befec52c1957e3f4359fbc36fc93f5, vars: {}, profile: , target: , version: 1.8.8
[0m04:10:38.775447 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m04:10:38.776447 [debug] [MainThread]: Partial parsing: updated file: task_4://models\calculate_comissions.sql
[0m04:10:38.968427 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '5bdd7902-4bcf-484f-a30c-ca0ea8d055b5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022A0AC8D2A0>]}
[0m04:10:39.052926 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '5bdd7902-4bcf-484f-a30c-ca0ea8d055b5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022A0AB02A40>]}
[0m04:10:39.053926 [info ] [MainThread]: Found 1 model, 423 macros
[0m04:10:39.054926 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '5bdd7902-4bcf-484f-a30c-ca0ea8d055b5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022A0AB02680>]}
[0m04:10:39.055927 [info ] [MainThread]: 
[0m04:10:39.056926 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m04:10:39.058666 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_engineering_test'
[0m04:10:39.140826 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test"
[0m04:10:39.141830 [debug] [ThreadPool]: On list_data_engineering_test: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "list_data_engineering_test"} */

    select distinct nspname from pg_namespace
  
[0m04:10:39.142831 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m04:10:39.159917 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.018 seconds
[0m04:10:39.161915 [debug] [ThreadPool]: On list_data_engineering_test: Close
[0m04:10:39.162917 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_engineering_test_public'
[0m04:10:39.168926 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test_public"
[0m04:10:39.168926 [debug] [ThreadPool]: On list_data_engineering_test_public: BEGIN
[0m04:10:39.169936 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m04:10:39.183654 [debug] [ThreadPool]: SQL status: BEGIN in 0.014 seconds
[0m04:10:39.184651 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test_public"
[0m04:10:39.184651 [debug] [ThreadPool]: On list_data_engineering_test_public: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "list_data_engineering_test_public"} */
select
      'data_engineering_test' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_engineering_test' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_engineering_test' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m04:10:39.191906 [debug] [ThreadPool]: SQL status: SELECT 3 in 0.006 seconds
[0m04:10:39.192906 [debug] [ThreadPool]: On list_data_engineering_test_public: ROLLBACK
[0m04:10:39.193902 [debug] [ThreadPool]: On list_data_engineering_test_public: Close
[0m04:10:39.198913 [debug] [MainThread]: Using postgres connection "master"
[0m04:10:39.199922 [debug] [MainThread]: On master: BEGIN
[0m04:10:39.199922 [debug] [MainThread]: Opening a new connection, currently in state init
[0m04:10:39.214942 [debug] [MainThread]: SQL status: BEGIN in 0.014 seconds
[0m04:10:39.214942 [debug] [MainThread]: Using postgres connection "master"
[0m04:10:39.215941 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m04:10:39.224958 [debug] [MainThread]: SQL status: SELECT 2 in 0.008 seconds
[0m04:10:39.226958 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '5bdd7902-4bcf-484f-a30c-ca0ea8d055b5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022A0AAE71F0>]}
[0m04:10:39.226958 [debug] [MainThread]: On master: ROLLBACK
[0m04:10:39.228467 [debug] [MainThread]: Using postgres connection "master"
[0m04:10:39.228973 [debug] [MainThread]: On master: BEGIN
[0m04:10:39.230980 [debug] [MainThread]: SQL status: BEGIN in 0.001 seconds
[0m04:10:39.230980 [debug] [MainThread]: On master: COMMIT
[0m04:10:39.230980 [debug] [MainThread]: Using postgres connection "master"
[0m04:10:39.231982 [debug] [MainThread]: On master: COMMIT
[0m04:10:39.232982 [debug] [MainThread]: SQL status: COMMIT in 0.001 seconds
[0m04:10:39.232982 [debug] [MainThread]: On master: Close
[0m04:10:39.233981 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m04:10:39.233981 [info ] [MainThread]: 
[0m04:10:39.236982 [debug] [Thread-1 (]: Began running node model.task_4.calculate_comissions
[0m04:10:39.238485 [info ] [Thread-1 (]: 1 of 1 START sql view model public.calculate_comissions ........................ [RUN]
[0m04:10:39.238989 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.task_4.calculate_comissions'
[0m04:10:39.238989 [debug] [Thread-1 (]: Began compiling node model.task_4.calculate_comissions
[0m04:10:39.246230 [debug] [Thread-1 (]: Writing injected SQL for node "model.task_4.calculate_comissions"
[0m04:10:39.246230 [debug] [Thread-1 (]: Began executing node model.task_4.calculate_comissions
[0m04:10:39.330842 [debug] [Thread-1 (]: Writing runtime sql for node "model.task_4.calculate_comissions"
[0m04:10:39.331842 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m04:10:39.332844 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: BEGIN
[0m04:10:39.332844 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m04:10:39.355121 [debug] [Thread-1 (]: SQL status: BEGIN in 0.022 seconds
[0m04:10:39.356121 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m04:10:39.356121 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */

  create view "data_engineering_test"."public"."calculate_comissions__dbt_tmp"
    
    
  as (
    WITH orders_with_salesowners AS (
    SELECT
        o.order_id,
        i.gross_value / 100.0 AS gross_value_in_euros,

        -- Converting the gross value into net value by taking the vat out in a non-lineal way.
        (i.gross_value / 100.0) / (1 + i.vat / 100.0) AS net_value_in_euros,
        string_to_array(o.salesowners, ', ') AS salesowners_array
    FROM
        public.orders o
    JOIN
        public.invoicing_data i ON o.order_id = i.order_id
),
salesowners AS (
    SELECT
        ows.order_id,
        ows.net_value_in_euros,
        so.salesowner,
        so.ordinality AS salesowner_position
    FROM
        orders_with_salesowners ows,
        unnest(ows.salesowners_array) WITH ORDINALITY AS so(salesowner, ordinality) -- unnests the array and assigns the order for each sales person in the order that it comes from the file
),
commission_calc AS (
    SELECT
        order_id,
        salesowner,
        CASE 
            WHEN salesowner_position = 1 THEN net_value_in_euros * 0.06    -- Main owner - 6%
            WHEN salesowner_position = 2 THEN net_value_in_euros * 0.025   -- Co-owner 1 - 2.5%
            WHEN salesowner_position = 3 THEN net_value_in_euros * 0.0095  -- Co-owner 2 - 0.95%
            ELSE 0  -- No comission
        END AS commission
    FROM salesowners
)
SELECT
    salesowner,
    ROUND(SUM(commission), 2) AS total_commission
FROM commission_calc
GROUP BY salesowner
ORDER BY total_commission DESC
  );
[0m04:10:39.366520 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.010 seconds
[0m04:10:39.374541 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m04:10:39.374541 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */
alter table "data_engineering_test"."public"."calculate_comissions" rename to "calculate_comissions__dbt_backup"
[0m04:10:39.376543 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.002 seconds
[0m04:10:39.380339 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m04:10:39.380339 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */
alter table "data_engineering_test"."public"."calculate_comissions__dbt_tmp" rename to "calculate_comissions"
[0m04:10:39.382407 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m04:10:39.397927 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: COMMIT
[0m04:10:39.398433 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m04:10:39.398937 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: COMMIT
[0m04:10:39.402104 [debug] [Thread-1 (]: SQL status: COMMIT in 0.003 seconds
[0m04:10:39.408608 [debug] [Thread-1 (]: Applying DROP to: "data_engineering_test"."public"."calculate_comissions__dbt_backup"
[0m04:10:39.413614 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m04:10:39.413614 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */
drop view if exists "data_engineering_test"."public"."calculate_comissions__dbt_backup" cascade
[0m04:10:39.419806 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.005 seconds
[0m04:10:39.422664 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: Close
[0m04:10:39.423665 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5bdd7902-4bcf-484f-a30c-ca0ea8d055b5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022A0C0A6920>]}
[0m04:10:39.424665 [info ] [Thread-1 (]: 1 of 1 OK created sql view model public.calculate_comissions ................... [[32mCREATE VIEW[0m in 0.18s]
[0m04:10:39.425663 [debug] [Thread-1 (]: Finished running node model.task_4.calculate_comissions
[0m04:10:39.426664 [debug] [MainThread]: Using postgres connection "master"
[0m04:10:39.426664 [debug] [MainThread]: On master: BEGIN
[0m04:10:39.428170 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m04:10:39.441706 [debug] [MainThread]: SQL status: BEGIN in 0.014 seconds
[0m04:10:39.441706 [debug] [MainThread]: On master: COMMIT
[0m04:10:39.442703 [debug] [MainThread]: Using postgres connection "master"
[0m04:10:39.442703 [debug] [MainThread]: On master: COMMIT
[0m04:10:39.443703 [debug] [MainThread]: SQL status: COMMIT in 0.001 seconds
[0m04:10:39.444704 [debug] [MainThread]: On master: Close
[0m04:10:39.444704 [debug] [MainThread]: Connection 'master' was properly closed.
[0m04:10:39.445704 [debug] [MainThread]: Connection 'list_data_engineering_test' was properly closed.
[0m04:10:39.445704 [debug] [MainThread]: Connection 'list_data_engineering_test_public' was properly closed.
[0m04:10:39.446705 [debug] [MainThread]: Connection 'model.task_4.calculate_comissions' was properly closed.
[0m04:10:39.446705 [info ] [MainThread]: 
[0m04:10:39.447703 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 0.39 seconds (0.39s).
[0m04:10:39.448209 [debug] [MainThread]: Command end result
[0m04:10:39.473778 [info ] [MainThread]: 
[0m04:10:39.474779 [info ] [MainThread]: [32mCompleted successfully[0m
[0m04:10:39.475779 [info ] [MainThread]: 
[0m04:10:39.475779 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m04:10:39.477779 [debug] [MainThread]: Command `dbt run` succeeded at 04:10:39.477779 after 1.17 seconds
[0m04:10:39.478285 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022A07BA4EE0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022A09B1B070>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022A0C0BEE60>]}
[0m04:10:39.478791 [debug] [MainThread]: Flushing usage events
[0m13:45:33.391956 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BDDC0B0E80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BDDEBD3C70>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BDDEBD2440>]}


============================== 13:45:33.395955 | aba7c214-0e24-43a9-9b08-d16d0afe9bbb ==============================
[0m13:45:33.395955 [info ] [MainThread]: Running with dbt=1.8.8
[0m13:45:33.396955 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4/dbt', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4\\dbt\\logs', 'warn_error': 'None', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --profiles-dir C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4/dbt --project-dir C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4/dbt', 'introspect': 'True', 'static_parser': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m13:45:33.589295 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'aba7c214-0e24-43a9-9b08-d16d0afe9bbb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BDDED87CD0>]}
[0m13:45:33.636921 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'aba7c214-0e24-43a9-9b08-d16d0afe9bbb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BDDBBE6AA0>]}
[0m13:45:33.638814 [info ] [MainThread]: Registered adapter: postgres=1.8.2
[0m13:45:33.659305 [debug] [MainThread]: checksum: ec53e341a936509427e16df1c646386a84befec52c1957e3f4359fbc36fc93f5, vars: {}, profile: , target: , version: 1.8.8
[0m13:45:34.391636 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m13:45:34.392636 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m13:45:34.418168 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'aba7c214-0e24-43a9-9b08-d16d0afe9bbb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BDDF044130>]}
[0m13:45:34.507569 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'aba7c214-0e24-43a9-9b08-d16d0afe9bbb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BDDF0562F0>]}
[0m13:45:34.508569 [info ] [MainThread]: Found 1 model, 423 macros
[0m13:45:34.508569 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'aba7c214-0e24-43a9-9b08-d16d0afe9bbb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BDDF0568F0>]}
[0m13:45:34.510074 [info ] [MainThread]: 
[0m13:45:34.511080 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m13:45:34.512082 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_engineering_test'
[0m13:45:36.228740 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test"
[0m13:45:36.228740 [debug] [ThreadPool]: On list_data_engineering_test: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "list_data_engineering_test"} */

    select distinct nspname from pg_namespace
  
[0m13:45:36.229738 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:45:40.331813 [debug] [ThreadPool]: Postgres adapter: Got a retryable error when attempting to open a postgres connection.
1 attempts remaining. Retrying in 0 seconds.
Error:
connection to server at "localhost" (::1), port 5432 failed: Connection refused (0x0000274D/10061)
	Is the server running on that host and accepting TCP/IP connections?
connection to server at "localhost" (127.0.0.1), port 5432 failed: Connection refused (0x0000274D/10061)
	Is the server running on that host and accepting TCP/IP connections?

[0m13:45:44.449068 [debug] [ThreadPool]: Postgres adapter: Error running SQL: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "list_data_engineering_test"} */

    select distinct nspname from pg_namespace
  
[0m13:45:44.450069 [debug] [ThreadPool]: Postgres adapter: Rolling back transaction.
[0m13:45:44.450069 [debug] [ThreadPool]: Postgres adapter: Error running SQL: macro list_schemas
[0m13:45:44.450069 [debug] [ThreadPool]: Postgres adapter: Rolling back transaction.
[0m13:45:44.450069 [debug] [ThreadPool]: On list_data_engineering_test: No close available on handle
[0m13:45:44.451574 [debug] [MainThread]: Connection 'master' was properly closed.
[0m13:45:44.452584 [debug] [MainThread]: Connection 'list_data_engineering_test' was properly closed.
[0m13:45:44.452584 [info ] [MainThread]: 
[0m13:45:44.453582 [info ] [MainThread]: Finished running  in 0 hours 0 minutes and 9.94 seconds (9.94s).
[0m13:45:44.453582 [error] [MainThread]: Encountered an error:
Database Error
  connection to server at "localhost" (::1), port 5432 failed: Connection refused (0x0000274D/10061)
  	Is the server running on that host and accepting TCP/IP connections?
  connection to server at "localhost" (127.0.0.1), port 5432 failed: Connection refused (0x0000274D/10061)
  	Is the server running on that host and accepting TCP/IP connections?
  
[0m13:45:44.455579 [debug] [MainThread]: Command `dbt run` failed at 13:45:44.455579 after 11.14 seconds
[0m13:45:44.455579 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BDDC0B0E80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BDDF03A290>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BDDF059A50>]}
[0m13:45:44.456579 [debug] [MainThread]: Flushing usage events
[0m21:30:30.665266 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E7E0FF0100>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E7E3BC3820>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E7E3BC3640>]}


============================== 21:30:30.765201 | 6172477e-4cdd-4677-9243-18858ba6e69b ==============================
[0m21:30:30.765201 [info ] [MainThread]: Running with dbt=1.8.9
[0m21:30:30.765201 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4\\dbt\\logs', 'profiles_dir': 'C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4/dbt', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'log_format': 'default', 'static_parser': 'True', 'invocation_command': 'dbt run --profiles-dir C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4/dbt --project-dir C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4/dbt', 'introspect': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m21:30:31.043269 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '6172477e-4cdd-4677-9243-18858ba6e69b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E7E3597220>]}
[0m21:30:31.092539 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '6172477e-4cdd-4677-9243-18858ba6e69b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E7DDA1CB20>]}
[0m21:30:31.094541 [info ] [MainThread]: Registered adapter: postgres=1.8.2
[0m21:30:31.404384 [debug] [MainThread]: checksum: 132857a23e9d07220246854f7763165174ce9b737cfc7867629ace4294e520b1, vars: {}, profile: , target: , version: 1.8.9
[0m21:30:31.470592 [info ] [MainThread]: Unable to do partial parsing because of a version mismatch
[0m21:30:31.471588 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '6172477e-4cdd-4677-9243-18858ba6e69b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E7E2FB3CD0>]}
[0m21:30:33.055774 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '6172477e-4cdd-4677-9243-18858ba6e69b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E7E518D060>]}
[0m21:30:33.222796 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '6172477e-4cdd-4677-9243-18858ba6e69b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E7E5274160>]}
[0m21:30:33.223791 [info ] [MainThread]: Found 1 model, 428 macros
[0m21:30:33.224791 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '6172477e-4cdd-4677-9243-18858ba6e69b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E7E52740D0>]}
[0m21:30:33.225792 [info ] [MainThread]: 
[0m21:30:33.226791 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m21:30:33.228304 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_engineering_test'
[0m21:30:35.537498 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test"
[0m21:30:35.537498 [debug] [ThreadPool]: On list_data_engineering_test: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "list_data_engineering_test"} */

    select distinct nspname from pg_namespace
  
[0m21:30:35.538688 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:30:35.572695 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.034 seconds
[0m21:30:35.573693 [debug] [ThreadPool]: On list_data_engineering_test: Close
[0m21:30:35.575695 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_engineering_test_public'
[0m21:30:35.581716 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test_public"
[0m21:30:35.581716 [debug] [ThreadPool]: On list_data_engineering_test_public: BEGIN
[0m21:30:35.582715 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:30:35.617629 [debug] [ThreadPool]: SQL status: BEGIN in 0.035 seconds
[0m21:30:35.617629 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test_public"
[0m21:30:35.618637 [debug] [ThreadPool]: On list_data_engineering_test_public: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "list_data_engineering_test_public"} */
select
      'data_engineering_test' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_engineering_test' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_engineering_test' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m21:30:35.624639 [debug] [ThreadPool]: SQL status: SELECT 2 in 0.005 seconds
[0m21:30:35.625635 [debug] [ThreadPool]: On list_data_engineering_test_public: ROLLBACK
[0m21:30:35.626637 [debug] [ThreadPool]: On list_data_engineering_test_public: Close
[0m21:30:35.631881 [debug] [MainThread]: Using postgres connection "master"
[0m21:30:35.631881 [debug] [MainThread]: On master: BEGIN
[0m21:30:35.632883 [debug] [MainThread]: Opening a new connection, currently in state init
[0m21:30:35.646421 [debug] [MainThread]: SQL status: BEGIN in 0.014 seconds
[0m21:30:35.646421 [debug] [MainThread]: Using postgres connection "master"
[0m21:30:35.647427 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m21:30:35.653003 [debug] [MainThread]: SQL status: SELECT 0 in 0.005 seconds
[0m21:30:35.654004 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '6172477e-4cdd-4677-9243-18858ba6e69b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E7E51B1600>]}
[0m21:30:35.655001 [debug] [MainThread]: On master: ROLLBACK
[0m21:30:35.656509 [debug] [MainThread]: Using postgres connection "master"
[0m21:30:35.656509 [debug] [MainThread]: On master: BEGIN
[0m21:30:35.658594 [debug] [MainThread]: SQL status: BEGIN in 0.001 seconds
[0m21:30:35.658594 [debug] [MainThread]: On master: COMMIT
[0m21:30:35.659594 [debug] [MainThread]: Using postgres connection "master"
[0m21:30:35.659594 [debug] [MainThread]: On master: COMMIT
[0m21:30:35.661104 [debug] [MainThread]: SQL status: COMMIT in 0.001 seconds
[0m21:30:35.661104 [debug] [MainThread]: On master: Close
[0m21:30:35.662110 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m21:30:35.662110 [info ] [MainThread]: 
[0m21:30:35.666616 [debug] [Thread-1 (]: Began running node model.task_4.calculate_comissions
[0m21:30:35.666616 [info ] [Thread-1 (]: 1 of 1 START sql view model public.calculate_comissions ........................ [RUN]
[0m21:30:35.668135 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.task_4.calculate_comissions'
[0m21:30:35.668135 [debug] [Thread-1 (]: Began compiling node model.task_4.calculate_comissions
[0m21:30:35.674393 [debug] [Thread-1 (]: Writing injected SQL for node "model.task_4.calculate_comissions"
[0m21:30:35.675393 [debug] [Thread-1 (]: Began executing node model.task_4.calculate_comissions
[0m21:30:35.710545 [debug] [Thread-1 (]: Writing runtime sql for node "model.task_4.calculate_comissions"
[0m21:30:35.712545 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m21:30:35.712545 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: BEGIN
[0m21:30:35.713542 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m21:30:35.741673 [debug] [Thread-1 (]: SQL status: BEGIN in 0.028 seconds
[0m21:30:35.741673 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m21:30:35.742669 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */

  create view "data_engineering_test"."public"."calculate_comissions__dbt_tmp"
    
    
  as (
    WITH orders_with_salesowners AS (
    SELECT
        o.order_id,
        i.gross_value / 100.0 AS gross_value_in_euros,

        -- Converting the gross value into net value by taking the vat out in a non-lineal way.
        (i.gross_value / 100.0) / (1 + i.vat / 100.0) AS net_value_in_euros,
        string_to_array(o.salesowners, ', ') AS salesowners_array
    FROM
        public.orders o
    JOIN
        public.invoicing_data i ON o.order_id = i.order_id
),
salesowners AS (
    SELECT
        ows.order_id,
        ows.net_value_in_euros,
        so.salesowner,
        so.ordinality AS salesowner_position
    FROM
        orders_with_salesowners ows,
        unnest(ows.salesowners_array) WITH ORDINALITY AS so(salesowner, ordinality) -- unnests the array and assigns the order for each sales person in the order that it comes from the file
),
commission_calc AS (
    SELECT
        order_id,
        salesowner,
        CASE 
            WHEN salesowner_position = 1 THEN net_value_in_euros * 0.06    -- Main owner - 6%
            WHEN salesowner_position = 2 THEN net_value_in_euros * 0.025   -- Co-owner 1 - 2.5%
            WHEN salesowner_position = 3 THEN net_value_in_euros * 0.0095  -- Co-owner 2 - 0.95%
            ELSE 0  -- No comission
        END AS commission
    FROM salesowners
)
SELECT
    salesowner,
    ROUND(SUM(commission), 2) AS total_commission
FROM commission_calc
GROUP BY salesowner
ORDER BY total_commission DESC
  );
[0m21:30:35.750702 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.007 seconds
[0m21:30:35.756699 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m21:30:35.757205 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */
alter table "data_engineering_test"."public"."calculate_comissions__dbt_tmp" rename to "calculate_comissions"
[0m21:30:35.758784 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m21:30:35.771255 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: COMMIT
[0m21:30:35.772255 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m21:30:35.773257 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: COMMIT
[0m21:30:35.774903 [debug] [Thread-1 (]: SQL status: COMMIT in 0.002 seconds
[0m21:30:35.781720 [debug] [Thread-1 (]: Applying DROP to: "data_engineering_test"."public"."calculate_comissions__dbt_backup"
[0m21:30:35.785720 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m21:30:35.785720 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */
drop view if exists "data_engineering_test"."public"."calculate_comissions__dbt_backup" cascade
[0m21:30:35.787739 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.001 seconds
[0m21:30:35.789745 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: Close
[0m21:30:35.792322 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6172477e-4cdd-4677-9243-18858ba6e69b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E7E55E24D0>]}
[0m21:30:35.793392 [info ] [Thread-1 (]: 1 of 1 OK created sql view model public.calculate_comissions ................... [[32mCREATE VIEW[0m in 0.12s]
[0m21:30:35.794466 [debug] [Thread-1 (]: Finished running node model.task_4.calculate_comissions
[0m21:30:35.796054 [debug] [MainThread]: Using postgres connection "master"
[0m21:30:35.796569 [debug] [MainThread]: On master: BEGIN
[0m21:30:35.797094 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m21:30:35.810673 [debug] [MainThread]: SQL status: BEGIN in 0.014 seconds
[0m21:30:35.811671 [debug] [MainThread]: On master: COMMIT
[0m21:30:35.811671 [debug] [MainThread]: Using postgres connection "master"
[0m21:30:35.812673 [debug] [MainThread]: On master: COMMIT
[0m21:30:35.813672 [debug] [MainThread]: SQL status: COMMIT in 0.001 seconds
[0m21:30:35.813672 [debug] [MainThread]: On master: Close
[0m21:30:35.814673 [debug] [MainThread]: Connection 'master' was properly closed.
[0m21:30:35.815676 [debug] [MainThread]: Connection 'list_data_engineering_test' was properly closed.
[0m21:30:35.815676 [debug] [MainThread]: Connection 'list_data_engineering_test_public' was properly closed.
[0m21:30:35.815676 [debug] [MainThread]: Connection 'model.task_4.calculate_comissions' was properly closed.
[0m21:30:35.816672 [info ] [MainThread]: 
[0m21:30:35.817428 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 2.59 seconds (2.59s).
[0m21:30:35.818437 [debug] [MainThread]: Command end result
[0m21:30:35.844838 [info ] [MainThread]: 
[0m21:30:35.845853 [info ] [MainThread]: [32mCompleted successfully[0m
[0m21:30:35.846851 [info ] [MainThread]: 
[0m21:30:35.847356 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m21:30:35.848362 [debug] [MainThread]: Command `dbt run` succeeded at 21:30:35.848362 after 5.25 seconds
[0m21:30:35.849367 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E7E0FF0100>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E7DDA1CB20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E7E51CC3D0>]}
[0m21:30:35.849367 [debug] [MainThread]: Flushing usage events
[0m21:31:38.931149 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000199A34F94E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000199A606B2E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000199A606B100>]}


============================== 21:31:38.934299 | 73aad163-489c-4a77-9a5a-cda966fbe6ef ==============================
[0m21:31:38.934299 [info ] [MainThread]: Running with dbt=1.8.9
[0m21:31:38.935297 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4/dbt', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4\\dbt\\logs', 'debug': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --profiles-dir C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4/dbt --project-dir C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4/dbt', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m21:31:39.123173 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '73aad163-489c-4a77-9a5a-cda966fbe6ef', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000199A37AA6E0>]}
[0m21:31:39.172433 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '73aad163-489c-4a77-9a5a-cda966fbe6ef', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000199A2FB1750>]}
[0m21:31:39.174816 [info ] [MainThread]: Registered adapter: postgres=1.8.2
[0m21:31:39.436061 [debug] [MainThread]: checksum: 132857a23e9d07220246854f7763165174ce9b737cfc7867629ace4294e520b1, vars: {}, profile: , target: , version: 1.8.9
[0m21:31:39.580964 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m21:31:39.581470 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m21:31:39.609046 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '73aad163-489c-4a77-9a5a-cda966fbe6ef', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000199A6644130>]}
[0m21:31:39.693078 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '73aad163-489c-4a77-9a5a-cda966fbe6ef', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000199A66343A0>]}
[0m21:31:39.694079 [info ] [MainThread]: Found 1 model, 428 macros
[0m21:31:39.694079 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '73aad163-489c-4a77-9a5a-cda966fbe6ef', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000199A66370A0>]}
[0m21:31:39.696079 [info ] [MainThread]: 
[0m21:31:39.697078 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m21:31:39.699078 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_engineering_test'
[0m21:31:39.782722 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test"
[0m21:31:39.783722 [debug] [ThreadPool]: On list_data_engineering_test: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "list_data_engineering_test"} */

    select distinct nspname from pg_namespace
  
[0m21:31:39.783722 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:31:39.803171 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.019 seconds
[0m21:31:39.804168 [debug] [ThreadPool]: On list_data_engineering_test: Close
[0m21:31:39.806173 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_engineering_test_public'
[0m21:31:39.812184 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test_public"
[0m21:31:39.812348 [debug] [ThreadPool]: On list_data_engineering_test_public: BEGIN
[0m21:31:39.812348 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:31:39.827372 [debug] [ThreadPool]: SQL status: BEGIN in 0.014 seconds
[0m21:31:39.828373 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test_public"
[0m21:31:39.828373 [debug] [ThreadPool]: On list_data_engineering_test_public: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "list_data_engineering_test_public"} */
select
      'data_engineering_test' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_engineering_test' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_engineering_test' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m21:31:39.831382 [debug] [ThreadPool]: SQL status: SELECT 3 in 0.003 seconds
[0m21:31:39.832931 [debug] [ThreadPool]: On list_data_engineering_test_public: ROLLBACK
[0m21:31:39.833939 [debug] [ThreadPool]: On list_data_engineering_test_public: Close
[0m21:31:39.838941 [debug] [MainThread]: Using postgres connection "master"
[0m21:31:39.838941 [debug] [MainThread]: On master: BEGIN
[0m21:31:39.838941 [debug] [MainThread]: Opening a new connection, currently in state init
[0m21:31:39.852390 [debug] [MainThread]: SQL status: BEGIN in 0.013 seconds
[0m21:31:39.853522 [debug] [MainThread]: Using postgres connection "master"
[0m21:31:39.854521 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m21:31:39.858522 [debug] [MainThread]: SQL status: SELECT 2 in 0.003 seconds
[0m21:31:39.859521 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '73aad163-489c-4a77-9a5a-cda966fbe6ef', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000199A6635720>]}
[0m21:31:39.861025 [debug] [MainThread]: On master: ROLLBACK
[0m21:31:39.862035 [debug] [MainThread]: Using postgres connection "master"
[0m21:31:39.862035 [debug] [MainThread]: On master: BEGIN
[0m21:31:39.864035 [debug] [MainThread]: SQL status: BEGIN in 0.001 seconds
[0m21:31:39.864035 [debug] [MainThread]: On master: COMMIT
[0m21:31:39.865034 [debug] [MainThread]: Using postgres connection "master"
[0m21:31:39.865034 [debug] [MainThread]: On master: COMMIT
[0m21:31:39.866030 [debug] [MainThread]: SQL status: COMMIT in 0.001 seconds
[0m21:31:39.867035 [debug] [MainThread]: On master: Close
[0m21:31:39.867035 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m21:31:39.868034 [info ] [MainThread]: 
[0m21:31:39.870536 [debug] [Thread-1 (]: Began running node model.task_4.calculate_comissions
[0m21:31:39.871050 [info ] [Thread-1 (]: 1 of 1 START sql view model public.calculate_comissions ........................ [RUN]
[0m21:31:39.872141 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.task_4.calculate_comissions'
[0m21:31:39.872141 [debug] [Thread-1 (]: Began compiling node model.task_4.calculate_comissions
[0m21:31:39.878655 [debug] [Thread-1 (]: Writing injected SQL for node "model.task_4.calculate_comissions"
[0m21:31:39.880162 [debug] [Thread-1 (]: Began executing node model.task_4.calculate_comissions
[0m21:31:39.914039 [debug] [Thread-1 (]: Writing runtime sql for node "model.task_4.calculate_comissions"
[0m21:31:39.916043 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m21:31:39.916043 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: BEGIN
[0m21:31:39.917042 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m21:31:39.931104 [debug] [Thread-1 (]: SQL status: BEGIN in 0.014 seconds
[0m21:31:39.931104 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m21:31:39.932116 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */

  create view "data_engineering_test"."public"."calculate_comissions__dbt_tmp"
    
    
  as (
    WITH orders_with_salesowners AS (
    SELECT
        o.order_id,
        i.gross_value / 100.0 AS gross_value_in_euros,

        -- Converting the gross value into net value by taking the vat out in a non-lineal way.
        (i.gross_value / 100.0) / (1 + i.vat / 100.0) AS net_value_in_euros,
        string_to_array(o.salesowners, ', ') AS salesowners_array
    FROM
        public.orders o
    JOIN
        public.invoicing_data i ON o.order_id = i.order_id
),
salesowners AS (
    SELECT
        ows.order_id,
        ows.net_value_in_euros,
        so.salesowner,
        so.ordinality AS salesowner_position
    FROM
        orders_with_salesowners ows,
        unnest(ows.salesowners_array) WITH ORDINALITY AS so(salesowner, ordinality) -- unnests the array and assigns the order for each sales person in the order that it comes from the file
),
commission_calc AS (
    SELECT
        order_id,
        salesowner,
        CASE 
            WHEN salesowner_position = 1 THEN net_value_in_euros * 0.06    -- Main owner - 6%
            WHEN salesowner_position = 2 THEN net_value_in_euros * 0.025   -- Co-owner 1 - 2.5%
            WHEN salesowner_position = 3 THEN net_value_in_euros * 0.0095  -- Co-owner 2 - 0.95%
            ELSE 0  -- No comission
        END AS commission
    FROM salesowners
)
SELECT
    salesowner,
    ROUND(SUM(commission), 2) AS total_commission
FROM commission_calc
GROUP BY salesowner
ORDER BY total_commission DESC
  );
[0m21:31:39.936116 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.003 seconds
[0m21:31:39.942339 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m21:31:39.943281 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */
alter table "data_engineering_test"."public"."calculate_comissions" rename to "calculate_comissions__dbt_backup"
[0m21:31:39.944282 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m21:31:39.948281 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m21:31:39.949281 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */
alter table "data_engineering_test"."public"."calculate_comissions__dbt_tmp" rename to "calculate_comissions"
[0m21:31:39.950790 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m21:31:39.965439 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: COMMIT
[0m21:31:39.965439 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m21:31:39.966441 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: COMMIT
[0m21:31:39.968444 [debug] [Thread-1 (]: SQL status: COMMIT in 0.002 seconds
[0m21:31:39.974457 [debug] [Thread-1 (]: Applying DROP to: "data_engineering_test"."public"."calculate_comissions__dbt_backup"
[0m21:31:39.978802 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m21:31:39.980310 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */
drop view if exists "data_engineering_test"."public"."calculate_comissions__dbt_backup" cascade
[0m21:31:39.982950 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.002 seconds
[0m21:31:39.985954 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: Close
[0m21:31:39.987617 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '73aad163-489c-4a77-9a5a-cda966fbe6ef', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000199A6ABE380>]}
[0m21:31:39.987954 [info ] [Thread-1 (]: 1 of 1 OK created sql view model public.calculate_comissions ................... [[32mCREATE VIEW[0m in 0.11s]
[0m21:31:39.989469 [debug] [Thread-1 (]: Finished running node model.task_4.calculate_comissions
[0m21:31:39.990478 [debug] [MainThread]: Using postgres connection "master"
[0m21:31:39.990983 [debug] [MainThread]: On master: BEGIN
[0m21:31:39.991486 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m21:31:40.015124 [debug] [MainThread]: SQL status: BEGIN in 0.024 seconds
[0m21:31:40.015124 [debug] [MainThread]: On master: COMMIT
[0m21:31:40.016124 [debug] [MainThread]: Using postgres connection "master"
[0m21:31:40.016124 [debug] [MainThread]: On master: COMMIT
[0m21:31:40.017122 [debug] [MainThread]: SQL status: COMMIT in 0.001 seconds
[0m21:31:40.018122 [debug] [MainThread]: On master: Close
[0m21:31:40.018122 [debug] [MainThread]: Connection 'master' was properly closed.
[0m21:31:40.019122 [debug] [MainThread]: Connection 'list_data_engineering_test' was properly closed.
[0m21:31:40.019122 [debug] [MainThread]: Connection 'list_data_engineering_test_public' was properly closed.
[0m21:31:40.020126 [debug] [MainThread]: Connection 'model.task_4.calculate_comissions' was properly closed.
[0m21:31:40.020631 [info ] [MainThread]: 
[0m21:31:40.021137 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 0.32 seconds (0.32s).
[0m21:31:40.021137 [debug] [MainThread]: Command end result
[0m21:31:40.045892 [info ] [MainThread]: 
[0m21:31:40.046892 [info ] [MainThread]: [32mCompleted successfully[0m
[0m21:31:40.046892 [info ] [MainThread]: 
[0m21:31:40.047898 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m21:31:40.048893 [debug] [MainThread]: Command `dbt run` succeeded at 21:31:40.048893 after 1.19 seconds
[0m21:31:40.048893 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000199A34F94E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000199A5A6B760>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000199A3901CC0>]}
[0m21:31:40.050399 [debug] [MainThread]: Flushing usage events
[0m21:32:33.510200 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E053F393F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E056AA72B0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E056AA70D0>]}


============================== 21:32:33.514387 | 8f2b5262-66b2-4d92-a7be-2f6dfdb530d3 ==============================
[0m21:32:33.514387 [info ] [MainThread]: Running with dbt=1.8.9
[0m21:32:33.514387 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4\\dbt\\logs', 'debug': 'False', 'profiles_dir': 'C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4/dbt', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'log_format': 'default', 'introspect': 'True', 'invocation_command': 'dbt run --profiles-dir C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4/dbt --project-dir C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4/dbt', 'static_parser': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m21:32:33.696927 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '8f2b5262-66b2-4d92-a7be-2f6dfdb530d3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E0564ABFD0>]}
[0m21:32:33.744883 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '8f2b5262-66b2-4d92-a7be-2f6dfdb530d3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E055EB3220>]}
[0m21:32:33.746982 [info ] [MainThread]: Registered adapter: postgres=1.8.2
[0m21:32:34.017964 [debug] [MainThread]: checksum: 132857a23e9d07220246854f7763165174ce9b737cfc7867629ace4294e520b1, vars: {}, profile: , target: , version: 1.8.9
[0m21:32:34.150170 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m21:32:34.150170 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m21:32:34.176739 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '8f2b5262-66b2-4d92-a7be-2f6dfdb530d3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E057084130>]}
[0m21:32:34.261998 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '8f2b5262-66b2-4d92-a7be-2f6dfdb530d3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E05707B8E0>]}
[0m21:32:34.263000 [info ] [MainThread]: Found 1 model, 428 macros
[0m21:32:34.263000 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '8f2b5262-66b2-4d92-a7be-2f6dfdb530d3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E05707B100>]}
[0m21:32:34.264999 [info ] [MainThread]: 
[0m21:32:34.266001 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m21:32:34.267001 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_engineering_test'
[0m21:32:34.351378 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test"
[0m21:32:34.351884 [debug] [ThreadPool]: On list_data_engineering_test: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "list_data_engineering_test"} */

    select distinct nspname from pg_namespace
  
[0m21:32:34.352892 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:32:34.370430 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.018 seconds
[0m21:32:34.371943 [debug] [ThreadPool]: On list_data_engineering_test: Close
[0m21:32:34.372949 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_engineering_test_public'
[0m21:32:34.378949 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test_public"
[0m21:32:34.378949 [debug] [ThreadPool]: On list_data_engineering_test_public: BEGIN
[0m21:32:34.380457 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:32:34.394143 [debug] [ThreadPool]: SQL status: BEGIN in 0.014 seconds
[0m21:32:34.395142 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test_public"
[0m21:32:34.395142 [debug] [ThreadPool]: On list_data_engineering_test_public: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "list_data_engineering_test_public"} */
select
      'data_engineering_test' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_engineering_test' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_engineering_test' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m21:32:34.399139 [debug] [ThreadPool]: SQL status: SELECT 3 in 0.003 seconds
[0m21:32:34.400649 [debug] [ThreadPool]: On list_data_engineering_test_public: ROLLBACK
[0m21:32:34.401153 [debug] [ThreadPool]: On list_data_engineering_test_public: Close
[0m21:32:34.406252 [debug] [MainThread]: Using postgres connection "master"
[0m21:32:34.407249 [debug] [MainThread]: On master: BEGIN
[0m21:32:34.407249 [debug] [MainThread]: Opening a new connection, currently in state init
[0m21:32:34.421430 [debug] [MainThread]: SQL status: BEGIN in 0.014 seconds
[0m21:32:34.421430 [debug] [MainThread]: Using postgres connection "master"
[0m21:32:34.422543 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m21:32:34.426435 [debug] [MainThread]: SQL status: SELECT 2 in 0.004 seconds
[0m21:32:34.428435 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '8f2b5262-66b2-4d92-a7be-2f6dfdb530d3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E057098520>]}
[0m21:32:34.429435 [debug] [MainThread]: On master: ROLLBACK
[0m21:32:34.430439 [debug] [MainThread]: Using postgres connection "master"
[0m21:32:34.431041 [debug] [MainThread]: On master: BEGIN
[0m21:32:34.432050 [debug] [MainThread]: SQL status: BEGIN in 0.001 seconds
[0m21:32:34.433052 [debug] [MainThread]: On master: COMMIT
[0m21:32:34.433052 [debug] [MainThread]: Using postgres connection "master"
[0m21:32:34.434047 [debug] [MainThread]: On master: COMMIT
[0m21:32:34.435047 [debug] [MainThread]: SQL status: COMMIT in 0.001 seconds
[0m21:32:34.436052 [debug] [MainThread]: On master: Close
[0m21:32:34.436052 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m21:32:34.437050 [info ] [MainThread]: 
[0m21:32:34.439052 [debug] [Thread-1 (]: Began running node model.task_4.calculate_comissions
[0m21:32:34.440561 [info ] [Thread-1 (]: 1 of 1 START sql view model public.calculate_comissions ........................ [RUN]
[0m21:32:34.441079 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.task_4.calculate_comissions'
[0m21:32:34.441079 [debug] [Thread-1 (]: Began compiling node model.task_4.calculate_comissions
[0m21:32:34.447216 [debug] [Thread-1 (]: Writing injected SQL for node "model.task_4.calculate_comissions"
[0m21:32:34.448216 [debug] [Thread-1 (]: Began executing node model.task_4.calculate_comissions
[0m21:32:34.482378 [debug] [Thread-1 (]: Writing runtime sql for node "model.task_4.calculate_comissions"
[0m21:32:34.484375 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m21:32:34.484375 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: BEGIN
[0m21:32:34.485375 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m21:32:34.499498 [debug] [Thread-1 (]: SQL status: BEGIN in 0.014 seconds
[0m21:32:34.500499 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m21:32:34.501003 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */

  create view "data_engineering_test"."public"."calculate_comissions__dbt_tmp"
    
    
  as (
    WITH orders_with_salesowners AS (
    SELECT
        o.order_id,
        i.gross_value / 100.0 AS gross_value_in_euros,

        -- Converting the gross value into net value by taking the vat out in a non-lineal way.
        (i.gross_value / 100.0) / (1 + i.vat / 100.0) AS net_value_in_euros,
        string_to_array(o.salesowners, ', ') AS salesowners_array
    FROM
        public.orders o
    JOIN
        public.invoicing_data i ON o.order_id = i.order_id
),
salesowners AS (
    SELECT
        ows.order_id,
        ows.net_value_in_euros,
        so.salesowner,
        so.ordinality AS salesowner_position
    FROM
        orders_with_salesowners ows,
        unnest(ows.salesowners_array) WITH ORDINALITY AS so(salesowner, ordinality) -- unnests the array and assigns the order for each sales person in the order that it comes from the file
),
commission_calc AS (
    SELECT
        order_id,
        salesowner,
        CASE 
            WHEN salesowner_position = 1 THEN net_value_in_euros * 0.06    -- Main owner - 6%
            WHEN salesowner_position = 2 THEN net_value_in_euros * 0.025   -- Co-owner 1 - 2.5%
            WHEN salesowner_position = 3 THEN net_value_in_euros * 0.0095  -- Co-owner 2 - 0.95%
            ELSE 0  -- No comission
        END AS commission
    FROM salesowners
)
SELECT
    salesowner,
    ROUND(SUM(commission), 2) AS total_commission
FROM commission_calc
GROUP BY salesowner
ORDER BY total_commission DESC
  );
[0m21:32:34.504008 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.003 seconds
[0m21:32:34.511042 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m21:32:34.511042 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */
alter table "data_engineering_test"."public"."calculate_comissions" rename to "calculate_comissions__dbt_backup"
[0m21:32:34.513052 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m21:32:34.516047 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m21:32:34.517047 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */
alter table "data_engineering_test"."public"."calculate_comissions__dbt_tmp" rename to "calculate_comissions"
[0m21:32:34.518047 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m21:32:34.533206 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: COMMIT
[0m21:32:34.533206 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m21:32:34.534205 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: COMMIT
[0m21:32:34.536365 [debug] [Thread-1 (]: SQL status: COMMIT in 0.002 seconds
[0m21:32:34.542392 [debug] [Thread-1 (]: Applying DROP to: "data_engineering_test"."public"."calculate_comissions__dbt_backup"
[0m21:32:34.546392 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m21:32:34.547396 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */
drop view if exists "data_engineering_test"."public"."calculate_comissions__dbt_backup" cascade
[0m21:32:34.549392 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.002 seconds
[0m21:32:34.552409 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: Close
[0m21:32:34.553949 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8f2b5262-66b2-4d92-a7be-2f6dfdb530d3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E0574FE380>]}
[0m21:32:34.554946 [info ] [Thread-1 (]: 1 of 1 OK created sql view model public.calculate_comissions ................... [[32mCREATE VIEW[0m in 0.11s]
[0m21:32:34.555950 [debug] [Thread-1 (]: Finished running node model.task_4.calculate_comissions
[0m21:32:34.556946 [debug] [MainThread]: Using postgres connection "master"
[0m21:32:34.556946 [debug] [MainThread]: On master: BEGIN
[0m21:32:34.557944 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m21:32:34.571009 [debug] [MainThread]: SQL status: BEGIN in 0.014 seconds
[0m21:32:34.572018 [debug] [MainThread]: On master: COMMIT
[0m21:32:34.572569 [debug] [MainThread]: Using postgres connection "master"
[0m21:32:34.572569 [debug] [MainThread]: On master: COMMIT
[0m21:32:34.573575 [debug] [MainThread]: SQL status: COMMIT in 0.001 seconds
[0m21:32:34.574575 [debug] [MainThread]: On master: Close
[0m21:32:34.574575 [debug] [MainThread]: Connection 'master' was properly closed.
[0m21:32:34.575576 [debug] [MainThread]: Connection 'list_data_engineering_test' was properly closed.
[0m21:32:34.575576 [debug] [MainThread]: Connection 'list_data_engineering_test_public' was properly closed.
[0m21:32:34.576575 [debug] [MainThread]: Connection 'model.task_4.calculate_comissions' was properly closed.
[0m21:32:34.576575 [info ] [MainThread]: 
[0m21:32:34.576575 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 0.31 seconds (0.31s).
[0m21:32:34.577576 [debug] [MainThread]: Command end result
[0m21:32:34.601229 [info ] [MainThread]: 
[0m21:32:34.602235 [info ] [MainThread]: [32mCompleted successfully[0m
[0m21:32:34.603235 [info ] [MainThread]: 
[0m21:32:34.603235 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m21:32:34.605237 [debug] [MainThread]: Command `dbt run` succeeded at 21:32:34.604235 after 1.16 seconds
[0m21:32:34.605237 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E053F393F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E056EBA290>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E056AA7C70>]}
[0m21:32:34.606236 [debug] [MainThread]: Flushing usage events
[0m21:37:38.451387 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AD55AC9540>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AD58633400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AD58633220>]}


============================== 21:37:38.455395 | fbccf053-05c3-4c53-b3b7-ccfb36c1be0f ==============================
[0m21:37:38.455395 [info ] [MainThread]: Running with dbt=1.8.9
[0m21:37:38.456394 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4\\dbt\\logs', 'version_check': 'True', 'profiles_dir': 'C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4/dbt', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --profiles-dir C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4/dbt --project-dir C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4/dbt', 'static_parser': 'True', 'introspect': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m21:37:38.646955 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'fbccf053-05c3-4c53-b3b7-ccfb36c1be0f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AD5628B7C0>]}
[0m21:37:38.697168 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'fbccf053-05c3-4c53-b3b7-ccfb36c1be0f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AD57A96B00>]}
[0m21:37:38.698492 [info ] [MainThread]: Registered adapter: postgres=1.8.2
[0m21:37:38.967275 [debug] [MainThread]: checksum: 132857a23e9d07220246854f7763165174ce9b737cfc7867629ace4294e520b1, vars: {}, profile: , target: , version: 1.8.9
[0m21:37:39.102343 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m21:37:39.102343 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m21:37:39.128893 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'fbccf053-05c3-4c53-b3b7-ccfb36c1be0f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AD58C10130>]}
[0m21:37:39.215444 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'fbccf053-05c3-4c53-b3b7-ccfb36c1be0f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AD58C0A590>]}
[0m21:37:39.215444 [info ] [MainThread]: Found 1 model, 428 macros
[0m21:37:39.216444 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'fbccf053-05c3-4c53-b3b7-ccfb36c1be0f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AD58C0A650>]}
[0m21:37:39.217444 [info ] [MainThread]: 
[0m21:37:39.218443 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m21:37:39.220448 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_engineering_test'
[0m21:37:39.321064 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test"
[0m21:37:39.321064 [debug] [ThreadPool]: On list_data_engineering_test: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "list_data_engineering_test"} */

    select distinct nspname from pg_namespace
  
[0m21:37:39.322242 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:37:39.339441 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.017 seconds
[0m21:37:39.340941 [debug] [ThreadPool]: On list_data_engineering_test: Close
[0m21:37:39.342513 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_engineering_test_public'
[0m21:37:39.348451 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test_public"
[0m21:37:39.348451 [debug] [ThreadPool]: On list_data_engineering_test_public: BEGIN
[0m21:37:39.348451 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:37:39.362494 [debug] [ThreadPool]: SQL status: BEGIN in 0.014 seconds
[0m21:37:39.363507 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test_public"
[0m21:37:39.363507 [debug] [ThreadPool]: On list_data_engineering_test_public: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "list_data_engineering_test_public"} */
select
      'data_engineering_test' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_engineering_test' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_engineering_test' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m21:37:39.367511 [debug] [ThreadPool]: SQL status: SELECT 3 in 0.003 seconds
[0m21:37:39.368508 [debug] [ThreadPool]: On list_data_engineering_test_public: ROLLBACK
[0m21:37:39.369507 [debug] [ThreadPool]: On list_data_engineering_test_public: Close
[0m21:37:39.374015 [debug] [MainThread]: Using postgres connection "master"
[0m21:37:39.375016 [debug] [MainThread]: On master: BEGIN
[0m21:37:39.375016 [debug] [MainThread]: Opening a new connection, currently in state init
[0m21:37:39.389326 [debug] [MainThread]: SQL status: BEGIN in 0.014 seconds
[0m21:37:39.389326 [debug] [MainThread]: Using postgres connection "master"
[0m21:37:39.390324 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m21:37:39.394343 [debug] [MainThread]: SQL status: SELECT 2 in 0.004 seconds
[0m21:37:39.396343 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'fbccf053-05c3-4c53-b3b7-ccfb36c1be0f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AD58C092D0>]}
[0m21:37:39.397345 [debug] [MainThread]: On master: ROLLBACK
[0m21:37:39.398348 [debug] [MainThread]: Using postgres connection "master"
[0m21:37:39.398348 [debug] [MainThread]: On master: BEGIN
[0m21:37:39.400348 [debug] [MainThread]: SQL status: BEGIN in 0.001 seconds
[0m21:37:39.400857 [debug] [MainThread]: On master: COMMIT
[0m21:37:39.401364 [debug] [MainThread]: Using postgres connection "master"
[0m21:37:39.401364 [debug] [MainThread]: On master: COMMIT
[0m21:37:39.402920 [debug] [MainThread]: SQL status: COMMIT in 0.001 seconds
[0m21:37:39.402920 [debug] [MainThread]: On master: Close
[0m21:37:39.403927 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m21:37:39.403927 [info ] [MainThread]: 
[0m21:37:39.406926 [debug] [Thread-1 (]: Began running node model.task_4.calculate_comissions
[0m21:37:39.407925 [info ] [Thread-1 (]: 1 of 1 START sql view model public.calculate_comissions ........................ [RUN]
[0m21:37:39.407925 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.task_4.calculate_comissions'
[0m21:37:39.408927 [debug] [Thread-1 (]: Began compiling node model.task_4.calculate_comissions
[0m21:37:39.415546 [debug] [Thread-1 (]: Writing injected SQL for node "model.task_4.calculate_comissions"
[0m21:37:39.416549 [debug] [Thread-1 (]: Began executing node model.task_4.calculate_comissions
[0m21:37:39.450718 [debug] [Thread-1 (]: Writing runtime sql for node "model.task_4.calculate_comissions"
[0m21:37:39.452229 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m21:37:39.452394 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: BEGIN
[0m21:37:39.452394 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m21:37:39.467107 [debug] [Thread-1 (]: SQL status: BEGIN in 0.014 seconds
[0m21:37:39.468109 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m21:37:39.468109 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */

  create view "data_engineering_test"."public"."calculate_comissions__dbt_tmp"
    
    
  as (
    WITH orders_with_salesowners AS (
    SELECT
        o.order_id,
        i.gross_value / 100.0 AS gross_value_in_euros,

        -- Converting the gross value into net value by taking the vat out in a non-lineal way.
        (i.gross_value / 100.0) / (1 + i.vat / 100.0) AS net_value_in_euros,
        string_to_array(o.salesowners, ', ') AS salesowners_array
    FROM
        public.orders o
    JOIN
        public.invoicing_data i ON o.order_id = i.order_id
),
salesowners AS (
    SELECT
        ows.order_id,
        ows.net_value_in_euros,
        so.salesowner,
        so.ordinality AS salesowner_position
    FROM
        orders_with_salesowners ows,
        unnest(ows.salesowners_array) WITH ORDINALITY AS so(salesowner, ordinality) -- unnests the array and assigns the order for each sales person in the order that it comes from the file
),
commission_calc AS (
    SELECT
        order_id,
        salesowner,
        CASE 
            WHEN salesowner_position = 1 THEN net_value_in_euros * 0.06    -- Main owner - 6%
            WHEN salesowner_position = 2 THEN net_value_in_euros * 0.025   -- Co-owner 1 - 2.5%
            WHEN salesowner_position = 3 THEN net_value_in_euros * 0.0095  -- Co-owner 2 - 0.95%
            ELSE 0  -- No comission
        END AS commission
    FROM salesowners
)
SELECT
    salesowner,
    ROUND(SUM(commission), 2) AS total_commission
FROM commission_calc
GROUP BY salesowner
ORDER BY total_commission DESC
  );
[0m21:37:39.472230 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.004 seconds
[0m21:37:39.481443 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m21:37:39.482450 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */
alter table "data_engineering_test"."public"."calculate_comissions" rename to "calculate_comissions__dbt_backup"
[0m21:37:39.484451 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m21:37:39.488452 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m21:37:39.489449 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */
alter table "data_engineering_test"."public"."calculate_comissions__dbt_tmp" rename to "calculate_comissions"
[0m21:37:39.491282 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.002 seconds
[0m21:37:39.508414 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: COMMIT
[0m21:37:39.509414 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m21:37:39.509414 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: COMMIT
[0m21:37:39.511203 [debug] [Thread-1 (]: SQL status: COMMIT in 0.002 seconds
[0m21:37:39.518736 [debug] [Thread-1 (]: Applying DROP to: "data_engineering_test"."public"."calculate_comissions__dbt_backup"
[0m21:37:39.523279 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m21:37:39.524279 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */
drop view if exists "data_engineering_test"."public"."calculate_comissions__dbt_backup" cascade
[0m21:37:39.527279 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.003 seconds
[0m21:37:39.530279 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: Close
[0m21:37:39.532434 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fbccf053-05c3-4c53-b3b7-ccfb36c1be0f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AD5908E380>]}
[0m21:37:39.533442 [info ] [Thread-1 (]: 1 of 1 OK created sql view model public.calculate_comissions ................... [[32mCREATE VIEW[0m in 0.12s]
[0m21:37:39.534440 [debug] [Thread-1 (]: Finished running node model.task_4.calculate_comissions
[0m21:37:39.536441 [debug] [MainThread]: Using postgres connection "master"
[0m21:37:39.536441 [debug] [MainThread]: On master: BEGIN
[0m21:37:39.537440 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m21:37:39.553519 [debug] [MainThread]: SQL status: BEGIN in 0.016 seconds
[0m21:37:39.554516 [debug] [MainThread]: On master: COMMIT
[0m21:37:39.554516 [debug] [MainThread]: Using postgres connection "master"
[0m21:37:39.555520 [debug] [MainThread]: On master: COMMIT
[0m21:37:39.556518 [debug] [MainThread]: SQL status: COMMIT in 0.001 seconds
[0m21:37:39.556518 [debug] [MainThread]: On master: Close
[0m21:37:39.557516 [debug] [MainThread]: Connection 'master' was properly closed.
[0m21:37:39.557516 [debug] [MainThread]: Connection 'list_data_engineering_test' was properly closed.
[0m21:37:39.558520 [debug] [MainThread]: Connection 'list_data_engineering_test_public' was properly closed.
[0m21:37:39.558520 [debug] [MainThread]: Connection 'model.task_4.calculate_comissions' was properly closed.
[0m21:37:39.559516 [info ] [MainThread]: 
[0m21:37:39.559516 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 0.34 seconds (0.34s).
[0m21:37:39.560520 [debug] [MainThread]: Command end result
[0m21:37:39.585143 [info ] [MainThread]: 
[0m21:37:39.585143 [info ] [MainThread]: [32mCompleted successfully[0m
[0m21:37:39.586141 [info ] [MainThread]: 
[0m21:37:39.586141 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m21:37:39.588142 [debug] [MainThread]: Command `dbt run` succeeded at 21:37:39.588142 after 1.20 seconds
[0m21:37:39.588142 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AD55AC9540>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AD57A3D030>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AD55ED1CC0>]}
[0m21:37:39.589143 [debug] [MainThread]: Flushing usage events
[0m22:00:31.973247 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002245EE49510>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000224619B3340>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000224619B3160>]}


============================== 22:00:31.977142 | 6a1d36f6-2290-4048-9d91-f54788865cdc ==============================
[0m22:00:31.977142 [info ] [MainThread]: Running with dbt=1.8.9
[0m22:00:31.978142 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4\\dbt\\logs', 'profiles_dir': 'C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4/dbt', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'log_format': 'default', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'target_path': 'None', 'invocation_command': 'dbt run --profiles-dir C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4/dbt --project-dir C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4/dbt', 'send_anonymous_usage_stats': 'True'}
[0m22:00:32.171056 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '6a1d36f6-2290-4048-9d91-f54788865cdc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000224619C07C0>]}
[0m22:00:32.219955 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '6a1d36f6-2290-4048-9d91-f54788865cdc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000224619C3730>]}
[0m22:00:32.221955 [info ] [MainThread]: Registered adapter: postgres=1.8.2
[0m22:00:32.488931 [debug] [MainThread]: checksum: 132857a23e9d07220246854f7763165174ce9b737cfc7867629ace4294e520b1, vars: {}, profile: , target: , version: 1.8.9
[0m22:00:32.620187 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m22:00:32.621187 [debug] [MainThread]: Partial parsing: updated file: task_4://models\calculate_comissions.sql
[0m22:00:32.845255 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '6a1d36f6-2290-4048-9d91-f54788865cdc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000224620D2980>]}
[0m22:00:32.944034 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '6a1d36f6-2290-4048-9d91-f54788865cdc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000224620ACDF0>]}
[0m22:00:32.945035 [info ] [MainThread]: Found 1 model, 428 macros
[0m22:00:32.946036 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '6a1d36f6-2290-4048-9d91-f54788865cdc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000224620AC790>]}
[0m22:00:32.948036 [info ] [MainThread]: 
[0m22:00:32.950034 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m22:00:32.952035 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_engineering_test'
[0m22:00:33.053036 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test"
[0m22:00:33.053669 [debug] [ThreadPool]: On list_data_engineering_test: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "list_data_engineering_test"} */

    select distinct nspname from pg_namespace
  
[0m22:00:33.055049 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:00:33.082181 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.027 seconds
[0m22:00:33.085392 [debug] [ThreadPool]: On list_data_engineering_test: Close
[0m22:00:33.088388 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_engineering_test_public'
[0m22:00:33.099081 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test_public"
[0m22:00:33.100080 [debug] [ThreadPool]: On list_data_engineering_test_public: BEGIN
[0m22:00:33.101080 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:00:33.122247 [debug] [ThreadPool]: SQL status: BEGIN in 0.021 seconds
[0m22:00:33.123958 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test_public"
[0m22:00:33.124958 [debug] [ThreadPool]: On list_data_engineering_test_public: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "list_data_engineering_test_public"} */
select
      'data_engineering_test' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_engineering_test' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_engineering_test' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m22:00:33.131959 [debug] [ThreadPool]: SQL status: SELECT 3 in 0.006 seconds
[0m22:00:33.134466 [debug] [ThreadPool]: On list_data_engineering_test_public: ROLLBACK
[0m22:00:33.136462 [debug] [ThreadPool]: On list_data_engineering_test_public: Close
[0m22:00:33.147503 [debug] [MainThread]: Using postgres connection "master"
[0m22:00:33.148501 [debug] [MainThread]: On master: BEGIN
[0m22:00:33.149503 [debug] [MainThread]: Opening a new connection, currently in state init
[0m22:00:33.174616 [debug] [MainThread]: SQL status: BEGIN in 0.025 seconds
[0m22:00:33.175613 [debug] [MainThread]: Using postgres connection "master"
[0m22:00:33.177119 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m22:00:33.189130 [debug] [MainThread]: SQL status: SELECT 2 in 0.011 seconds
[0m22:00:33.194127 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '6a1d36f6-2290-4048-9d91-f54788865cdc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000224620D3130>]}
[0m22:00:33.196131 [debug] [MainThread]: On master: ROLLBACK
[0m22:00:33.199129 [debug] [MainThread]: Using postgres connection "master"
[0m22:00:33.199129 [debug] [MainThread]: On master: BEGIN
[0m22:00:33.203129 [debug] [MainThread]: SQL status: BEGIN in 0.002 seconds
[0m22:00:33.204127 [debug] [MainThread]: On master: COMMIT
[0m22:00:33.205127 [debug] [MainThread]: Using postgres connection "master"
[0m22:00:33.206129 [debug] [MainThread]: On master: COMMIT
[0m22:00:33.209129 [debug] [MainThread]: SQL status: COMMIT in 0.002 seconds
[0m22:00:33.210129 [debug] [MainThread]: On master: Close
[0m22:00:33.211127 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m22:00:33.212128 [info ] [MainThread]: 
[0m22:00:33.218128 [debug] [Thread-1 (]: Began running node model.task_4.calculate_comissions
[0m22:00:33.220130 [info ] [Thread-1 (]: 1 of 1 START sql view model public.calculate_comissions ........................ [RUN]
[0m22:00:33.222128 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.task_4.calculate_comissions'
[0m22:00:33.224130 [debug] [Thread-1 (]: Began compiling node model.task_4.calculate_comissions
[0m22:00:33.233130 [debug] [Thread-1 (]: Writing injected SQL for node "model.task_4.calculate_comissions"
[0m22:00:33.235131 [debug] [Thread-1 (]: Began executing node model.task_4.calculate_comissions
[0m22:00:33.351659 [debug] [Thread-1 (]: Writing runtime sql for node "model.task_4.calculate_comissions"
[0m22:00:33.353661 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m22:00:33.353661 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: BEGIN
[0m22:00:33.354658 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m22:00:33.368666 [debug] [Thread-1 (]: SQL status: BEGIN in 0.014 seconds
[0m22:00:33.369664 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m22:00:33.370664 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */

  create view "data_engineering_test"."public"."calculate_comissions__dbt_tmp"
    
    
  as (
    WITH orders_with_salesowners AS (
    SELECT
        o.order_id,
        round(i.gross_value / 100.0, 2) AS gross_value_in_euros,

        -- Converting the gross value into net value by taking the vat out in a non-lineal way.
        round((i.gross_value / 100.0) / (1 + i.vat / 100.0), 2) AS net_value_in_euros,
        string_to_array(o.salesowners, ', ') AS salesowners_array
    FROM
        public.orders o
    JOIN
        public.invoicing_data i ON o.order_id = i.order_id
),
salesowners AS (
    SELECT
        ows.order_id,
        ows.net_value_in_euros,
        so.salesowner,
        so.ordinality AS salesowner_position
    FROM
        orders_with_salesowners ows,
        unnest(ows.salesowners_array) WITH ORDINALITY AS so(salesowner, ordinality) -- unnests the array and assigns the order for each sales person in the order that it comes from the file
),
commission_calc AS (
    SELECT
        order_id,
        salesowner,
        CASE 
            WHEN salesowner_position = 1 THEN net_value_in_euros * 0.06    -- Main owner - 6%
            WHEN salesowner_position = 2 THEN net_value_in_euros * 0.025   -- Co-owner 1 - 2.5%
            WHEN salesowner_position = 3 THEN net_value_in_euros * 0.0095  -- Co-owner 2 - 0.95%
            ELSE 0  -- No comission
        END AS commission
    FROM salesowners
)
SELECT
    salesowner,
    ROUND(SUM(commission), 2) AS total_commission
FROM commission_calc
GROUP BY salesowner
ORDER BY total_commission DESC
  );
[0m22:00:33.378179 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.007 seconds
[0m22:00:33.393181 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m22:00:33.394179 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */
alter table "data_engineering_test"."public"."calculate_comissions" rename to "calculate_comissions__dbt_backup"
[0m22:00:33.397181 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.002 seconds
[0m22:00:33.403177 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m22:00:33.404180 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */
alter table "data_engineering_test"."public"."calculate_comissions__dbt_tmp" rename to "calculate_comissions"
[0m22:00:33.406180 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.002 seconds
[0m22:00:33.427181 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: COMMIT
[0m22:00:33.428179 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m22:00:33.429181 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: COMMIT
[0m22:00:33.433179 [debug] [Thread-1 (]: SQL status: COMMIT in 0.003 seconds
[0m22:00:33.444178 [debug] [Thread-1 (]: Applying DROP to: "data_engineering_test"."public"."calculate_comissions__dbt_backup"
[0m22:00:33.452179 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m22:00:33.454177 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */
drop view if exists "data_engineering_test"."public"."calculate_comissions__dbt_backup" cascade
[0m22:00:33.459179 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.004 seconds
[0m22:00:33.462184 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: Close
[0m22:00:33.465187 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6a1d36f6-2290-4048-9d91-f54788865cdc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002245DB6E0E0>]}
[0m22:00:33.466187 [info ] [Thread-1 (]: 1 of 1 OK created sql view model public.calculate_comissions ................... [[32mCREATE VIEW[0m in 0.24s]
[0m22:00:33.467187 [debug] [Thread-1 (]: Finished running node model.task_4.calculate_comissions
[0m22:00:33.468187 [debug] [MainThread]: Using postgres connection "master"
[0m22:00:33.469189 [debug] [MainThread]: On master: BEGIN
[0m22:00:33.469189 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m22:00:33.494712 [debug] [MainThread]: SQL status: BEGIN in 0.025 seconds
[0m22:00:33.495711 [debug] [MainThread]: On master: COMMIT
[0m22:00:33.496714 [debug] [MainThread]: Using postgres connection "master"
[0m22:00:33.496714 [debug] [MainThread]: On master: COMMIT
[0m22:00:33.499712 [debug] [MainThread]: SQL status: COMMIT in 0.002 seconds
[0m22:00:33.500714 [debug] [MainThread]: On master: Close
[0m22:00:33.502713 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:00:33.503714 [debug] [MainThread]: Connection 'list_data_engineering_test' was properly closed.
[0m22:00:33.504711 [debug] [MainThread]: Connection 'list_data_engineering_test_public' was properly closed.
[0m22:00:33.505712 [debug] [MainThread]: Connection 'model.task_4.calculate_comissions' was properly closed.
[0m22:00:33.505712 [info ] [MainThread]: 
[0m22:00:33.506713 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 0.56 seconds (0.56s).
[0m22:00:33.507711 [debug] [MainThread]: Command end result
[0m22:00:33.548712 [info ] [MainThread]: 
[0m22:00:33.549712 [info ] [MainThread]: [32mCompleted successfully[0m
[0m22:00:33.550712 [info ] [MainThread]: 
[0m22:00:33.551710 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m22:00:33.553709 [debug] [MainThread]: Command `dbt run` succeeded at 22:00:33.553709 after 1.65 seconds
[0m22:00:33.554710 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002245EE49510>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002246355F070>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002246355F190>]}
[0m22:00:33.555713 [debug] [MainThread]: Flushing usage events
[0m22:03:41.599103 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002AD5DB494B0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002AD606B32B0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002AD606B30D0>]}


============================== 22:03:41.603123 | 6fc81601-ef2d-47d8-afd7-c97655c1962f ==============================
[0m22:03:41.603123 [info ] [MainThread]: Running with dbt=1.8.9
[0m22:03:41.604133 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4/dbt', 'fail_fast': 'False', 'warn_error': 'None', 'log_path': 'C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4\\dbt\\logs', 'debug': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --profiles-dir C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4/dbt --project-dir C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4/dbt', 'introspect': 'True', 'static_parser': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m22:03:41.790379 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '6fc81601-ef2d-47d8-afd7-c97655c1962f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002AD5E363190>]}
[0m22:03:41.840329 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '6fc81601-ef2d-47d8-afd7-c97655c1962f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002AD5D603C40>]}
[0m22:03:41.842336 [info ] [MainThread]: Registered adapter: postgres=1.8.2
[0m22:03:42.116201 [debug] [MainThread]: checksum: 132857a23e9d07220246854f7763165174ce9b737cfc7867629ace4294e520b1, vars: {}, profile: , target: , version: 1.8.9
[0m22:03:42.266560 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m22:03:42.266560 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m22:03:42.295284 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '6fc81601-ef2d-47d8-afd7-c97655c1962f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002AD60C94130>]}
[0m22:03:42.379277 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '6fc81601-ef2d-47d8-afd7-c97655c1962f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002AD60C8A5C0>]}
[0m22:03:42.380782 [info ] [MainThread]: Found 1 model, 428 macros
[0m22:03:42.380782 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '6fc81601-ef2d-47d8-afd7-c97655c1962f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002AD60C8B100>]}
[0m22:03:42.382311 [info ] [MainThread]: 
[0m22:03:42.383824 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m22:03:42.384829 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_engineering_test'
[0m22:03:42.470656 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test"
[0m22:03:42.470656 [debug] [ThreadPool]: On list_data_engineering_test: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "list_data_engineering_test"} */

    select distinct nspname from pg_namespace
  
[0m22:03:42.471655 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:03:42.491212 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.019 seconds
[0m22:03:42.492720 [debug] [ThreadPool]: On list_data_engineering_test: Close
[0m22:03:42.494229 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_engineering_test_public'
[0m22:03:42.500230 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test_public"
[0m22:03:42.501229 [debug] [ThreadPool]: On list_data_engineering_test_public: BEGIN
[0m22:03:42.501229 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:03:42.516319 [debug] [ThreadPool]: SQL status: BEGIN in 0.015 seconds
[0m22:03:42.517317 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test_public"
[0m22:03:42.517317 [debug] [ThreadPool]: On list_data_engineering_test_public: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "list_data_engineering_test_public"} */
select
      'data_engineering_test' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_engineering_test' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_engineering_test' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m22:03:42.521315 [debug] [ThreadPool]: SQL status: SELECT 3 in 0.004 seconds
[0m22:03:42.523327 [debug] [ThreadPool]: On list_data_engineering_test_public: ROLLBACK
[0m22:03:42.524850 [debug] [ThreadPool]: On list_data_engineering_test_public: Close
[0m22:03:42.529857 [debug] [MainThread]: Using postgres connection "master"
[0m22:03:42.529857 [debug] [MainThread]: On master: BEGIN
[0m22:03:42.530857 [debug] [MainThread]: Opening a new connection, currently in state init
[0m22:03:42.545465 [debug] [MainThread]: SQL status: BEGIN in 0.014 seconds
[0m22:03:42.545465 [debug] [MainThread]: Using postgres connection "master"
[0m22:03:42.546463 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m22:03:42.550466 [debug] [MainThread]: SQL status: SELECT 2 in 0.004 seconds
[0m22:03:42.552967 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '6fc81601-ef2d-47d8-afd7-c97655c1962f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002AD60CA9A50>]}
[0m22:03:42.553472 [debug] [MainThread]: On master: ROLLBACK
[0m22:03:42.554483 [debug] [MainThread]: Using postgres connection "master"
[0m22:03:42.554483 [debug] [MainThread]: On master: BEGIN
[0m22:03:42.556481 [debug] [MainThread]: SQL status: BEGIN in 0.001 seconds
[0m22:03:42.556481 [debug] [MainThread]: On master: COMMIT
[0m22:03:42.557479 [debug] [MainThread]: Using postgres connection "master"
[0m22:03:42.557479 [debug] [MainThread]: On master: COMMIT
[0m22:03:42.558478 [debug] [MainThread]: SQL status: COMMIT in 0.001 seconds
[0m22:03:42.559483 [debug] [MainThread]: On master: Close
[0m22:03:42.560479 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m22:03:42.560479 [info ] [MainThread]: 
[0m22:03:42.563555 [debug] [Thread-1 (]: Began running node model.task_4.calculate_comissions
[0m22:03:42.563555 [info ] [Thread-1 (]: 1 of 1 START sql view model public.calculate_comissions ........................ [RUN]
[0m22:03:42.564634 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.task_4.calculate_comissions'
[0m22:03:42.564634 [debug] [Thread-1 (]: Began compiling node model.task_4.calculate_comissions
[0m22:03:42.571641 [debug] [Thread-1 (]: Writing injected SQL for node "model.task_4.calculate_comissions"
[0m22:03:42.573146 [debug] [Thread-1 (]: Began executing node model.task_4.calculate_comissions
[0m22:03:42.606276 [debug] [Thread-1 (]: Writing runtime sql for node "model.task_4.calculate_comissions"
[0m22:03:42.607280 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m22:03:42.608277 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: BEGIN
[0m22:03:42.608277 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m22:03:42.622384 [debug] [Thread-1 (]: SQL status: BEGIN in 0.014 seconds
[0m22:03:42.623393 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m22:03:42.623393 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */

  create view "data_engineering_test"."public"."calculate_comissions__dbt_tmp"
    
    
  as (
    WITH orders_with_salesowners AS (
    SELECT
        o.order_id,
        round(i.gross_value / 100.0, 2) AS gross_value_in_euros,

        -- Converting the gross value into net value by taking the vat out in a non-lineal way.
        round((i.gross_value / 100.0) / (1 + i.vat / 100.0), 2) AS net_value_in_euros,
        string_to_array(o.salesowners, ', ') AS salesowners_array
    FROM
        public.orders o
    JOIN
        public.invoicing_data i ON o.order_id = i.order_id
),
salesowners AS (
    SELECT
        ows.order_id,
        ows.net_value_in_euros,
        so.salesowner,
        so.ordinality AS salesowner_position
    FROM
        orders_with_salesowners ows,
        unnest(ows.salesowners_array) WITH ORDINALITY AS so(salesowner, ordinality) -- unnests the array and assigns the order for each sales person in the order that it comes from the file
),
commission_calc AS (
    SELECT
        order_id,
        salesowner,
        CASE 
            WHEN salesowner_position = 1 THEN net_value_in_euros * 0.06    -- Main owner - 6%
            WHEN salesowner_position = 2 THEN net_value_in_euros * 0.025   -- Co-owner 1 - 2.5%
            WHEN salesowner_position = 3 THEN net_value_in_euros * 0.0095  -- Co-owner 2 - 0.95%
            ELSE 0  -- No comission
        END AS commission
    FROM salesowners
)
SELECT
    salesowner,
    ROUND(SUM(commission), 2) AS total_commission
FROM commission_calc
GROUP BY salesowner
ORDER BY total_commission DESC
  );
[0m22:03:42.628713 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.004 seconds
[0m22:03:42.634924 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m22:03:42.635929 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */
alter table "data_engineering_test"."public"."calculate_comissions" rename to "calculate_comissions__dbt_backup"
[0m22:03:42.637934 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m22:03:42.640930 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m22:03:42.642434 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */
alter table "data_engineering_test"."public"."calculate_comissions__dbt_tmp" rename to "calculate_comissions"
[0m22:03:42.643967 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m22:03:42.658114 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: COMMIT
[0m22:03:42.658114 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m22:03:42.659118 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: COMMIT
[0m22:03:42.661114 [debug] [Thread-1 (]: SQL status: COMMIT in 0.002 seconds
[0m22:03:42.668137 [debug] [Thread-1 (]: Applying DROP to: "data_engineering_test"."public"."calculate_comissions__dbt_backup"
[0m22:03:42.671141 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m22:03:42.672646 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */
drop view if exists "data_engineering_test"."public"."calculate_comissions__dbt_backup" cascade
[0m22:03:42.675235 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.003 seconds
[0m22:03:42.678658 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: Close
[0m22:03:42.680663 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6fc81601-ef2d-47d8-afd7-c97655c1962f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002AD6110E380>]}
[0m22:03:42.681168 [info ] [Thread-1 (]: 1 of 1 OK created sql view model public.calculate_comissions ................... [[32mCREATE VIEW[0m in 0.12s]
[0m22:03:42.682678 [debug] [Thread-1 (]: Finished running node model.task_4.calculate_comissions
[0m22:03:42.684204 [debug] [MainThread]: Using postgres connection "master"
[0m22:03:42.684204 [debug] [MainThread]: On master: BEGIN
[0m22:03:42.684204 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m22:03:42.698216 [debug] [MainThread]: SQL status: BEGIN in 0.014 seconds
[0m22:03:42.699216 [debug] [MainThread]: On master: COMMIT
[0m22:03:42.699216 [debug] [MainThread]: Using postgres connection "master"
[0m22:03:42.700216 [debug] [MainThread]: On master: COMMIT
[0m22:03:42.701216 [debug] [MainThread]: SQL status: COMMIT in 0.001 seconds
[0m22:03:42.701216 [debug] [MainThread]: On master: Close
[0m22:03:42.702723 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:03:42.703228 [debug] [MainThread]: Connection 'list_data_engineering_test' was properly closed.
[0m22:03:42.703228 [debug] [MainThread]: Connection 'list_data_engineering_test_public' was properly closed.
[0m22:03:42.703228 [debug] [MainThread]: Connection 'model.task_4.calculate_comissions' was properly closed.
[0m22:03:42.704235 [info ] [MainThread]: 
[0m22:03:42.704235 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 0.32 seconds (0.32s).
[0m22:03:42.705235 [debug] [MainThread]: Command end result
[0m22:03:42.730324 [info ] [MainThread]: 
[0m22:03:42.731325 [info ] [MainThread]: [32mCompleted successfully[0m
[0m22:03:42.731325 [info ] [MainThread]: 
[0m22:03:42.732327 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m22:03:42.733342 [debug] [MainThread]: Command `dbt run` succeeded at 22:03:42.733342 after 1.20 seconds
[0m22:03:42.734521 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002AD5DB494B0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002AD600BB430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002AD5DF51D50>]}
[0m22:03:42.734521 [debug] [MainThread]: Flushing usage events
[0m22:06:16.811598 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002606F659540>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000260721C3400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000260721C3220>]}


============================== 22:06:16.815107 | 1fb0a3dc-d8c2-4c04-822d-73a6dd959e5a ==============================
[0m22:06:16.815107 [info ] [MainThread]: Running with dbt=1.8.9
[0m22:06:16.816107 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4/dbt', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4\\dbt\\logs', 'debug': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'log_format': 'default', 'invocation_command': 'dbt run --profiles-dir C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4/dbt --project-dir C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4/dbt', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m22:06:17.005573 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '1fb0a3dc-d8c2-4c04-822d-73a6dd959e5a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002606FE1B7C0>]}
[0m22:06:17.057397 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '1fb0a3dc-d8c2-4c04-822d-73a6dd959e5a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026071626B00>]}
[0m22:06:17.058395 [info ] [MainThread]: Registered adapter: postgres=1.8.2
[0m22:06:17.321159 [debug] [MainThread]: checksum: 132857a23e9d07220246854f7763165174ce9b737cfc7867629ace4294e520b1, vars: {}, profile: , target: , version: 1.8.9
[0m22:06:17.450663 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m22:06:17.451663 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m22:06:17.479867 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '1fb0a3dc-d8c2-4c04-822d-73a6dd959e5a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000260727A4130>]}
[0m22:06:17.564732 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '1fb0a3dc-d8c2-4c04-822d-73a6dd959e5a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026072794460>]}
[0m22:06:17.565733 [info ] [MainThread]: Found 1 model, 428 macros
[0m22:06:17.565733 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '1fb0a3dc-d8c2-4c04-822d-73a6dd959e5a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000260727943A0>]}
[0m22:06:17.567732 [info ] [MainThread]: 
[0m22:06:17.567732 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m22:06:17.569739 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_engineering_test'
[0m22:06:17.654499 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test"
[0m22:06:17.655503 [debug] [ThreadPool]: On list_data_engineering_test: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "list_data_engineering_test"} */

    select distinct nspname from pg_namespace
  
[0m22:06:17.656501 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:06:17.673637 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.017 seconds
[0m22:06:17.674644 [debug] [ThreadPool]: On list_data_engineering_test: Close
[0m22:06:17.676645 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_engineering_test_public'
[0m22:06:17.683148 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test_public"
[0m22:06:17.683148 [debug] [ThreadPool]: On list_data_engineering_test_public: BEGIN
[0m22:06:17.684226 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:06:17.698251 [debug] [ThreadPool]: SQL status: BEGIN in 0.014 seconds
[0m22:06:17.698251 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test_public"
[0m22:06:17.699250 [debug] [ThreadPool]: On list_data_engineering_test_public: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "list_data_engineering_test_public"} */
select
      'data_engineering_test' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_engineering_test' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_engineering_test' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m22:06:17.702253 [debug] [ThreadPool]: SQL status: SELECT 3 in 0.003 seconds
[0m22:06:17.703510 [debug] [ThreadPool]: On list_data_engineering_test_public: ROLLBACK
[0m22:06:17.705659 [debug] [ThreadPool]: On list_data_engineering_test_public: Close
[0m22:06:17.709662 [debug] [MainThread]: Using postgres connection "master"
[0m22:06:17.710658 [debug] [MainThread]: On master: BEGIN
[0m22:06:17.710658 [debug] [MainThread]: Opening a new connection, currently in state init
[0m22:06:17.724742 [debug] [MainThread]: SQL status: BEGIN in 0.014 seconds
[0m22:06:17.725750 [debug] [MainThread]: Using postgres connection "master"
[0m22:06:17.725750 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m22:06:17.730749 [debug] [MainThread]: SQL status: SELECT 2 in 0.004 seconds
[0m22:06:17.732253 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '1fb0a3dc-d8c2-4c04-822d-73a6dd959e5a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026072795720>]}
[0m22:06:17.733258 [debug] [MainThread]: On master: ROLLBACK
[0m22:06:17.734425 [debug] [MainThread]: Using postgres connection "master"
[0m22:06:17.734425 [debug] [MainThread]: On master: BEGIN
[0m22:06:17.736431 [debug] [MainThread]: SQL status: BEGIN in 0.001 seconds
[0m22:06:17.736431 [debug] [MainThread]: On master: COMMIT
[0m22:06:17.737426 [debug] [MainThread]: Using postgres connection "master"
[0m22:06:17.737426 [debug] [MainThread]: On master: COMMIT
[0m22:06:17.738425 [debug] [MainThread]: SQL status: COMMIT in 0.001 seconds
[0m22:06:17.739426 [debug] [MainThread]: On master: Close
[0m22:06:17.740427 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m22:06:17.740427 [info ] [MainThread]: 
[0m22:06:17.743316 [debug] [Thread-1 (]: Began running node model.task_4.calculate_comissions
[0m22:06:17.744423 [info ] [Thread-1 (]: 1 of 1 START sql view model public.calculate_comissions ........................ [RUN]
[0m22:06:17.744423 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.task_4.calculate_comissions'
[0m22:06:17.745324 [debug] [Thread-1 (]: Began compiling node model.task_4.calculate_comissions
[0m22:06:17.752323 [debug] [Thread-1 (]: Writing injected SQL for node "model.task_4.calculate_comissions"
[0m22:06:17.753334 [debug] [Thread-1 (]: Began executing node model.task_4.calculate_comissions
[0m22:06:17.787925 [debug] [Thread-1 (]: Writing runtime sql for node "model.task_4.calculate_comissions"
[0m22:06:17.788927 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m22:06:17.789927 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: BEGIN
[0m22:06:17.789927 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m22:06:17.823167 [debug] [Thread-1 (]: SQL status: BEGIN in 0.033 seconds
[0m22:06:17.824176 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m22:06:17.825177 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */

  create view "data_engineering_test"."public"."calculate_comissions__dbt_tmp"
    
    
  as (
    WITH orders_with_salesowners AS (
    SELECT
        o.order_id,
        round(i.gross_value / 100.0, 2) AS gross_value_in_euros,

        -- Converting the gross value into net value by taking the vat out in a non-lineal way.
        round((i.gross_value / 100.0) / (1 + i.vat / 100.0), 2) AS net_value_in_euros,
        string_to_array(o.salesowners, ', ') AS salesowners_array
    FROM
        public.orders o
    JOIN
        public.invoicing_data i ON o.order_id = i.order_id
),
salesowners AS (
    SELECT
        ows.order_id,
        ows.net_value_in_euros,
        so.salesowner,
        so.ordinality AS salesowner_position
    FROM
        orders_with_salesowners ows,
        unnest(ows.salesowners_array) WITH ORDINALITY AS so(salesowner, ordinality) -- unnests the array and assigns the order for each sales person in the order that it comes from the file
),
commission_calc AS (
    SELECT
        order_id,
        salesowner,
        CASE 
            WHEN salesowner_position = 1 THEN net_value_in_euros * 0.06    -- Main owner - 6%
            WHEN salesowner_position = 2 THEN net_value_in_euros * 0.025   -- Co-owner 1 - 2.5%
            WHEN salesowner_position = 3 THEN net_value_in_euros * 0.0095  -- Co-owner 2 - 0.95%
            ELSE 0  -- No comission
        END AS commission
    FROM salesowners
)
SELECT
    salesowner,
    ROUND(SUM(commission), 2) AS total_commission
FROM commission_calc
GROUP BY salesowner
ORDER BY total_commission DESC
  );
[0m22:06:17.830176 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.004 seconds
[0m22:06:17.836276 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m22:06:17.837277 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */
alter table "data_engineering_test"."public"."calculate_comissions" rename to "calculate_comissions__dbt_backup"
[0m22:06:17.839278 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m22:06:17.842782 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m22:06:17.843287 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */
alter table "data_engineering_test"."public"."calculate_comissions__dbt_tmp" rename to "calculate_comissions"
[0m22:06:17.845296 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m22:06:17.860315 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: COMMIT
[0m22:06:17.860315 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m22:06:17.861315 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: COMMIT
[0m22:06:17.864339 [debug] [Thread-1 (]: SQL status: COMMIT in 0.002 seconds
[0m22:06:17.870335 [debug] [Thread-1 (]: Applying DROP to: "data_engineering_test"."public"."calculate_comissions__dbt_backup"
[0m22:06:17.874485 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m22:06:17.875670 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */
drop view if exists "data_engineering_test"."public"."calculate_comissions__dbt_backup" cascade
[0m22:06:17.879669 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.004 seconds
[0m22:06:17.883183 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: Close
[0m22:06:17.885193 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1fb0a3dc-d8c2-4c04-822d-73a6dd959e5a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026072C1E380>]}
[0m22:06:17.886192 [info ] [Thread-1 (]: 1 of 1 OK created sql view model public.calculate_comissions ................... [[32mCREATE VIEW[0m in 0.14s]
[0m22:06:17.887196 [debug] [Thread-1 (]: Finished running node model.task_4.calculate_comissions
[0m22:06:17.888193 [debug] [MainThread]: Using postgres connection "master"
[0m22:06:17.889190 [debug] [MainThread]: On master: BEGIN
[0m22:06:17.889190 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m22:06:17.903725 [debug] [MainThread]: SQL status: BEGIN in 0.014 seconds
[0m22:06:17.903725 [debug] [MainThread]: On master: COMMIT
[0m22:06:17.904731 [debug] [MainThread]: Using postgres connection "master"
[0m22:06:17.904731 [debug] [MainThread]: On master: COMMIT
[0m22:06:17.906731 [debug] [MainThread]: SQL status: COMMIT in 0.001 seconds
[0m22:06:17.906731 [debug] [MainThread]: On master: Close
[0m22:06:17.907732 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:06:17.907732 [debug] [MainThread]: Connection 'list_data_engineering_test' was properly closed.
[0m22:06:17.907732 [debug] [MainThread]: Connection 'list_data_engineering_test_public' was properly closed.
[0m22:06:17.907732 [debug] [MainThread]: Connection 'model.task_4.calculate_comissions' was properly closed.
[0m22:06:17.909237 [info ] [MainThread]: 
[0m22:06:17.909237 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 0.34 seconds (0.34s).
[0m22:06:17.910244 [debug] [MainThread]: Command end result
[0m22:06:17.934576 [info ] [MainThread]: 
[0m22:06:17.935583 [info ] [MainThread]: [32mCompleted successfully[0m
[0m22:06:17.935583 [info ] [MainThread]: 
[0m22:06:17.936584 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m22:06:17.937582 [debug] [MainThread]: Command `dbt run` succeeded at 22:06:17.937582 after 1.19 seconds
[0m22:06:17.938583 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002606F659540>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000260715CCEE0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002606FA61CC0>]}
[0m22:06:17.938583 [debug] [MainThread]: Flushing usage events
[0m22:07:54.065365 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002225A3094B0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002225CE732B0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002225CE730D0>]}


============================== 22:07:54.070361 | 247dce4b-6b7b-4a94-8696-05482e3fa2ce ==============================
[0m22:07:54.070361 [info ] [MainThread]: Running with dbt=1.8.9
[0m22:07:54.071367 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4/dbt', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4\\dbt\\logs', 'fail_fast': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'invocation_command': 'dbt run --profiles-dir C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4/dbt --project-dir C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4/dbt', 'log_format': 'default', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m22:07:54.276383 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '247dce4b-6b7b-4a94-8696-05482e3fa2ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002225AB23190>]}
[0m22:07:54.325119 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '247dce4b-6b7b-4a94-8696-05482e3fa2ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022259DC3C40>]}
[0m22:07:54.327113 [info ] [MainThread]: Registered adapter: postgres=1.8.2
[0m22:07:54.596427 [debug] [MainThread]: checksum: 132857a23e9d07220246854f7763165174ce9b737cfc7867629ace4294e520b1, vars: {}, profile: , target: , version: 1.8.9
[0m22:07:54.726520 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m22:07:54.727521 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m22:07:54.754514 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '247dce4b-6b7b-4a94-8696-05482e3fa2ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002225D454130>]}
[0m22:07:54.838944 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '247dce4b-6b7b-4a94-8696-05482e3fa2ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002225D43FC70>]}
[0m22:07:54.839946 [info ] [MainThread]: Found 1 model, 428 macros
[0m22:07:54.839946 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '247dce4b-6b7b-4a94-8696-05482e3fa2ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002225D43CF10>]}
[0m22:07:54.840944 [info ] [MainThread]: 
[0m22:07:54.842448 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m22:07:54.843960 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_engineering_test'
[0m22:07:54.927788 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test"
[0m22:07:54.928792 [debug] [ThreadPool]: On list_data_engineering_test: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "list_data_engineering_test"} */

    select distinct nspname from pg_namespace
  
[0m22:07:54.928792 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:07:54.955453 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.027 seconds
[0m22:07:54.957451 [debug] [ThreadPool]: On list_data_engineering_test: Close
[0m22:07:54.958453 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_engineering_test_public'
[0m22:07:54.965005 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test_public"
[0m22:07:54.965005 [debug] [ThreadPool]: On list_data_engineering_test_public: BEGIN
[0m22:07:54.965005 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:07:55.000853 [debug] [ThreadPool]: SQL status: BEGIN in 0.036 seconds
[0m22:07:55.002360 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test_public"
[0m22:07:55.002360 [debug] [ThreadPool]: On list_data_engineering_test_public: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "list_data_engineering_test_public"} */
select
      'data_engineering_test' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_engineering_test' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_engineering_test' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m22:07:55.006396 [debug] [ThreadPool]: SQL status: SELECT 3 in 0.003 seconds
[0m22:07:55.007397 [debug] [ThreadPool]: On list_data_engineering_test_public: ROLLBACK
[0m22:07:55.008394 [debug] [ThreadPool]: On list_data_engineering_test_public: Close
[0m22:07:55.013410 [debug] [MainThread]: Using postgres connection "master"
[0m22:07:55.013410 [debug] [MainThread]: On master: BEGIN
[0m22:07:55.014417 [debug] [MainThread]: Opening a new connection, currently in state init
[0m22:07:55.027969 [debug] [MainThread]: SQL status: BEGIN in 0.014 seconds
[0m22:07:55.027969 [debug] [MainThread]: Using postgres connection "master"
[0m22:07:55.028972 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m22:07:55.033502 [debug] [MainThread]: SQL status: SELECT 2 in 0.004 seconds
[0m22:07:55.035513 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '247dce4b-6b7b-4a94-8696-05482e3fa2ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002225D469A50>]}
[0m22:07:55.035513 [debug] [MainThread]: On master: ROLLBACK
[0m22:07:55.036514 [debug] [MainThread]: Using postgres connection "master"
[0m22:07:55.037513 [debug] [MainThread]: On master: BEGIN
[0m22:07:55.039512 [debug] [MainThread]: SQL status: BEGIN in 0.001 seconds
[0m22:07:55.039512 [debug] [MainThread]: On master: COMMIT
[0m22:07:55.039512 [debug] [MainThread]: Using postgres connection "master"
[0m22:07:55.040514 [debug] [MainThread]: On master: COMMIT
[0m22:07:55.041512 [debug] [MainThread]: SQL status: COMMIT in 0.001 seconds
[0m22:07:55.041512 [debug] [MainThread]: On master: Close
[0m22:07:55.042514 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m22:07:55.043027 [info ] [MainThread]: 
[0m22:07:55.045077 [debug] [Thread-1 (]: Began running node model.task_4.calculate_comissions
[0m22:07:55.046084 [info ] [Thread-1 (]: 1 of 1 START sql view model public.calculate_comissions ........................ [RUN]
[0m22:07:55.047082 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.task_4.calculate_comissions'
[0m22:07:55.047082 [debug] [Thread-1 (]: Began compiling node model.task_4.calculate_comissions
[0m22:07:55.054167 [debug] [Thread-1 (]: Writing injected SQL for node "model.task_4.calculate_comissions"
[0m22:07:55.055171 [debug] [Thread-1 (]: Began executing node model.task_4.calculate_comissions
[0m22:07:55.092399 [debug] [Thread-1 (]: Writing runtime sql for node "model.task_4.calculate_comissions"
[0m22:07:55.093412 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m22:07:55.094425 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: BEGIN
[0m22:07:55.094967 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m22:07:55.108002 [debug] [Thread-1 (]: SQL status: BEGIN in 0.014 seconds
[0m22:07:55.108998 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m22:07:55.108998 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */

  create view "data_engineering_test"."public"."calculate_comissions__dbt_tmp"
    
    
  as (
    WITH orders_with_salesowners AS (
    SELECT
        o.order_id,
        round(i.gross_value / 100.0, 2) AS gross_value_in_euros,

        -- Converting the gross value into net value by taking the vat out in a non-lineal way.
        round((i.gross_value / 100.0) / (1 + i.vat / 100.0), 2) AS net_value_in_euros,
        string_to_array(o.salesowners, ', ') AS salesowners_array
    FROM
        public.orders o
    JOIN
        public.invoicing_data i ON o.order_id = i.order_id
),
salesowners AS (
    SELECT
        ows.order_id,
        ows.net_value_in_euros,
        so.salesowner,
        so.ordinality AS salesowner_position
    FROM
        orders_with_salesowners ows,
        unnest(ows.salesowners_array) WITH ORDINALITY AS so(salesowner, ordinality) -- unnests the array and assigns the order for each sales person in the order that it comes from the file
),
commission_calc AS (
    SELECT
        order_id,
        salesowner,
        CASE 
            WHEN salesowner_position = 1 THEN net_value_in_euros * 0.06    -- Main owner - 6%
            WHEN salesowner_position = 2 THEN net_value_in_euros * 0.025   -- Co-owner 1 - 2.5%
            WHEN salesowner_position = 3 THEN net_value_in_euros * 0.0095  -- Co-owner 2 - 0.95%
            ELSE 0  -- No comission
        END AS commission
    FROM salesowners
)
SELECT
    salesowner,
    ROUND(SUM(commission), 2) AS total_commission
FROM commission_calc
GROUP BY salesowner
ORDER BY total_commission DESC
  );
[0m22:07:55.113509 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.003 seconds
[0m22:07:55.119728 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m22:07:55.119728 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */
alter table "data_engineering_test"."public"."calculate_comissions" rename to "calculate_comissions__dbt_backup"
[0m22:07:55.122232 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m22:07:55.125748 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m22:07:55.125748 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */
alter table "data_engineering_test"."public"."calculate_comissions__dbt_tmp" rename to "calculate_comissions"
[0m22:07:55.127748 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m22:07:55.142422 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: COMMIT
[0m22:07:55.142927 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m22:07:55.143431 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: COMMIT
[0m22:07:55.146064 [debug] [Thread-1 (]: SQL status: COMMIT in 0.003 seconds
[0m22:07:55.152581 [debug] [Thread-1 (]: Applying DROP to: "data_engineering_test"."public"."calculate_comissions__dbt_backup"
[0m22:07:55.156195 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m22:07:55.157195 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */
drop view if exists "data_engineering_test"."public"."calculate_comissions__dbt_backup" cascade
[0m22:07:55.160195 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.002 seconds
[0m22:07:55.162702 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: Close
[0m22:07:55.164225 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '247dce4b-6b7b-4a94-8696-05482e3fa2ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002225D8DA380>]}
[0m22:07:55.165224 [info ] [Thread-1 (]: 1 of 1 OK created sql view model public.calculate_comissions ................... [[32mCREATE VIEW[0m in 0.12s]
[0m22:07:55.166223 [debug] [Thread-1 (]: Finished running node model.task_4.calculate_comissions
[0m22:07:55.167219 [debug] [MainThread]: Using postgres connection "master"
[0m22:07:55.167219 [debug] [MainThread]: On master: BEGIN
[0m22:07:55.168220 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m22:07:55.210054 [debug] [MainThread]: SQL status: BEGIN in 0.042 seconds
[0m22:07:55.210054 [debug] [MainThread]: On master: COMMIT
[0m22:07:55.211051 [debug] [MainThread]: Using postgres connection "master"
[0m22:07:55.211051 [debug] [MainThread]: On master: COMMIT
[0m22:07:55.212559 [debug] [MainThread]: SQL status: COMMIT in 0.001 seconds
[0m22:07:55.212559 [debug] [MainThread]: On master: Close
[0m22:07:55.213567 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:07:55.214079 [debug] [MainThread]: Connection 'list_data_engineering_test' was properly closed.
[0m22:07:55.214573 [debug] [MainThread]: Connection 'list_data_engineering_test_public' was properly closed.
[0m22:07:55.215086 [debug] [MainThread]: Connection 'model.task_4.calculate_comissions' was properly closed.
[0m22:07:55.215086 [info ] [MainThread]: 
[0m22:07:55.216096 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 0.37 seconds (0.37s).
[0m22:07:55.216096 [debug] [MainThread]: Command end result
[0m22:07:55.240213 [info ] [MainThread]: 
[0m22:07:55.241209 [info ] [MainThread]: [32mCompleted successfully[0m
[0m22:07:55.241209 [info ] [MainThread]: 
[0m22:07:55.242713 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m22:07:55.244232 [debug] [MainThread]: Command `dbt run` succeeded at 22:07:55.243226 after 1.25 seconds
[0m22:07:55.244350 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002225A3094B0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002225C87B430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002225A711D50>]}
[0m22:07:55.244350 [debug] [MainThread]: Flushing usage events
[0m22:08:04.517425 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BE81FF9480>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BE8453AF20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BE84C372E0>]}


============================== 22:08:04.521426 | 36f31a97-1766-447a-8614-2e44a8677220 ==============================
[0m22:08:04.521426 [info ] [MainThread]: Running with dbt=1.8.9
[0m22:08:04.522424 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4/dbt', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4\\dbt\\logs', 'warn_error': 'None', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'log_format': 'default', 'introspect': 'True', 'invocation_command': 'dbt run --profiles-dir C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4/dbt --project-dir C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4/dbt', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m22:08:04.729186 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '36f31a97-1766-447a-8614-2e44a8677220', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BE822AA680>]}
[0m22:08:04.778840 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '36f31a97-1766-447a-8614-2e44a8677220', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BE84A83BE0>]}
[0m22:08:04.779841 [info ] [MainThread]: Registered adapter: postgres=1.8.2
[0m22:08:05.041147 [debug] [MainThread]: checksum: 132857a23e9d07220246854f7763165174ce9b737cfc7867629ace4294e520b1, vars: {}, profile: , target: , version: 1.8.9
[0m22:08:05.171622 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m22:08:05.171622 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m22:08:05.199301 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '36f31a97-1766-447a-8614-2e44a8677220', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BE85214130>]}
[0m22:08:05.283300 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '36f31a97-1766-447a-8614-2e44a8677220', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BE8520AEF0>]}
[0m22:08:05.284387 [info ] [MainThread]: Found 1 model, 428 macros
[0m22:08:05.284387 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '36f31a97-1766-447a-8614-2e44a8677220', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BE8520A5C0>]}
[0m22:08:05.286314 [info ] [MainThread]: 
[0m22:08:05.287314 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m22:08:05.288315 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_engineering_test'
[0m22:08:05.373011 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test"
[0m22:08:05.373516 [debug] [ThreadPool]: On list_data_engineering_test: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "list_data_engineering_test"} */

    select distinct nspname from pg_namespace
  
[0m22:08:05.374626 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:08:05.392292 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.018 seconds
[0m22:08:05.393308 [debug] [ThreadPool]: On list_data_engineering_test: Close
[0m22:08:05.395417 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_engineering_test_public'
[0m22:08:05.401413 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test_public"
[0m22:08:05.401413 [debug] [ThreadPool]: On list_data_engineering_test_public: BEGIN
[0m22:08:05.402414 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:08:05.415505 [debug] [ThreadPool]: SQL status: BEGIN in 0.013 seconds
[0m22:08:05.415505 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test_public"
[0m22:08:05.416503 [debug] [ThreadPool]: On list_data_engineering_test_public: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "list_data_engineering_test_public"} */
select
      'data_engineering_test' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_engineering_test' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_engineering_test' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m22:08:05.419503 [debug] [ThreadPool]: SQL status: SELECT 3 in 0.003 seconds
[0m22:08:05.421502 [debug] [ThreadPool]: On list_data_engineering_test_public: ROLLBACK
[0m22:08:05.422505 [debug] [ThreadPool]: On list_data_engineering_test_public: Close
[0m22:08:05.427558 [debug] [MainThread]: Using postgres connection "master"
[0m22:08:05.427558 [debug] [MainThread]: On master: BEGIN
[0m22:08:05.428558 [debug] [MainThread]: Opening a new connection, currently in state init
[0m22:08:05.442294 [debug] [MainThread]: SQL status: BEGIN in 0.014 seconds
[0m22:08:05.443303 [debug] [MainThread]: Using postgres connection "master"
[0m22:08:05.443303 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m22:08:05.447621 [debug] [MainThread]: SQL status: SELECT 2 in 0.004 seconds
[0m22:08:05.449626 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '36f31a97-1766-447a-8614-2e44a8677220', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BE852090C0>]}
[0m22:08:05.450622 [debug] [MainThread]: On master: ROLLBACK
[0m22:08:05.451626 [debug] [MainThread]: Using postgres connection "master"
[0m22:08:05.451626 [debug] [MainThread]: On master: BEGIN
[0m22:08:05.454137 [debug] [MainThread]: SQL status: BEGIN in 0.001 seconds
[0m22:08:05.454267 [debug] [MainThread]: On master: COMMIT
[0m22:08:05.454267 [debug] [MainThread]: Using postgres connection "master"
[0m22:08:05.455275 [debug] [MainThread]: On master: COMMIT
[0m22:08:05.456277 [debug] [MainThread]: SQL status: COMMIT in 0.001 seconds
[0m22:08:05.456277 [debug] [MainThread]: On master: Close
[0m22:08:05.457273 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m22:08:05.457273 [info ] [MainThread]: 
[0m22:08:05.460485 [debug] [Thread-1 (]: Began running node model.task_4.calculate_comissions
[0m22:08:05.461499 [info ] [Thread-1 (]: 1 of 1 START sql view model public.calculate_comissions ........................ [RUN]
[0m22:08:05.461499 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.task_4.calculate_comissions'
[0m22:08:05.462497 [debug] [Thread-1 (]: Began compiling node model.task_4.calculate_comissions
[0m22:08:05.468512 [debug] [Thread-1 (]: Writing injected SQL for node "model.task_4.calculate_comissions"
[0m22:08:05.469935 [debug] [Thread-1 (]: Began executing node model.task_4.calculate_comissions
[0m22:08:05.505049 [debug] [Thread-1 (]: Writing runtime sql for node "model.task_4.calculate_comissions"
[0m22:08:05.506049 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m22:08:05.507050 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: BEGIN
[0m22:08:05.507050 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m22:08:05.520836 [debug] [Thread-1 (]: SQL status: BEGIN in 0.014 seconds
[0m22:08:05.522343 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m22:08:05.522343 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */

  create view "data_engineering_test"."public"."calculate_comissions__dbt_tmp"
    
    
  as (
    WITH orders_with_salesowners AS (
    SELECT
        o.order_id,
        round(i.gross_value / 100.0, 2) AS gross_value_in_euros,

        -- Converting the gross value into net value by taking the vat out in a non-lineal way.
        round((i.gross_value / 100.0) / (1 + i.vat / 100.0), 2) AS net_value_in_euros,
        string_to_array(o.salesowners, ', ') AS salesowners_array
    FROM
        public.orders o
    JOIN
        public.invoicing_data i ON o.order_id = i.order_id
),
salesowners AS (
    SELECT
        ows.order_id,
        ows.net_value_in_euros,
        so.salesowner,
        so.ordinality AS salesowner_position
    FROM
        orders_with_salesowners ows,
        unnest(ows.salesowners_array) WITH ORDINALITY AS so(salesowner, ordinality) -- unnests the array and assigns the order for each sales person in the order that it comes from the file
),
commission_calc AS (
    SELECT
        order_id,
        salesowner,
        CASE 
            WHEN salesowner_position = 1 THEN net_value_in_euros * 0.06    -- Main owner - 6%
            WHEN salesowner_position = 2 THEN net_value_in_euros * 0.025   -- Co-owner 1 - 2.5%
            WHEN salesowner_position = 3 THEN net_value_in_euros * 0.0095  -- Co-owner 2 - 0.95%
            ELSE 0  -- No comission
        END AS commission
    FROM salesowners
)
SELECT
    salesowner,
    ROUND(SUM(commission), 2) AS total_commission
FROM commission_calc
GROUP BY salesowner
ORDER BY total_commission DESC
  );
[0m22:08:05.525960 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.003 seconds
[0m22:08:05.533469 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m22:08:05.533976 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */
alter table "data_engineering_test"."public"."calculate_comissions" rename to "calculate_comissions__dbt_backup"
[0m22:08:05.534983 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m22:08:05.539495 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m22:08:05.540495 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */
alter table "data_engineering_test"."public"."calculate_comissions__dbt_tmp" rename to "calculate_comissions"
[0m22:08:05.541500 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m22:08:05.557071 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: COMMIT
[0m22:08:05.557071 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m22:08:05.558074 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: COMMIT
[0m22:08:05.561072 [debug] [Thread-1 (]: SQL status: COMMIT in 0.002 seconds
[0m22:08:05.567218 [debug] [Thread-1 (]: Applying DROP to: "data_engineering_test"."public"."calculate_comissions__dbt_backup"
[0m22:08:05.571218 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m22:08:05.571218 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */
drop view if exists "data_engineering_test"."public"."calculate_comissions__dbt_backup" cascade
[0m22:08:05.574238 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.002 seconds
[0m22:08:05.577238 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: Close
[0m22:08:05.579242 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '36f31a97-1766-447a-8614-2e44a8677220', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BE8569E380>]}
[0m22:08:05.579242 [info ] [Thread-1 (]: 1 of 1 OK created sql view model public.calculate_comissions ................... [[32mCREATE VIEW[0m in 0.12s]
[0m22:08:05.580238 [debug] [Thread-1 (]: Finished running node model.task_4.calculate_comissions
[0m22:08:05.581243 [debug] [MainThread]: Using postgres connection "master"
[0m22:08:05.582239 [debug] [MainThread]: On master: BEGIN
[0m22:08:05.582745 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m22:08:05.615808 [debug] [MainThread]: SQL status: BEGIN in 0.033 seconds
[0m22:08:05.616807 [debug] [MainThread]: On master: COMMIT
[0m22:08:05.616807 [debug] [MainThread]: Using postgres connection "master"
[0m22:08:05.616807 [debug] [MainThread]: On master: COMMIT
[0m22:08:05.618809 [debug] [MainThread]: SQL status: COMMIT in 0.001 seconds
[0m22:08:05.618809 [debug] [MainThread]: On master: Close
[0m22:08:05.619809 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:08:05.619809 [debug] [MainThread]: Connection 'list_data_engineering_test' was properly closed.
[0m22:08:05.619809 [debug] [MainThread]: Connection 'list_data_engineering_test_public' was properly closed.
[0m22:08:05.620808 [debug] [MainThread]: Connection 'model.task_4.calculate_comissions' was properly closed.
[0m22:08:05.620808 [info ] [MainThread]: 
[0m22:08:05.620808 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 0.33 seconds (0.33s).
[0m22:08:05.622315 [debug] [MainThread]: Command end result
[0m22:08:05.647178 [info ] [MainThread]: 
[0m22:08:05.647178 [info ] [MainThread]: [32mCompleted successfully[0m
[0m22:08:05.648180 [info ] [MainThread]: 
[0m22:08:05.648180 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m22:08:05.650181 [debug] [MainThread]: Command `dbt run` succeeded at 22:08:05.650181 after 1.20 seconds
[0m22:08:05.650181 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BE81FF9480>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BE8453ABC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BE823F1D50>]}
[0m22:08:05.651182 [debug] [MainThread]: Flushing usage events
[0m22:09:29.320202 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B2A7AF94E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B2AA66B2E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B2AA66B100>]}


============================== 22:09:29.324224 | cb3801ce-f7a1-4023-9fb7-75319190bc62 ==============================
[0m22:09:29.324224 [info ] [MainThread]: Running with dbt=1.8.9
[0m22:09:29.324349 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4/dbt', 'version_check': 'True', 'warn_error': 'None', 'log_path': 'C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4\\dbt\\logs', 'debug': 'False', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'log_format': 'default', 'introspect': 'True', 'target_path': 'None', 'invocation_command': 'dbt run --profiles-dir C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4/dbt --project-dir C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4/dbt', 'send_anonymous_usage_stats': 'True'}
[0m22:09:29.508053 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'cb3801ce-f7a1-4023-9fb7-75319190bc62', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B2A7DAA6E0>]}
[0m22:09:29.556597 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'cb3801ce-f7a1-4023-9fb7-75319190bc62', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B2A75B1750>]}
[0m22:09:29.558599 [info ] [MainThread]: Registered adapter: postgres=1.8.2
[0m22:09:29.816377 [debug] [MainThread]: checksum: 132857a23e9d07220246854f7763165174ce9b737cfc7867629ace4294e520b1, vars: {}, profile: , target: , version: 1.8.9
[0m22:09:29.944210 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m22:09:29.945210 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m22:09:29.972312 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'cb3801ce-f7a1-4023-9fb7-75319190bc62', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B2AAC44130>]}
[0m22:09:30.056364 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'cb3801ce-f7a1-4023-9fb7-75319190bc62', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B2AAC343A0>]}
[0m22:09:30.057365 [info ] [MainThread]: Found 1 model, 428 macros
[0m22:09:30.057365 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'cb3801ce-f7a1-4023-9fb7-75319190bc62', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B2AAC370A0>]}
[0m22:09:30.059362 [info ] [MainThread]: 
[0m22:09:30.060362 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m22:09:30.061363 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_engineering_test'
[0m22:09:30.145076 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test"
[0m22:09:30.145076 [debug] [ThreadPool]: On list_data_engineering_test: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "list_data_engineering_test"} */

    select distinct nspname from pg_namespace
  
[0m22:09:30.146075 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:09:30.164128 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.018 seconds
[0m22:09:30.166129 [debug] [ThreadPool]: On list_data_engineering_test: Close
[0m22:09:30.167133 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_engineering_test_public'
[0m22:09:30.173144 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test_public"
[0m22:09:30.174249 [debug] [ThreadPool]: On list_data_engineering_test_public: BEGIN
[0m22:09:30.174249 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:09:30.188272 [debug] [ThreadPool]: SQL status: BEGIN in 0.014 seconds
[0m22:09:30.188272 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test_public"
[0m22:09:30.189272 [debug] [ThreadPool]: On list_data_engineering_test_public: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "list_data_engineering_test_public"} */
select
      'data_engineering_test' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_engineering_test' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_engineering_test' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m22:09:30.192309 [debug] [ThreadPool]: SQL status: SELECT 3 in 0.003 seconds
[0m22:09:30.194434 [debug] [ThreadPool]: On list_data_engineering_test_public: ROLLBACK
[0m22:09:30.195957 [debug] [ThreadPool]: On list_data_engineering_test_public: Close
[0m22:09:30.199956 [debug] [MainThread]: Using postgres connection "master"
[0m22:09:30.200959 [debug] [MainThread]: On master: BEGIN
[0m22:09:30.200959 [debug] [MainThread]: Opening a new connection, currently in state init
[0m22:09:30.214750 [debug] [MainThread]: SQL status: BEGIN in 0.014 seconds
[0m22:09:30.215757 [debug] [MainThread]: Using postgres connection "master"
[0m22:09:30.215757 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m22:09:30.222262 [debug] [MainThread]: SQL status: SELECT 2 in 0.005 seconds
[0m22:09:30.223786 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'cb3801ce-f7a1-4023-9fb7-75319190bc62', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B2AAC35720>]}
[0m22:09:30.224798 [debug] [MainThread]: On master: ROLLBACK
[0m22:09:30.225796 [debug] [MainThread]: Using postgres connection "master"
[0m22:09:30.225796 [debug] [MainThread]: On master: BEGIN
[0m22:09:30.227795 [debug] [MainThread]: SQL status: BEGIN in 0.001 seconds
[0m22:09:30.228794 [debug] [MainThread]: On master: COMMIT
[0m22:09:30.228794 [debug] [MainThread]: Using postgres connection "master"
[0m22:09:30.229795 [debug] [MainThread]: On master: COMMIT
[0m22:09:30.230796 [debug] [MainThread]: SQL status: COMMIT in 0.001 seconds
[0m22:09:30.230796 [debug] [MainThread]: On master: Close
[0m22:09:30.230796 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m22:09:30.232306 [info ] [MainThread]: 
[0m22:09:30.234458 [debug] [Thread-1 (]: Began running node model.task_4.calculate_comissions
[0m22:09:30.235597 [info ] [Thread-1 (]: 1 of 1 START sql view model public.calculate_comissions ........................ [RUN]
[0m22:09:30.236597 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.task_4.calculate_comissions'
[0m22:09:30.236597 [debug] [Thread-1 (]: Began compiling node model.task_4.calculate_comissions
[0m22:09:30.243102 [debug] [Thread-1 (]: Writing injected SQL for node "model.task_4.calculate_comissions"
[0m22:09:30.244107 [debug] [Thread-1 (]: Began executing node model.task_4.calculate_comissions
[0m22:09:30.278314 [debug] [Thread-1 (]: Writing runtime sql for node "model.task_4.calculate_comissions"
[0m22:09:30.280316 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m22:09:30.280316 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: BEGIN
[0m22:09:30.281316 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m22:09:30.296427 [debug] [Thread-1 (]: SQL status: BEGIN in 0.015 seconds
[0m22:09:30.297427 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m22:09:30.297427 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */

  create view "data_engineering_test"."public"."calculate_comissions__dbt_tmp"
    
    
  as (
    WITH orders_with_salesowners AS (
    SELECT
        o.order_id,
        round(i.gross_value / 100.0, 2) AS gross_value_in_euros,

        -- Converting the gross value into net value by taking the vat out in a non-lineal way.
        round((i.gross_value / 100.0) / (1 + i.vat / 100.0), 2) AS net_value_in_euros,
        string_to_array(o.salesowners, ', ') AS salesowners_array
    FROM
        public.orders o
    JOIN
        public.invoicing_data i ON o.order_id = i.order_id
),
salesowners AS (
    SELECT
        ows.order_id,
        ows.net_value_in_euros,
        so.salesowner,
        so.ordinality AS salesowner_position
    FROM
        orders_with_salesowners ows,
        unnest(ows.salesowners_array) WITH ORDINALITY AS so(salesowner, ordinality) -- unnests the array and assigns the order for each sales person in the order that it comes from the file
),
commission_calc AS (
    SELECT
        order_id,
        salesowner,
        CASE 
            WHEN salesowner_position = 1 THEN net_value_in_euros * 0.06    -- Main owner - 6%
            WHEN salesowner_position = 2 THEN net_value_in_euros * 0.025   -- Co-owner 1 - 2.5%
            WHEN salesowner_position = 3 THEN net_value_in_euros * 0.0095  -- Co-owner 2 - 0.95%
            ELSE 0  -- No comission
        END AS commission
    FROM salesowners
)
SELECT
    salesowner,
    ROUND(SUM(commission), 2) AS total_commission
FROM commission_calc
GROUP BY salesowner
ORDER BY total_commission DESC
  );
[0m22:09:30.301426 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.003 seconds
[0m22:09:30.307996 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m22:09:30.308996 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */
alter table "data_engineering_test"."public"."calculate_comissions" rename to "calculate_comissions__dbt_backup"
[0m22:09:30.310001 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m22:09:30.314016 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m22:09:30.314016 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */
alter table "data_engineering_test"."public"."calculate_comissions__dbt_tmp" rename to "calculate_comissions"
[0m22:09:30.316025 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m22:09:30.330185 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: COMMIT
[0m22:09:30.331181 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m22:09:30.332190 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: COMMIT
[0m22:09:30.335335 [debug] [Thread-1 (]: SQL status: COMMIT in 0.003 seconds
[0m22:09:30.340345 [debug] [Thread-1 (]: Applying DROP to: "data_engineering_test"."public"."calculate_comissions__dbt_backup"
[0m22:09:30.345438 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m22:09:30.345438 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */
drop view if exists "data_engineering_test"."public"."calculate_comissions__dbt_backup" cascade
[0m22:09:30.348439 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.003 seconds
[0m22:09:30.351438 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: Close
[0m22:09:30.352444 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cb3801ce-f7a1-4023-9fb7-75319190bc62', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B2AB0CA380>]}
[0m22:09:30.353576 [info ] [Thread-1 (]: 1 of 1 OK created sql view model public.calculate_comissions ................... [[32mCREATE VIEW[0m in 0.12s]
[0m22:09:30.354583 [debug] [Thread-1 (]: Finished running node model.task_4.calculate_comissions
[0m22:09:30.355585 [debug] [MainThread]: Using postgres connection "master"
[0m22:09:30.355585 [debug] [MainThread]: On master: BEGIN
[0m22:09:30.356583 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m22:09:30.390770 [debug] [MainThread]: SQL status: BEGIN in 0.035 seconds
[0m22:09:30.392228 [debug] [MainThread]: On master: COMMIT
[0m22:09:30.392228 [debug] [MainThread]: Using postgres connection "master"
[0m22:09:30.393237 [debug] [MainThread]: On master: COMMIT
[0m22:09:30.393743 [debug] [MainThread]: SQL status: COMMIT in 0.001 seconds
[0m22:09:30.394750 [debug] [MainThread]: On master: Close
[0m22:09:30.395748 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:09:30.395748 [debug] [MainThread]: Connection 'list_data_engineering_test' was properly closed.
[0m22:09:30.396752 [debug] [MainThread]: Connection 'list_data_engineering_test_public' was properly closed.
[0m22:09:30.396752 [debug] [MainThread]: Connection 'model.task_4.calculate_comissions' was properly closed.
[0m22:09:30.396752 [info ] [MainThread]: 
[0m22:09:30.397749 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 0.34 seconds (0.34s).
[0m22:09:30.398751 [debug] [MainThread]: Command end result
[0m22:09:30.422196 [info ] [MainThread]: 
[0m22:09:30.423202 [info ] [MainThread]: [32mCompleted successfully[0m
[0m22:09:30.423713 [info ] [MainThread]: 
[0m22:09:30.423713 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m22:09:30.425723 [debug] [MainThread]: Command `dbt run` succeeded at 22:09:30.424719 after 1.17 seconds
[0m22:09:30.425723 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B2A7AF94E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B2AA06B760>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B2A7F01CC0>]}
[0m22:09:30.425723 [debug] [MainThread]: Flushing usage events
[0m22:09:33.148474 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F1FE4294B0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F18115B2B0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F18115B0D0>]}


============================== 22:09:33.152181 | b8cafa35-3356-4b0c-a667-b99da9a016d3 ==============================
[0m22:09:33.152181 [info ] [MainThread]: Running with dbt=1.8.9
[0m22:09:33.153206 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4/dbt', 'fail_fast': 'False', 'warn_error': 'None', 'log_path': 'C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4\\dbt\\logs', 'version_check': 'True', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'log_format': 'default', 'static_parser': 'True', 'invocation_command': 'dbt run --profiles-dir C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4/dbt --project-dir C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4/dbt', 'introspect': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m22:09:33.340619 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'b8cafa35-3356-4b0c-a667-b99da9a016d3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F1FEC43190>]}
[0m22:09:33.391277 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'b8cafa35-3356-4b0c-a667-b99da9a016d3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F180FA3C40>]}
[0m22:09:33.393288 [info ] [MainThread]: Registered adapter: postgres=1.8.2
[0m22:09:33.675532 [debug] [MainThread]: checksum: 132857a23e9d07220246854f7763165174ce9b737cfc7867629ace4294e520b1, vars: {}, profile: , target: , version: 1.8.9
[0m22:09:33.804945 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m22:09:33.804945 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m22:09:33.832641 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'b8cafa35-3356-4b0c-a667-b99da9a016d3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F181734130>]}
[0m22:09:33.919919 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'b8cafa35-3356-4b0c-a667-b99da9a016d3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F18172A5C0>]}
[0m22:09:33.919919 [info ] [MainThread]: Found 1 model, 428 macros
[0m22:09:33.920917 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'b8cafa35-3356-4b0c-a667-b99da9a016d3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F18172B100>]}
[0m22:09:33.922421 [info ] [MainThread]: 
[0m22:09:33.923426 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m22:09:33.924516 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_engineering_test'
[0m22:09:34.008816 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test"
[0m22:09:34.008816 [debug] [ThreadPool]: On list_data_engineering_test: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "list_data_engineering_test"} */

    select distinct nspname from pg_namespace
  
[0m22:09:34.009819 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:09:34.027775 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.018 seconds
[0m22:09:34.029775 [debug] [ThreadPool]: On list_data_engineering_test: Close
[0m22:09:34.030777 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_engineering_test_public'
[0m22:09:34.037898 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test_public"
[0m22:09:34.038901 [debug] [ThreadPool]: On list_data_engineering_test_public: BEGIN
[0m22:09:34.038901 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:09:34.053454 [debug] [ThreadPool]: SQL status: BEGIN in 0.015 seconds
[0m22:09:34.054641 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test_public"
[0m22:09:34.055152 [debug] [ThreadPool]: On list_data_engineering_test_public: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "list_data_engineering_test_public"} */
select
      'data_engineering_test' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_engineering_test' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_engineering_test' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m22:09:34.059161 [debug] [ThreadPool]: SQL status: SELECT 3 in 0.003 seconds
[0m22:09:34.060161 [debug] [ThreadPool]: On list_data_engineering_test_public: ROLLBACK
[0m22:09:34.061158 [debug] [ThreadPool]: On list_data_engineering_test_public: Close
[0m22:09:34.067208 [debug] [MainThread]: Using postgres connection "master"
[0m22:09:34.067208 [debug] [MainThread]: On master: BEGIN
[0m22:09:34.068206 [debug] [MainThread]: Opening a new connection, currently in state init
[0m22:09:34.083157 [debug] [MainThread]: SQL status: BEGIN in 0.015 seconds
[0m22:09:34.084165 [debug] [MainThread]: Using postgres connection "master"
[0m22:09:34.085166 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m22:09:34.091166 [debug] [MainThread]: SQL status: SELECT 2 in 0.005 seconds
[0m22:09:34.093171 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'b8cafa35-3356-4b0c-a667-b99da9a016d3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F181749A50>]}
[0m22:09:34.093171 [debug] [MainThread]: On master: ROLLBACK
[0m22:09:34.094685 [debug] [MainThread]: Using postgres connection "master"
[0m22:09:34.095690 [debug] [MainThread]: On master: BEGIN
[0m22:09:34.097693 [debug] [MainThread]: SQL status: BEGIN in 0.001 seconds
[0m22:09:34.097693 [debug] [MainThread]: On master: COMMIT
[0m22:09:34.098695 [debug] [MainThread]: Using postgres connection "master"
[0m22:09:34.098695 [debug] [MainThread]: On master: COMMIT
[0m22:09:34.099691 [debug] [MainThread]: SQL status: COMMIT in 0.001 seconds
[0m22:09:34.100691 [debug] [MainThread]: On master: Close
[0m22:09:34.100691 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m22:09:34.100691 [info ] [MainThread]: 
[0m22:09:34.104727 [debug] [Thread-1 (]: Began running node model.task_4.calculate_comissions
[0m22:09:34.104727 [info ] [Thread-1 (]: 1 of 1 START sql view model public.calculate_comissions ........................ [RUN]
[0m22:09:34.105727 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.task_4.calculate_comissions'
[0m22:09:34.106728 [debug] [Thread-1 (]: Began compiling node model.task_4.calculate_comissions
[0m22:09:34.113237 [debug] [Thread-1 (]: Writing injected SQL for node "model.task_4.calculate_comissions"
[0m22:09:34.113743 [debug] [Thread-1 (]: Began executing node model.task_4.calculate_comissions
[0m22:09:34.147851 [debug] [Thread-1 (]: Writing runtime sql for node "model.task_4.calculate_comissions"
[0m22:09:34.148852 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m22:09:34.149852 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: BEGIN
[0m22:09:34.150853 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m22:09:34.164644 [debug] [Thread-1 (]: SQL status: BEGIN in 0.014 seconds
[0m22:09:34.165652 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m22:09:34.165652 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */

  create view "data_engineering_test"."public"."calculate_comissions__dbt_tmp"
    
    
  as (
    WITH orders_with_salesowners AS (
    SELECT
        o.order_id,
        round(i.gross_value / 100.0, 2) AS gross_value_in_euros,

        -- Converting the gross value into net value by taking the vat out in a non-lineal way.
        round((i.gross_value / 100.0) / (1 + i.vat / 100.0), 2) AS net_value_in_euros,
        string_to_array(o.salesowners, ', ') AS salesowners_array
    FROM
        public.orders o
    JOIN
        public.invoicing_data i ON o.order_id = i.order_id
),
salesowners AS (
    SELECT
        ows.order_id,
        ows.net_value_in_euros,
        so.salesowner,
        so.ordinality AS salesowner_position
    FROM
        orders_with_salesowners ows,
        unnest(ows.salesowners_array) WITH ORDINALITY AS so(salesowner, ordinality) -- unnests the array and assigns the order for each sales person in the order that it comes from the file
),
commission_calc AS (
    SELECT
        order_id,
        salesowner,
        CASE 
            WHEN salesowner_position = 1 THEN net_value_in_euros * 0.06    -- Main owner - 6%
            WHEN salesowner_position = 2 THEN net_value_in_euros * 0.025   -- Co-owner 1 - 2.5%
            WHEN salesowner_position = 3 THEN net_value_in_euros * 0.0095  -- Co-owner 2 - 0.95%
            ELSE 0  -- No comission
        END AS commission
    FROM salesowners
)
SELECT
    salesowner,
    ROUND(SUM(commission), 2) AS total_commission
FROM commission_calc
GROUP BY salesowner
ORDER BY total_commission DESC
  );
[0m22:09:34.169655 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.003 seconds
[0m22:09:34.177680 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m22:09:34.178682 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */
alter table "data_engineering_test"."public"."calculate_comissions" rename to "calculate_comissions__dbt_backup"
[0m22:09:34.179682 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m22:09:34.184710 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m22:09:34.184710 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */
alter table "data_engineering_test"."public"."calculate_comissions__dbt_tmp" rename to "calculate_comissions"
[0m22:09:34.186708 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m22:09:34.201238 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: COMMIT
[0m22:09:34.202240 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m22:09:34.202746 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: COMMIT
[0m22:09:34.204353 [debug] [Thread-1 (]: SQL status: COMMIT in 0.002 seconds
[0m22:09:34.210361 [debug] [Thread-1 (]: Applying DROP to: "data_engineering_test"."public"."calculate_comissions__dbt_backup"
[0m22:09:34.215385 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m22:09:34.215385 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */
drop view if exists "data_engineering_test"."public"."calculate_comissions__dbt_backup" cascade
[0m22:09:34.218382 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.002 seconds
[0m22:09:34.221385 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: Close
[0m22:09:34.223397 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b8cafa35-3356-4b0c-a667-b99da9a016d3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F181BAE380>]}
[0m22:09:34.223397 [info ] [Thread-1 (]: 1 of 1 OK created sql view model public.calculate_comissions ................... [[32mCREATE VIEW[0m in 0.12s]
[0m22:09:34.224468 [debug] [Thread-1 (]: Finished running node model.task_4.calculate_comissions
[0m22:09:34.225413 [debug] [MainThread]: Using postgres connection "master"
[0m22:09:34.226412 [debug] [MainThread]: On master: BEGIN
[0m22:09:34.226412 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m22:09:34.240373 [debug] [MainThread]: SQL status: BEGIN in 0.013 seconds
[0m22:09:34.240373 [debug] [MainThread]: On master: COMMIT
[0m22:09:34.241371 [debug] [MainThread]: Using postgres connection "master"
[0m22:09:34.241371 [debug] [MainThread]: On master: COMMIT
[0m22:09:34.242371 [debug] [MainThread]: SQL status: COMMIT in 0.001 seconds
[0m22:09:34.243420 [debug] [MainThread]: On master: Close
[0m22:09:34.243420 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:09:34.244511 [debug] [MainThread]: Connection 'list_data_engineering_test' was properly closed.
[0m22:09:34.244511 [debug] [MainThread]: Connection 'list_data_engineering_test_public' was properly closed.
[0m22:09:34.244511 [debug] [MainThread]: Connection 'model.task_4.calculate_comissions' was properly closed.
[0m22:09:34.245518 [info ] [MainThread]: 
[0m22:09:34.245518 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 0.32 seconds (0.32s).
[0m22:09:34.246518 [debug] [MainThread]: Command end result
[0m22:09:34.271278 [info ] [MainThread]: 
[0m22:09:34.271278 [info ] [MainThread]: [32mCompleted successfully[0m
[0m22:09:34.272278 [info ] [MainThread]: 
[0m22:09:34.273088 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m22:09:34.274626 [debug] [MainThread]: Command `dbt run` succeeded at 22:09:34.274097 after 1.19 seconds
[0m22:09:34.274626 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F1FE4294B0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F180A5B430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F1FE831D50>]}
[0m22:09:34.275632 [debug] [MainThread]: Flushing usage events
[0m22:09:36.750682 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E0B4759510>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E0B72C3340>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E0B72C3160>]}


============================== 22:09:36.755236 | 4330e778-002f-477e-a986-05cf22371fe6 ==============================
[0m22:09:36.755236 [info ] [MainThread]: Running with dbt=1.8.9
[0m22:09:36.756239 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'profiles_dir': 'C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4/dbt', 'log_path': 'C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4\\dbt\\logs', 'fail_fast': 'False', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --profiles-dir C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4/dbt --project-dir C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4/dbt', 'static_parser': 'True', 'introspect': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m22:09:36.953164 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '4330e778-002f-477e-a986-05cf22371fe6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E0B72D07C0>]}
[0m22:09:37.005639 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '4330e778-002f-477e-a986-05cf22371fe6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E0B72D3730>]}
[0m22:09:37.007161 [info ] [MainThread]: Registered adapter: postgres=1.8.2
[0m22:09:37.269127 [debug] [MainThread]: checksum: 132857a23e9d07220246854f7763165174ce9b737cfc7867629ace4294e520b1, vars: {}, profile: , target: , version: 1.8.9
[0m22:09:37.397264 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m22:09:37.398266 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m22:09:37.424803 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '4330e778-002f-477e-a986-05cf22371fe6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E0B78A0130>]}
[0m22:09:37.508890 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '4330e778-002f-477e-a986-05cf22371fe6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E0B7893040>]}
[0m22:09:37.508890 [info ] [MainThread]: Found 1 model, 428 macros
[0m22:09:37.509888 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '4330e778-002f-477e-a986-05cf22371fe6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E0B78930A0>]}
[0m22:09:37.510889 [info ] [MainThread]: 
[0m22:09:37.510889 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m22:09:37.513398 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_engineering_test'
[0m22:09:37.599764 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test"
[0m22:09:37.600751 [debug] [ThreadPool]: On list_data_engineering_test: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "list_data_engineering_test"} */

    select distinct nspname from pg_namespace
  
[0m22:09:37.600751 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:09:37.619885 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.018 seconds
[0m22:09:37.620882 [debug] [ThreadPool]: On list_data_engineering_test: Close
[0m22:09:37.622391 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_engineering_test_public'
[0m22:09:37.628914 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test_public"
[0m22:09:37.628914 [debug] [ThreadPool]: On list_data_engineering_test_public: BEGIN
[0m22:09:37.629915 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:09:37.644606 [debug] [ThreadPool]: SQL status: BEGIN in 0.014 seconds
[0m22:09:37.644606 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test_public"
[0m22:09:37.645526 [debug] [ThreadPool]: On list_data_engineering_test_public: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "list_data_engineering_test_public"} */
select
      'data_engineering_test' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_engineering_test' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_engineering_test' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m22:09:37.649530 [debug] [ThreadPool]: SQL status: SELECT 3 in 0.004 seconds
[0m22:09:37.651526 [debug] [ThreadPool]: On list_data_engineering_test_public: ROLLBACK
[0m22:09:37.652526 [debug] [ThreadPool]: On list_data_engineering_test_public: Close
[0m22:09:37.656537 [debug] [MainThread]: Using postgres connection "master"
[0m22:09:37.657532 [debug] [MainThread]: On master: BEGIN
[0m22:09:37.657532 [debug] [MainThread]: Opening a new connection, currently in state init
[0m22:09:37.670550 [debug] [MainThread]: SQL status: BEGIN in 0.013 seconds
[0m22:09:37.671548 [debug] [MainThread]: Using postgres connection "master"
[0m22:09:37.671548 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m22:09:37.677562 [debug] [MainThread]: SQL status: SELECT 2 in 0.005 seconds
[0m22:09:37.679566 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '4330e778-002f-477e-a986-05cf22371fe6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E0B78A8520>]}
[0m22:09:37.680562 [debug] [MainThread]: On master: ROLLBACK
[0m22:09:37.681566 [debug] [MainThread]: Using postgres connection "master"
[0m22:09:37.681566 [debug] [MainThread]: On master: BEGIN
[0m22:09:37.683572 [debug] [MainThread]: SQL status: BEGIN in 0.001 seconds
[0m22:09:37.683572 [debug] [MainThread]: On master: COMMIT
[0m22:09:37.684578 [debug] [MainThread]: Using postgres connection "master"
[0m22:09:37.685098 [debug] [MainThread]: On master: COMMIT
[0m22:09:37.686103 [debug] [MainThread]: SQL status: COMMIT in 0.001 seconds
[0m22:09:37.686103 [debug] [MainThread]: On master: Close
[0m22:09:37.687103 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m22:09:37.687103 [info ] [MainThread]: 
[0m22:09:37.690104 [debug] [Thread-1 (]: Began running node model.task_4.calculate_comissions
[0m22:09:37.691110 [info ] [Thread-1 (]: 1 of 1 START sql view model public.calculate_comissions ........................ [RUN]
[0m22:09:37.691110 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.task_4.calculate_comissions'
[0m22:09:37.691110 [debug] [Thread-1 (]: Began compiling node model.task_4.calculate_comissions
[0m22:09:37.698661 [debug] [Thread-1 (]: Writing injected SQL for node "model.task_4.calculate_comissions"
[0m22:09:37.699673 [debug] [Thread-1 (]: Began executing node model.task_4.calculate_comissions
[0m22:09:37.733852 [debug] [Thread-1 (]: Writing runtime sql for node "model.task_4.calculate_comissions"
[0m22:09:37.734863 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m22:09:37.734863 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: BEGIN
[0m22:09:37.735864 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m22:09:37.749890 [debug] [Thread-1 (]: SQL status: BEGIN in 0.014 seconds
[0m22:09:37.750892 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m22:09:37.750892 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */

  create view "data_engineering_test"."public"."calculate_comissions__dbt_tmp"
    
    
  as (
    WITH orders_with_salesowners AS (
    SELECT
        o.order_id,
        round(i.gross_value / 100.0, 2) AS gross_value_in_euros,

        -- Converting the gross value into net value by taking the vat out in a non-lineal way.
        round((i.gross_value / 100.0) / (1 + i.vat / 100.0), 2) AS net_value_in_euros,
        string_to_array(o.salesowners, ', ') AS salesowners_array
    FROM
        public.orders o
    JOIN
        public.invoicing_data i ON o.order_id = i.order_id
),
salesowners AS (
    SELECT
        ows.order_id,
        ows.net_value_in_euros,
        so.salesowner,
        so.ordinality AS salesowner_position
    FROM
        orders_with_salesowners ows,
        unnest(ows.salesowners_array) WITH ORDINALITY AS so(salesowner, ordinality) -- unnests the array and assigns the order for each sales person in the order that it comes from the file
),
commission_calc AS (
    SELECT
        order_id,
        salesowner,
        CASE 
            WHEN salesowner_position = 1 THEN net_value_in_euros * 0.06    -- Main owner - 6%
            WHEN salesowner_position = 2 THEN net_value_in_euros * 0.025   -- Co-owner 1 - 2.5%
            WHEN salesowner_position = 3 THEN net_value_in_euros * 0.0095  -- Co-owner 2 - 0.95%
            ELSE 0  -- No comission
        END AS commission
    FROM salesowners
)
SELECT
    salesowner,
    ROUND(SUM(commission), 2) AS total_commission
FROM commission_calc
GROUP BY salesowner
ORDER BY total_commission DESC
  );
[0m22:09:37.754936 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.003 seconds
[0m22:09:37.760935 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m22:09:37.762502 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */
alter table "data_engineering_test"."public"."calculate_comissions" rename to "calculate_comissions__dbt_backup"
[0m22:09:37.763961 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m22:09:37.767972 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m22:09:37.767972 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */
alter table "data_engineering_test"."public"."calculate_comissions__dbt_tmp" rename to "calculate_comissions"
[0m22:09:37.769969 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m22:09:37.784045 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: COMMIT
[0m22:09:37.785056 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m22:09:37.785056 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: COMMIT
[0m22:09:37.787565 [debug] [Thread-1 (]: SQL status: COMMIT in 0.002 seconds
[0m22:09:37.794638 [debug] [Thread-1 (]: Applying DROP to: "data_engineering_test"."public"."calculate_comissions__dbt_backup"
[0m22:09:37.798689 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m22:09:37.798689 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */
drop view if exists "data_engineering_test"."public"."calculate_comissions__dbt_backup" cascade
[0m22:09:37.801695 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.002 seconds
[0m22:09:37.804205 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: Close
[0m22:09:37.806209 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4330e778-002f-477e-a986-05cf22371fe6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E0B7D1E380>]}
[0m22:09:37.807209 [info ] [Thread-1 (]: 1 of 1 OK created sql view model public.calculate_comissions ................... [[32mCREATE VIEW[0m in 0.11s]
[0m22:09:37.808208 [debug] [Thread-1 (]: Finished running node model.task_4.calculate_comissions
[0m22:09:37.809205 [debug] [MainThread]: Using postgres connection "master"
[0m22:09:37.809205 [debug] [MainThread]: On master: BEGIN
[0m22:09:37.810207 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m22:09:37.840569 [debug] [MainThread]: SQL status: BEGIN in 0.031 seconds
[0m22:09:37.841568 [debug] [MainThread]: On master: COMMIT
[0m22:09:37.841568 [debug] [MainThread]: Using postgres connection "master"
[0m22:09:37.842565 [debug] [MainThread]: On master: COMMIT
[0m22:09:37.843579 [debug] [MainThread]: SQL status: COMMIT in 0.001 seconds
[0m22:09:37.843579 [debug] [MainThread]: On master: Close
[0m22:09:37.844590 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:09:37.844590 [debug] [MainThread]: Connection 'list_data_engineering_test' was properly closed.
[0m22:09:37.845589 [debug] [MainThread]: Connection 'list_data_engineering_test_public' was properly closed.
[0m22:09:37.845589 [debug] [MainThread]: Connection 'model.task_4.calculate_comissions' was properly closed.
[0m22:09:37.846588 [info ] [MainThread]: 
[0m22:09:37.846588 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 0.34 seconds (0.34s).
[0m22:09:37.847588 [debug] [MainThread]: Command end result
[0m22:09:37.871141 [info ] [MainThread]: 
[0m22:09:37.872645 [info ] [MainThread]: [32mCompleted successfully[0m
[0m22:09:37.872645 [info ] [MainThread]: 
[0m22:09:37.873159 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m22:09:37.874618 [debug] [MainThread]: Command `dbt run` succeeded at 22:09:37.874618 after 1.19 seconds
[0m22:09:37.874618 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E0B4759510>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E0B72C3D00>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E0B7799030>]}
[0m22:09:37.875623 [debug] [MainThread]: Flushing usage events
[0m22:24:24.174840 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EE0F9BD450>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EE12527280>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EE125270A0>]}


============================== 22:24:24.178843 | fd74a0dc-de63-4aec-881f-ad4eb0c25e59 ==============================
[0m22:24:24.178843 [info ] [MainThread]: Running with dbt=1.8.9
[0m22:24:24.179842 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4/dbt', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4\\dbt\\logs', 'warn_error': 'None', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'log_format': 'default', 'introspect': 'True', 'target_path': 'None', 'invocation_command': 'dbt run --profiles-dir C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4/dbt --project-dir C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4/dbt', 'send_anonymous_usage_stats': 'True'}
[0m22:24:24.370370 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'fd74a0dc-de63-4aec-881f-ad4eb0c25e59', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EE1252A830>]}
[0m22:24:24.420521 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'fd74a0dc-de63-4aec-881f-ad4eb0c25e59', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EE0F470130>]}
[0m22:24:24.422519 [info ] [MainThread]: Registered adapter: postgres=1.8.2
[0m22:24:24.685343 [debug] [MainThread]: checksum: 132857a23e9d07220246854f7763165174ce9b737cfc7867629ace4294e520b1, vars: {}, profile: , target: , version: 1.8.9
[0m22:24:24.832237 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m22:24:24.833256 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m22:24:24.862314 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'fd74a0dc-de63-4aec-881f-ad4eb0c25e59', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EE12AFC130>]}
[0m22:24:24.954900 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'fd74a0dc-de63-4aec-881f-ad4eb0c25e59', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EE12ABA410>]}
[0m22:24:24.955901 [info ] [MainThread]: Found 1 model, 428 macros
[0m22:24:24.956901 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'fd74a0dc-de63-4aec-881f-ad4eb0c25e59', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EE12ABA4D0>]}
[0m22:24:24.957901 [info ] [MainThread]: 
[0m22:24:24.958901 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m22:24:24.960410 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_engineering_test'
[0m22:24:25.051327 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test"
[0m22:24:25.052328 [debug] [ThreadPool]: On list_data_engineering_test: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "list_data_engineering_test"} */

    select distinct nspname from pg_namespace
  
[0m22:24:25.052834 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:24:25.070667 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.018 seconds
[0m22:24:25.072666 [debug] [ThreadPool]: On list_data_engineering_test: Close
[0m22:24:25.074180 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_engineering_test_public'
[0m22:24:25.080177 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test_public"
[0m22:24:25.081178 [debug] [ThreadPool]: On list_data_engineering_test_public: BEGIN
[0m22:24:25.081178 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:24:25.117110 [debug] [ThreadPool]: SQL status: BEGIN in 0.035 seconds
[0m22:24:25.117110 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test_public"
[0m22:24:25.118107 [debug] [ThreadPool]: On list_data_engineering_test_public: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "list_data_engineering_test_public"} */
select
      'data_engineering_test' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_engineering_test' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_engineering_test' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m22:24:25.121107 [debug] [ThreadPool]: SQL status: SELECT 3 in 0.003 seconds
[0m22:24:25.123128 [debug] [ThreadPool]: On list_data_engineering_test_public: ROLLBACK
[0m22:24:25.124136 [debug] [ThreadPool]: On list_data_engineering_test_public: Close
[0m22:24:25.128687 [debug] [MainThread]: Using postgres connection "master"
[0m22:24:25.128687 [debug] [MainThread]: On master: BEGIN
[0m22:24:25.129686 [debug] [MainThread]: Opening a new connection, currently in state init
[0m22:24:25.142255 [debug] [MainThread]: SQL status: BEGIN in 0.013 seconds
[0m22:24:25.143357 [debug] [MainThread]: Using postgres connection "master"
[0m22:24:25.144364 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m22:24:25.148363 [debug] [MainThread]: SQL status: SELECT 2 in 0.004 seconds
[0m22:24:25.150363 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'fd74a0dc-de63-4aec-881f-ad4eb0c25e59', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EE12AE6EC0>]}
[0m22:24:25.150363 [debug] [MainThread]: On master: ROLLBACK
[0m22:24:25.152367 [debug] [MainThread]: Using postgres connection "master"
[0m22:24:25.152367 [debug] [MainThread]: On master: BEGIN
[0m22:24:25.154660 [debug] [MainThread]: SQL status: BEGIN in 0.001 seconds
[0m22:24:25.154660 [debug] [MainThread]: On master: COMMIT
[0m22:24:25.155501 [debug] [MainThread]: Using postgres connection "master"
[0m22:24:25.155501 [debug] [MainThread]: On master: COMMIT
[0m22:24:25.156500 [debug] [MainThread]: SQL status: COMMIT in 0.001 seconds
[0m22:24:25.157499 [debug] [MainThread]: On master: Close
[0m22:24:25.158501 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m22:24:25.158501 [info ] [MainThread]: 
[0m22:24:25.161020 [debug] [Thread-1 (]: Began running node model.task_4.calculate_comissions
[0m22:24:25.162529 [info ] [Thread-1 (]: 1 of 1 START sql view model public.calculate_comissions ........................ [RUN]
[0m22:24:25.163541 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.task_4.calculate_comissions'
[0m22:24:25.164051 [debug] [Thread-1 (]: Began compiling node model.task_4.calculate_comissions
[0m22:24:25.170062 [debug] [Thread-1 (]: Writing injected SQL for node "model.task_4.calculate_comissions"
[0m22:24:25.171058 [debug] [Thread-1 (]: Began executing node model.task_4.calculate_comissions
[0m22:24:25.206170 [debug] [Thread-1 (]: Writing runtime sql for node "model.task_4.calculate_comissions"
[0m22:24:25.207171 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m22:24:25.207171 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: BEGIN
[0m22:24:25.208171 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m22:24:25.222169 [debug] [Thread-1 (]: SQL status: BEGIN in 0.014 seconds
[0m22:24:25.223277 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m22:24:25.223277 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */

  create view "data_engineering_test"."public"."calculate_comissions__dbt_tmp"
    
    
  as (
    WITH orders_with_salesowners AS (
    SELECT
        o.order_id,
        round(i.gross_value / 100.0, 2) AS gross_value_in_euros,

        -- Converting the gross value into net value by taking the vat out in a non-lineal way.
        round((i.gross_value / 100.0) / (1 + i.vat / 100.0), 2) AS net_value_in_euros,
        string_to_array(o.salesowners, ', ') AS salesowners_array
    FROM
        public.orders o
    JOIN
        public.invoicing_data i ON o.order_id = i.order_id
),
salesowners AS (
    SELECT
        ows.order_id,
        ows.net_value_in_euros,
        so.salesowner,
        so.ordinality AS salesowner_position
    FROM
        orders_with_salesowners ows,
        unnest(ows.salesowners_array) WITH ORDINALITY AS so(salesowner, ordinality) -- unnests the array and assigns the order for each sales person in the order that it comes from the file
),
commission_calc AS (
    SELECT
        order_id,
        salesowner,
        CASE 
            WHEN salesowner_position = 1 THEN net_value_in_euros * 0.06    -- Main owner - 6%
            WHEN salesowner_position = 2 THEN net_value_in_euros * 0.025   -- Co-owner 1 - 2.5%
            WHEN salesowner_position = 3 THEN net_value_in_euros * 0.0095  -- Co-owner 2 - 0.95%
            ELSE 0  -- No comission
        END AS commission
    FROM salesowners
)
SELECT
    salesowner,
    ROUND(SUM(commission), 2) AS total_commission
FROM commission_calc
GROUP BY salesowner
ORDER BY total_commission DESC
  );
[0m22:24:25.228794 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.005 seconds
[0m22:24:25.235840 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m22:24:25.235840 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */
alter table "data_engineering_test"."public"."calculate_comissions" rename to "calculate_comissions__dbt_backup"
[0m22:24:25.237838 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m22:24:25.242345 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m22:24:25.242345 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */
alter table "data_engineering_test"."public"."calculate_comissions__dbt_tmp" rename to "calculate_comissions"
[0m22:24:25.244877 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m22:24:25.259917 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: COMMIT
[0m22:24:25.261259 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m22:24:25.261259 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: COMMIT
[0m22:24:25.264316 [debug] [Thread-1 (]: SQL status: COMMIT in 0.002 seconds
[0m22:24:25.270322 [debug] [Thread-1 (]: Applying DROP to: "data_engineering_test"."public"."calculate_comissions__dbt_backup"
[0m22:24:25.274474 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m22:24:25.275479 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */
drop view if exists "data_engineering_test"."public"."calculate_comissions__dbt_backup" cascade
[0m22:24:25.278480 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.003 seconds
[0m22:24:25.280481 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: Close
[0m22:24:25.283000 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fd74a0dc-de63-4aec-881f-ad4eb0c25e59', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EE12F7E380>]}
[0m22:24:25.283509 [info ] [Thread-1 (]: 1 of 1 OK created sql view model public.calculate_comissions ................... [[32mCREATE VIEW[0m in 0.12s]
[0m22:24:25.284516 [debug] [Thread-1 (]: Finished running node model.task_4.calculate_comissions
[0m22:24:25.286516 [debug] [MainThread]: Using postgres connection "master"
[0m22:24:25.286516 [debug] [MainThread]: On master: BEGIN
[0m22:24:25.287517 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m22:24:25.319191 [debug] [MainThread]: SQL status: BEGIN in 0.032 seconds
[0m22:24:25.320188 [debug] [MainThread]: On master: COMMIT
[0m22:24:25.320188 [debug] [MainThread]: Using postgres connection "master"
[0m22:24:25.321187 [debug] [MainThread]: On master: COMMIT
[0m22:24:25.322189 [debug] [MainThread]: SQL status: COMMIT in 0.001 seconds
[0m22:24:25.323144 [debug] [MainThread]: On master: Close
[0m22:24:25.323276 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:24:25.324152 [debug] [MainThread]: Connection 'list_data_engineering_test' was properly closed.
[0m22:24:25.324389 [debug] [MainThread]: Connection 'list_data_engineering_test_public' was properly closed.
[0m22:24:25.324389 [debug] [MainThread]: Connection 'model.task_4.calculate_comissions' was properly closed.
[0m22:24:25.325397 [info ] [MainThread]: 
[0m22:24:25.325397 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 0.37 seconds (0.37s).
[0m22:24:25.326395 [debug] [MainThread]: Command end result
[0m22:24:25.351606 [info ] [MainThread]: 
[0m22:24:25.352608 [info ] [MainThread]: [32mCompleted successfully[0m
[0m22:24:25.353115 [info ] [MainThread]: 
[0m22:24:25.353115 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m22:24:25.355126 [debug] [MainThread]: Command `dbt run` succeeded at 22:24:25.355126 after 1.25 seconds
[0m22:24:25.356122 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EE0F9BD450>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EE12527C40>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EE11F273D0>]}
[0m22:24:25.356122 [debug] [MainThread]: Flushing usage events
[0m22:29:46.869559 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BFDCBDD540>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BFDF743400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BFDF743220>]}


============================== 22:29:46.873570 | 98836820-cdf0-49b3-bcdf-da57186465f7 ==============================
[0m22:29:46.873570 [info ] [MainThread]: Running with dbt=1.8.9
[0m22:29:46.874577 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4\\dbt\\logs', 'profiles_dir': 'C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4/dbt', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --profiles-dir C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4/dbt --project-dir C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4/dbt', 'static_parser': 'True', 'log_format': 'default', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m22:29:47.064014 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '98836820-cdf0-49b3-bcdf-da57186465f7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BFDD39B7C0>]}
[0m22:29:47.113395 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '98836820-cdf0-49b3-bcdf-da57186465f7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BFDEBAAB00>]}
[0m22:29:47.115533 [info ] [MainThread]: Registered adapter: postgres=1.8.2
[0m22:29:47.379184 [debug] [MainThread]: checksum: 132857a23e9d07220246854f7763165174ce9b737cfc7867629ace4294e520b1, vars: {}, profile: , target: , version: 1.8.9
[0m22:29:47.510900 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m22:29:47.512408 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m22:29:47.540041 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '98836820-cdf0-49b3-bcdf-da57186465f7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BFDFD20130>]}
[0m22:29:47.627680 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '98836820-cdf0-49b3-bcdf-da57186465f7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BFDFD14460>]}
[0m22:29:47.628683 [info ] [MainThread]: Found 1 model, 428 macros
[0m22:29:47.628683 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '98836820-cdf0-49b3-bcdf-da57186465f7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BFDFD143A0>]}
[0m22:29:47.630682 [info ] [MainThread]: 
[0m22:29:47.630682 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m22:29:47.632188 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_engineering_test'
[0m22:29:47.719599 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test"
[0m22:29:47.719599 [debug] [ThreadPool]: On list_data_engineering_test: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "list_data_engineering_test"} */

    select distinct nspname from pg_namespace
  
[0m22:29:47.720597 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:29:47.738220 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.017 seconds
[0m22:29:47.739220 [debug] [ThreadPool]: On list_data_engineering_test: Close
[0m22:29:47.741218 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_engineering_test_public'
[0m22:29:47.747235 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test_public"
[0m22:29:47.747235 [debug] [ThreadPool]: On list_data_engineering_test_public: BEGIN
[0m22:29:47.747235 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:29:47.761621 [debug] [ThreadPool]: SQL status: BEGIN in 0.014 seconds
[0m22:29:47.761621 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test_public"
[0m22:29:47.762625 [debug] [ThreadPool]: On list_data_engineering_test_public: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "list_data_engineering_test_public"} */
select
      'data_engineering_test' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_engineering_test' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_engineering_test' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m22:29:47.766141 [debug] [ThreadPool]: SQL status: SELECT 2 in 0.003 seconds
[0m22:29:47.767143 [debug] [ThreadPool]: On list_data_engineering_test_public: ROLLBACK
[0m22:29:47.769142 [debug] [ThreadPool]: On list_data_engineering_test_public: Close
[0m22:29:47.773160 [debug] [MainThread]: Using postgres connection "master"
[0m22:29:47.774173 [debug] [MainThread]: On master: BEGIN
[0m22:29:47.774718 [debug] [MainThread]: Opening a new connection, currently in state init
[0m22:29:47.787282 [debug] [MainThread]: SQL status: BEGIN in 0.013 seconds
[0m22:29:47.788282 [debug] [MainThread]: Using postgres connection "master"
[0m22:29:47.789281 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m22:29:47.793291 [debug] [MainThread]: SQL status: SELECT 0 in 0.004 seconds
[0m22:29:47.794379 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '98836820-cdf0-49b3-bcdf-da57186465f7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BFDFD15720>]}
[0m22:29:47.795384 [debug] [MainThread]: On master: ROLLBACK
[0m22:29:47.796386 [debug] [MainThread]: Using postgres connection "master"
[0m22:29:47.796386 [debug] [MainThread]: On master: BEGIN
[0m22:29:47.798385 [debug] [MainThread]: SQL status: BEGIN in 0.001 seconds
[0m22:29:47.799388 [debug] [MainThread]: On master: COMMIT
[0m22:29:47.799388 [debug] [MainThread]: Using postgres connection "master"
[0m22:29:47.800386 [debug] [MainThread]: On master: COMMIT
[0m22:29:47.801389 [debug] [MainThread]: SQL status: COMMIT in 0.001 seconds
[0m22:29:47.801389 [debug] [MainThread]: On master: Close
[0m22:29:47.802387 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m22:29:47.802896 [info ] [MainThread]: 
[0m22:29:47.805406 [debug] [Thread-1 (]: Began running node model.task_4.calculate_comissions
[0m22:29:47.806406 [info ] [Thread-1 (]: 1 of 1 START sql view model public.calculate_comissions ........................ [RUN]
[0m22:29:47.806406 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.task_4.calculate_comissions'
[0m22:29:47.807406 [debug] [Thread-1 (]: Began compiling node model.task_4.calculate_comissions
[0m22:29:47.813417 [debug] [Thread-1 (]: Writing injected SQL for node "model.task_4.calculate_comissions"
[0m22:29:47.814549 [debug] [Thread-1 (]: Began executing node model.task_4.calculate_comissions
[0m22:29:47.848770 [debug] [Thread-1 (]: Writing runtime sql for node "model.task_4.calculate_comissions"
[0m22:29:47.850771 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m22:29:47.850771 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: BEGIN
[0m22:29:47.850771 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m22:29:47.865507 [debug] [Thread-1 (]: SQL status: BEGIN in 0.014 seconds
[0m22:29:47.866506 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m22:29:47.866506 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */

  create view "data_engineering_test"."public"."calculate_comissions__dbt_tmp"
    
    
  as (
    WITH orders_with_salesowners AS (
    SELECT
        o.order_id,
        round(i.gross_value / 100.0, 2) AS gross_value_in_euros,

        -- Converting the gross value into net value by taking the vat out in a non-lineal way.
        round((i.gross_value / 100.0) / (1 + i.vat / 100.0), 2) AS net_value_in_euros,
        string_to_array(o.salesowners, ', ') AS salesowners_array
    FROM
        public.orders o
    JOIN
        public.invoicing_data i ON o.order_id = i.order_id
),
salesowners AS (
    SELECT
        ows.order_id,
        ows.net_value_in_euros,
        so.salesowner,
        so.ordinality AS salesowner_position
    FROM
        orders_with_salesowners ows,
        unnest(ows.salesowners_array) WITH ORDINALITY AS so(salesowner, ordinality) -- unnests the array and assigns the order for each sales person in the order that it comes from the file
),
commission_calc AS (
    SELECT
        order_id,
        salesowner,
        CASE 
            WHEN salesowner_position = 1 THEN net_value_in_euros * 0.06    -- Main owner - 6%
            WHEN salesowner_position = 2 THEN net_value_in_euros * 0.025   -- Co-owner 1 - 2.5%
            WHEN salesowner_position = 3 THEN net_value_in_euros * 0.0095  -- Co-owner 2 - 0.95%
            ELSE 0  -- No comission
        END AS commission
    FROM salesowners
)
SELECT
    salesowner,
    ROUND(SUM(commission), 2) AS total_commission
FROM commission_calc
GROUP BY salesowner
ORDER BY total_commission DESC
  );
[0m22:29:47.871503 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.004 seconds
[0m22:29:47.877521 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m22:29:47.878521 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */
alter table "data_engineering_test"."public"."calculate_comissions__dbt_tmp" rename to "calculate_comissions"
[0m22:29:47.880524 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m22:29:47.893227 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: COMMIT
[0m22:29:47.893227 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m22:29:47.894315 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: COMMIT
[0m22:29:47.896685 [debug] [Thread-1 (]: SQL status: COMMIT in 0.002 seconds
[0m22:29:47.903732 [debug] [Thread-1 (]: Applying DROP to: "data_engineering_test"."public"."calculate_comissions__dbt_backup"
[0m22:29:47.907744 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m22:29:47.908744 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */
drop view if exists "data_engineering_test"."public"."calculate_comissions__dbt_backup" cascade
[0m22:29:47.909741 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.001 seconds
[0m22:29:47.912247 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: Close
[0m22:29:47.914771 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '98836820-cdf0-49b3-bcdf-da57186465f7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BFDB8FE110>]}
[0m22:29:47.914771 [info ] [Thread-1 (]: 1 of 1 OK created sql view model public.calculate_comissions ................... [[32mCREATE VIEW[0m in 0.11s]
[0m22:29:47.915772 [debug] [Thread-1 (]: Finished running node model.task_4.calculate_comissions
[0m22:29:47.916770 [debug] [MainThread]: Using postgres connection "master"
[0m22:29:47.917768 [debug] [MainThread]: On master: BEGIN
[0m22:29:47.917768 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m22:29:47.945690 [debug] [MainThread]: SQL status: BEGIN in 0.027 seconds
[0m22:29:47.945690 [debug] [MainThread]: On master: COMMIT
[0m22:29:47.946687 [debug] [MainThread]: Using postgres connection "master"
[0m22:29:47.946687 [debug] [MainThread]: On master: COMMIT
[0m22:29:47.947691 [debug] [MainThread]: SQL status: COMMIT in 0.001 seconds
[0m22:29:47.948691 [debug] [MainThread]: On master: Close
[0m22:29:47.948691 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:29:47.949687 [debug] [MainThread]: Connection 'list_data_engineering_test' was properly closed.
[0m22:29:47.949687 [debug] [MainThread]: Connection 'list_data_engineering_test_public' was properly closed.
[0m22:29:47.950688 [debug] [MainThread]: Connection 'model.task_4.calculate_comissions' was properly closed.
[0m22:29:47.950688 [info ] [MainThread]: 
[0m22:29:47.950688 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 0.32 seconds (0.32s).
[0m22:29:47.952192 [debug] [MainThread]: Command end result
[0m22:29:47.975253 [info ] [MainThread]: 
[0m22:29:47.976254 [info ] [MainThread]: [32mCompleted successfully[0m
[0m22:29:47.976254 [info ] [MainThread]: 
[0m22:29:47.977253 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m22:29:47.978253 [debug] [MainThread]: Command `dbt run` succeeded at 22:29:47.978253 after 1.18 seconds
[0m22:29:47.978253 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BFDCBDD540>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BFDEBAAB00>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BFDEB519F0>]}
[0m22:29:47.979252 [debug] [MainThread]: Flushing usage events
[0m22:33:08.725605 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ED1163D540>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ED141A3400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ED141A3220>]}


============================== 22:33:08.729606 | 1bf3b30d-2360-47c5-a8d5-e57ccf02b6fa ==============================
[0m22:33:08.729606 [info ] [MainThread]: Running with dbt=1.8.9
[0m22:33:08.730604 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4\\dbt\\logs', 'version_check': 'True', 'profiles_dir': 'C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4/dbt', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --profiles-dir C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4/dbt --project-dir C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4/dbt', 'log_format': 'default', 'static_parser': 'True', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m22:33:08.914115 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '1bf3b30d-2360-47c5-a8d5-e57ccf02b6fa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ED11DFB7C0>]}
[0m22:33:08.962635 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '1bf3b30d-2360-47c5-a8d5-e57ccf02b6fa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ED1360AB00>]}
[0m22:33:08.964636 [info ] [MainThread]: Registered adapter: postgres=1.8.2
[0m22:33:09.227197 [debug] [MainThread]: checksum: 132857a23e9d07220246854f7763165174ce9b737cfc7867629ace4294e520b1, vars: {}, profile: , target: , version: 1.8.9
[0m22:33:09.354718 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m22:33:09.354718 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m22:33:09.381229 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '1bf3b30d-2360-47c5-a8d5-e57ccf02b6fa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ED14780130>]}
[0m22:33:09.465594 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '1bf3b30d-2360-47c5-a8d5-e57ccf02b6fa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ED14774460>]}
[0m22:33:09.465594 [info ] [MainThread]: Found 1 model, 428 macros
[0m22:33:09.466593 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '1bf3b30d-2360-47c5-a8d5-e57ccf02b6fa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ED147743A0>]}
[0m22:33:09.467590 [info ] [MainThread]: 
[0m22:33:09.468589 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m22:33:09.469826 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_engineering_test'
[0m22:33:09.557558 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test"
[0m22:33:09.558558 [debug] [ThreadPool]: On list_data_engineering_test: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "list_data_engineering_test"} */

    select distinct nspname from pg_namespace
  
[0m22:33:09.558558 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:33:09.577099 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.018 seconds
[0m22:33:09.578098 [debug] [ThreadPool]: On list_data_engineering_test: Close
[0m22:33:09.580101 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_engineering_test_public'
[0m22:33:09.586096 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test_public"
[0m22:33:09.587099 [debug] [ThreadPool]: On list_data_engineering_test_public: BEGIN
[0m22:33:09.587099 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:33:09.601097 [debug] [ThreadPool]: SQL status: BEGIN in 0.014 seconds
[0m22:33:09.601097 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test_public"
[0m22:33:09.602097 [debug] [ThreadPool]: On list_data_engineering_test_public: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "list_data_engineering_test_public"} */
select
      'data_engineering_test' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_engineering_test' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_engineering_test' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m22:33:09.605097 [debug] [ThreadPool]: SQL status: SELECT 2 in 0.003 seconds
[0m22:33:09.607097 [debug] [ThreadPool]: On list_data_engineering_test_public: ROLLBACK
[0m22:33:09.608100 [debug] [ThreadPool]: On list_data_engineering_test_public: Close
[0m22:33:09.613096 [debug] [MainThread]: Using postgres connection "master"
[0m22:33:09.613096 [debug] [MainThread]: On master: BEGIN
[0m22:33:09.614096 [debug] [MainThread]: Opening a new connection, currently in state init
[0m22:33:09.627097 [debug] [MainThread]: SQL status: BEGIN in 0.013 seconds
[0m22:33:09.628098 [debug] [MainThread]: Using postgres connection "master"
[0m22:33:09.628098 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m22:33:09.633100 [debug] [MainThread]: SQL status: SELECT 0 in 0.004 seconds
[0m22:33:09.634096 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '1bf3b30d-2360-47c5-a8d5-e57ccf02b6fa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ED14775720>]}
[0m22:33:09.635097 [debug] [MainThread]: On master: ROLLBACK
[0m22:33:09.636101 [debug] [MainThread]: Using postgres connection "master"
[0m22:33:09.636101 [debug] [MainThread]: On master: BEGIN
[0m22:33:09.638101 [debug] [MainThread]: SQL status: BEGIN in 0.001 seconds
[0m22:33:09.639101 [debug] [MainThread]: On master: COMMIT
[0m22:33:09.639101 [debug] [MainThread]: Using postgres connection "master"
[0m22:33:09.639101 [debug] [MainThread]: On master: COMMIT
[0m22:33:09.641098 [debug] [MainThread]: SQL status: COMMIT in 0.001 seconds
[0m22:33:09.641098 [debug] [MainThread]: On master: Close
[0m22:33:09.642105 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m22:33:09.642105 [info ] [MainThread]: 
[0m22:33:09.645104 [debug] [Thread-1 (]: Began running node model.task_4.calculate_comissions
[0m22:33:09.645104 [info ] [Thread-1 (]: 1 of 1 START sql view model public.calculate_comissions ........................ [RUN]
[0m22:33:09.646103 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.task_4.calculate_comissions'
[0m22:33:09.647104 [debug] [Thread-1 (]: Began compiling node model.task_4.calculate_comissions
[0m22:33:09.653103 [debug] [Thread-1 (]: Writing injected SQL for node "model.task_4.calculate_comissions"
[0m22:33:09.654104 [debug] [Thread-1 (]: Began executing node model.task_4.calculate_comissions
[0m22:33:09.686615 [debug] [Thread-1 (]: Writing runtime sql for node "model.task_4.calculate_comissions"
[0m22:33:09.688617 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m22:33:09.688617 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: BEGIN
[0m22:33:09.689615 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m22:33:09.703618 [debug] [Thread-1 (]: SQL status: BEGIN in 0.015 seconds
[0m22:33:09.704618 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m22:33:09.705620 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */

  create view "data_engineering_test"."public"."calculate_comissions__dbt_tmp"
    
    
  as (
    WITH orders_with_salesowners AS (
    SELECT
        o.order_id,
        round(i.gross_value / 100.0, 2) AS gross_value_in_euros,

        -- Converting the gross value into net value by taking the vat out in a non-lineal way.
        round((i.gross_value / 100.0) / (1 + i.vat / 100.0), 2) AS net_value_in_euros,
        string_to_array(o.salesowners, ', ') AS salesowners_array
    FROM
        public.orders o
    JOIN
        public.invoicing_data i ON o.order_id = i.order_id
),
salesowners AS (
    SELECT
        ows.order_id,
        ows.net_value_in_euros,
        so.salesowner,
        so.ordinality AS salesowner_position
    FROM
        orders_with_salesowners ows,
        unnest(ows.salesowners_array) WITH ORDINALITY AS so(salesowner, ordinality) -- unnests the array and assigns the order for each sales person in the order that it comes from the file
),
commission_calc AS (
    SELECT
        order_id,
        salesowner,
        CASE 
            WHEN salesowner_position = 1 THEN net_value_in_euros * 0.06    -- Main owner - 6%
            WHEN salesowner_position = 2 THEN net_value_in_euros * 0.025   -- Co-owner 1 - 2.5%
            WHEN salesowner_position = 3 THEN net_value_in_euros * 0.0095  -- Co-owner 2 - 0.95%
            ELSE 0  -- No comission
        END AS commission
    FROM salesowners
)
SELECT
    salesowner,
    ROUND(SUM(commission), 2) AS total_commission
FROM commission_calc
GROUP BY salesowner
ORDER BY total_commission DESC
  );
[0m22:33:09.710620 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.004 seconds
[0m22:33:09.716615 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m22:33:09.716615 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */
alter table "data_engineering_test"."public"."calculate_comissions__dbt_tmp" rename to "calculate_comissions"
[0m22:33:09.718620 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m22:33:09.731615 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: COMMIT
[0m22:33:09.731615 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m22:33:09.732615 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: COMMIT
[0m22:33:09.735615 [debug] [Thread-1 (]: SQL status: COMMIT in 0.002 seconds
[0m22:33:09.741620 [debug] [Thread-1 (]: Applying DROP to: "data_engineering_test"."public"."calculate_comissions__dbt_backup"
[0m22:33:09.745620 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m22:33:09.746621 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */
drop view if exists "data_engineering_test"."public"."calculate_comissions__dbt_backup" cascade
[0m22:33:09.747621 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.001 seconds
[0m22:33:09.750620 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: Close
[0m22:33:09.752625 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1bf3b30d-2360-47c5-a8d5-e57ccf02b6fa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ED1035E110>]}
[0m22:33:09.752625 [info ] [Thread-1 (]: 1 of 1 OK created sql view model public.calculate_comissions ................... [[32mCREATE VIEW[0m in 0.10s]
[0m22:33:09.753624 [debug] [Thread-1 (]: Finished running node model.task_4.calculate_comissions
[0m22:33:09.754622 [debug] [MainThread]: Using postgres connection "master"
[0m22:33:09.754622 [debug] [MainThread]: On master: BEGIN
[0m22:33:09.756125 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m22:33:09.782707 [debug] [MainThread]: SQL status: BEGIN in 0.027 seconds
[0m22:33:09.783704 [debug] [MainThread]: On master: COMMIT
[0m22:33:09.783704 [debug] [MainThread]: Using postgres connection "master"
[0m22:33:09.784705 [debug] [MainThread]: On master: COMMIT
[0m22:33:09.785709 [debug] [MainThread]: SQL status: COMMIT in 0.001 seconds
[0m22:33:09.785709 [debug] [MainThread]: On master: Close
[0m22:33:09.786708 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:33:09.786708 [debug] [MainThread]: Connection 'list_data_engineering_test' was properly closed.
[0m22:33:09.786708 [debug] [MainThread]: Connection 'list_data_engineering_test_public' was properly closed.
[0m22:33:09.787706 [debug] [MainThread]: Connection 'model.task_4.calculate_comissions' was properly closed.
[0m22:33:09.787706 [info ] [MainThread]: 
[0m22:33:09.788709 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 0.32 seconds (0.32s).
[0m22:33:09.789708 [debug] [MainThread]: Command end result
[0m22:33:09.812705 [info ] [MainThread]: 
[0m22:33:09.813707 [info ] [MainThread]: [32mCompleted successfully[0m
[0m22:33:09.814705 [info ] [MainThread]: 
[0m22:33:09.814705 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m22:33:09.816705 [debug] [MainThread]: Command `dbt run` succeeded at 22:33:09.815705 after 1.15 seconds
[0m22:33:09.816705 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ED1163D540>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ED1360AB00>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ED135B19F0>]}
[0m22:33:09.817705 [debug] [MainThread]: Flushing usage events
[0m00:19:42.215608 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025731AB9480>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002573402AF20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000257346272E0>]}


============================== 00:19:42.220666 | e84a4335-9170-4f3b-8ef5-6a5ed43b4f8b ==============================
[0m00:19:42.220666 [info ] [MainThread]: Running with dbt=1.8.9
[0m00:19:42.220666 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'profiles_dir': 'C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4/dbt', 'log_path': 'C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4\\dbt\\logs', 'version_check': 'True', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'log_format': 'default', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'target_path': 'None', 'invocation_command': 'dbt run --profiles-dir C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4/dbt --project-dir C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4/dbt', 'send_anonymous_usage_stats': 'True'}
[0m00:19:42.471105 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'e84a4335-9170-4f3b-8ef5-6a5ed43b4f8b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025731D6A680>]}
[0m00:19:42.521240 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'e84a4335-9170-4f3b-8ef5-6a5ed43b4f8b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025731573BE0>]}
[0m00:19:42.522974 [info ] [MainThread]: Registered adapter: postgres=1.8.2
[0m00:19:42.790198 [debug] [MainThread]: checksum: 132857a23e9d07220246854f7763165174ce9b737cfc7867629ace4294e520b1, vars: {}, profile: , target: , version: 1.8.9
[0m00:19:42.952102 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m00:19:42.952102 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m00:19:42.979727 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'e84a4335-9170-4f3b-8ef5-6a5ed43b4f8b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025734C04130>]}
[0m00:19:43.079070 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'e84a4335-9170-4f3b-8ef5-6a5ed43b4f8b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025734BFAEF0>]}
[0m00:19:43.080070 [info ] [MainThread]: Found 1 model, 428 macros
[0m00:19:43.081069 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e84a4335-9170-4f3b-8ef5-6a5ed43b4f8b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025734BFA5C0>]}
[0m00:19:43.082069 [info ] [MainThread]: 
[0m00:19:43.083070 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m00:19:43.084070 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_engineering_test'
[0m00:19:43.240932 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test"
[0m00:19:43.241929 [debug] [ThreadPool]: On list_data_engineering_test: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "list_data_engineering_test"} */

    select distinct nspname from pg_namespace
  
[0m00:19:43.241929 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m00:19:43.262191 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.020 seconds
[0m00:19:43.263696 [debug] [ThreadPool]: On list_data_engineering_test: Close
[0m00:19:43.265226 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_engineering_test_public'
[0m00:19:43.271750 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test_public"
[0m00:19:43.271750 [debug] [ThreadPool]: On list_data_engineering_test_public: BEGIN
[0m00:19:43.272750 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m00:19:43.285394 [debug] [ThreadPool]: SQL status: BEGIN in 0.013 seconds
[0m00:19:43.286405 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test_public"
[0m00:19:43.286405 [debug] [ThreadPool]: On list_data_engineering_test_public: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "list_data_engineering_test_public"} */
select
      'data_engineering_test' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_engineering_test' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_engineering_test' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m00:19:43.296026 [debug] [ThreadPool]: SQL status: SELECT 3 in 0.008 seconds
[0m00:19:43.297035 [debug] [ThreadPool]: On list_data_engineering_test_public: ROLLBACK
[0m00:19:43.299037 [debug] [ThreadPool]: On list_data_engineering_test_public: Close
[0m00:19:43.303033 [debug] [MainThread]: Using postgres connection "master"
[0m00:19:43.304032 [debug] [MainThread]: On master: BEGIN
[0m00:19:43.304032 [debug] [MainThread]: Opening a new connection, currently in state init
[0m00:19:43.317108 [debug] [MainThread]: SQL status: BEGIN in 0.013 seconds
[0m00:19:43.318109 [debug] [MainThread]: Using postgres connection "master"
[0m00:19:43.319105 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m00:19:43.327265 [debug] [MainThread]: SQL status: SELECT 2 in 0.008 seconds
[0m00:19:43.329134 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e84a4335-9170-4f3b-8ef5-6a5ed43b4f8b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025734BF90C0>]}
[0m00:19:43.330135 [debug] [MainThread]: On master: ROLLBACK
[0m00:19:43.331139 [debug] [MainThread]: Using postgres connection "master"
[0m00:19:43.331139 [debug] [MainThread]: On master: BEGIN
[0m00:19:43.333142 [debug] [MainThread]: SQL status: BEGIN in 0.001 seconds
[0m00:19:43.333142 [debug] [MainThread]: On master: COMMIT
[0m00:19:43.334138 [debug] [MainThread]: Using postgres connection "master"
[0m00:19:43.334138 [debug] [MainThread]: On master: COMMIT
[0m00:19:43.335646 [debug] [MainThread]: SQL status: COMMIT in 0.001 seconds
[0m00:19:43.336154 [debug] [MainThread]: On master: Close
[0m00:19:43.336154 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m00:19:43.337159 [info ] [MainThread]: 
[0m00:19:43.340160 [debug] [Thread-1 (]: Began running node model.task_4.calculate_comissions
[0m00:19:43.341164 [info ] [Thread-1 (]: 1 of 1 START sql view model public.calculate_comissions ........................ [RUN]
[0m00:19:43.342165 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.task_4.calculate_comissions'
[0m00:19:43.342165 [debug] [Thread-1 (]: Began compiling node model.task_4.calculate_comissions
[0m00:19:43.349190 [debug] [Thread-1 (]: Writing injected SQL for node "model.task_4.calculate_comissions"
[0m00:19:43.350192 [debug] [Thread-1 (]: Began executing node model.task_4.calculate_comissions
[0m00:19:43.384559 [debug] [Thread-1 (]: Writing runtime sql for node "model.task_4.calculate_comissions"
[0m00:19:43.386063 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m00:19:43.387069 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: BEGIN
[0m00:19:43.387168 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m00:19:43.423178 [debug] [Thread-1 (]: SQL status: BEGIN in 0.036 seconds
[0m00:19:43.424180 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m00:19:43.425178 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */

  create view "data_engineering_test"."public"."calculate_comissions__dbt_tmp"
    
    
  as (
    WITH orders_with_salesowners AS (
    SELECT
        o.order_id,
        round(i.gross_value / 100.0, 2) AS gross_value_in_euros,

        -- Converting the gross value into net value by taking the vat out in a non-lineal way.
        round((i.gross_value / 100.0) / (1 + i.vat / 100.0), 2) AS net_value_in_euros,
        string_to_array(o.salesowners, ', ') AS salesowners_array
    FROM
        public.orders o
    JOIN
        public.invoicing_data i ON o.order_id = i.order_id
),
salesowners AS (
    SELECT
        ows.order_id,
        ows.net_value_in_euros,
        so.salesowner,
        so.ordinality AS salesowner_position
    FROM
        orders_with_salesowners ows,
        unnest(ows.salesowners_array) WITH ORDINALITY AS so(salesowner, ordinality) -- unnests the array and assigns the order for each sales person in the order that it comes from the file
),
commission_calc AS (
    SELECT
        order_id,
        salesowner,
        CASE 
            WHEN salesowner_position = 1 THEN net_value_in_euros * 0.06    -- Main owner - 6%
            WHEN salesowner_position = 2 THEN net_value_in_euros * 0.025   -- Co-owner 1 - 2.5%
            WHEN salesowner_position = 3 THEN net_value_in_euros * 0.0095  -- Co-owner 2 - 0.95%
            ELSE 0  -- No comission
        END AS commission
    FROM salesowners
)
SELECT
    salesowner,
    ROUND(SUM(commission), 2) AS total_commission
FROM commission_calc
GROUP BY salesowner
ORDER BY total_commission DESC
  );
[0m00:19:43.437310 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.012 seconds
[0m00:19:43.444309 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m00:19:43.444309 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */
alter table "data_engineering_test"."public"."calculate_comissions" rename to "calculate_comissions__dbt_backup"
[0m00:19:43.447402 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.002 seconds
[0m00:19:43.451407 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m00:19:43.451407 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */
alter table "data_engineering_test"."public"."calculate_comissions__dbt_tmp" rename to "calculate_comissions"
[0m00:19:43.453410 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m00:19:43.467986 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: COMMIT
[0m00:19:43.468987 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m00:19:43.469989 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: COMMIT
[0m00:19:43.471988 [debug] [Thread-1 (]: SQL status: COMMIT in 0.002 seconds
[0m00:19:43.479613 [debug] [Thread-1 (]: Applying DROP to: "data_engineering_test"."public"."calculate_comissions__dbt_backup"
[0m00:19:43.483610 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m00:19:43.485116 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */
drop view if exists "data_engineering_test"."public"."calculate_comissions__dbt_backup" cascade
[0m00:19:43.490315 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.005 seconds
[0m00:19:43.493312 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: Close
[0m00:19:43.495314 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e84a4335-9170-4f3b-8ef5-6a5ed43b4f8b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002573507A380>]}
[0m00:19:43.496143 [info ] [Thread-1 (]: 1 of 1 OK created sql view model public.calculate_comissions ................... [[32mCREATE VIEW[0m in 0.15s]
[0m00:19:43.497266 [debug] [Thread-1 (]: Finished running node model.task_4.calculate_comissions
[0m00:19:43.498274 [debug] [MainThread]: Using postgres connection "master"
[0m00:19:43.499274 [debug] [MainThread]: On master: BEGIN
[0m00:19:43.499274 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m00:19:43.514241 [debug] [MainThread]: SQL status: BEGIN in 0.015 seconds
[0m00:19:43.515242 [debug] [MainThread]: On master: COMMIT
[0m00:19:43.515242 [debug] [MainThread]: Using postgres connection "master"
[0m00:19:43.516286 [debug] [MainThread]: On master: COMMIT
[0m00:19:43.517385 [debug] [MainThread]: SQL status: COMMIT in 0.001 seconds
[0m00:19:43.518393 [debug] [MainThread]: On master: Close
[0m00:19:43.519392 [debug] [MainThread]: Connection 'master' was properly closed.
[0m00:19:43.519392 [debug] [MainThread]: Connection 'list_data_engineering_test' was properly closed.
[0m00:19:43.520392 [debug] [MainThread]: Connection 'list_data_engineering_test_public' was properly closed.
[0m00:19:43.520392 [debug] [MainThread]: Connection 'model.task_4.calculate_comissions' was properly closed.
[0m00:19:43.521392 [info ] [MainThread]: 
[0m00:19:43.521392 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 0.44 seconds (0.44s).
[0m00:19:43.522395 [debug] [MainThread]: Command end result
[0m00:19:43.547731 [info ] [MainThread]: 
[0m00:19:43.548731 [info ] [MainThread]: [32mCompleted successfully[0m
[0m00:19:43.549731 [info ] [MainThread]: 
[0m00:19:43.549731 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m00:19:43.551738 [debug] [MainThread]: Command `dbt run` succeeded at 00:19:43.551738 after 1.41 seconds
[0m00:19:43.551738 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025731AB9480>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002573402ABC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025731EC1D50>]}
[0m00:19:43.552731 [debug] [MainThread]: Flushing usage events
[0m00:20:03.978117 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001894733EDD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001894A4B18D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001894A4B1A80>]}


============================== 00:20:03.983627 | 6f12564a-3c82-4d09-bfcd-c4e6e3d3d95e ==============================
[0m00:20:03.983627 [info ] [MainThread]: Running with dbt=1.8.9
[0m00:20:03.985131 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4/dbt', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4\\dbt\\logs', 'warn_error': 'None', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'introspect': 'True', 'log_format': 'default', 'target_path': 'None', 'invocation_command': 'dbt run --profiles-dir C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4/dbt --project-dir C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4/dbt', 'send_anonymous_usage_stats': 'True'}
[0m00:20:04.271207 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '6f12564a-3c82-4d09-bfcd-c4e6e3d3d95e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001894A5C0610>]}
[0m00:20:04.388244 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '6f12564a-3c82-4d09-bfcd-c4e6e3d3d95e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001894A4748E0>]}
[0m00:20:04.391245 [info ] [MainThread]: Registered adapter: postgres=1.8.2
[0m00:20:04.672023 [debug] [MainThread]: checksum: 132857a23e9d07220246854f7763165174ce9b737cfc7867629ace4294e520b1, vars: {}, profile: , target: , version: 1.8.9
[0m00:20:04.866389 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m00:20:04.866894 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m00:20:04.911496 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '6f12564a-3c82-4d09-bfcd-c4e6e3d3d95e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001894BAD8A30>]}
[0m00:20:05.079320 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '6f12564a-3c82-4d09-bfcd-c4e6e3d3d95e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001894B9473D0>]}
[0m00:20:05.080826 [info ] [MainThread]: Found 1 model, 428 macros
[0m00:20:05.081835 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '6f12564a-3c82-4d09-bfcd-c4e6e3d3d95e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001894B9472E0>]}
[0m00:20:05.083835 [info ] [MainThread]: 
[0m00:20:05.085341 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m00:20:05.087461 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_engineering_test'
[0m00:20:05.195236 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test"
[0m00:20:05.196247 [debug] [ThreadPool]: On list_data_engineering_test: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "list_data_engineering_test"} */

    select distinct nspname from pg_namespace
  
[0m00:20:05.197399 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m00:20:05.215251 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.018 seconds
[0m00:20:05.217266 [debug] [ThreadPool]: On list_data_engineering_test: Close
[0m00:20:05.219268 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_engineering_test_public'
[0m00:20:05.229282 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test_public"
[0m00:20:05.230281 [debug] [ThreadPool]: On list_data_engineering_test_public: BEGIN
[0m00:20:05.230281 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m00:20:05.243693 [debug] [ThreadPool]: SQL status: BEGIN in 0.014 seconds
[0m00:20:05.245199 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test_public"
[0m00:20:05.246204 [debug] [ThreadPool]: On list_data_engineering_test_public: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "list_data_engineering_test_public"} */
select
      'data_engineering_test' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_engineering_test' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_engineering_test' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m00:20:05.249718 [debug] [ThreadPool]: SQL status: SELECT 3 in 0.003 seconds
[0m00:20:05.252714 [debug] [ThreadPool]: On list_data_engineering_test_public: ROLLBACK
[0m00:20:05.253720 [debug] [ThreadPool]: On list_data_engineering_test_public: Close
[0m00:20:05.261842 [debug] [MainThread]: Using postgres connection "master"
[0m00:20:05.261842 [debug] [MainThread]: On master: BEGIN
[0m00:20:05.262842 [debug] [MainThread]: Opening a new connection, currently in state init
[0m00:20:05.276381 [debug] [MainThread]: SQL status: BEGIN in 0.014 seconds
[0m00:20:05.277953 [debug] [MainThread]: Using postgres connection "master"
[0m00:20:05.277953 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m00:20:05.283477 [debug] [MainThread]: SQL status: SELECT 2 in 0.004 seconds
[0m00:20:05.286389 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '6f12564a-3c82-4d09-bfcd-c4e6e3d3d95e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001894BAF3010>]}
[0m00:20:05.287398 [debug] [MainThread]: On master: ROLLBACK
[0m00:20:05.288397 [debug] [MainThread]: Using postgres connection "master"
[0m00:20:05.289398 [debug] [MainThread]: On master: BEGIN
[0m00:20:05.291399 [debug] [MainThread]: SQL status: BEGIN in 0.001 seconds
[0m00:20:05.292397 [debug] [MainThread]: On master: COMMIT
[0m00:20:05.293395 [debug] [MainThread]: Using postgres connection "master"
[0m00:20:05.293395 [debug] [MainThread]: On master: COMMIT
[0m00:20:05.295398 [debug] [MainThread]: SQL status: COMMIT in 0.001 seconds
[0m00:20:05.295904 [debug] [MainThread]: On master: Close
[0m00:20:05.296411 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m00:20:05.297509 [info ] [MainThread]: 
[0m00:20:05.300514 [debug] [Thread-1 (]: Began running node model.task_4.calculate_comissions
[0m00:20:05.301514 [info ] [Thread-1 (]: 1 of 1 START sql view model public.calculate_comissions ........................ [RUN]
[0m00:20:05.302514 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.task_4.calculate_comissions'
[0m00:20:05.303514 [debug] [Thread-1 (]: Began compiling node model.task_4.calculate_comissions
[0m00:20:05.317123 [debug] [Thread-1 (]: Writing injected SQL for node "model.task_4.calculate_comissions"
[0m00:20:05.319129 [debug] [Thread-1 (]: Began executing node model.task_4.calculate_comissions
[0m00:20:05.380962 [debug] [Thread-1 (]: Writing runtime sql for node "model.task_4.calculate_comissions"
[0m00:20:05.382969 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m00:20:05.382969 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: BEGIN
[0m00:20:05.383967 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m00:20:05.416053 [debug] [Thread-1 (]: SQL status: BEGIN in 0.032 seconds
[0m00:20:05.418063 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m00:20:05.418063 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */

  create view "data_engineering_test"."public"."calculate_comissions__dbt_tmp"
    
    
  as (
    WITH orders_with_salesowners AS (
    SELECT
        o.order_id,
        round(i.gross_value / 100.0, 2) AS gross_value_in_euros,

        -- Converting the gross value into net value by taking the vat out in a non-lineal way.
        round((i.gross_value / 100.0) / (1 + i.vat / 100.0), 2) AS net_value_in_euros,
        string_to_array(o.salesowners, ', ') AS salesowners_array
    FROM
        public.orders o
    JOIN
        public.invoicing_data i ON o.order_id = i.order_id
),
salesowners AS (
    SELECT
        ows.order_id,
        ows.net_value_in_euros,
        so.salesowner,
        so.ordinality AS salesowner_position
    FROM
        orders_with_salesowners ows,
        unnest(ows.salesowners_array) WITH ORDINALITY AS so(salesowner, ordinality) -- unnests the array and assigns the order for each sales person in the order that it comes from the file
),
commission_calc AS (
    SELECT
        order_id,
        salesowner,
        CASE 
            WHEN salesowner_position = 1 THEN net_value_in_euros * 0.06    -- Main owner - 6%
            WHEN salesowner_position = 2 THEN net_value_in_euros * 0.025   -- Co-owner 1 - 2.5%
            WHEN salesowner_position = 3 THEN net_value_in_euros * 0.0095  -- Co-owner 2 - 0.95%
            ELSE 0  -- No comission
        END AS commission
    FROM salesowners
)
SELECT
    salesowner,
    ROUND(SUM(commission), 2) AS total_commission
FROM commission_calc
GROUP BY salesowner
ORDER BY total_commission DESC
  );
[0m00:20:05.424059 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.005 seconds
[0m00:20:05.436156 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m00:20:05.437298 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */
alter table "data_engineering_test"."public"."calculate_comissions" rename to "calculate_comissions__dbt_backup"
[0m00:20:05.439302 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m00:20:05.445297 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m00:20:05.446307 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */
alter table "data_engineering_test"."public"."calculate_comissions__dbt_tmp" rename to "calculate_comissions"
[0m00:20:05.447495 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m00:20:05.475630 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: COMMIT
[0m00:20:05.477149 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m00:20:05.478148 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: COMMIT
[0m00:20:05.480661 [debug] [Thread-1 (]: SQL status: COMMIT in 0.002 seconds
[0m00:20:05.492352 [debug] [Thread-1 (]: Applying DROP to: "data_engineering_test"."public"."calculate_comissions__dbt_backup"
[0m00:20:05.500366 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m00:20:05.500366 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */
drop view if exists "data_engineering_test"."public"."calculate_comissions__dbt_backup" cascade
[0m00:20:05.503894 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.003 seconds
[0m00:20:05.509028 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: Close
[0m00:20:05.511024 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6f12564a-3c82-4d09-bfcd-c4e6e3d3d95e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001894BF79AE0>]}
[0m00:20:05.512026 [info ] [Thread-1 (]: 1 of 1 OK created sql view model public.calculate_comissions ................... [[32mCREATE VIEW[0m in 0.21s]
[0m00:20:05.513024 [debug] [Thread-1 (]: Finished running node model.task_4.calculate_comissions
[0m00:20:05.515533 [debug] [MainThread]: Using postgres connection "master"
[0m00:20:05.516046 [debug] [MainThread]: On master: BEGIN
[0m00:20:05.516046 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m00:20:05.540282 [debug] [MainThread]: SQL status: BEGIN in 0.023 seconds
[0m00:20:05.541280 [debug] [MainThread]: On master: COMMIT
[0m00:20:05.541280 [debug] [MainThread]: Using postgres connection "master"
[0m00:20:05.542280 [debug] [MainThread]: On master: COMMIT
[0m00:20:05.543284 [debug] [MainThread]: SQL status: COMMIT in 0.001 seconds
[0m00:20:05.544283 [debug] [MainThread]: On master: Close
[0m00:20:05.545280 [debug] [MainThread]: Connection 'master' was properly closed.
[0m00:20:05.546061 [debug] [MainThread]: Connection 'list_data_engineering_test' was properly closed.
[0m00:20:05.547067 [debug] [MainThread]: Connection 'list_data_engineering_test_public' was properly closed.
[0m00:20:05.547067 [debug] [MainThread]: Connection 'model.task_4.calculate_comissions' was properly closed.
[0m00:20:05.548073 [info ] [MainThread]: 
[0m00:20:05.549067 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 0.46 seconds (0.46s).
[0m00:20:05.550068 [debug] [MainThread]: Command end result
[0m00:20:05.622245 [info ] [MainThread]: 
[0m00:20:05.623246 [info ] [MainThread]: [32mCompleted successfully[0m
[0m00:20:05.624245 [info ] [MainThread]: 
[0m00:20:05.624245 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m00:20:05.626253 [debug] [MainThread]: Command `dbt run` succeeded at 00:20:05.626253 after 1.74 seconds
[0m00:20:05.627259 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001894733EDD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001894B9473D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001894A745360>]}
[0m00:20:05.628258 [debug] [MainThread]: Flushing usage events
[0m00:33:35.612234 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014C585194E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014C5B08B2E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014C5B08B100>]}


============================== 00:33:35.616072 | 468b3552-5ed5-433a-9fb7-e13bdadf49dd ==============================
[0m00:33:35.616072 [info ] [MainThread]: Running with dbt=1.8.9
[0m00:33:35.617578 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4/dbt', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4\\dbt\\logs', 'warn_error': 'None', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --profiles-dir C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4/dbt --project-dir C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4/dbt', 'static_parser': 'True', 'log_format': 'default', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m00:33:35.807555 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '468b3552-5ed5-433a-9fb7-e13bdadf49dd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014C587CA6E0>]}
[0m00:33:35.858844 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '468b3552-5ed5-433a-9fb7-e13bdadf49dd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014C57FD1750>]}
[0m00:33:35.859854 [info ] [MainThread]: Registered adapter: postgres=1.8.2
[0m00:33:36.129873 [debug] [MainThread]: checksum: 132857a23e9d07220246854f7763165174ce9b737cfc7867629ace4294e520b1, vars: {}, profile: , target: , version: 1.8.9
[0m00:33:36.261990 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m00:33:36.262990 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m00:33:36.291817 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '468b3552-5ed5-433a-9fb7-e13bdadf49dd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014C5B664130>]}
[0m00:33:36.379670 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '468b3552-5ed5-433a-9fb7-e13bdadf49dd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014C5B6543A0>]}
[0m00:33:36.380678 [info ] [MainThread]: Found 1 model, 428 macros
[0m00:33:36.381678 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '468b3552-5ed5-433a-9fb7-e13bdadf49dd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014C5B6570A0>]}
[0m00:33:36.382678 [info ] [MainThread]: 
[0m00:33:36.383677 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m00:33:36.384706 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_engineering_test'
[0m00:33:36.474088 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test"
[0m00:33:36.474088 [debug] [ThreadPool]: On list_data_engineering_test: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "list_data_engineering_test"} */

    select distinct nspname from pg_namespace
  
[0m00:33:36.475087 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m00:33:36.492801 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.018 seconds
[0m00:33:36.494804 [debug] [ThreadPool]: On list_data_engineering_test: Close
[0m00:33:36.496806 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_engineering_test_public'
[0m00:33:36.503029 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test_public"
[0m00:33:36.503029 [debug] [ThreadPool]: On list_data_engineering_test_public: BEGIN
[0m00:33:36.504029 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m00:33:36.519150 [debug] [ThreadPool]: SQL status: BEGIN in 0.015 seconds
[0m00:33:36.519663 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test_public"
[0m00:33:36.519663 [debug] [ThreadPool]: On list_data_engineering_test_public: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "list_data_engineering_test_public"} */
select
      'data_engineering_test' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_engineering_test' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_engineering_test' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m00:33:36.523758 [debug] [ThreadPool]: SQL status: SELECT 3 in 0.003 seconds
[0m00:33:36.524761 [debug] [ThreadPool]: On list_data_engineering_test_public: ROLLBACK
[0m00:33:36.525756 [debug] [ThreadPool]: On list_data_engineering_test_public: Close
[0m00:33:36.530731 [debug] [MainThread]: Using postgres connection "master"
[0m00:33:36.531731 [debug] [MainThread]: On master: BEGIN
[0m00:33:36.531731 [debug] [MainThread]: Opening a new connection, currently in state init
[0m00:33:36.545870 [debug] [MainThread]: SQL status: BEGIN in 0.014 seconds
[0m00:33:36.545870 [debug] [MainThread]: Using postgres connection "master"
[0m00:33:36.546870 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m00:33:36.552894 [debug] [MainThread]: SQL status: SELECT 2 in 0.005 seconds
[0m00:33:36.553889 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '468b3552-5ed5-433a-9fb7-e13bdadf49dd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014C5B655720>]}
[0m00:33:36.554889 [debug] [MainThread]: On master: ROLLBACK
[0m00:33:36.555890 [debug] [MainThread]: Using postgres connection "master"
[0m00:33:36.556893 [debug] [MainThread]: On master: BEGIN
[0m00:33:36.557892 [debug] [MainThread]: SQL status: BEGIN in 0.001 seconds
[0m00:33:36.558894 [debug] [MainThread]: On master: COMMIT
[0m00:33:36.558894 [debug] [MainThread]: Using postgres connection "master"
[0m00:33:36.559936 [debug] [MainThread]: On master: COMMIT
[0m00:33:36.561034 [debug] [MainThread]: SQL status: COMMIT in 0.001 seconds
[0m00:33:36.561034 [debug] [MainThread]: On master: Close
[0m00:33:36.561943 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m00:33:36.561943 [info ] [MainThread]: 
[0m00:33:36.564944 [debug] [Thread-1 (]: Began running node model.task_4.calculate_comissions
[0m00:33:36.565940 [info ] [Thread-1 (]: 1 of 1 START sql view model public.calculate_comissions ........................ [RUN]
[0m00:33:36.565940 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.task_4.calculate_comissions'
[0m00:33:36.566941 [debug] [Thread-1 (]: Began compiling node model.task_4.calculate_comissions
[0m00:33:36.573959 [debug] [Thread-1 (]: Writing injected SQL for node "model.task_4.calculate_comissions"
[0m00:33:36.574959 [debug] [Thread-1 (]: Began executing node model.task_4.calculate_comissions
[0m00:33:36.609104 [debug] [Thread-1 (]: Writing runtime sql for node "model.task_4.calculate_comissions"
[0m00:33:36.610681 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m00:33:36.610681 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: BEGIN
[0m00:33:36.611686 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m00:33:36.633982 [debug] [Thread-1 (]: SQL status: BEGIN in 0.022 seconds
[0m00:33:36.634980 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m00:33:36.634980 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */

  create view "data_engineering_test"."public"."calculate_comissions__dbt_tmp"
    
    
  as (
    WITH orders_with_salesowners AS (
    SELECT
        o.order_id,
        round(i.gross_value / 100.0, 2) AS gross_value_in_euros,

        -- Converting the gross value into net value by taking the vat out in a non-lineal way.
        round((i.gross_value / 100.0) / (1 + i.vat / 100.0), 2) AS net_value_in_euros,
        string_to_array(o.salesowners, ', ') AS salesowners_array
    FROM
        public.orders o
    JOIN
        public.invoicing_data i ON o.order_id = i.order_id
),
salesowners AS (
    SELECT
        ows.order_id,
        ows.net_value_in_euros,
        so.salesowner,
        so.ordinality AS salesowner_position
    FROM
        orders_with_salesowners ows,
        unnest(ows.salesowners_array) WITH ORDINALITY AS so(salesowner, ordinality) -- unnests the array and assigns the order for each sales person in the order that it comes from the file
),
commission_calc AS (
    SELECT
        order_id,
        salesowner,
        CASE 
            WHEN salesowner_position = 1 THEN net_value_in_euros * 0.06    -- Main owner - 6%
            WHEN salesowner_position = 2 THEN net_value_in_euros * 0.025   -- Co-owner 1 - 2.5%
            WHEN salesowner_position = 3 THEN net_value_in_euros * 0.0095  -- Co-owner 2 - 0.95%
            ELSE 0  -- No comission
        END AS commission
    FROM salesowners
)
SELECT
    salesowner,
    ROUND(SUM(commission), 2) AS total_commission
FROM commission_calc
GROUP BY salesowner
ORDER BY total_commission DESC
  );
[0m00:33:36.642708 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.006 seconds
[0m00:33:36.649733 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m00:33:36.650239 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */
alter table "data_engineering_test"."public"."calculate_comissions" rename to "calculate_comissions__dbt_backup"
[0m00:33:36.651925 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m00:33:36.655923 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m00:33:36.655923 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */
alter table "data_engineering_test"."public"."calculate_comissions__dbt_tmp" rename to "calculate_comissions"
[0m00:33:36.657929 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m00:33:36.672052 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: COMMIT
[0m00:33:36.673052 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m00:33:36.674056 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: COMMIT
[0m00:33:36.677055 [debug] [Thread-1 (]: SQL status: COMMIT in 0.003 seconds
[0m00:33:36.682707 [debug] [Thread-1 (]: Applying DROP to: "data_engineering_test"."public"."calculate_comissions__dbt_backup"
[0m00:33:36.687722 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m00:33:36.687722 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */
drop view if exists "data_engineering_test"."public"."calculate_comissions__dbt_backup" cascade
[0m00:33:36.691417 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.003 seconds
[0m00:33:36.694430 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: Close
[0m00:33:36.696433 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '468b3552-5ed5-433a-9fb7-e13bdadf49dd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014C5BADE380>]}
[0m00:33:36.696433 [info ] [Thread-1 (]: 1 of 1 OK created sql view model public.calculate_comissions ................... [[32mCREATE VIEW[0m in 0.13s]
[0m00:33:36.697430 [debug] [Thread-1 (]: Finished running node model.task_4.calculate_comissions
[0m00:33:36.698935 [debug] [MainThread]: Using postgres connection "master"
[0m00:33:36.699945 [debug] [MainThread]: On master: BEGIN
[0m00:33:36.700451 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m00:33:36.714095 [debug] [MainThread]: SQL status: BEGIN in 0.014 seconds
[0m00:33:36.714095 [debug] [MainThread]: On master: COMMIT
[0m00:33:36.715097 [debug] [MainThread]: Using postgres connection "master"
[0m00:33:36.715097 [debug] [MainThread]: On master: COMMIT
[0m00:33:36.716093 [debug] [MainThread]: SQL status: COMMIT in 0.001 seconds
[0m00:33:36.717092 [debug] [MainThread]: On master: Close
[0m00:33:36.718095 [debug] [MainThread]: Connection 'master' was properly closed.
[0m00:33:36.718095 [debug] [MainThread]: Connection 'list_data_engineering_test' was properly closed.
[0m00:33:36.718095 [debug] [MainThread]: Connection 'list_data_engineering_test_public' was properly closed.
[0m00:33:36.719097 [debug] [MainThread]: Connection 'model.task_4.calculate_comissions' was properly closed.
[0m00:33:36.719808 [info ] [MainThread]: 
[0m00:33:36.719808 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 0.34 seconds (0.34s).
[0m00:33:36.720815 [debug] [MainThread]: Command end result
[0m00:33:36.743969 [info ] [MainThread]: 
[0m00:33:36.744973 [info ] [MainThread]: [32mCompleted successfully[0m
[0m00:33:36.745970 [info ] [MainThread]: 
[0m00:33:36.745970 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m00:33:36.747969 [debug] [MainThread]: Command `dbt run` succeeded at 00:33:36.746970 after 1.20 seconds
[0m00:33:36.747969 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014C585194E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014C5AA8B760>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014C58921CC0>]}
[0m00:33:36.748969 [debug] [MainThread]: Flushing usage events
[0m00:34:04.850950 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016A1D889510>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016A203F3340>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016A203F3160>]}


============================== 00:34:04.854413 | c70b3195-f458-42d6-94b1-2474c09f8a28 ==============================
[0m00:34:04.854413 [info ] [MainThread]: Running with dbt=1.8.9
[0m00:34:04.855412 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4\\dbt\\logs', 'debug': 'False', 'profiles_dir': 'C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4/dbt', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --profiles-dir C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4/dbt --project-dir C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4/dbt', 'introspect': 'True', 'static_parser': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m00:34:05.044541 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'c70b3195-f458-42d6-94b1-2474c09f8a28', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016A204007C0>]}
[0m00:34:05.094049 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'c70b3195-f458-42d6-94b1-2474c09f8a28', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016A20403730>]}
[0m00:34:05.096057 [info ] [MainThread]: Registered adapter: postgres=1.8.2
[0m00:34:05.362251 [debug] [MainThread]: checksum: 132857a23e9d07220246854f7763165174ce9b737cfc7867629ace4294e520b1, vars: {}, profile: , target: , version: 1.8.9
[0m00:34:05.493307 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m00:34:05.493307 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m00:34:05.520506 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'c70b3195-f458-42d6-94b1-2474c09f8a28', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016A209D4130>]}
[0m00:34:05.607562 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'c70b3195-f458-42d6-94b1-2474c09f8a28', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016A209C7040>]}
[0m00:34:05.609068 [info ] [MainThread]: Found 1 model, 428 macros
[0m00:34:05.609068 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'c70b3195-f458-42d6-94b1-2474c09f8a28', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016A209C70A0>]}
[0m00:34:05.610584 [info ] [MainThread]: 
[0m00:34:05.611589 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m00:34:05.612591 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_engineering_test'
[0m00:34:05.698992 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test"
[0m00:34:05.698992 [debug] [ThreadPool]: On list_data_engineering_test: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "list_data_engineering_test"} */

    select distinct nspname from pg_namespace
  
[0m00:34:05.700002 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m00:34:05.716534 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.017 seconds
[0m00:34:05.717535 [debug] [ThreadPool]: On list_data_engineering_test: Close
[0m00:34:05.720049 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_engineering_test_public'
[0m00:34:05.727081 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test_public"
[0m00:34:05.727081 [debug] [ThreadPool]: On list_data_engineering_test_public: BEGIN
[0m00:34:05.728083 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m00:34:05.741215 [debug] [ThreadPool]: SQL status: BEGIN in 0.014 seconds
[0m00:34:05.742217 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test_public"
[0m00:34:05.743216 [debug] [ThreadPool]: On list_data_engineering_test_public: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "list_data_engineering_test_public"} */
select
      'data_engineering_test' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_engineering_test' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_engineering_test' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m00:34:05.746211 [debug] [ThreadPool]: SQL status: SELECT 3 in 0.003 seconds
[0m00:34:05.748213 [debug] [ThreadPool]: On list_data_engineering_test_public: ROLLBACK
[0m00:34:05.749722 [debug] [ThreadPool]: On list_data_engineering_test_public: Close
[0m00:34:05.754791 [debug] [MainThread]: Using postgres connection "master"
[0m00:34:05.755791 [debug] [MainThread]: On master: BEGIN
[0m00:34:05.755791 [debug] [MainThread]: Opening a new connection, currently in state init
[0m00:34:05.770666 [debug] [MainThread]: SQL status: BEGIN in 0.014 seconds
[0m00:34:05.770778 [debug] [MainThread]: Using postgres connection "master"
[0m00:34:05.771784 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m00:34:05.775349 [debug] [MainThread]: SQL status: SELECT 2 in 0.004 seconds
[0m00:34:05.777348 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'c70b3195-f458-42d6-94b1-2474c09f8a28', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016A209EBAF0>]}
[0m00:34:05.777348 [debug] [MainThread]: On master: ROLLBACK
[0m00:34:05.779865 [debug] [MainThread]: Using postgres connection "master"
[0m00:34:05.779865 [debug] [MainThread]: On master: BEGIN
[0m00:34:05.781923 [debug] [MainThread]: SQL status: BEGIN in 0.001 seconds
[0m00:34:05.782919 [debug] [MainThread]: On master: COMMIT
[0m00:34:05.782919 [debug] [MainThread]: Using postgres connection "master"
[0m00:34:05.782919 [debug] [MainThread]: On master: COMMIT
[0m00:34:05.784922 [debug] [MainThread]: SQL status: COMMIT in 0.001 seconds
[0m00:34:05.784922 [debug] [MainThread]: On master: Close
[0m00:34:05.785918 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m00:34:05.785918 [info ] [MainThread]: 
[0m00:34:05.789424 [debug] [Thread-1 (]: Began running node model.task_4.calculate_comissions
[0m00:34:05.790466 [info ] [Thread-1 (]: 1 of 1 START sql view model public.calculate_comissions ........................ [RUN]
[0m00:34:05.790990 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.task_4.calculate_comissions'
[0m00:34:05.791516 [debug] [Thread-1 (]: Began compiling node model.task_4.calculate_comissions
[0m00:34:05.798846 [debug] [Thread-1 (]: Writing injected SQL for node "model.task_4.calculate_comissions"
[0m00:34:05.799891 [debug] [Thread-1 (]: Began executing node model.task_4.calculate_comissions
[0m00:34:05.837708 [debug] [Thread-1 (]: Writing runtime sql for node "model.task_4.calculate_comissions"
[0m00:34:05.839736 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m00:34:05.839736 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: BEGIN
[0m00:34:05.840744 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m00:34:05.857267 [debug] [Thread-1 (]: SQL status: BEGIN in 0.016 seconds
[0m00:34:05.857267 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m00:34:05.858773 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */

  create view "data_engineering_test"."public"."calculate_comissions__dbt_tmp"
    
    
  as (
    WITH orders_with_salesowners AS (
    SELECT
        o.order_id,
        round(i.gross_value / 100.0, 2) AS gross_value_in_euros,

        -- Converting the gross value into net value by taking the vat out in a non-lineal way.
        round((i.gross_value / 100.0) / (1 + i.vat / 100.0), 2) AS net_value_in_euros,
        string_to_array(o.salesowners, ', ') AS salesowners_array
    FROM
        public.orders o
    JOIN
        public.invoicing_data i ON o.order_id = i.order_id
),
salesowners AS (
    SELECT
        ows.order_id,
        ows.net_value_in_euros,
        so.salesowner,
        so.ordinality AS salesowner_position
    FROM
        orders_with_salesowners ows,
        unnest(ows.salesowners_array) WITH ORDINALITY AS so(salesowner, ordinality) -- unnests the array and assigns the order for each sales person in the order that it comes from the file
),
commission_calc AS (
    SELECT
        order_id,
        salesowner,
        CASE 
            WHEN salesowner_position = 1 THEN net_value_in_euros * 0.06    -- Main owner - 6%
            WHEN salesowner_position = 2 THEN net_value_in_euros * 0.025   -- Co-owner 1 - 2.5%
            WHEN salesowner_position = 3 THEN net_value_in_euros * 0.0095  -- Co-owner 2 - 0.95%
            ELSE 0  -- No comission
        END AS commission
    FROM salesowners
)
SELECT
    salesowner,
    ROUND(SUM(commission), 2) AS total_commission
FROM commission_calc
GROUP BY salesowner
ORDER BY total_commission DESC
  );
[0m00:34:05.862893 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.004 seconds
[0m00:34:05.874992 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m00:34:05.874992 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */
alter table "data_engineering_test"."public"."calculate_comissions" rename to "calculate_comissions__dbt_backup"
[0m00:34:05.877993 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.002 seconds
[0m00:34:05.887418 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m00:34:05.888937 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */
alter table "data_engineering_test"."public"."calculate_comissions__dbt_tmp" rename to "calculate_comissions"
[0m00:34:05.891081 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m00:34:05.908129 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: COMMIT
[0m00:34:05.909637 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m00:34:05.909637 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: COMMIT
[0m00:34:05.914660 [debug] [Thread-1 (]: SQL status: COMMIT in 0.004 seconds
[0m00:34:05.924004 [debug] [Thread-1 (]: Applying DROP to: "data_engineering_test"."public"."calculate_comissions__dbt_backup"
[0m00:34:05.929004 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m00:34:05.929768 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */
drop view if exists "data_engineering_test"."public"."calculate_comissions__dbt_backup" cascade
[0m00:34:05.933776 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.003 seconds
[0m00:34:05.937774 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: Close
[0m00:34:05.940975 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c70b3195-f458-42d6-94b1-2474c09f8a28', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016A20E4E380>]}
[0m00:34:05.941915 [info ] [Thread-1 (]: 1 of 1 OK created sql view model public.calculate_comissions ................... [[32mCREATE VIEW[0m in 0.15s]
[0m00:34:05.942913 [debug] [Thread-1 (]: Finished running node model.task_4.calculate_comissions
[0m00:34:05.944914 [debug] [MainThread]: Using postgres connection "master"
[0m00:34:05.945915 [debug] [MainThread]: On master: BEGIN
[0m00:34:05.946913 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m00:34:05.969679 [debug] [MainThread]: SQL status: BEGIN in 0.023 seconds
[0m00:34:05.970687 [debug] [MainThread]: On master: COMMIT
[0m00:34:05.970687 [debug] [MainThread]: Using postgres connection "master"
[0m00:34:05.970687 [debug] [MainThread]: On master: COMMIT
[0m00:34:05.972691 [debug] [MainThread]: SQL status: COMMIT in 0.001 seconds
[0m00:34:05.972691 [debug] [MainThread]: On master: Close
[0m00:34:05.973685 [debug] [MainThread]: Connection 'master' was properly closed.
[0m00:34:05.974691 [debug] [MainThread]: Connection 'list_data_engineering_test' was properly closed.
[0m00:34:05.974691 [debug] [MainThread]: Connection 'list_data_engineering_test_public' was properly closed.
[0m00:34:05.974691 [debug] [MainThread]: Connection 'model.task_4.calculate_comissions' was properly closed.
[0m00:34:05.975692 [info ] [MainThread]: 
[0m00:34:05.976688 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 0.36 seconds (0.36s).
[0m00:34:05.976688 [debug] [MainThread]: Command end result
[0m00:34:06.004372 [info ] [MainThread]: 
[0m00:34:06.005310 [info ] [MainThread]: [32mCompleted successfully[0m
[0m00:34:06.005310 [info ] [MainThread]: 
[0m00:34:06.006816 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m00:34:06.008824 [debug] [MainThread]: Command `dbt run` succeeded at 00:34:06.008824 after 1.22 seconds
[0m00:34:06.008824 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016A1D889510>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016A203F3D00>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016A208CD030>]}
[0m00:34:06.010075 [debug] [MainThread]: Flushing usage events
[0m00:34:49.800858 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E2D1619510>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E2D4183340>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E2D4183160>]}


============================== 00:34:49.804223 | aadf25a4-e749-4e9c-8e46-dca47361cee7 ==============================
[0m00:34:49.804223 [info ] [MainThread]: Running with dbt=1.8.9
[0m00:34:49.805728 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4/dbt', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4\\dbt\\logs', 'fail_fast': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'invocation_command': 'dbt run --profiles-dir C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4/dbt --project-dir C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4/dbt', 'introspect': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m00:34:49.999674 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'aadf25a4-e749-4e9c-8e46-dca47361cee7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E2D41907C0>]}
[0m00:34:50.053118 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'aadf25a4-e749-4e9c-8e46-dca47361cee7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E2D4193730>]}
[0m00:34:50.054121 [info ] [MainThread]: Registered adapter: postgres=1.8.2
[0m00:34:50.317066 [debug] [MainThread]: checksum: 132857a23e9d07220246854f7763165174ce9b737cfc7867629ace4294e520b1, vars: {}, profile: , target: , version: 1.8.9
[0m00:34:50.447089 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m00:34:50.448090 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m00:34:50.475865 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'aadf25a4-e749-4e9c-8e46-dca47361cee7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E2D4764130>]}
[0m00:34:50.562112 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'aadf25a4-e749-4e9c-8e46-dca47361cee7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E2D4757040>]}
[0m00:34:50.563112 [info ] [MainThread]: Found 1 model, 428 macros
[0m00:34:50.563112 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'aadf25a4-e749-4e9c-8e46-dca47361cee7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E2D47570A0>]}
[0m00:34:50.565432 [info ] [MainThread]: 
[0m00:34:50.565432 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m00:34:50.567430 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_engineering_test'
[0m00:34:50.652821 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test"
[0m00:34:50.653826 [debug] [ThreadPool]: On list_data_engineering_test: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "list_data_engineering_test"} */

    select distinct nspname from pg_namespace
  
[0m00:34:50.654822 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m00:34:50.672309 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.018 seconds
[0m00:34:50.674340 [debug] [ThreadPool]: On list_data_engineering_test: Close
[0m00:34:50.676341 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_engineering_test_public'
[0m00:34:50.683005 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test_public"
[0m00:34:50.683005 [debug] [ThreadPool]: On list_data_engineering_test_public: BEGIN
[0m00:34:50.684012 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m00:34:50.697659 [debug] [ThreadPool]: SQL status: BEGIN in 0.014 seconds
[0m00:34:50.697659 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test_public"
[0m00:34:50.699230 [debug] [ThreadPool]: On list_data_engineering_test_public: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "list_data_engineering_test_public"} */
select
      'data_engineering_test' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_engineering_test' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_engineering_test' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m00:34:50.704742 [debug] [ThreadPool]: SQL status: SELECT 3 in 0.005 seconds
[0m00:34:50.706745 [debug] [ThreadPool]: On list_data_engineering_test_public: ROLLBACK
[0m00:34:50.708743 [debug] [ThreadPool]: On list_data_engineering_test_public: Close
[0m00:34:50.716835 [debug] [MainThread]: Using postgres connection "master"
[0m00:34:50.717833 [debug] [MainThread]: On master: BEGIN
[0m00:34:50.718833 [debug] [MainThread]: Opening a new connection, currently in state init
[0m00:34:50.742796 [debug] [MainThread]: SQL status: BEGIN in 0.024 seconds
[0m00:34:50.743795 [debug] [MainThread]: Using postgres connection "master"
[0m00:34:50.743795 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m00:34:50.752820 [debug] [MainThread]: SQL status: SELECT 2 in 0.008 seconds
[0m00:34:50.754821 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'aadf25a4-e749-4e9c-8e46-dca47361cee7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E2D477BAF0>]}
[0m00:34:50.755817 [debug] [MainThread]: On master: ROLLBACK
[0m00:34:50.756819 [debug] [MainThread]: Using postgres connection "master"
[0m00:34:50.756819 [debug] [MainThread]: On master: BEGIN
[0m00:34:50.759884 [debug] [MainThread]: SQL status: BEGIN in 0.002 seconds
[0m00:34:50.759884 [debug] [MainThread]: On master: COMMIT
[0m00:34:50.760893 [debug] [MainThread]: Using postgres connection "master"
[0m00:34:50.761038 [debug] [MainThread]: On master: COMMIT
[0m00:34:50.761966 [debug] [MainThread]: SQL status: COMMIT in 0.001 seconds
[0m00:34:50.762970 [debug] [MainThread]: On master: Close
[0m00:34:50.762970 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m00:34:50.763970 [info ] [MainThread]: 
[0m00:34:50.765967 [debug] [Thread-1 (]: Began running node model.task_4.calculate_comissions
[0m00:34:50.766967 [info ] [Thread-1 (]: 1 of 1 START sql view model public.calculate_comissions ........................ [RUN]
[0m00:34:50.767969 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.task_4.calculate_comissions'
[0m00:34:50.767969 [debug] [Thread-1 (]: Began compiling node model.task_4.calculate_comissions
[0m00:34:50.775058 [debug] [Thread-1 (]: Writing injected SQL for node "model.task_4.calculate_comissions"
[0m00:34:50.777060 [debug] [Thread-1 (]: Began executing node model.task_4.calculate_comissions
[0m00:34:50.811570 [debug] [Thread-1 (]: Writing runtime sql for node "model.task_4.calculate_comissions"
[0m00:34:50.812574 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m00:34:50.813572 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: BEGIN
[0m00:34:50.813572 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m00:34:50.827607 [debug] [Thread-1 (]: SQL status: BEGIN in 0.014 seconds
[0m00:34:50.829115 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m00:34:50.829634 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */

  create view "data_engineering_test"."public"."calculate_comissions__dbt_tmp"
    
    
  as (
    WITH orders_with_salesowners AS (
    SELECT
        o.order_id,
        round(i.gross_value / 100.0, 2) AS gross_value_in_euros,

        -- Converting the gross value into net value by taking the vat out in a non-lineal way.
        round((i.gross_value / 100.0) / (1 + i.vat / 100.0), 2) AS net_value_in_euros,
        string_to_array(o.salesowners, ', ') AS salesowners_array
    FROM
        public.orders o
    JOIN
        public.invoicing_data i ON o.order_id = i.order_id
),
salesowners AS (
    SELECT
        ows.order_id,
        ows.net_value_in_euros,
        so.salesowner,
        so.ordinality AS salesowner_position
    FROM
        orders_with_salesowners ows,
        unnest(ows.salesowners_array) WITH ORDINALITY AS so(salesowner, ordinality) -- unnests the array and assigns the order for each sales person in the order that it comes from the file
),
commission_calc AS (
    SELECT
        order_id,
        salesowner,
        CASE 
            WHEN salesowner_position = 1 THEN net_value_in_euros * 0.06    -- Main owner - 6%
            WHEN salesowner_position = 2 THEN net_value_in_euros * 0.025   -- Co-owner 1 - 2.5%
            WHEN salesowner_position = 3 THEN net_value_in_euros * 0.0095  -- Co-owner 2 - 0.95%
            ELSE 0  -- No comission
        END AS commission
    FROM salesowners
)
SELECT
    salesowner,
    ROUND(SUM(commission), 2) AS total_commission
FROM commission_calc
GROUP BY salesowner
ORDER BY total_commission DESC
  );
[0m00:34:50.833641 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.004 seconds
[0m00:34:50.841006 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m00:34:50.841006 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */
alter table "data_engineering_test"."public"."calculate_comissions" rename to "calculate_comissions__dbt_backup"
[0m00:34:50.843010 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m00:34:50.847006 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m00:34:50.848006 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */
alter table "data_engineering_test"."public"."calculate_comissions__dbt_tmp" rename to "calculate_comissions"
[0m00:34:50.849897 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.002 seconds
[0m00:34:50.865645 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: COMMIT
[0m00:34:50.865645 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m00:34:50.866646 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: COMMIT
[0m00:34:50.869153 [debug] [Thread-1 (]: SQL status: COMMIT in 0.002 seconds
[0m00:34:50.877230 [debug] [Thread-1 (]: Applying DROP to: "data_engineering_test"."public"."calculate_comissions__dbt_backup"
[0m00:34:50.882549 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m00:34:50.884064 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */
drop view if exists "data_engineering_test"."public"."calculate_comissions__dbt_backup" cascade
[0m00:34:50.887076 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.003 seconds
[0m00:34:50.889749 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: Close
[0m00:34:50.891880 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aadf25a4-e749-4e9c-8e46-dca47361cee7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E2D4BDE380>]}
[0m00:34:50.892881 [info ] [Thread-1 (]: 1 of 1 OK created sql view model public.calculate_comissions ................... [[32mCREATE VIEW[0m in 0.12s]
[0m00:34:50.893877 [debug] [Thread-1 (]: Finished running node model.task_4.calculate_comissions
[0m00:34:50.894878 [debug] [MainThread]: Using postgres connection "master"
[0m00:34:50.895878 [debug] [MainThread]: On master: BEGIN
[0m00:34:50.895878 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m00:34:50.911009 [debug] [MainThread]: SQL status: BEGIN in 0.015 seconds
[0m00:34:50.911140 [debug] [MainThread]: On master: COMMIT
[0m00:34:50.912006 [debug] [MainThread]: Using postgres connection "master"
[0m00:34:50.912510 [debug] [MainThread]: On master: COMMIT
[0m00:34:50.913519 [debug] [MainThread]: SQL status: COMMIT in 0.001 seconds
[0m00:34:50.913519 [debug] [MainThread]: On master: Close
[0m00:34:50.914516 [debug] [MainThread]: Connection 'master' was properly closed.
[0m00:34:50.914516 [debug] [MainThread]: Connection 'list_data_engineering_test' was properly closed.
[0m00:34:50.915519 [debug] [MainThread]: Connection 'list_data_engineering_test_public' was properly closed.
[0m00:34:50.915519 [debug] [MainThread]: Connection 'model.task_4.calculate_comissions' was properly closed.
[0m00:34:50.916516 [info ] [MainThread]: 
[0m00:34:50.916516 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 0.35 seconds (0.35s).
[0m00:34:50.917518 [debug] [MainThread]: Command end result
[0m00:34:50.944051 [info ] [MainThread]: 
[0m00:34:50.944051 [info ] [MainThread]: [32mCompleted successfully[0m
[0m00:34:50.945051 [info ] [MainThread]: 
[0m00:34:50.945051 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m00:34:50.947050 [debug] [MainThread]: Command `dbt run` succeeded at 00:34:50.947050 after 1.21 seconds
[0m00:34:50.947050 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E2D1619510>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E2D4183D00>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E2D45C1030>]}
[0m00:34:50.948050 [debug] [MainThread]: Flushing usage events
[0m00:35:22.349780 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028527F294B0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002852AA932B0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002852AA930D0>]}


============================== 00:35:22.353838 | a99bab21-9ced-4710-8531-599143a77b52 ==============================
[0m00:35:22.353838 [info ] [MainThread]: Running with dbt=1.8.9
[0m00:35:22.354838 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4\\dbt\\logs', 'version_check': 'True', 'profiles_dir': 'C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4/dbt', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'invocation_command': 'dbt run --profiles-dir C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4/dbt --project-dir C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4/dbt', 'static_parser': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m00:35:22.568998 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'a99bab21-9ced-4710-8531-599143a77b52', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028528743190>]}
[0m00:35:22.617845 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'a99bab21-9ced-4710-8531-599143a77b52', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000285279E3C40>]}
[0m00:35:22.620029 [info ] [MainThread]: Registered adapter: postgres=1.8.2
[0m00:35:22.886364 [debug] [MainThread]: checksum: 132857a23e9d07220246854f7763165174ce9b737cfc7867629ace4294e520b1, vars: {}, profile: , target: , version: 1.8.9
[0m00:35:23.025797 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m00:35:23.026799 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m00:35:23.054993 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'a99bab21-9ced-4710-8531-599143a77b52', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002852B074130>]}
[0m00:35:23.155851 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'a99bab21-9ced-4710-8531-599143a77b52', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002852B06A5C0>]}
[0m00:35:23.156853 [info ] [MainThread]: Found 1 model, 428 macros
[0m00:35:23.156853 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'a99bab21-9ced-4710-8531-599143a77b52', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002852B06B100>]}
[0m00:35:23.159361 [info ] [MainThread]: 
[0m00:35:23.159867 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m00:35:23.161881 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_engineering_test'
[0m00:35:23.249759 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test"
[0m00:35:23.250876 [debug] [ThreadPool]: On list_data_engineering_test: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "list_data_engineering_test"} */

    select distinct nspname from pg_namespace
  
[0m00:35:23.251767 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m00:35:23.269813 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.018 seconds
[0m00:35:23.271370 [debug] [ThreadPool]: On list_data_engineering_test: Close
[0m00:35:23.272378 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_engineering_test_public'
[0m00:35:23.279893 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test_public"
[0m00:35:23.280220 [debug] [ThreadPool]: On list_data_engineering_test_public: BEGIN
[0m00:35:23.280980 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m00:35:23.295114 [debug] [ThreadPool]: SQL status: BEGIN in 0.014 seconds
[0m00:35:23.296109 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test_public"
[0m00:35:23.297112 [debug] [ThreadPool]: On list_data_engineering_test_public: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "list_data_engineering_test_public"} */
select
      'data_engineering_test' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_engineering_test' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_engineering_test' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m00:35:23.301617 [debug] [ThreadPool]: SQL status: SELECT 3 in 0.004 seconds
[0m00:35:23.302619 [debug] [ThreadPool]: On list_data_engineering_test_public: ROLLBACK
[0m00:35:23.304619 [debug] [ThreadPool]: On list_data_engineering_test_public: Close
[0m00:35:23.309641 [debug] [MainThread]: Using postgres connection "master"
[0m00:35:23.310649 [debug] [MainThread]: On master: BEGIN
[0m00:35:23.310649 [debug] [MainThread]: Opening a new connection, currently in state init
[0m00:35:23.325160 [debug] [MainThread]: SQL status: BEGIN in 0.014 seconds
[0m00:35:23.326164 [debug] [MainThread]: Using postgres connection "master"
[0m00:35:23.326164 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m00:35:23.336964 [debug] [MainThread]: SQL status: SELECT 2 in 0.010 seconds
[0m00:35:23.339998 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'a99bab21-9ced-4710-8531-599143a77b52', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002852B089A50>]}
[0m00:35:23.339998 [debug] [MainThread]: On master: ROLLBACK
[0m00:35:23.342110 [debug] [MainThread]: Using postgres connection "master"
[0m00:35:23.342110 [debug] [MainThread]: On master: BEGIN
[0m00:35:23.344107 [debug] [MainThread]: SQL status: BEGIN in 0.001 seconds
[0m00:35:23.344107 [debug] [MainThread]: On master: COMMIT
[0m00:35:23.345110 [debug] [MainThread]: Using postgres connection "master"
[0m00:35:23.345110 [debug] [MainThread]: On master: COMMIT
[0m00:35:23.346111 [debug] [MainThread]: SQL status: COMMIT in 0.001 seconds
[0m00:35:23.347109 [debug] [MainThread]: On master: Close
[0m00:35:23.348109 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m00:35:23.348109 [info ] [MainThread]: 
[0m00:35:23.351698 [debug] [Thread-1 (]: Began running node model.task_4.calculate_comissions
[0m00:35:23.352700 [info ] [Thread-1 (]: 1 of 1 START sql view model public.calculate_comissions ........................ [RUN]
[0m00:35:23.353699 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.task_4.calculate_comissions'
[0m00:35:23.353699 [debug] [Thread-1 (]: Began compiling node model.task_4.calculate_comissions
[0m00:35:23.360797 [debug] [Thread-1 (]: Writing injected SQL for node "model.task_4.calculate_comissions"
[0m00:35:23.361809 [debug] [Thread-1 (]: Began executing node model.task_4.calculate_comissions
[0m00:35:23.398120 [debug] [Thread-1 (]: Writing runtime sql for node "model.task_4.calculate_comissions"
[0m00:35:23.399624 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m00:35:23.400689 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: BEGIN
[0m00:35:23.400689 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m00:35:23.414729 [debug] [Thread-1 (]: SQL status: BEGIN in 0.014 seconds
[0m00:35:23.415727 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m00:35:23.416725 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */

  create view "data_engineering_test"."public"."calculate_comissions__dbt_tmp"
    
    
  as (
    WITH orders_with_salesowners AS (
    SELECT
        o.order_id,
        round(i.gross_value / 100.0, 2) AS gross_value_in_euros,

        -- Converting the gross value into net value by taking the vat out in a non-lineal way.
        round((i.gross_value / 100.0) / (1 + i.vat / 100.0), 2) AS net_value_in_euros,
        string_to_array(o.salesowners, ', ') AS salesowners_array
    FROM
        public.orders o
    JOIN
        public.invoicing_data i ON o.order_id = i.order_id
),
salesowners AS (
    SELECT
        ows.order_id,
        ows.net_value_in_euros,
        so.salesowner,
        so.ordinality AS salesowner_position
    FROM
        orders_with_salesowners ows,
        unnest(ows.salesowners_array) WITH ORDINALITY AS so(salesowner, ordinality) -- unnests the array and assigns the order for each sales person in the order that it comes from the file
),
commission_calc AS (
    SELECT
        order_id,
        salesowner,
        CASE 
            WHEN salesowner_position = 1 THEN net_value_in_euros * 0.06    -- Main owner - 6%
            WHEN salesowner_position = 2 THEN net_value_in_euros * 0.025   -- Co-owner 1 - 2.5%
            WHEN salesowner_position = 3 THEN net_value_in_euros * 0.0095  -- Co-owner 2 - 0.95%
            ELSE 0  -- No comission
        END AS commission
    FROM salesowners
)
SELECT
    salesowner,
    ROUND(SUM(commission), 2) AS total_commission
FROM commission_calc
GROUP BY salesowner
ORDER BY total_commission DESC
  );
[0m00:35:23.420768 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.004 seconds
[0m00:35:23.427768 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m00:35:23.427768 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */
alter table "data_engineering_test"."public"."calculate_comissions" rename to "calculate_comissions__dbt_backup"
[0m00:35:23.429943 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m00:35:23.433954 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m00:35:23.433954 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */
alter table "data_engineering_test"."public"."calculate_comissions__dbt_tmp" rename to "calculate_comissions"
[0m00:35:23.434957 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m00:35:23.450636 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: COMMIT
[0m00:35:23.451633 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m00:35:23.452636 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: COMMIT
[0m00:35:23.454638 [debug] [Thread-1 (]: SQL status: COMMIT in 0.002 seconds
[0m00:35:23.461674 [debug] [Thread-1 (]: Applying DROP to: "data_engineering_test"."public"."calculate_comissions__dbt_backup"
[0m00:35:23.465680 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m00:35:23.466677 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */
drop view if exists "data_engineering_test"."public"."calculate_comissions__dbt_backup" cascade
[0m00:35:23.469702 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.003 seconds
[0m00:35:23.473803 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: Close
[0m00:35:23.476805 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a99bab21-9ced-4710-8531-599143a77b52', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002852B4EE380>]}
[0m00:35:23.478804 [info ] [Thread-1 (]: 1 of 1 OK created sql view model public.calculate_comissions ................... [[32mCREATE VIEW[0m in 0.12s]
[0m00:35:23.479827 [debug] [Thread-1 (]: Finished running node model.task_4.calculate_comissions
[0m00:35:23.481835 [debug] [MainThread]: Using postgres connection "master"
[0m00:35:23.482834 [debug] [MainThread]: On master: BEGIN
[0m00:35:23.482834 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m00:35:23.497695 [debug] [MainThread]: SQL status: BEGIN in 0.015 seconds
[0m00:35:23.499204 [debug] [MainThread]: On master: COMMIT
[0m00:35:23.499732 [debug] [MainThread]: Using postgres connection "master"
[0m00:35:23.499732 [debug] [MainThread]: On master: COMMIT
[0m00:35:23.501741 [debug] [MainThread]: SQL status: COMMIT in 0.001 seconds
[0m00:35:23.501741 [debug] [MainThread]: On master: Close
[0m00:35:23.502744 [debug] [MainThread]: Connection 'master' was properly closed.
[0m00:35:23.502744 [debug] [MainThread]: Connection 'list_data_engineering_test' was properly closed.
[0m00:35:23.503739 [debug] [MainThread]: Connection 'list_data_engineering_test_public' was properly closed.
[0m00:35:23.503739 [debug] [MainThread]: Connection 'model.task_4.calculate_comissions' was properly closed.
[0m00:35:23.504739 [info ] [MainThread]: 
[0m00:35:23.504739 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 0.34 seconds (0.34s).
[0m00:35:23.505739 [debug] [MainThread]: Command end result
[0m00:35:23.531833 [info ] [MainThread]: 
[0m00:35:23.532837 [info ] [MainThread]: [32mCompleted successfully[0m
[0m00:35:23.533834 [info ] [MainThread]: 
[0m00:35:23.533834 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m00:35:23.535834 [debug] [MainThread]: Command `dbt run` succeeded at 00:35:23.535834 after 1.25 seconds
[0m00:35:23.535834 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028527F294B0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002852A49B430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028528331D50>]}
[0m00:35:23.536834 [debug] [MainThread]: Flushing usage events
[0m00:35:35.223166 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025DBC6693F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025DBF1D72B0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025DBF1D70D0>]}


============================== 00:35:35.227165 | 0386fc72-cfc3-4576-9d33-3ae041a66bd3 ==============================
[0m00:35:35.227165 [info ] [MainThread]: Running with dbt=1.8.9
[0m00:35:35.228166 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4/dbt', 'debug': 'False', 'warn_error': 'None', 'log_path': 'C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4\\dbt\\logs', 'fail_fast': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'log_format': 'default', 'introspect': 'True', 'invocation_command': 'dbt run --profiles-dir C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4/dbt --project-dir C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4/dbt', 'static_parser': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m00:35:35.413522 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '0386fc72-cfc3-4576-9d33-3ae041a66bd3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025DBEBDBFD0>]}
[0m00:35:35.465863 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '0386fc72-cfc3-4576-9d33-3ae041a66bd3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025DBE5DF220>]}
[0m00:35:35.467863 [info ] [MainThread]: Registered adapter: postgres=1.8.2
[0m00:35:35.736359 [debug] [MainThread]: checksum: 132857a23e9d07220246854f7763165174ce9b737cfc7867629ace4294e520b1, vars: {}, profile: , target: , version: 1.8.9
[0m00:35:35.867828 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m00:35:35.869358 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m00:35:35.896624 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '0386fc72-cfc3-4576-9d33-3ae041a66bd3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025DBF7B0130>]}
[0m00:35:35.985899 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '0386fc72-cfc3-4576-9d33-3ae041a66bd3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025DBF7A78E0>]}
[0m00:35:35.986911 [info ] [MainThread]: Found 1 model, 428 macros
[0m00:35:35.986911 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0386fc72-cfc3-4576-9d33-3ae041a66bd3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025DBF7A7100>]}
[0m00:35:35.988909 [info ] [MainThread]: 
[0m00:35:35.989415 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m00:35:35.991016 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_engineering_test'
[0m00:35:36.077868 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test"
[0m00:35:36.078868 [debug] [ThreadPool]: On list_data_engineering_test: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "list_data_engineering_test"} */

    select distinct nspname from pg_namespace
  
[0m00:35:36.079375 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m00:35:36.101124 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.021 seconds
[0m00:35:36.102126 [debug] [ThreadPool]: On list_data_engineering_test: Close
[0m00:35:36.104128 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_engineering_test_public'
[0m00:35:36.109631 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test_public"
[0m00:35:36.110636 [debug] [ThreadPool]: On list_data_engineering_test_public: BEGIN
[0m00:35:36.110636 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m00:35:36.124848 [debug] [ThreadPool]: SQL status: BEGIN in 0.014 seconds
[0m00:35:36.124848 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test_public"
[0m00:35:36.125847 [debug] [ThreadPool]: On list_data_engineering_test_public: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "list_data_engineering_test_public"} */
select
      'data_engineering_test' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_engineering_test' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_engineering_test' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m00:35:36.131849 [debug] [ThreadPool]: SQL status: SELECT 3 in 0.005 seconds
[0m00:35:36.132845 [debug] [ThreadPool]: On list_data_engineering_test_public: ROLLBACK
[0m00:35:36.133844 [debug] [ThreadPool]: On list_data_engineering_test_public: Close
[0m00:35:36.138849 [debug] [MainThread]: Using postgres connection "master"
[0m00:35:36.138849 [debug] [MainThread]: On master: BEGIN
[0m00:35:36.139691 [debug] [MainThread]: Opening a new connection, currently in state init
[0m00:35:36.152836 [debug] [MainThread]: SQL status: BEGIN in 0.013 seconds
[0m00:35:36.153836 [debug] [MainThread]: Using postgres connection "master"
[0m00:35:36.154832 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m00:35:36.159839 [debug] [MainThread]: SQL status: SELECT 2 in 0.004 seconds
[0m00:35:36.162052 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0386fc72-cfc3-4576-9d33-3ae041a66bd3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025DBF7BBAF0>]}
[0m00:35:36.162052 [debug] [MainThread]: On master: ROLLBACK
[0m00:35:36.164057 [debug] [MainThread]: Using postgres connection "master"
[0m00:35:36.164057 [debug] [MainThread]: On master: BEGIN
[0m00:35:36.166054 [debug] [MainThread]: SQL status: BEGIN in 0.001 seconds
[0m00:35:36.166054 [debug] [MainThread]: On master: COMMIT
[0m00:35:36.167054 [debug] [MainThread]: Using postgres connection "master"
[0m00:35:36.167054 [debug] [MainThread]: On master: COMMIT
[0m00:35:36.168053 [debug] [MainThread]: SQL status: COMMIT in 0.001 seconds
[0m00:35:36.169055 [debug] [MainThread]: On master: Close
[0m00:35:36.169666 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m00:35:36.169666 [info ] [MainThread]: 
[0m00:35:36.172672 [debug] [Thread-1 (]: Began running node model.task_4.calculate_comissions
[0m00:35:36.173675 [info ] [Thread-1 (]: 1 of 1 START sql view model public.calculate_comissions ........................ [RUN]
[0m00:35:36.173675 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.task_4.calculate_comissions'
[0m00:35:36.174673 [debug] [Thread-1 (]: Began compiling node model.task_4.calculate_comissions
[0m00:35:36.181841 [debug] [Thread-1 (]: Writing injected SQL for node "model.task_4.calculate_comissions"
[0m00:35:36.182842 [debug] [Thread-1 (]: Began executing node model.task_4.calculate_comissions
[0m00:35:36.216668 [debug] [Thread-1 (]: Writing runtime sql for node "model.task_4.calculate_comissions"
[0m00:35:36.217673 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m00:35:36.217673 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: BEGIN
[0m00:35:36.219182 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m00:35:36.232821 [debug] [Thread-1 (]: SQL status: BEGIN in 0.013 seconds
[0m00:35:36.232821 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m00:35:36.233819 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */

  create view "data_engineering_test"."public"."calculate_comissions__dbt_tmp"
    
    
  as (
    WITH orders_with_salesowners AS (
    SELECT
        o.order_id,
        round(i.gross_value / 100.0, 2) AS gross_value_in_euros,

        -- Converting the gross value into net value by taking the vat out in a non-lineal way.
        round((i.gross_value / 100.0) / (1 + i.vat / 100.0), 2) AS net_value_in_euros,
        string_to_array(o.salesowners, ', ') AS salesowners_array
    FROM
        public.orders o
    JOIN
        public.invoicing_data i ON o.order_id = i.order_id
),
salesowners AS (
    SELECT
        ows.order_id,
        ows.net_value_in_euros,
        so.salesowner,
        so.ordinality AS salesowner_position
    FROM
        orders_with_salesowners ows,
        unnest(ows.salesowners_array) WITH ORDINALITY AS so(salesowner, ordinality) -- unnests the array and assigns the order for each sales person in the order that it comes from the file
),
commission_calc AS (
    SELECT
        order_id,
        salesowner,
        CASE 
            WHEN salesowner_position = 1 THEN net_value_in_euros * 0.06    -- Main owner - 6%
            WHEN salesowner_position = 2 THEN net_value_in_euros * 0.025   -- Co-owner 1 - 2.5%
            WHEN salesowner_position = 3 THEN net_value_in_euros * 0.0095  -- Co-owner 2 - 0.95%
            ELSE 0  -- No comission
        END AS commission
    FROM salesowners
)
SELECT
    salesowner,
    ROUND(SUM(commission), 2) AS total_commission
FROM commission_calc
GROUP BY salesowner
ORDER BY total_commission DESC
  );
[0m00:35:36.236818 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.003 seconds
[0m00:35:36.243993 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m00:35:36.243993 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */
alter table "data_engineering_test"."public"."calculate_comissions" rename to "calculate_comissions__dbt_backup"
[0m00:35:36.245994 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m00:35:36.250006 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m00:35:36.251016 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */
alter table "data_engineering_test"."public"."calculate_comissions__dbt_tmp" rename to "calculate_comissions"
[0m00:35:36.252016 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m00:35:36.267027 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: COMMIT
[0m00:35:36.267027 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m00:35:36.268032 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: COMMIT
[0m00:35:36.270982 [debug] [Thread-1 (]: SQL status: COMMIT in 0.002 seconds
[0m00:35:36.276456 [debug] [Thread-1 (]: Applying DROP to: "data_engineering_test"."public"."calculate_comissions__dbt_backup"
[0m00:35:36.281391 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m00:35:36.282393 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */
drop view if exists "data_engineering_test"."public"."calculate_comissions__dbt_backup" cascade
[0m00:35:36.283953 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.002 seconds
[0m00:35:36.287984 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: Close
[0m00:35:36.288988 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0386fc72-cfc3-4576-9d33-3ae041a66bd3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025DBFC2E380>]}
[0m00:35:36.289923 [info ] [Thread-1 (]: 1 of 1 OK created sql view model public.calculate_comissions ................... [[32mCREATE VIEW[0m in 0.11s]
[0m00:35:36.291043 [debug] [Thread-1 (]: Finished running node model.task_4.calculate_comissions
[0m00:35:36.292054 [debug] [MainThread]: Using postgres connection "master"
[0m00:35:36.293056 [debug] [MainThread]: On master: BEGIN
[0m00:35:36.293056 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m00:35:36.319700 [debug] [MainThread]: SQL status: BEGIN in 0.026 seconds
[0m00:35:36.320707 [debug] [MainThread]: On master: COMMIT
[0m00:35:36.320707 [debug] [MainThread]: Using postgres connection "master"
[0m00:35:36.320707 [debug] [MainThread]: On master: COMMIT
[0m00:35:36.321705 [debug] [MainThread]: SQL status: COMMIT in 0.001 seconds
[0m00:35:36.322706 [debug] [MainThread]: On master: Close
[0m00:35:36.323707 [debug] [MainThread]: Connection 'master' was properly closed.
[0m00:35:36.323707 [debug] [MainThread]: Connection 'list_data_engineering_test' was properly closed.
[0m00:35:36.323707 [debug] [MainThread]: Connection 'list_data_engineering_test_public' was properly closed.
[0m00:35:36.324706 [debug] [MainThread]: Connection 'model.task_4.calculate_comissions' was properly closed.
[0m00:35:36.324706 [info ] [MainThread]: 
[0m00:35:36.325709 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 0.34 seconds (0.34s).
[0m00:35:36.325709 [debug] [MainThread]: Command end result
[0m00:35:36.350919 [info ] [MainThread]: 
[0m00:35:36.351773 [info ] [MainThread]: [32mCompleted successfully[0m
[0m00:35:36.351773 [info ] [MainThread]: 
[0m00:35:36.352771 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m00:35:36.353773 [debug] [MainThread]: Command `dbt run` succeeded at 00:35:36.353773 after 1.20 seconds
[0m00:35:36.354772 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025DBC6693F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025DBF5EA290>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025DBF1D7C70>]}
[0m00:35:36.354772 [debug] [MainThread]: Flushing usage events
[0m01:41:29.196432 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017AF9D5AE90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017AFCED0CD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017AFCED19F0>]}


============================== 01:41:29.203237 | 7fb24b08-bc58-4806-a26e-8e6e976dcfb4 ==============================
[0m01:41:29.203237 [info ] [MainThread]: Running with dbt=1.8.9
[0m01:41:29.204229 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4\\dbt\\logs', 'version_check': 'True', 'profiles_dir': 'C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4/dbt', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'log_format': 'default', 'introspect': 'True', 'invocation_command': 'dbt run --profiles-dir C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4/dbt --project-dir C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4/dbt', 'static_parser': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m01:41:29.546819 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '7fb24b08-bc58-4806-a26e-8e6e976dcfb4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017AFD0019C0>]}
[0m01:41:29.663610 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '7fb24b08-bc58-4806-a26e-8e6e976dcfb4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017AFCEB9360>]}
[0m01:41:29.666608 [info ] [MainThread]: Registered adapter: postgres=1.8.2
[0m01:41:30.014951 [debug] [MainThread]: checksum: 132857a23e9d07220246854f7763165174ce9b737cfc7867629ace4294e520b1, vars: {}, profile: , target: , version: 1.8.9
[0m01:41:30.867269 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m01:41:30.868275 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m01:41:30.918794 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '7fb24b08-bc58-4806-a26e-8e6e976dcfb4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017AFE4F8AF0>]}
[0m01:41:31.108293 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '7fb24b08-bc58-4806-a26e-8e6e976dcfb4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017AFE3673A0>]}
[0m01:41:31.109295 [info ] [MainThread]: Found 1 model, 428 macros
[0m01:41:31.110293 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '7fb24b08-bc58-4806-a26e-8e6e976dcfb4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017AFE367430>]}
[0m01:41:31.112293 [info ] [MainThread]: 
[0m01:41:31.113295 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m01:41:31.115293 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_engineering_test'
[0m01:41:32.973665 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test"
[0m01:41:32.974664 [debug] [ThreadPool]: On list_data_engineering_test: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "list_data_engineering_test"} */

    select distinct nspname from pg_namespace
  
[0m01:41:32.975664 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m01:41:32.995664 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.020 seconds
[0m01:41:32.997664 [debug] [ThreadPool]: On list_data_engineering_test: Close
[0m01:41:32.999667 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_engineering_test_public'
[0m01:41:33.010664 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test_public"
[0m01:41:33.010664 [debug] [ThreadPool]: On list_data_engineering_test_public: BEGIN
[0m01:41:33.011666 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m01:41:33.027667 [debug] [ThreadPool]: SQL status: BEGIN in 0.016 seconds
[0m01:41:33.028666 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test_public"
[0m01:41:33.029665 [debug] [ThreadPool]: On list_data_engineering_test_public: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "list_data_engineering_test_public"} */
select
      'data_engineering_test' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_engineering_test' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_engineering_test' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m01:41:33.044669 [debug] [ThreadPool]: SQL status: SELECT 3 in 0.015 seconds
[0m01:41:33.046669 [debug] [ThreadPool]: On list_data_engineering_test_public: ROLLBACK
[0m01:41:33.048678 [debug] [ThreadPool]: On list_data_engineering_test_public: Close
[0m01:41:33.056178 [debug] [MainThread]: Using postgres connection "master"
[0m01:41:33.057178 [debug] [MainThread]: On master: BEGIN
[0m01:41:33.057178 [debug] [MainThread]: Opening a new connection, currently in state init
[0m01:41:33.082182 [debug] [MainThread]: SQL status: BEGIN in 0.024 seconds
[0m01:41:33.083178 [debug] [MainThread]: Using postgres connection "master"
[0m01:41:33.083178 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m01:41:33.092183 [debug] [MainThread]: SQL status: SELECT 2 in 0.008 seconds
[0m01:41:33.095179 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '7fb24b08-bc58-4806-a26e-8e6e976dcfb4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017AFE978D90>]}
[0m01:41:33.096178 [debug] [MainThread]: On master: ROLLBACK
[0m01:41:33.097181 [debug] [MainThread]: Using postgres connection "master"
[0m01:41:33.098183 [debug] [MainThread]: On master: BEGIN
[0m01:41:33.100183 [debug] [MainThread]: SQL status: BEGIN in 0.002 seconds
[0m01:41:33.101181 [debug] [MainThread]: On master: COMMIT
[0m01:41:33.102179 [debug] [MainThread]: Using postgres connection "master"
[0m01:41:33.102179 [debug] [MainThread]: On master: COMMIT
[0m01:41:33.104183 [debug] [MainThread]: SQL status: COMMIT in 0.001 seconds
[0m01:41:33.105179 [debug] [MainThread]: On master: Close
[0m01:41:33.105179 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m01:41:33.106183 [info ] [MainThread]: 
[0m01:41:33.110179 [debug] [Thread-1 (]: Began running node model.task_4.calculate_comissions
[0m01:41:33.111179 [info ] [Thread-1 (]: 1 of 1 START sql view model public.calculate_comissions ........................ [RUN]
[0m01:41:33.113178 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.task_4.calculate_comissions'
[0m01:41:33.113178 [debug] [Thread-1 (]: Began compiling node model.task_4.calculate_comissions
[0m01:41:33.127178 [debug] [Thread-1 (]: Writing injected SQL for node "model.task_4.calculate_comissions"
[0m01:41:33.129179 [debug] [Thread-1 (]: Began executing node model.task_4.calculate_comissions
[0m01:41:33.188693 [debug] [Thread-1 (]: Writing runtime sql for node "model.task_4.calculate_comissions"
[0m01:41:33.189693 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m01:41:33.190701 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: BEGIN
[0m01:41:33.191695 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m01:41:33.206976 [debug] [Thread-1 (]: SQL status: BEGIN in 0.015 seconds
[0m01:41:33.207974 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m01:41:33.208971 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */

  create view "data_engineering_test"."public"."calculate_comissions__dbt_tmp"
    
    
  as (
    WITH orders_with_salesowners AS (
    SELECT
        o.order_id,
        round(i.gross_value / 100.0, 2) AS gross_value_in_euros,

        -- Converting the gross value into net value by taking the vat out in a non-lineal way.
        round((i.gross_value / 100.0) / (1 + i.vat / 100.0), 2) AS net_value_in_euros,
        string_to_array(o.salesowners, ', ') AS salesowners_array
    FROM
        public.orders o
    JOIN
        public.invoicing_data i ON o.order_id = i.order_id
),
salesowners AS (
    SELECT
        ows.order_id,
        ows.net_value_in_euros,
        so.salesowner,
        so.ordinality AS salesowner_position
    FROM
        orders_with_salesowners ows,
        unnest(ows.salesowners_array) WITH ORDINALITY AS so(salesowner, ordinality) -- unnests the array and assigns the order for each sales person in the order that it comes from the file
),
commission_calc AS (
    SELECT
        order_id,
        salesowner,
        CASE 
            WHEN salesowner_position = 1 THEN net_value_in_euros * 0.06    -- Main owner - 6%
            WHEN salesowner_position = 2 THEN net_value_in_euros * 0.025   -- Co-owner 1 - 2.5%
            WHEN salesowner_position = 3 THEN net_value_in_euros * 0.0095  -- Co-owner 2 - 0.95%
            ELSE 0  -- No comission
        END AS commission
    FROM salesowners
)
SELECT
    salesowner,
    ROUND(SUM(commission), 2) AS total_commission
FROM commission_calc
GROUP BY salesowner
ORDER BY total_commission DESC
  );
[0m01:41:33.224975 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.015 seconds
[0m01:41:33.236972 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m01:41:33.237976 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */
alter table "data_engineering_test"."public"."calculate_comissions" rename to "calculate_comissions__dbt_backup"
[0m01:41:33.240982 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.002 seconds
[0m01:41:33.246977 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m01:41:33.247981 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */
alter table "data_engineering_test"."public"."calculate_comissions__dbt_tmp" rename to "calculate_comissions"
[0m01:41:33.249981 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m01:41:33.276486 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: COMMIT
[0m01:41:33.277486 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m01:41:33.277486 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: COMMIT
[0m01:41:33.281372 [debug] [Thread-1 (]: SQL status: COMMIT in 0.003 seconds
[0m01:41:33.291390 [debug] [Thread-1 (]: Applying DROP to: "data_engineering_test"."public"."calculate_comissions__dbt_backup"
[0m01:41:33.298389 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m01:41:33.299390 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */
drop view if exists "data_engineering_test"."public"."calculate_comissions__dbt_backup" cascade
[0m01:41:33.304673 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.005 seconds
[0m01:41:33.308686 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: Close
[0m01:41:33.311689 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7fb24b08-bc58-4806-a26e-8e6e976dcfb4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017AFE99DAE0>]}
[0m01:41:33.312687 [info ] [Thread-1 (]: 1 of 1 OK created sql view model public.calculate_comissions ................... [[32mCREATE VIEW[0m in 0.20s]
[0m01:41:33.313689 [debug] [Thread-1 (]: Finished running node model.task_4.calculate_comissions
[0m01:41:33.315687 [debug] [MainThread]: Using postgres connection "master"
[0m01:41:33.316686 [debug] [MainThread]: On master: BEGIN
[0m01:41:33.317690 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m01:41:33.333690 [debug] [MainThread]: SQL status: BEGIN in 0.016 seconds
[0m01:41:33.334689 [debug] [MainThread]: On master: COMMIT
[0m01:41:33.334689 [debug] [MainThread]: Using postgres connection "master"
[0m01:41:33.335687 [debug] [MainThread]: On master: COMMIT
[0m01:41:33.336687 [debug] [MainThread]: SQL status: COMMIT in 0.001 seconds
[0m01:41:33.337689 [debug] [MainThread]: On master: Close
[0m01:41:33.338687 [debug] [MainThread]: Connection 'master' was properly closed.
[0m01:41:33.338687 [debug] [MainThread]: Connection 'list_data_engineering_test' was properly closed.
[0m01:41:33.339692 [debug] [MainThread]: Connection 'list_data_engineering_test_public' was properly closed.
[0m01:41:33.340692 [debug] [MainThread]: Connection 'model.task_4.calculate_comissions' was properly closed.
[0m01:41:33.340692 [info ] [MainThread]: 
[0m01:41:33.341693 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 2.23 seconds (2.23s).
[0m01:41:33.342692 [debug] [MainThread]: Command end result
[0m01:41:33.414202 [info ] [MainThread]: 
[0m01:41:33.415206 [info ] [MainThread]: [32mCompleted successfully[0m
[0m01:41:33.416203 [info ] [MainThread]: 
[0m01:41:33.417209 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m01:41:33.419202 [debug] [MainThread]: Command `dbt run` succeeded at 01:41:33.419202 after 4.33 seconds
[0m01:41:33.419202 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017AF9D5AE90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017AFE32E050>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017AFE174310>]}
[0m01:41:33.420202 [debug] [MainThread]: Flushing usage events
[0m02:42:21.384225 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023162FED3C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023165B53280>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023165B530A0>]}


============================== 02:42:21.389731 | 5388a5da-1f49-422d-8fe3-6a949f6b63f6 ==============================
[0m02:42:21.389731 [info ] [MainThread]: Running with dbt=1.8.9
[0m02:42:21.389731 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4\\dbt\\logs', 'version_check': 'True', 'profiles_dir': 'C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4/dbt', 'use_colors': 'True', 'use_experimental_parser': 'False', 'empty': 'False', 'quiet': 'False', 'no_print': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'introspect': 'True', 'log_format': 'default', 'target_path': 'None', 'invocation_command': 'dbt run --profiles-dir C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4/dbt --project-dir C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4/dbt', 'send_anonymous_usage_stats': 'True'}
[0m02:42:21.611144 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '5388a5da-1f49-422d-8fe3-6a949f6b63f6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000231637A8940>]}
[0m02:42:21.661952 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '5388a5da-1f49-422d-8fe3-6a949f6b63f6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000231655574C0>]}
[0m02:42:21.663954 [info ] [MainThread]: Registered adapter: postgres=1.8.2
[0m02:42:22.049799 [debug] [MainThread]: checksum: 132857a23e9d07220246854f7763165174ce9b737cfc7867629ace4294e520b1, vars: {}, profile: , target: , version: 1.8.9
[0m02:42:22.999621 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m02:42:23.000622 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m02:42:23.028724 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '5388a5da-1f49-422d-8fe3-6a949f6b63f6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023166130130>]}
[0m02:42:23.139316 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '5388a5da-1f49-422d-8fe3-6a949f6b63f6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002316610DAB0>]}
[0m02:42:23.140318 [info ] [MainThread]: Found 1 model, 428 macros
[0m02:42:23.140318 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '5388a5da-1f49-422d-8fe3-6a949f6b63f6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002316610DDE0>]}
[0m02:42:23.142318 [info ] [MainThread]: 
[0m02:42:23.143318 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m02:42:23.145317 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_engineering_test'
[0m02:42:23.272813 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test"
[0m02:42:23.273814 [debug] [ThreadPool]: On list_data_engineering_test: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "list_data_engineering_test"} */

    select distinct nspname from pg_namespace
  
[0m02:42:23.274814 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m02:42:23.309035 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.034 seconds
[0m02:42:23.310605 [debug] [ThreadPool]: On list_data_engineering_test: Close
[0m02:42:23.312612 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_engineering_test_public'
[0m02:42:23.320658 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test_public"
[0m02:42:23.321656 [debug] [ThreadPool]: On list_data_engineering_test_public: BEGIN
[0m02:42:23.322656 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m02:42:23.340209 [debug] [ThreadPool]: SQL status: BEGIN in 0.018 seconds
[0m02:42:23.341209 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test_public"
[0m02:42:23.341209 [debug] [ThreadPool]: On list_data_engineering_test_public: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "list_data_engineering_test_public"} */
select
      'data_engineering_test' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_engineering_test' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_engineering_test' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m02:42:23.357328 [debug] [ThreadPool]: SQL status: SELECT 3 in 0.015 seconds
[0m02:42:23.359145 [debug] [ThreadPool]: On list_data_engineering_test_public: ROLLBACK
[0m02:42:23.360147 [debug] [ThreadPool]: On list_data_engineering_test_public: Close
[0m02:42:23.366145 [debug] [MainThread]: Using postgres connection "master"
[0m02:42:23.367146 [debug] [MainThread]: On master: BEGIN
[0m02:42:23.367146 [debug] [MainThread]: Opening a new connection, currently in state init
[0m02:42:23.384128 [debug] [MainThread]: SQL status: BEGIN in 0.016 seconds
[0m02:42:23.384128 [debug] [MainThread]: Using postgres connection "master"
[0m02:42:23.385129 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m02:42:23.394599 [debug] [MainThread]: SQL status: SELECT 2 in 0.008 seconds
[0m02:42:23.395600 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '5388a5da-1f49-422d-8fe3-6a949f6b63f6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002316610CF70>]}
[0m02:42:23.397107 [debug] [MainThread]: On master: ROLLBACK
[0m02:42:23.399170 [debug] [MainThread]: Using postgres connection "master"
[0m02:42:23.399170 [debug] [MainThread]: On master: BEGIN
[0m02:42:23.401173 [debug] [MainThread]: SQL status: BEGIN in 0.002 seconds
[0m02:42:23.402171 [debug] [MainThread]: On master: COMMIT
[0m02:42:23.402171 [debug] [MainThread]: Using postgres connection "master"
[0m02:42:23.403172 [debug] [MainThread]: On master: COMMIT
[0m02:42:23.404171 [debug] [MainThread]: SQL status: COMMIT in 0.001 seconds
[0m02:42:23.405170 [debug] [MainThread]: On master: Close
[0m02:42:23.406171 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m02:42:23.406171 [info ] [MainThread]: 
[0m02:42:23.410113 [debug] [Thread-1 (]: Began running node model.task_4.calculate_comissions
[0m02:42:23.411112 [info ] [Thread-1 (]: 1 of 1 START sql view model public.calculate_comissions ........................ [RUN]
[0m02:42:23.412114 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.task_4.calculate_comissions'
[0m02:42:23.413114 [debug] [Thread-1 (]: Began compiling node model.task_4.calculate_comissions
[0m02:42:23.420658 [debug] [Thread-1 (]: Writing injected SQL for node "model.task_4.calculate_comissions"
[0m02:42:23.421652 [debug] [Thread-1 (]: Began executing node model.task_4.calculate_comissions
[0m02:42:23.465161 [debug] [Thread-1 (]: Writing runtime sql for node "model.task_4.calculate_comissions"
[0m02:42:23.467131 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m02:42:23.468155 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: BEGIN
[0m02:42:23.468155 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m02:42:23.484644 [debug] [Thread-1 (]: SQL status: BEGIN in 0.016 seconds
[0m02:42:23.485643 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m02:42:23.485643 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */

  create view "data_engineering_test"."public"."calculate_comissions__dbt_tmp"
    
    
  as (
    WITH orders_with_salesowners AS (
    SELECT
        o.order_id,
        round(i.gross_value / 100.0, 2) AS gross_value_in_euros,

        -- Converting the gross value into net value by taking the vat out in a non-lineal way.
        round((i.gross_value / 100.0) / (1 + i.vat / 100.0), 2) AS net_value_in_euros,
        string_to_array(o.salesowners, ', ') AS salesowners_array
    FROM
        public.orders o
    JOIN
        public.invoicing_data i ON o.order_id = i.order_id
),
salesowners AS (
    SELECT
        ows.order_id,
        ows.net_value_in_euros,
        so.salesowner,
        so.ordinality AS salesowner_position
    FROM
        orders_with_salesowners ows,
        unnest(ows.salesowners_array) WITH ORDINALITY AS so(salesowner, ordinality) -- unnests the array and assigns the order for each sales person in the order that it comes from the file
),
commission_calc AS (
    SELECT
        order_id,
        salesowner,
        CASE 
            WHEN salesowner_position = 1 THEN net_value_in_euros * 0.06    -- Main owner - 6%
            WHEN salesowner_position = 2 THEN net_value_in_euros * 0.025   -- Co-owner 1 - 2.5%
            WHEN salesowner_position = 3 THEN net_value_in_euros * 0.0095  -- Co-owner 2 - 0.95%
            ELSE 0  -- No comission
        END AS commission
    FROM salesowners
)
SELECT
    salesowner,
    ROUND(SUM(commission), 2) AS total_commission
FROM commission_calc
GROUP BY salesowner
ORDER BY total_commission DESC
  );
[0m02:42:23.504102 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.017 seconds
[0m02:42:23.512160 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m02:42:23.513666 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */
alter table "data_engineering_test"."public"."calculate_comissions" rename to "calculate_comissions__dbt_backup"
[0m02:42:23.515679 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.002 seconds
[0m02:42:23.521143 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m02:42:23.522146 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */
alter table "data_engineering_test"."public"."calculate_comissions__dbt_tmp" rename to "calculate_comissions"
[0m02:42:23.524143 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.001 seconds
[0m02:42:23.541781 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: COMMIT
[0m02:42:23.542779 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m02:42:23.542779 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: COMMIT
[0m02:42:23.545782 [debug] [Thread-1 (]: SQL status: COMMIT in 0.003 seconds
[0m02:42:23.553807 [debug] [Thread-1 (]: Applying DROP to: "data_engineering_test"."public"."calculate_comissions__dbt_backup"
[0m02:42:23.558323 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m02:42:23.558832 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */
drop view if exists "data_engineering_test"."public"."calculate_comissions__dbt_backup" cascade
[0m02:42:23.563889 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.005 seconds
[0m02:42:23.567912 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: Close
[0m02:42:23.569930 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5388a5da-1f49-422d-8fe3-6a949f6b63f6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000231665BE380>]}
[0m02:42:23.570928 [info ] [Thread-1 (]: 1 of 1 OK created sql view model public.calculate_comissions ................... [[32mCREATE VIEW[0m in 0.16s]
[0m02:42:23.571932 [debug] [Thread-1 (]: Finished running node model.task_4.calculate_comissions
[0m02:42:23.572935 [debug] [MainThread]: Using postgres connection "master"
[0m02:42:23.573950 [debug] [MainThread]: On master: BEGIN
[0m02:42:23.573950 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m02:42:23.588993 [debug] [MainThread]: SQL status: BEGIN in 0.015 seconds
[0m02:42:23.590200 [debug] [MainThread]: On master: COMMIT
[0m02:42:23.590200 [debug] [MainThread]: Using postgres connection "master"
[0m02:42:23.591198 [debug] [MainThread]: On master: COMMIT
[0m02:42:23.592201 [debug] [MainThread]: SQL status: COMMIT in 0.001 seconds
[0m02:42:23.593203 [debug] [MainThread]: On master: Close
[0m02:42:23.593203 [debug] [MainThread]: Connection 'master' was properly closed.
[0m02:42:23.594200 [debug] [MainThread]: Connection 'list_data_engineering_test' was properly closed.
[0m02:42:23.594200 [debug] [MainThread]: Connection 'list_data_engineering_test_public' was properly closed.
[0m02:42:23.595199 [debug] [MainThread]: Connection 'model.task_4.calculate_comissions' was properly closed.
[0m02:42:23.595199 [info ] [MainThread]: 
[0m02:42:23.596202 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 0.45 seconds (0.45s).
[0m02:42:23.596202 [debug] [MainThread]: Command end result
[0m02:42:23.622830 [info ] [MainThread]: 
[0m02:42:23.622830 [info ] [MainThread]: [32mCompleted successfully[0m
[0m02:42:23.623829 [info ] [MainThread]: 
[0m02:42:23.623829 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m02:42:23.624826 [debug] [MainThread]: Command `dbt run` succeeded at 02:42:23.624826 after 2.33 seconds
[0m02:42:23.626331 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023162FED3C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023165B53C40>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023165D0C460>]}
[0m02:42:23.626331 [debug] [MainThread]: Flushing usage events
[0m02:43:39.086123 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000197D3BD93F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000197D67432B0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000197D67430D0>]}


============================== 02:43:39.091512 | 70627bee-8912-46df-b32c-11cd11805df8 ==============================
[0m02:43:39.091512 [info ] [MainThread]: Running with dbt=1.8.9
[0m02:43:39.091512 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'profiles_dir': 'C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4/dbt', 'log_path': 'C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4\\dbt\\logs', 'version_check': 'True', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --profiles-dir C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4/dbt --project-dir C:\\Users\\nicol\\Desktop\\ifco-assessment\\data-engineering-test\\solution\\src\\task_4/dbt', 'introspect': 'True', 'static_parser': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m02:43:39.308634 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '70627bee-8912-46df-b32c-11cd11805df8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000197D6147FD0>]}
[0m02:43:39.358559 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '70627bee-8912-46df-b32c-11cd11805df8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000197D5B53220>]}
[0m02:43:39.359595 [info ] [MainThread]: Registered adapter: postgres=1.8.2
[0m02:43:39.631700 [debug] [MainThread]: checksum: 132857a23e9d07220246854f7763165174ce9b737cfc7867629ace4294e520b1, vars: {}, profile: , target: , version: 1.8.9
[0m02:43:39.765265 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m02:43:39.766265 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m02:43:39.795242 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '70627bee-8912-46df-b32c-11cd11805df8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000197D6D20130>]}
[0m02:43:39.881806 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '70627bee-8912-46df-b32c-11cd11805df8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000197D6CFF8E0>]}
[0m02:43:39.882811 [info ] [MainThread]: Found 1 model, 428 macros
[0m02:43:39.883808 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '70627bee-8912-46df-b32c-11cd11805df8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000197D6CFF100>]}
[0m02:43:39.884806 [info ] [MainThread]: 
[0m02:43:39.885805 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m02:43:39.887309 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_engineering_test'
[0m02:43:39.972020 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test"
[0m02:43:39.973018 [debug] [ThreadPool]: On list_data_engineering_test: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "list_data_engineering_test"} */

    select distinct nspname from pg_namespace
  
[0m02:43:39.973018 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m02:43:39.993254 [debug] [ThreadPool]: SQL status: SELECT 4 in 0.020 seconds
[0m02:43:39.994254 [debug] [ThreadPool]: On list_data_engineering_test: Close
[0m02:43:39.996258 [debug] [ThreadPool]: Acquiring new postgres connection 'list_data_engineering_test_public'
[0m02:43:40.001817 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test_public"
[0m02:43:40.002816 [debug] [ThreadPool]: On list_data_engineering_test_public: BEGIN
[0m02:43:40.002816 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m02:43:40.017901 [debug] [ThreadPool]: SQL status: BEGIN in 0.015 seconds
[0m02:43:40.018910 [debug] [ThreadPool]: Using postgres connection "list_data_engineering_test_public"
[0m02:43:40.019513 [debug] [ThreadPool]: On list_data_engineering_test_public: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "list_data_engineering_test_public"} */
select
      'data_engineering_test' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'data_engineering_test' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
    union all
    select
      'data_engineering_test' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'public'
  
[0m02:43:40.024454 [debug] [ThreadPool]: SQL status: SELECT 2 in 0.005 seconds
[0m02:43:40.026458 [debug] [ThreadPool]: On list_data_engineering_test_public: ROLLBACK
[0m02:43:40.027458 [debug] [ThreadPool]: On list_data_engineering_test_public: Close
[0m02:43:40.031972 [debug] [MainThread]: Using postgres connection "master"
[0m02:43:40.031972 [debug] [MainThread]: On master: BEGIN
[0m02:43:40.032973 [debug] [MainThread]: Opening a new connection, currently in state init
[0m02:43:40.047089 [debug] [MainThread]: SQL status: BEGIN in 0.014 seconds
[0m02:43:40.048215 [debug] [MainThread]: Using postgres connection "master"
[0m02:43:40.048215 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m02:43:40.056365 [debug] [MainThread]: SQL status: SELECT 0 in 0.007 seconds
[0m02:43:40.058121 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '70627bee-8912-46df-b32c-11cd11805df8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000197D6D38520>]}
[0m02:43:40.058121 [debug] [MainThread]: On master: ROLLBACK
[0m02:43:40.060136 [debug] [MainThread]: Using postgres connection "master"
[0m02:43:40.060136 [debug] [MainThread]: On master: BEGIN
[0m02:43:40.062127 [debug] [MainThread]: SQL status: BEGIN in 0.001 seconds
[0m02:43:40.063130 [debug] [MainThread]: On master: COMMIT
[0m02:43:40.063130 [debug] [MainThread]: Using postgres connection "master"
[0m02:43:40.064126 [debug] [MainThread]: On master: COMMIT
[0m02:43:40.065131 [debug] [MainThread]: SQL status: COMMIT in 0.001 seconds
[0m02:43:40.065131 [debug] [MainThread]: On master: Close
[0m02:43:40.066127 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m02:43:40.067130 [info ] [MainThread]: 
[0m02:43:40.070346 [debug] [Thread-1 (]: Began running node model.task_4.calculate_comissions
[0m02:43:40.070346 [info ] [Thread-1 (]: 1 of 1 START sql view model public.calculate_comissions ........................ [RUN]
[0m02:43:40.071347 [debug] [Thread-1 (]: Acquiring new postgres connection 'model.task_4.calculate_comissions'
[0m02:43:40.072346 [debug] [Thread-1 (]: Began compiling node model.task_4.calculate_comissions
[0m02:43:40.078362 [debug] [Thread-1 (]: Writing injected SQL for node "model.task_4.calculate_comissions"
[0m02:43:40.079368 [debug] [Thread-1 (]: Began executing node model.task_4.calculate_comissions
[0m02:43:40.115411 [debug] [Thread-1 (]: Writing runtime sql for node "model.task_4.calculate_comissions"
[0m02:43:40.116409 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m02:43:40.117414 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: BEGIN
[0m02:43:40.117920 [debug] [Thread-1 (]: Opening a new connection, currently in state init
[0m02:43:40.132521 [debug] [Thread-1 (]: SQL status: BEGIN in 0.015 seconds
[0m02:43:40.133518 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m02:43:40.133518 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */

  create view "data_engineering_test"."public"."calculate_comissions__dbt_tmp"
    
    
  as (
    WITH orders_with_salesowners AS (
    SELECT
        o.order_id,
        round(i.gross_value / 100.0, 2) AS gross_value_in_euros,

        -- Converting the gross value into net value by taking the vat out in a non-lineal way.
        round((i.gross_value / 100.0) / (1 + i.vat / 100.0), 2) AS net_value_in_euros,
        string_to_array(o.salesowners, ', ') AS salesowners_array
    FROM
        public.orders o
    JOIN
        public.invoicing_data i ON o.order_id = i.order_id
),
salesowners AS (
    SELECT
        ows.order_id,
        ows.net_value_in_euros,
        so.salesowner,
        so.ordinality AS salesowner_position
    FROM
        orders_with_salesowners ows,
        unnest(ows.salesowners_array) WITH ORDINALITY AS so(salesowner, ordinality) -- unnests the array and assigns the order for each sales person in the order that it comes from the file
),
commission_calc AS (
    SELECT
        order_id,
        salesowner,
        CASE 
            WHEN salesowner_position = 1 THEN net_value_in_euros * 0.06    -- Main owner - 6%
            WHEN salesowner_position = 2 THEN net_value_in_euros * 0.025   -- Co-owner 1 - 2.5%
            WHEN salesowner_position = 3 THEN net_value_in_euros * 0.0095  -- Co-owner 2 - 0.95%
            ELSE 0  -- No comission
        END AS commission
    FROM salesowners
)
SELECT
    salesowner,
    ROUND(SUM(commission), 2) AS total_commission
FROM commission_calc
GROUP BY salesowner
ORDER BY total_commission DESC
  );
[0m02:43:40.141562 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.007 seconds
[0m02:43:40.148072 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m02:43:40.148580 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */
alter table "data_engineering_test"."public"."calculate_comissions__dbt_tmp" rename to "calculate_comissions"
[0m02:43:40.150610 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.002 seconds
[0m02:43:40.164626 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: COMMIT
[0m02:43:40.164626 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m02:43:40.165627 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: COMMIT
[0m02:43:40.169155 [debug] [Thread-1 (]: SQL status: COMMIT in 0.003 seconds
[0m02:43:40.175667 [debug] [Thread-1 (]: Applying DROP to: "data_engineering_test"."public"."calculate_comissions__dbt_backup"
[0m02:43:40.180255 [debug] [Thread-1 (]: Using postgres connection "model.task_4.calculate_comissions"
[0m02:43:40.180255 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: /* {"app": "dbt", "dbt_version": "1.8.9", "profile_name": "task_4_profile", "target_name": "dev", "node_id": "model.task_4.calculate_comissions"} */
drop view if exists "data_engineering_test"."public"."calculate_comissions__dbt_backup" cascade
[0m02:43:40.182261 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.001 seconds
[0m02:43:40.185255 [debug] [Thread-1 (]: On model.task_4.calculate_comissions: Close
[0m02:43:40.186260 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '70627bee-8912-46df-b32c-11cd11805df8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000197D28EE0E0>]}
[0m02:43:40.187773 [info ] [Thread-1 (]: 1 of 1 OK created sql view model public.calculate_comissions ................... [[32mCREATE VIEW[0m in 0.11s]
[0m02:43:40.188283 [debug] [Thread-1 (]: Finished running node model.task_4.calculate_comissions
[0m02:43:40.189812 [debug] [MainThread]: Using postgres connection "master"
[0m02:43:40.189812 [debug] [MainThread]: On master: BEGIN
[0m02:43:40.190820 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m02:43:40.204365 [debug] [MainThread]: SQL status: BEGIN in 0.014 seconds
[0m02:43:40.205363 [debug] [MainThread]: On master: COMMIT
[0m02:43:40.206362 [debug] [MainThread]: Using postgres connection "master"
[0m02:43:40.206362 [debug] [MainThread]: On master: COMMIT
[0m02:43:40.208092 [debug] [MainThread]: SQL status: COMMIT in 0.001 seconds
[0m02:43:40.208092 [debug] [MainThread]: On master: Close
[0m02:43:40.209098 [debug] [MainThread]: Connection 'master' was properly closed.
[0m02:43:40.209098 [debug] [MainThread]: Connection 'list_data_engineering_test' was properly closed.
[0m02:43:40.210099 [debug] [MainThread]: Connection 'list_data_engineering_test_public' was properly closed.
[0m02:43:40.210099 [debug] [MainThread]: Connection 'model.task_4.calculate_comissions' was properly closed.
[0m02:43:40.211100 [info ] [MainThread]: 
[0m02:43:40.211100 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 0.33 seconds (0.33s).
[0m02:43:40.212098 [debug] [MainThread]: Command end result
[0m02:43:40.238085 [info ] [MainThread]: 
[0m02:43:40.238085 [info ] [MainThread]: [32mCompleted successfully[0m
[0m02:43:40.239058 [info ] [MainThread]: 
[0m02:43:40.239058 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m02:43:40.241183 [debug] [MainThread]: Command `dbt run` succeeded at 02:43:40.241183 after 1.26 seconds
[0m02:43:40.241183 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000197D3BD93F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000197D6146A70>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000197D6147BE0>]}
[0m02:43:40.242187 [debug] [MainThread]: Flushing usage events
